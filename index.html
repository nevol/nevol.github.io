<!DOCTYPE html>
<html lang="he" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>××¢×¨×›×ª ×©×™×‘×•×¦×™× - ××œ××” ×•×™×¦×™×‘×”</title>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f172a; --card:#1e293b; --ink:#f8fafc; --muted:#94a3b8;
      --border:#334155; --accent:#38bdf8; --accent2:#06b6d4;
      --chip-bg:#0f172a; --pill-bg:#334155; --btn-ink:#0f172a;
      --ok-bg:#052e16; --ok-br:#22c55e; --ok-ink:#bbf7d0;
      --warn-bg:#422006; --warn-br:#ca8a04; --warn-ink:#fde047;
      --bad-bg:#450a0a; --bad-br:#ef4444; --bad-ink:#fecaca;
      --fri-bg:#172554; --fri-br:#1e40af;
      --toast-bg:#1e293b; --toast-br:#475569; --toast-ink:#f1f5f9;
    }
    html[data-theme="light"]{
      --bg:#f1f5f9; --card:#ffffff; --ink:#0f172a; --muted:#64748b;
      --border:#cbd5e1;
      --chip-bg:#f8fafc; --pill-bg:#f1f5f9;
      --ok-bg:#dcfce7; --ok-br:#22c55e; --ok-ink:#14532d;
      --warn-bg:#fef9c3; --warn-br:#eab308; --warn-ink:#713f12;
      --bad-bg:#fee2e2; --bad-br:#ef4444; --bad-ink:#7f1d1d;
      --fri-bg:#eff6ff; --fri-br:#bfdbfe;
      --toast-bg:#ffffff; --toast-br:#cbd5e1; --toast-ink:#0f172a;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:"Assistant",system-ui;padding-bottom:80px;overflow-y:scroll;}
    
    .app{max-width:1600px;margin:0 auto;padding:16px;}
    
    /* Header */
    header.header{display:flex;justify-content:space-between;align-items:flex-start;gap:16px;flex-wrap:wrap;margin-bottom:20px;}
    .title{margin:0;font-size:26px;font-weight:800}
    .sub{color:var(--muted);font-size:14px;margin-top:4px;display:block}
    .header-actions{display:flex;gap:8px;align-items:center}
    .id-badge{border:1px solid var(--border);padding:6px 12px;border-radius:999px;font-size:13px;background:var(--card)}
    
    /* Buttons */
    button{cursor:pointer;border:none;border-radius:10px;padding:8px 14px;font-weight:700;font-family:inherit;font-size:14px;transition:0.2s;}
    button.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:var(--btn-ink)}
    button.primary:hover{opacity:0.9;transform:translateY(-1px)}
    button.ghost{background:transparent;border:1px solid var(--border);color:var(--ink)}
    button.ghost:hover{background:var(--pill-bg)}
    .icon-btn{width:40px;height:40px;display:inline-flex;align-items:center;justify-content:center;border-radius:10px;background:var(--card);border:1px solid var(--border);color:var(--ink)}
    
    /* Panels */
    .panel{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:16px;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1)}
    .panel .hd{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .panel .bd{padding:16px}
    .split{display:grid;grid-template-columns:1fr 350px;gap:16px}
    @media(max-width:1100px){.split{grid-template-columns:1fr}}

    /* Schedule Grid */
    .schedule-header{display:flex;gap:10px;align-items:center}
    .schedule{display:grid;grid-template-columns:90px repeat(6, 1fr);gap:8px;overflow-x:auto}
    @media(max-width:1200px){.schedule{min-width:800px}}
    
    .col-hd{text-align:center;color:var(--muted);font-size:13px;font-weight:700;padding-bottom:4px}
    .row-label{display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--muted);text-align:center;line-height:1.2;border-right:3px solid var(--border);padding-right:8px}
    
    .slot{background:var(--bg);border:1px solid var(--border);border-radius:12px;min-height:90px;padding:8px;display:flex;flex-direction:column;gap:6px;position:relative}
    .slot.fri{background:var(--fri-bg);border-color:var(--fri-br)}
    
    .datebox{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:2px}
    .d-top{font-weight:700;color:var(--ink)}
    
    .pill{display:inline-flex;gap:4px;align-items:center;border-radius:6px;padding:2px 8px;border:1px solid var(--border);background:var(--pill-bg);font-size:12px;width:fit-content}
    .pill.ok{background:var(--ok-bg);border-color:var(--ok-br);color:var(--ok-ink)}
    .pill.bad{background:var(--bad-bg);border-color:var(--bad-br);color:var(--bad-ink)}
    .pill.warn{background:var(--warn-bg);border-color:var(--warn-br);color:var(--warn-ink)}

    /* Days & Chips */
    .days{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .day{background:var(--bg);border:1px dashed var(--border);border-radius:8px;padding:8px;min-height:50px;cursor:pointer;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;gap:2px;font-size:13px;transition:0.1s;user-select:none}
    .day:hover{border-color:var(--accent)}
    .day.state-1{background:var(--warn-bg);border-color:var(--warn-br);border-style:solid}
    .day.state-2{background:var(--bad-bg);border-color:var(--bad-br);border-style:solid}
    .day.shabbat{opacity:.3;cursor:not-allowed;background:var(--pill-bg)}
    
    .legend{display:flex;gap:12px;font-size:12px;color:var(--muted);margin-bottom:8px}
    .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-inline-end:4px}
    .dot.bg0{background:var(--bg);border:1px dashed var(--muted)}
    .dot.bg1{background:var(--warn-br)}
    .dot.bg2{background:var(--bad-br)}

    .chip{background:var(--chip-bg);border:1px solid var(--border);border-radius:999px;padding:6px 12px;cursor:pointer;font-size:13px;transition:0.2s;display:inline-block;margin:2px}
    .chip:hover{background:var(--pill-bg)}
    .chip.active{background:var(--accent);color:var(--btn-ink);border-color:var(--accent);font-weight:700}

    /* Modals & Toasts */
    .toast-wrap{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);z-index:10000;display:flex;flex-direction:column;gap:8px;pointer-events:none}
    .toast{pointer-events:all;background:var(--toast-bg);border:1px solid var(--toast-br);color:var(--toast-ink);padding:10px 16px;border-radius:12px;display:flex;align-items:center;box-shadow:0 10px 40px rgba(0,0,0,0.3);min-width:300px;animation:slideUp 0.3s}
    @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
    
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal{background:var(--card);border:1px solid var(--border);border-radius:16px;max-width:400px;width:90%;padding:24px;box-shadow:0 20px 25px -5px rgba(0,0,0,0.4)}
    input, select{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;color:var(--ink);font-family:inherit;outline:none;font-size:16px}
    
    .bottom-tabs{position:fixed;bottom:0;left:0;right:0;background:var(--card);border-top:1px solid var(--border);display:flex;gap:8px;padding:10px 16px;overflow-x:auto;z-index:500}
    .tab{padding:6px 14px;border-radius:999px;border:1px solid transparent;color:var(--muted);white-space:nowrap;cursor:pointer;font-size:14px;transition:0.2s}
    .tab.active{background:var(--accent);color:var(--btn-ink);font-weight:700}
    .admin-bar{position:fixed;left:16px;top:16px;z-index:10001}
  </style>
</head>
<body>
  
  <div class="admin-bar">
    <button id="adminBtn" class="icon-btn" title="×¤×× ×œ × ×™×”×•×œ" style="display:none">âš™ï¸</button>
  </div>

  <div class="app">
    <header class="header">
      <div>
        <h1 class="title">×œ×•×— ×©×™×‘×•×¦×™×</h1>
        <span class="sub">× ×™×”×•×œ ××©××¨×•×ª ×¡×“× ×”</span>
      </div>
      <div class="header-actions">
        <span id="whoami" class="id-badge">×œ× ××—×•×‘×¨</span>
        <button id="switchUserBtn" class="ghost">×™×¦×™××”</button>
        <button id="themeBtn" class="icon-btn">ğŸŒ™</button>
      </div>
    </header>

    <main class="split">
      <section class="panel">
        <div class="hd">
          <div class="schedule-header">
            <h3 style="margin:0" id="scheduleTitle">×˜×•×¢×Ÿ...</h3>
            <span id="dateRangeBadge" class="badge" style="border:1px solid var(--border);padding:2px 8px;border-radius:4px;font-size:12px"></span>
            <span id="lockBadge" class="badge" style="background:var(--bad-bg);color:var(--bad-ink);padding:2px 8px;border-radius:4px;font-size:12px;display:none;">ğŸ”’ × ×¢×•×œ</span>
          </div>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <button id="computeBtn" class="ghost">âš¡ ×—×©×‘</button>
            <button id="exportBtn" class="ghost">ğŸ“¥ CSV</button>
          </div>
        </div>
        <div class="bd">
          <div id="scheduleGrid" class="schedule"></div>
          <div id="summaryBox" style="margin-top:16px"></div>
        </div>
      </section>

      <section class="panel">
        <div class="hd"><h3 style="margin:0">×”××™×œ×•×¦×™× ×©×œ×™</h3></div>
        <div class="bd">
          <div id="peopleChips" style="margin-bottom:12px"></div>
          <div class="legend">
            <span><span class="dot bg0"></span>×–××™×Ÿ</span>
            <span><span class="dot bg1"></span>××¢×“×™×£ ×©×œ×</span>
            <span><span class="dot bg2"></span>×œ× ×™×›×•×œ</span>
          </div>
          <div id="daysGrid" class="days" style="margin-bottom:16px"></div>
          <div style="display:flex;gap:8px;flex-direction:column">
            <button id="saveBtn" class="primary" style="width:100%">ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×</button>
            <button id="resetMineBtn" class="ghost" style="width:100%">× ×§×” ××™×œ×•×¦×™×</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="bottomTabs" class="bottom-tabs"></div>

  <!-- Login Modal -->
  <div id="identityBackdrop" class="modal-backdrop" style="display:none">
    <div class="modal">
      <h2>×”×ª×—×‘×¨×•×ª</h2>
      <p style="color:var(--muted);margin-bottom:16px">×‘×—×¨ ××ª ×”×©× ×©×œ×š ×›×“×™ ×œ×”×ª×—×™×œ.</p>
      <div style="margin-bottom:16px">
        <select id="identitySelect"><option>×˜×•×¢×Ÿ ×¨×©×™××”...</option></select>
      </div>
      <button id="identityStartBtn" class="primary" style="width:100%">×”×ª×—×œ</button>
    </div>
  </div>

  <!-- Admin Modal -->
  <div id="adminBackdrop" class="modal-backdrop">
    <div class="modal">
      <h2>×”×’×“×¨×•×ª ×× ×”×œ</h2>
      <div style="margin-bottom:12px">
        <label>×ª××¨×™×š ×”×ª×—×œ×”</label>
        <input id="adminStartDate" type="date">
      </div>
      <div style="margin-bottom:12px">
        <label>×©×‘×•×¢×•×ª ×§×“×™××”</label>
        <input id="adminHorizon" type="number" min="1" max="8">
      </div>
      <div style="margin-bottom:12px">
        <label>× ×¢×•×œ ×¢×“</label>
        <input id="adminLockUntil" type="date">
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px">
        <button id="adminCloseBtn" class="ghost">×‘×™×˜×•×œ</button>
        <button id="adminSaveBtn" class="primary">×©××•×¨</button>
      </div>
    </div>
  </div>

  <div id="toastWrap" class="toast-wrap"></div>

  <!-- MAIN SCRIPT -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, getDocs, collection, deleteField, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // 1. CONFIGURATION
    const firebaseConfig = {
      apiKey: "AIzaSyBiZIHRpbg0bq4VFZ2kDDXj6QeRJZpjOpg",
      authDomain: "sadna-timetable.firebaseapp.com",
      projectId: "sadna-timetable",
      storageBucket: "sadna-timetable.firebasestorage.app",
      messagingSenderId: "605203492621",
      appId: "1:605203492621:web:7ed83f0e5e64d67b9c8a44",
      measurementId: "G-8941L7ZZJ6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // 2. DATA CONSTANTS (Defaults / Offline)
    const DEFAULT_GROUPS = {
      "××“×¤×¡×•×ª": { name: "××“×¤×¡×•×ª", people: ["× ×‘×•","× ×˜×¢","×˜×œ"], horizonWeeks: 4 },
      "×ª×¤×™×¨×”": { name: "×ª×¤×™×¨×”", people: ["×›×œ×™×œ","×¢××™×ª","×©×™×¨×”"], horizonWeeks: 4 },
      "××ª×›×ª": { name: "××ª×›×ª", people: ["×××™"], horizonWeeks: 4 },
      "×¢×™×‘×•×“ ×©×‘×‘×™×": { name: "×¢×™×‘×•×“ ×©×‘×‘×™×", people: ["×œ×™×¢×“"], horizonWeeks: 4 },
      "×¢×¥": { name: "×¢×¥", people: ["××•×¨×™"], horizonWeeks: 4 }
    };

    const DEFAULT_USERS = [
      { id: "u-navo", name: "× ×‘×•", group: "××“×¤×¡×•×ª", role: "admin" },
      { id: "u-neta", name: "× ×˜×¢", group: "××“×¤×¡×•×ª", role: "user" },
      { id: "u-tal",  name: "×˜×œ",  group: "××“×¤×¡×•×ª", role: "user" },
      { id: "u-klil", name: "×›×œ×™×œ", group: "×ª×¤×™×¨×”", role: "user" },
      { id: "u-amit", name: "×¢××™×ª", group: "×ª×¤×™×¨×”", role: "user" },
      { id: "u-shira",name: "×©×™×¨×”", group: "×ª×¤×™×¨×”", role: "user" },
      { id: "u-mai",  name: "×××™", group: "××ª×›×ª", role: "user" },
      { id: "u-liad", name: "×œ×™×¢×“", group: "×¢×™×‘×•×“ ×©×‘×‘×™×", role: "user" },
      { id: "u-uri",  name: "××•×¨×™", group: "×¢×¥", role: "user" }
    ];

    // 3. STATE
    let activeUser = null;
    let currentGroupId = null;
    let currentGroupData = null;
    let state = {}; 
    let peopleInGroup = [];
    let unsubConstraints = null;
    let lastComputedPack = null;
    let allUsersCache = [];
    const MS_DAY = 86400000;
    const hebDaysShort = ["××³","×‘×³","×’×³","×“×³","×”×³","×•×³","×©×³"];

    // 4. HELPERS
    function parseLocalDate(str) {
      if(!str) return new Date();
      const [y,m,d] = str.split('-').map(Number);
      return new Date(y, m-1, d, 0, 0, 0, 0);
    }
    function fmtDateKey(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    function fmtDM(d) { return `${d.getDate()}.${d.getMonth()+1}`; }
    function addDays(d, n) { return new Date(d.getFullYear(), d.getMonth(), d.getDate() + n); }
    function rangeDays(start, end) {
      const arr=[];
      let c = new Date(start);
      while(c <= end) { arr.push(new Date(c)); c = addDays(c,1); }
      return arr;
    }
    function toast(msg, type="ok") {
      const t = document.createElement("div");
      t.className = `toast`;
      let icon = type==="ok"?"âœ…":type==="warn"?"âš ï¸":"âŒ";
      t.innerHTML = `<div><span style="margin-inline-end:8px">${icon}</span>${msg}</div>`;
      document.getElementById("toastWrap").appendChild(t);
      setTimeout(() => { t.style.opacity="0"; setTimeout(()=>t.remove(),300); }, 3000);
    }

    // 5. APP LOGIC
    async function initApp() {
      // 1. Get Users (Fail-safe)
      try {
        const snap = await getDocs(collection(db, "users"));
        if(!snap.empty) {
          allUsersCache = [];
          snap.forEach(d => allUsersCache.push({id:d.id, ...d.data()}));
        } else {
          throw new Error("Empty DB");
        }
      } catch(e) {
        console.warn("Loading offline users", e);
        allUsersCache = DEFAULT_USERS;
        // Seed if possible
        try {
           const batch = writeBatch(db);
           DEFAULT_USERS.forEach(u => batch.set(doc(db,"users",u.id), u));
           await batch.commit();
        } catch(e2){}
      }

      // Populate Select
      const sel = document.getElementById("identitySelect");
      sel.innerHTML = allUsersCache.map(u => `<option value="${u.id}">${u.name} (${u.group})</option>`).join("");

      // Auto Login
      const savedUid = localStorage.getItem("sched_uid");
      if(savedUid) {
        const found = allUsersCache.find(u => u.id === savedUid);
        if(found) {
           doLogin(found);
           return;
        }
      }
      document.getElementById("identityBackdrop").style.display = "flex";
    }

    async function doLogin(user) {
      activeUser = user;
      localStorage.setItem("sched_uid", user.id);
      
      document.getElementById("whoami").textContent = `${user.name}`;
      document.getElementById("adminBtn").style.display = user.role === 'admin' ? 'inline-flex' : 'none';
      
      await switchGroup(user.group);
      document.getElementById("identityBackdrop").style.display = "none";
      toast("×”×ª×—×‘×¨×ª ×‘×”×¦×œ×—×”");
    }

    async function switchGroup(groupId) {
      currentGroupId = groupId;
      
      // Default Data + Ensure valid start date
      let finalData = DEFAULT_GROUPS[groupId] || { name: groupId, people: [], horizonWeeks: 4 };
      // Always fallback to today if DB date is missing
      finalData.startDate = fmtDateKey(new Date()); 

      // Try DB Fetch
      try {
        const snap = await getDoc(doc(db, "groups", groupId));
        if(snap.exists()) {
          const dbData = snap.data();
          if(dbData.startDate) finalData.startDate = dbData.startDate;
          if(dbData.horizonWeeks) finalData.horizonWeeks = dbData.horizonWeeks;
          if(dbData.lockedUntil) finalData.lockedUntil = dbData.lockedUntil;
          if(dbData.people) finalData.people = dbData.people;
          if(dbData.name) finalData.name = dbData.name;
        } else {
          // Create missing doc silently
          setDoc(doc(db, "groups", groupId), finalData, {merge:true}).catch(e=>{});
        }
      } catch(e) {
        console.error("Group load failed, using default", e);
      }

      currentGroupData = finalData;
      
      // Determine People
      let pList = finalData.people || [];
      if(!pList.length) pList = allUsersCache.filter(u => u.group === groupId).map(u => u.name);
      peopleInGroup = pList;

      // Update UI
      document.getElementById("scheduleTitle").textContent = `×œ×•×— ×©×™×‘×•×¦×™× â€“ ${finalData.name}`;
      renderTabs();
      renderChips();

      document.getElementById("adminStartDate").value = finalData.startDate;
      document.getElementById("adminHorizon").value = finalData.horizonWeeks;
      document.getElementById("adminLockUntil").value = finalData.lockedUntil || "";

      // Load Constraints
      if(unsubConstraints) unsubConstraints();
      state = {};
      renderCalendar(); // clear old
      runCompute(); // run empty compute to clear schedule

      // Live Listener
      try {
        const startDate = parseLocalDate(finalData.startDate);
        const monthKey = `${startDate.getFullYear()}-${String(startDate.getMonth()+1).padStart(2,'0')}`;
        const q = collection(db, "groups", groupId, "constraints", monthKey, "days");
        
        unsubConstraints = onSnapshot(q, (ss) => {
          ss.docChanges().forEach(ch => {
            if(ch.type==="removed") delete state[ch.doc.id];
            else state[ch.doc.id] = ch.doc.data();
          });
          renderCalendar();
          runCompute();
        }, (err) => {
          console.warn("Live sync failed", err);
        });
      } catch(e) { console.warn("Snapshot init failed", e); }
    }

    // 6. RENDERERS
    function renderTabs() {
      const div = document.getElementById("bottomTabs");
      div.innerHTML = Object.keys(DEFAULT_GROUPS).map(k => 
        `<div class="tab ${k===currentGroupId?'active':''}" onclick="changeGroup('${k}')">${k}</div>`
      ).join("");
    }
    window.changeGroup = (g) => switchGroup(g);

    function renderChips() {
      const div = document.getElementById("peopleChips");
      div.innerHTML = peopleInGroup.map(p => 
        `<div class="chip ${activeUser&&activeUser.name===p?'active':''}" onclick="impersonate('${p}')">${p}</div>`
      ).join("");
    }
    window.impersonate = (p) => {
      if(activeUser && activeUser.role === 'admin') {
        activeUser = {...activeUser, name:p};
        renderChips(); renderCalendar(); toast(`×¢×•×¨×š ×›: ${p}`);
      }
    };

    function renderCalendar() {
      if(!currentGroupData) return;
      const startDate = parseLocalDate(currentGroupData.startDate);
      const weeks = Number(currentGroupData.horizonWeeks);
      const endDate = addDays(startDate, weeks*7 - 1);
      
      document.getElementById("dateRangeBadge").textContent = `${fmtDM(startDate)} â€“ ${fmtDM(endDate)}`;
      const locked = currentGroupData.lockedUntil && new Date() < parseLocalDate(currentGroupData.lockedUntil);
      document.getElementById("lockBadge").style.display = locked ? "inline-block" : "none";

      const grid = document.getElementById("daysGrid");
      grid.innerHTML = rangeDays(startDate, endDate).map(d => {
        const k = fmtDateKey(d);
        const day = d.getDay();
        const isShabbat = day===6;
        let val = 0;
        if(activeUser && state[k]) val = state[k][activeUser.name] || 0;
        
        return `<div class="day state-${val} ${isShabbat?'shabbat':''}" onclick="toggleDay('${k}', ${isShabbat})">
          <div>${hebDaysShort[day]} ${fmtDM(d)}</div>
        </div>`;
      }).join("");
    }

    window.toggleDay = (k, isShabbat) => {
      if(isShabbat || !activeUser) return;
      const locked = currentGroupData.lockedUntil && new Date() < parseLocalDate(currentGroupData.lockedUntil);
      if(locked && activeUser.role !== 'admin') return toast("×”×œ×•×— × ×¢×•×œ","warn");
      
      if(!state[k]) state[k]={};
      state[k][activeUser.name] = ((state[k][activeUser.name]||0)+1)%3;
      renderCalendar();
    };

    // 7. COMPUTE ALGORITHM
    function runCompute() {
      if(!currentGroupData) return;
      const startDate = parseLocalDate(currentGroupData.startDate);
      const weeks = Number(currentGroupData.horizonWeeks);
      const endDate = addDays(startDate, weeks*7 - 1);
      const allDays = rangeDays(startDate, endDate);

      const counters = { total:{}, week:[], friday:{} };
      peopleInGroup.forEach(p => { counters.total[p]=0; counters.friday[p]=0; });
      for(let i=0; i<weeks; i++) { 
        counters.week[i]={}; peopleInGroup.forEach(p=>counters.week[i][p]=0); 
      }

      const assignment = {};
      const getPref = (k,p) => (state[k] && state[k][p]!==undefined) ? state[k][p] : 0;

      allDays.forEach(d => {
        const day = d.getDay();
        if(day===6) return;
        const k = fmtDateKey(d);
        const wIdx = Math.floor((d - startDate)/(7*MS_DAY));
        if(wIdx >= weeks) return;

        let candidates = peopleInGroup.filter(p => getPref(k,p) !== 2);
        const avail = candidates.filter(p => getPref(k,p) === 0);
        if(avail.length) candidates = avail;

        if(candidates.length) {
          candidates.sort((a,b) => {
            if(day===5) { // Friday fairness
               if(counters.friday[a] !== counters.friday[b]) return counters.friday[a]-counters.friday[b];
            }
            if(counters.week[wIdx][a] !== counters.week[wIdx][b]) return counters.week[wIdx][a]-counters.week[wIdx][b];
            return counters.total[a]-counters.total[b];
          });
          const win = candidates[0];
          assignment[k] = win;
          counters.total[win]++;
          counters.week[wIdx][win]++;
          if(day===5) counters.friday[win]++;
        } else {
          assignment[k] = null;
        }
      });
      lastComputedPack = { assignment, counters, weeks, startDate };
      renderSchedule();
      renderSummary();
    }

    function renderSchedule() {
      if(!lastComputedPack) return;
      const { assignment, weeks, startDate } = lastComputedPack;
      let html = `<div class="col-hd"></div>` + [0,1,2,3,4,5].map(i=>`<div class="col-hd">${hebDaysShort[i]}</div>`).join("");
      
      for(let w=0; w<weeks; w++) {
        const sun = addDays(startDate, w*7);
        html += `<div class="row-label">${fmtDM(sun)}-${fmtDM(addDays(sun,6))}</div>`;
        for(let d=0; d<6; d++) {
          const curr = addDays(sun, d);
          const k = fmtDateKey(curr);
          const win = assignment[k];
          const prefs = state[k]||{};
          const warn = peopleInGroup.filter(p=>prefs[p]===1).length;
          const bad = peopleInGroup.filter(p=>prefs[p]===2).length;

          html += `<div class="slot ${d===5?'fri':''}">
            <div class="datebox"><span class="d-top">${hebDaysShort[d]}</span><span>${d===5?'08:00':'16:00'}</span></div>
            <div style="flex:1;display:flex;flex-direction:column;justify-content:center;gap:2px">
              ${win ? `<div class="pill ok"><b>${win}</b></div>` : `<div class="pill bad">×¨×™×§</div>`}
              <div style="display:flex;gap:2px">
                ${warn?`<span class="pill warn" style="font-size:10px">${warn}âš ï¸</span>`:''}
                ${bad?`<span class="pill bad" style="font-size:10px">${bad}â›”</span>`:''}
              </div>
            </div>
          </div>`;
        }
      }
      document.getElementById("scheduleGrid").innerHTML = html;
    }

    function renderSummary() {
      if(!lastComputedPack) return;
      const { counters, weeks } = lastComputedPack;
      let html = `<table style="width:100%;font-size:13px;text-align:center"><thead><tr><th>×©×</th>`;
      for(let i=0; i<weeks; i++) html+=`<th>×©×‘×³ ${i+1}</th>`;
      html += `<th>×©×™×©×™</th><th>×¡×”×´×›</th></tr></thead><tbody>`;
      
      peopleInGroup.forEach(p => {
        html += `<tr><td style="text-align:right">${p}</td>`;
        for(let i=0; i<weeks; i++) html+=`<td>${counters.week[i][p]}</td>`;
        html += `<td>${counters.friday[p]}</td><td style="font-weight:bold">${counters.total[p]}</td></tr>`;
      });
      document.getElementById("summaryBox").innerHTML = html + "</tbody></table>";
    }

    // 8. EVENTS
    document.getElementById("identityStartBtn").onclick = () => {
      const uid = document.getElementById("identitySelect").value;
      const u = allUsersCache.find(x => x.id === uid);
      if(u) doLogin(u);
    };
    document.getElementById("switchUserBtn").onclick = () => { localStorage.removeItem("sched_uid"); location.reload(); };
    document.getElementById("saveBtn").onclick = async () => {
      if(!activeUser) return;
      const startDate = parseLocalDate(currentGroupData.startDate);
      const monthKey = `${startDate.getFullYear()}-${String(startDate.getMonth()+1).padStart(2,'0')}`;
      const batch = writeBatch(db);
      let c=0;
      for(const [k,v] of Object.entries(state)) {
        if(v[activeUser.name]!==undefined) {
          batch.set(doc(db,"groups",currentGroupId,"constraints",monthKey,"days",k), 
             {[activeUser.name]:v[activeUser.name]}, {merge:true});
          c++;
        }
      }
      if(c>0) { await batch.commit(); toast("× ×©××¨ ×‘×”×¦×œ×—×”"); } 
      else toast("××™×Ÿ ×©×™× ×•×™×™×");
    };
    document.getElementById("resetMineBtn").onclick = async () => {
       if(!activeUser || !confirm("×œ× ×§×•×ª ××ª ×›×œ ×”××™×œ×•×¦×™× ×©×œ×š ××”××¡×š?")) return;
       renderCalendar();
    };
    document.getElementById("computeBtn").onclick = () => { runCompute(); toast("×—×•×©×‘..."); };
    document.getElementById("exportBtn").onclick = () => {
      if(!lastComputedPack) return toast("××™×Ÿ × ×ª×•× ×™×","warn");
      const { assignment } = lastComputedPack;
      let csv = "Date,Day,Shift,Person\n";
      for(const [k,v] of Object.entries(assignment)) {
        if(!v) continue;
        const d = parseLocalDate(k);
        csv += `${k},${hebDaysShort[d.getDay()]},Shift,${v}\n`;
      }
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob); a.download = "schedule.csv"; a.click();
    };
    document.getElementById("themeBtn").onclick = () => {
      const n = document.documentElement.getAttribute("data-theme")==='dark'?'light':'dark';
      document.documentElement.setAttribute("data-theme", n);
    };

    // Admin
    document.getElementById("adminBtn").onclick = () => document.getElementById("adminBackdrop").style.display="flex";
    document.getElementById("adminCloseBtn").onclick = () => document.getElementById("adminBackdrop").style.display="none";
    document.getElementById("adminSaveBtn").onclick = async () => {
      await setDoc(doc(db,"groups",currentGroupId), {
        startDate: document.getElementById("adminStartDate").value,
        horizonWeeks: Number(document.getElementById("adminHorizon").value),
        lockedUntil: document.getElementById("adminLockUntil").value
      }, {merge:true});
      document.getElementById("adminBackdrop").style.display="none";
      switchGroup(currentGroupId);
    };

    // 9. INIT
    onAuthStateChanged(auth, (user) => {
      if(user) initApp();
      else signInAnonymously(auth).catch(e => {
        console.error("Auth Error", e);
        initApp(); // Run offline anyway
      });
    });

  </script>
</body>
</html>
