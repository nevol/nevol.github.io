<!DOCTYPE html>
<html lang="he" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>××¢×¨×›×ª ×©×™×‘×•×¦×™× - ×¡×“× ×”</title>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9aa6b2;
      --border:#273244; --accent:#38bdf8; --accent2:#22d3ee;
      --chip-bg:#0b1222; --pill-bg:#122; --btn-ink:#06121c;
      --ok-bg:#032015; --ok-br:#0c3; --ok-ink:#b7f7cf;
      --warn-bg:#231e07; --warn-br:#54450a; --warn-ink:#fde68a;
      --bad-bg:#2b0a0a; --bad-br:#521; --bad-ink:#fecaca;
      --fri-bg:#0a1d2b; --fri-br:#224055; --fri-pill:#0e2a3f;
      --badge-bg:transparent;
      --title-g1: var(--accent); --title-g2: var(--accent2);
      --toast-bg: rgba(15,23,42,.9); --toast-br:#2b3a55; --toast-ink:#e5e7eb;
      --toast-ok:#16a34a; --toast-warn:#eab308; --toast-bad:#ef4444;
    }
    html[data-theme="light"]{
      --bg:#f6f8fb; --card:#ffffff; --ink:#0b1222; --muted:#5b6472;
      --border:#dce3ea; --accent:#0ea5e9; --accent2:#06b6d4;
      --chip-bg:#f4f7fb; --pill-bg:#f6fafc; --btn-ink:#001018;
      --ok-bg:#e8f8ed; --ok-br:#16a34a; --ok-ink:#065f2a;
      --warn-bg:#fff6db; --warn-br:#eab308; --warn-ink:#6b4f00;
      --bad-bg:#ffe7e7; --bad-br:#ef4444; --bad-ink:#7f1d1d;
      --fri-bg:#ecf6ff; --fri-br:#cfe9ff; --fri-pill:#f5faff;
      --badge-bg:#eef3f8;
      --title-g1:#0ea5e9; --title-g2:#06b6d4;
      --toast-bg:#ffffff; --toast-br:#dce3ea; --toast-ink:#0b1222;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; overflow-x:hidden;
      font-family:"Assistant",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif;
      background:
        radial-gradient(1200px 800px at 80% -10%, #0b1222 0%, var(--bg) 40%),
        linear-gradient(180deg, #0b1222 0%, var(--bg) 100%);
      color:var(--ink); font-size:16px;
    }
    
    .app{max-width:1600px;margin:0 auto;padding:16px}
    header.header{display:flex;justify-content:space-between;align-items:flex-start;gap:16px;flex-wrap:wrap; margin-bottom: 20px;}
    .title{margin:0;font-weight:800;letter-spacing:.2px;font-size:clamp(22px,2.8vw,34px);
      background:linear-gradient(90deg,var(--title-g1),var(--title-g2));
      -webkit-background-clip:text;background-clip:text;color:transparent}
    .sub{color:var(--muted);font-size:14px;margin-top:6px;display:block}
    .header-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap;max-width:100%}
    .badge{border:1px solid var(--border);border-radius:999px;padding:6px 12px;font-size:13px;color:var(--muted);background:var(--badge-bg)}
    .id-badge{border:1px solid var(--border);padding:6px 12px;border-radius:999px;font-size:13px; cursor: pointer; transition: 0.2s;}
    .id-badge:hover{background: var(--chip-bg);}

    /* Group Tabs */
    .group-tabs {
        display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap;
    }
    .tab-btn {
        background: var(--chip-bg); border: 1px solid var(--border); color: var(--muted);
        padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s;
    }
    .tab-btn:hover { background: var(--border); color: var(--ink); }
    .tab-btn.active {
        background: var(--accent); color: var(--btn-ink); border-color: var(--accent);
        box-shadow: 0 4px 12px rgba(56, 189, 248, 0.25);
    }

    .two{
      display:grid;
      grid-template-columns:minmax(0,1fr) minmax(0,2fr);
      grid-template-areas:"constraints schedule";
      gap:18px; align-items:start;
    }
    .constraints{grid-area:constraints}
    .schedule-panel{grid-area:schedule}

    @media (max-width: 1100px){
      .two{grid-template-columns:1fr;grid-template-areas:"schedule" "constraints";}
      .constraints{position:static}
      .constraints .bd{max-height:none;overflow:visible}
    }

    body.view-only .two{grid-template-columns:1fr;grid-template-areas:"schedule"}

    .panel{background:linear-gradient(180deg,var(--card),color-mix(in oklab,var(--card) 80%,var(--bg)));
      border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08);overflow:hidden}
    html[data-theme="dark"] .panel{box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .hd{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
    .panel .bd{padding:16px}
    .panel h3{margin:0;font-size:20px}

    button{cursor:pointer;border:none;border-radius:12px;padding:10px 14px;font-weight:700;color:var(--btn-ink);background:linear-gradient(90deg,var(--accent),var(--accent2))}
    button.ghost{background:transparent;color:var(--ink);border:1px solid var(--border)}
    button.secondary{background:var(--chip-bg);color:var(--ink);border:1px solid var(--border);height:48px}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .vsep{width:1px;height:34px;background:var(--border);border-radius:1px;margin-inline:8px}

    .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:48px;height:48px;border-radius:12px;background:var(--chip-bg);border:1px solid var(--border);color:var(--ink)}
    .icon-btn svg{width:26px;height:26px}

    .legend{display:flex;align-items:center;gap:10px;color:var(--muted);font-size:13px}
    .dot{display:inline-block;width:14px;height:14px;border-radius:4px;border:1px solid var(--border)}
    .dot-0{background:var(--chip-bg)}
    .dot-1{background:#231e07;border-color:#54450a}
    .dot-2{background:#2b0a0a;border-color:#512}
    html[data-theme="light"] .dot-1{background:#fff6db;border-color:var(--warn-br)}
    html[data-theme="light"] .dot-2{background:#ffe7e7;border-color:var(--bad-br)}

    .people{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .chip{background:var(--chip-bg);color:var(--ink);border:1px solid var(--border);border-radius:999px;padding:8px 12px; opacity: 0.6; pointer-events: none;}
    .chip.active{outline:2px solid var(--accent); opacity: 1;}
    .chip.interactable{opacity: 1; cursor: pointer; pointer-events: all;}

    .days{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .day{background:var(--chip-bg);border:1px dashed var(--border);border-radius:12px;padding:10px;text-align:center;cursor:pointer;min-height:64px;display:flex;flex-direction:column;gap:6px;justify-content:center}
    .day .d1{font-size:15px;}
    .day .d2{font-size:12px;color:var(--muted)}
    .day.shabbat{opacity:.35;cursor:not-allowed}
    .day.fri.state-0{background:var(--fri-bg);border-color:var(--fri-br)}
    .day.state-1{background:var(--warn-bg);border:1px solid var(--warn-br)}
    .day.state-2{background:var(--bad-bg);border:1px solid var(--bad-br)}
    .hint{color:var(--muted);font-size:12px;margin-top:8px}

    .schedule{display:grid;grid-template-columns:minmax(90px,9ch) repeat(6,minmax(0,1fr));gap:10px;align-items:stretch}
    @media (max-width:1500px){.schedule{grid-template-columns:minmax(90px,9ch) repeat(3,minmax(0,1fr))}}
    @media (max-width:700px){.schedule{grid-template-columns:1fr}.schedule .col-hd{display:none}}
    .col-hd{font-size:13px;color:var(--muted);text-align:center;white-space:nowrap}

    .slot{background:var(--chip-bg);border:1px solid var(--border);border-radius:12px;min-height:88px;padding:10px;display:flex;flex-direction:column;gap:8px;min-width:0}
    .slot.fri{background:var(--fri-bg);border-color:var(--fri-br)}
    .slot .datebox{border:1px solid var(--border);border-radius:10px;padding:8px 10px;background:color-mix(in oklab,var(--chip-bg) 90%, transparent)}
    .slot .datebox .d-top{font-size:16px;font-weight:700}
    .slot .datebox .d-time{font-size:12px;color:var(--muted);margin-top:2px}
    .pill{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:var(--pill-bg);white-space:nowrap}
    .pill.ok{background:var(--ok-bg);border-color:var(--ok-br);color:var(--ok-ink)}
    .pill.bad{background:var(--bad-bg);border-color:var(--bad-br);color:var(--bad-ink)}
    .pill.warn{background:var(--warn-bg);border-color:var(--warn-br);color:var(--warn-ink)}

    .constraints{align-self:start; position:sticky; top:20px}
    .constraints .bd{max-height:calc(100vh - 132px); overflow:auto}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
    html[data-theme="light"] .modal-backdrop{background:rgba(0,0,0,.25)}
    .modal{width:min(560px,92vw);background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 24px 60px rgba(0,0,0,.35);padding:18px}
    .modal h2{margin:0 0 6px 0}.modal p{margin:0 0 12px 0;color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:12px}
    .select,.date{background:var(--chip-bg);color:var(--ink);border:1px solid var(--border);padding:10px 12px;border-radius:10px;min-width:auto;font-weight:600;width:100%}
    .checkbox{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;cursor:pointer;background:var(--chip-bg);border:1px solid var(--border);border-radius:10px}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    .admin-bar{position:fixed;left:12px;top:12px;z-index:10000;display:flex;gap:8px;flex-wrap:wrap}

    .toast-wrap{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;z-index:10050;display:flex;flex-direction:column;gap:8px;pointer-events:none}
    .toast{pointer-events:auto;min-width:260px;max-width:min(92vw,520px);border-radius:14px;border:1px solid var(--toast-br);background:var(--toast-bg);color:var(--toast-ink);padding:12px 14px;box-shadow:0 18px 40px rgba(0,0,0,.35);display:flex;align-items:flex-start;gap:10px}
    .toast .icon{margin-top:2px}
    .toast.ok{border-color:color-mix(in oklab,var(--toast-br) 60%,var(--toast-ok))}
    .toast.warn{border-color:color-mix(in oklab,var(--toast-br) 60%,var(--toast-warn))}
    .toast.bad{border-color:color-mix(in oklab,var(--toast-br) 60%,var(--toast-bad))}
    .toast .t-title{font-weight:700;margin-bottom:2px}
    .toast .t-actions{margin-inline-start:auto;display:flex;gap:6px}
    .toast .btn{background:transparent;border:1px solid var(--border);color:var(--ink);border-radius:999px;padding:6px 10px;cursor:pointer}
    
    .loading-overlay {
        position: absolute; inset: 0; background: var(--bg); opacity: 0.8; 
        display: flex; align-items: center; justify-content: center; z-index: 50;
    }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <!-- admin -->
  <div class="admin-bar">
    <button id="adminBtn" class="icon-btn hidden" title="××¦×‘ × ×™×”×•×œ">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"/>
        <path d="M19.4 15a1.8 1.8 0 0 0 .36 1.98l.05.05a2 2 0 1 1-2.83 2.83l-.05-.05A1.8 1.8 0 0 0 15 19.4a1.8 1.8 0 0 0-1 .2 1.8 1.8 0 0 0-.9 1.57V21a2 2 0 1 1-4 0v-.03A1.8 1.8 0 0 0 8.2 19.4 1.8 1.8 0 0 0 7 19.4a1.8 1.8 0 0 0-1.98.36l-.05.05a2 2 0 1 1-2.83-2.83l.05-.05A1.8 1.8 0 0 0 4.6 15a1.8 1.8 0 0 0-.2-1 1.8 1.8 0 0 0-1.57-.9H2a2 2 0 1 1 0-4h.03A1.8 1.8 0 0 0 4.6 8.2a1.8 1.8 0 0 0 .2-1A1.8 1.8 0 0 0 4.44 5.2l-.05-.05A2 2 0 1 1 7.22 2.3l.05.05A1.8 1.8 0 0 0 9 4.6c.31.05.66.05 1 0A1.8 1.8 0 0 0 10.9 3V3a2 2 0 1 1 4 0v.03a1.8 1.8 0 0 0 .9 1.57c.34.17.69.24 1 .2a1.8 1.8 0 0 0 1.98-.36l.05-.05a2 2 0 1 1 2.83 2.83l-.05.05A1.8 1.8 0 0 0 19.4 9c.05.34 0 .69-.2 1 .17.34.24.69.2 1 .05.31.05.66 0 1Z"/>
      </svg>
    </button>
  </div>

  <div class="app">
    <header class="header">
      <div>
        <h1 class="title">××¢×¨×›×ª ×©×™×‘×•×¦×™× - ×¡×“× ×”</h1>
        <div class="group-tabs" id="groupTabs">
           <!-- Tabs will be injected here -->
        </div>
      </div>
      <div class="header-actions">
        <div id="whoami" class="id-badge" title="×œ×—×¥ ×œ×”×—×œ×¤×”">×œ× ××—×•×‘×¨</div>
        <button id="themeBtn" class="icon-btn" title="××¦×‘ ×‘×”×™×¨/×›×”×”">
          <svg id="themeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"></svg>
        </button>
      </div>
    </header>

    <main class="two">
      <!-- schedule -->
      <section class="panel schedule-panel" style="position:relative">
        <div id="loadingSchedule" class="loading-overlay hidden">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
        <div class="hd" style="display:flex;align-items:center">
          <h3 style="margin-inline-end:12px">×œ×•×— ×©×™×‘×•×¦×™×</h3>
          <span id="dateRangeBadge" class="badge" style="margin-inline-end:auto"></span>
          <span id="lockedBadge" class="badge" style="color:var(--bad-ink); border-color:var(--bad-br); display:none">ğŸ”’ × ×¢×•×œ ×œ×¢×¨×™×›×”</span>

          <button id="exportBtn" class="ghost">×™×¦×•× CSV</button>
        </div>
        <div class="bd">
          <div id="scheduleGrid" class="schedule"></div>
          <div id="summaryBox" style="margin-top:12px"></div>
        </div>
      </section>

      <!-- constraints -->
      <section class="panel constraints">
        <div class="hd">
          <h3>××™×œ×•×¦×™× ×œ×—×•×“×© ×§×“×™××”</h3>
          <div class="legend">
            <span class="dot dot-0"></span> ×–××™×Ÿ
            <span class="dot dot-1"></span> ××¢×“×™×£ ×©×œ×
            <span class="dot dot-2"></span> ×œ× ×–××™×Ÿ
          </div>
        </div>
        <div class="bd">
          <div id="peopleChips" class="people">
            <!-- Dynamic Chips -->
          </div>
          <div id="daysGrid" class="days"></div>
          <p class="hint">×˜×¤×™×—×” ×¢×œ ×™×•× ××—×œ×™×¤×” ××¦×‘. ×”× ×ª×•× ×™× × ×©××¨×™× ×‘×¢× ×Ÿ.</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="saveBtn">×©××•×¨ ×©×™× ×•×™×™×</button>
            <button id="resetMineBtn" class="ghost">××¤×¡ ××ª ×”××™×œ×•×¦×™× ×©×œ×™</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Toasts -->
  <div id="toastWrap" class="toast-wrap" aria-live="polite"></div>

  <!-- Identity Modal -->
  <div id="identityBackdrop" class="modal-backdrop">
    <div class="modal">
      <h2>×”×–×“×”×•×ª</h2>
      <p>×‘×—×¨ ××ª ×”×©× ×©×œ×š ×›×“×™ ×œ×”×ª×—×‘×¨ ×œ××¢×¨×›×ª.</p>
      <div class="row">
        <label for="identitySelect">×©× ××©×ª××©</label>
        <select id="identitySelect" class="select">
          <option value="">×˜×•×¢×Ÿ ×¨×©×™××”...</option>
        </select>
      </div>
      <div class="actions"><button id="identityStartBtn" type="button">×”×ª×—×‘×¨</button></div>
    </div>
  </div>

  <!-- Admin Modal -->
  <div id="adminBackdrop" class="modal-backdrop">
    <div class="modal">
      <h2>×”×’×“×¨×•×ª ×× ×”×œ (<span id="adminGroupName"></span>)</h2>
      <p>×©×™× ×•×™ ×”×’×“×¨×•×ª ×œ×§×‘×•×¦×” ×”× ×•×›×—×™×ª.</p>
      <div class="row">
        <label for="dateInput">×ª××¨×™×š ×”×ª×—×œ×”</label>
        <input id="dateInput" class="date" type="date" />
      </div>
      <div class="row">
        <label for="lockInput">× ×¢×•×œ ×œ×¢×¨×™×›×” ×¢×“ (×ª××¨×™×š)</label>
        <input id="lockInput" class="date" type="date" />
      </div>
      <div class="row">
        <button id="adminResetBtn" class="ghost" style="border-color:#f00;color:#fca5a5; width:100%" type="button">××™×¤×•×¡ ×˜×‘×œ×” (×œ×˜×•×•×— ×”×¤×¢×™×œ)</button>
      </div>
      <div class="actions">
        <button id="adminCancelBtn" class="ghost" type="button">×¡×’×•×¨</button>
        <button id="adminSaveBtn" type="button">×©××•×¨</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, getDocs, deleteDoc, collection, query, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // --- CONFIG ---
    // Using the config from "multiuser-index.html" as requested
    const firebaseConfig = {
      apiKey: "AIzaSyBiZIHRpbg0bq4VFZ2kDDXj6QeRJZpjOpg",
      authDomain: "sadna-timetable.firebaseapp.com",
      projectId: "sadna-timetable",
      storageBucket: "sadna-timetable.firebasestorage.app",
      messagingSenderId: "605203492621",
      appId: "1:605203492621:web:7ed83f0e5e64d67b9c8a44",
      measurementId: "G-8941L7ZZJ6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // --- DATA ---
    const GROUPS = ["××“×¤×¡×•×ª", "×ª×¤×™×¨×”", "××ª×›×ª", "×¢×™×‘×•×“ ×©×‘×‘×™×", "×¢×¥"];
    
    // Hardcoded User DB (In a real app, this would be in Firestore)
    const USERS_DB = [
        {id:"u1", name:"× ×‘×•", group:"××“×¤×¡×•×ª", role:"admin"},
        {id:"u2", name:"× ×˜×¢", group:"××“×¤×¡×•×ª", role:"user"},
        {id:"u3", name:"×˜×œ", group:"××“×¤×¡×•×ª", role:"user"},
        {id:"u4", name:"×›×œ×™×œ", group:"×ª×¤×™×¨×”", role:"user"},
        {id:"u5", name:"×¢××™×ª", group:"×ª×¤×™×¨×”", role:"user"},
        {id:"u6", name:"×©×™×¨×”", group:"×ª×¤×™×¨×”", role:"user"},
        {id:"u7", name:"×××™", group:"××ª×›×ª", role:"user"},
        {id:"u8", name:"×œ×™×¢×“", group:"×¢×™×‘×•×“ ×©×‘×‘×™×", role:"user"},
        {id:"u9", name:"××•×¨×™", group:"×¢×¥", role:"user"}
    ];

    const MS_DAY = 86400000;
    const hebDays=["××³","×‘×³","×’×³","×“×³","×”×³","×•×³","×©×³"];
    const hebDaysLong=["×¨××©×•×Ÿ","×©× ×™","×©×œ×™×©×™","×¨×‘×™×¢×™","×—××™×©×™","×©×™×©×™","×©×‘×ª"];
    const MIN_PER_PERSON = 2; // Default per week

    // --- STATE ---
    let currentGroup = GROUPS[0];
    let currentUser = null; // Object from USERS_DB
    let activePersonName = null; // Name string
    let groupMembers = []; // ["× ×‘×•", "×˜×œ"...] derived from USERS_DB
    let groupSettings = { startDate: null, lockedUntil: null };
    
    let state = Object.create(null); // constraints map: dateKey -> {name: 0/1/2}
    let overrides = {}; // manual overrides map
    let constraintsUnsub = null;
    let settingsUnsub = null;

    // --- DOM ---
    const daysGrid = document.getElementById("daysGrid");
    const scheduleGrid = document.getElementById("scheduleGrid");
    const summaryBox = document.getElementById("summaryBox");
    const dateRangeBadge = document.getElementById("dateRangeBadge");
    const lockedBadge = document.getElementById("lockedBadge");
    const peopleChips = document.getElementById("peopleChips");
    const groupTabs = document.getElementById("groupTabs");
    const loadingSchedule = document.getElementById("loadingSchedule");
    
    // Modals & Identity
    const identityBackdrop = document.getElementById("identityBackdrop");
    const identitySelect = document.getElementById("identitySelect");
    const identityStartBtn = document.getElementById("identityStartBtn");
    const whoamiEl = document.getElementById("whoami");
    
    // Admin
    const adminBtn = document.getElementById("adminBtn");
    const adminBackdrop = document.getElementById("adminBackdrop");
    const adminSaveBtn = document.getElementById("adminSaveBtn");
    const adminCancelBtn = document.getElementById("adminCancelBtn");
    const adminResetBtn = document.getElementById("adminResetBtn");
    const dateInput = document.getElementById("dateInput");
    const lockInput = document.getElementById("lockInput");

    // Buttons
    const saveBtn = document.getElementById("saveBtn");
    const resetMineBtn = document.getElementById("resetMineBtn");
    const exportBtn = document.getElementById("exportBtn");
    const themeBtn = document.getElementById("themeBtn");

    // --- UTILS ---
    function startOfDay(d){ const c=new Date(d); c.setHours(0,0,0,0); return c; }
    function addDays(d,n){ return new Date(startOfDay(d).getTime() + n*MS_DAY); }
    function prevSunday(d){ let x=startOfDay(d); while(x.getDay()!==0){ x=addDays(x,-1);} return x; }
    function calcFourWeekEnd(d){ const sunday = prevSunday(d); return addDays(sunday, 27); } // 4 weeks
    function fmtDateKey(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0"); return `${y}-${m}-${dd}`; }
    function fmtDM(d){ const dd=String(d.getDate()).padStart(2,"0"), mm=String(d.getMonth()+1).padStart(2,"0"); return `${dd}.${mm}`; }
    function rangeDays(d0,d1){ const out=[]; let t=startOfDay(d0).getTime(), t1=startOfDay(d1).getTime(); for(;t<=t1;t+=MS_DAY) out.push(new Date(t)); return out; }
    function shiftForWeekday(jsDow){ if(jsDow>=0 && jsDow<=4) return {label:"16:00â€“22:00"}; if(jsDow===5) return {label:"08:00â€“14:00"}; return null; }
    function weekIndexFor(date, startD){ let s = prevSunday(startD); return Math.floor((startOfDay(date) - s) / (7*MS_DAY)); }
    function monthKeyFrom(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"); return `${y}-${m}`; }

    function toast(msg, type="ok") {
      const el = document.createElement("div");
      el.className = `toast ${type}`;
      el.innerHTML = `<div class="icon">${type==='ok'?'âœ…':(type==='warn'?'âš ï¸':'âŒ')}</div><div class="t-text">${msg}</div>`;
      document.getElementById("toastWrap").appendChild(el);
      setTimeout(()=> { el.style.opacity="0"; setTimeout(()=>el.remove(),300); }, 3000);
    }

    // --- THEME ---
    const savedTheme = localStorage.getItem("scheduler_theme") || "dark";
    document.documentElement.setAttribute("data-theme", savedTheme);
    renderThemeIcon();
    themeBtn.addEventListener("click", ()=>{
      const cur = document.documentElement.getAttribute("data-theme") || "dark";
      const next = cur === "dark" ? "light" : "dark";
      document.documentElement.setAttribute("data-theme", next);
      localStorage.setItem("scheduler_theme", next);
      renderThemeIcon();
    });
    function renderThemeIcon(){
       const mode = document.documentElement.getAttribute("data-theme") || "dark";
       document.getElementById("themeIcon").innerHTML = mode === "dark"
        ? `<path d="M12 3v2M12 19v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M3 12h2M19 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/><circle cx="12" cy="12" r="4"/>`
        : `<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>`;
    }

    // --- INIT & TABS ---
    function renderTabs() {
        groupTabs.innerHTML = GROUPS.map(g => 
            `<button class="tab-btn ${g === currentGroup ? 'active' : ''}" data-group="${g}">${g}</button>`
        ).join("");
        
        groupTabs.querySelectorAll(".tab-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const g = btn.dataset.group;
                if(g !== currentGroup) switchGroup(g);
            });
        });
    }

    async function switchGroup(newGroup) {
        currentGroup = newGroup;
        renderTabs();
        
        // Only load if logged in, otherwise wait
        if(auth.currentUser) {
            await loadGroupData();
        }
    }

    // --- LOADING LOGIC ---
    async function loadGroupData() {
        loadingSchedule.classList.remove("hidden");
        
        // 1. Get Group Members
        groupMembers = USERS_DB.filter(u => u.group === currentGroup).map(u => u.name);
        
        // 2. Load Settings (Start Date, Lock)
        if(settingsUnsub) settingsUnsub();
        settingsUnsub = onSnapshot(doc(db, "groups", currentGroup), (docSnap) => {
            const data = docSnap.exists() ? docSnap.data() : {};
            
            // Defaults
            groupSettings.startDate = data.startDate ? startOfDay(new Date(data.startDate)) : startOfDay(new Date());
            groupSettings.lockedUntil = data.lockedUntil ? startOfDay(new Date(data.lockedUntil)) : null;

            // Re-subscribe constraints if month changed, or just re-render
            subscribeConstraints(); 
        });
    }

    function subscribeConstraints() {
        if(constraintsUnsub) constraintsUnsub();
        
        const start = groupSettings.startDate;
        const monthKey = monthKeyFrom(start);
        
        constraintsUnsub = onSnapshot(collection(db, "groups", currentGroup, "constraints", monthKey, "days"), (snap) => {
            state = Object.create(null);
            snap.forEach(doc => { state[doc.id] = doc.data(); });
            
            renderUI();
            loadingSchedule.classList.add("hidden");
        });
    }

    function renderUI() {
        renderDateInfo();
        renderConstraintsPanel();
        
        const pack = computeSchedule();
        renderSchedule(pack);
        renderSummary(pack);
        checkAdminAccess();
    }

    function renderDateInfo() {
        const start = groupSettings.startDate;
        const end = calcFourWeekEnd(start);
        dateRangeBadge.textContent = `${fmtDM(start)} â€“ ${fmtDM(end)}`;
        
        // Lock check
        const isLocked = groupSettings.lockedUntil && new Date() < groupSettings.lockedUntil;
        if(isLocked && (!currentUser || currentUser.role !== 'admin')) {
            lockedBadge.style.display = "inline-flex";
            saveBtn.setAttribute("disabled", "disabled");
            saveBtn.title = "×”×œ×•×— × ×¢×•×œ ×œ×¢×¨×™×›×”";
        } else {
            lockedBadge.style.display = "none";
            saveBtn.removeAttribute("disabled");
            saveBtn.title = "";
        }
    }

    function checkAdminAccess() {
        if(currentUser && currentUser.role === 'admin' && currentUser.group === currentGroup) {
            adminBtn.classList.remove("hidden");
        } else {
            adminBtn.classList.add("hidden");
        }
    }

    // --- CONSTRAINTS PANEL ---
    function renderConstraintsPanel() {
        // 1. Chips
        let chipsHtml = "";
        groupMembers.forEach(p => {
            const isMe = (p === activePersonName);
            chipsHtml += `<span class="chip ${isMe ? 'active' : ''}">${p}</span>`;
        });
        peopleChips.innerHTML = chipsHtml;

        // 2. Days Grid
        const start = groupSettings.startDate;
        const end = calcFourWeekEnd(start);
        const days = rangeDays(start, end);

        // Header (days of week)
        let html = hebDays.map(h=>`<div class="day head" aria-hidden="true" style="cursor:default;border:none;background:transparent;min-height:auto"><div class="d2">${h}</div></div>`).join("");
        
        // Days
        for(const d of days) {
            const key = fmtDateKey(d);
            const jsDow = d.getDay();
            const isShabbat = jsDow === 6;
            const isFri = jsDow === 5;
            
            // Get my status
            const myStatus = (state[key] && activePersonName) ? (state[key][activePersonName] || 0) : 0;
            
            html += `
              <div class="day ${isShabbat?'shabbat':''} ${isFri?'fri':''} state-${myStatus}" 
                   data-key="${key}" onclick="toggleDay('${key}', ${isShabbat})">
                <div class="d1">${d.getDate()}</div>
                <div class="d2">${d.getMonth()+1}</div>
              </div>
            `;
        }
        daysGrid.innerHTML = html;
    }

    window.toggleDay = (key, isShabbat) => {
        if(isShabbat) return;
        if(!activePersonName) { toast("×¢×œ×™×š ×œ×”×ª×—×‘×¨ ×›×“×™ ×œ×¢×¨×•×š", "warn"); return; }
        
        // Check Lock
        const isLocked = groupSettings.lockedUntil && new Date() < groupSettings.lockedUntil;
        if(isLocked && currentUser.role !== 'admin') { toast("×”×œ×•×— × ×¢×•×œ ×œ×¢×¨×™×›×”", "bad"); return; }

        // Validate group match
        if(currentUser.group !== currentGroup && currentUser.role !== 'admin') {
            toast(`××ª×” ×©×™×™×š ×œ×¦×•×•×ª ${currentUser.group}, ×œ× × ×™×ª×Ÿ ×œ×¢×¨×•×š ×‘${currentGroup}`, "warn");
            return;
        }

        const row = state[key] || {};
        const currentVal = row[activePersonName] || 0;
        const nextVal = (currentVal + 1) % 3;
        
        // Optimistic update
        if(!state[key]) state[key] = {};
        state[key][activePersonName] = nextVal;
        
        // Re-render just this cell visually
        const cell = document.querySelector(`.day[data-key="${key}"]`);
        if(cell) {
            cell.classList.remove("state-0", "state-1", "state-2");
            cell.classList.add(`state-${nextVal}`);
        }
    };

    // --- SCHEDULE LOGIC (The Smart Algorithm) ---
    function computeSchedule() {
        const start = groupSettings.startDate;
        const end = calcFourWeekEnd(start);
        const days = rangeDays(start, end);
        
        const assign = {};
        const totalCounts = Object.fromEntries(groupMembers.map(p=>[p,0]));
        const fridayCounts = Object.fromEntries(groupMembers.map(p=>[p,0]));
        const weekCounts = {};

        // Helper to check availability
        const getPref = (dateKey, person) => (state[dateKey]||{})[person] || 0; // 0=avail, 1=prefer-no, 2=no

        // Step 1: Basic assignment
        for(const d of days) {
            const jsDow = d.getDay();
            const sh = shiftForWeekday(jsDow);
            if(!sh) continue; // Skip Shabbat
            
            const key = fmtDateKey(d);
            const wIdx = weekIndexFor(d, start);
            if(!weekCounts[wIdx]) weekCounts[wIdx] = Object.fromEntries(groupMembers.map(p=>[p,0]));

            // Filter available people (0 or 1)
            let candidates = groupMembers.filter(p => getPref(key, p) !== 2);
            
            // Prefer those who marked 0 over 1
            const avail0 = candidates.filter(p => getPref(key, p) === 0);
            if(avail0.length > 0) candidates = avail0;

            // Sort by fairness
            candidates.sort((a,b) => {
                // If Friday, balance Fridays first
                if(jsDow === 5) {
                    if(fridayCounts[a] !== fridayCounts[b]) return fridayCounts[a] - fridayCounts[b];
                }
                // Then balance weekly
                const wCa = weekCounts[wIdx][a] || 0;
                const wCb = weekCounts[wIdx][b] || 0;
                if(wCa !== wCb) return wCa - wCb;
                
                // Then balance total
                return totalCounts[a] - totalCounts[b];
            });

            if(candidates.length > 0) {
                const pick = candidates[0];
                assign[key] = pick;
                totalCounts[pick]++;
                weekCounts[wIdx][pick]++;
                if(jsDow === 5) fridayCounts[pick]++;
            } else {
                assign[key] = null; // Unassigned
            }
        }

        // (Algorithm could be expanded here with swap logic from original, simplified for brevity)
        return { assign, weekCounts, fridayCounts };
    }

    function renderSchedule(pack) {
        const { assign } = pack;
        const start = groupSettings.startDate;
        const end = calcFourWeekEnd(start);
        
        let html = `
          <div></div>
          <div class="col-hd">××³</div>
          <div class="col-hd">×‘×³</div>
          <div class="col-hd">×’×³</div>
          <div class="col-hd">×“×³</div>
          <div class="col-hd">×”×³</div>
          <div class="col-hd">×•×³</div>
        `;

        let weekStart = prevSunday(start);
        let guard = 0;
        
        while(weekStart <= end && guard++ < 10) {
            const weekEnd = addDays(weekStart, 6);
            html += `<div class="muted" style="display:flex;align-items:center;white-space:nowrap;font-size:12px">
                ${fmtDM(weekStart)} â€“ ${fmtDM(weekEnd)}
            </div>`;

            for(let i=0; i<6; i++) {
                const cur = addDays(weekStart, i);
                const key = fmtDateKey(cur);
                const inRange = cur >= start && cur <= end;
                const sh = shiftForWeekday(cur.getDay());
                
                if(!inRange || !sh) {
                     html += `<div class="slot" style="opacity:0.3;border:none"></div>`;
                } else {
                    const who = assign[key];
                    const row = state[key] || {};
                    const isFri = cur.getDay() === 5;
                    
                    // Warnings
                    const preferNo = groupMembers.filter(p => row[p]===1);
                    const absent = groupMembers.filter(p => row[p]===2);

                    html += `
                      <div class="slot ${isFri?'fri':''}">
                        <div class="datebox">
                           <div class="d-top">${hebDaysLong[cur.getDay()]} ${cur.getDate()}</div>
                           <div class="d-time">${sh.label}</div>
                        </div>
                        <div class="${who ? 'pill ok' : 'pill bad'}" style="justify-content:center;font-size:14px">
                            ${who || '××™×Ÿ ×©×™×‘×•×¥'}
                        </div>
                        ${preferNo.length ? `<div class="pill warn" style="font-size:10px">××¢×“×™×£ ×©×œ×: ${preferNo.join(', ')}</div>` : ''}
                        ${absent.length ? `<div class="pill bad" style="font-size:10px">×œ×: ${absent.join(', ')}</div>` : ''}
                      </div>
                    `;
                }
            }
            weekStart = addDays(weekStart, 7);
        }
        scheduleGrid.innerHTML = html;
    }

    function renderSummary(pack) {
        const { weekCounts, fridayCounts } = pack;
        let html = `<table style="width:100%;border-collapse:collapse;font-size:14px"><thead><tr>
           <th style="text-align:right;padding:6px;border-bottom:1px solid var(--border)">×©×‘×•×¢</th>`;
        
        groupMembers.forEach(p => html += `<th style="text-align:center;padding:6px;border-bottom:1px solid var(--border)">${p}</th>`);
        html += `</tr></thead><tbody>`;

        Object.keys(weekCounts).sort().forEach((wIdx, i) => {
             html += `<tr><td style="padding:6px;border-bottom:1px solid var(--border)">×©×‘×•×¢ ${i+1}</td>`;
             groupMembers.forEach(p => {
                 html += `<td style="text-align:center;padding:6px;border-bottom:1px solid var(--border)">${weekCounts[wIdx][p]||0}</td>`;
             });
             html += `</tr>`;
        });
        
        // Fridays row
        html += `<tr style="font-weight:bold;background:var(--chip-bg)"><td style="padding:6px">×¡×”×´×› ×©×™×©×™</td>`;
        groupMembers.forEach(p => {
            html += `<td style="text-align:center;padding:6px">${fridayCounts[p]||0}</td>`;
        });
        html += `</tr></tbody></table>`;

        summaryBox.innerHTML = html;
    }

    // --- ACTIONS ---
    saveBtn.addEventListener("click", async () => {
        if(!activePersonName) return;
        const start = groupSettings.startDate;
        const monthKey = monthKeyFrom(start);
        
        const batch = writeBatch(db);
        let count = 0;

        for(const [dateKey, rowData] of Object.entries(state)) {
            // Only save active user's data to prevent overwriting others in race conditions
            if(rowData[activePersonName] !== undefined) {
                const docRef = doc(db, "groups", currentGroup, "constraints", monthKey, "days", dateKey);
                batch.set(docRef, { [activePersonName]: rowData[activePersonName] }, { merge: true });
                count++;
            }
        }

        if(count > 0) {
            try {
                await batch.commit();
                toast("×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×”", "ok");
            } catch(e) {
                console.error(e);
                toast("×©×’×™××” ×‘×©××™×¨×”", "bad");
            }
        } else {
            toast("××™×Ÿ ×©×™× ×•×™×™× ×œ×©××™×¨×”", "warn");
        }
    });

    resetMineBtn.addEventListener("click", () => {
        if(confirm("×–×” ×™× ×§×” ××ª ×›×œ ×”×¡×™××•× ×™× ×©×œ×š ××”×ª×¦×•×’×” (×™×© ×œ×©××•×¨ ×›×“×™ ×œ×¢×“×›×Ÿ ×‘×¢× ×Ÿ). ×œ×”××©×™×š?")) {
            for(const k in state) {
                if(state[k][activePersonName]) delete state[k][activePersonName];
            }
            renderConstraintsPanel();
            renderSchedule(computeSchedule()); // Re-calc locally
        }
    });

    exportBtn.addEventListener("click", () => {
        const pack = computeSchedule();
        const rows = [["×ª××¨×™×š", "×™×•×", "×©×¢×”", "××©×•×‘×¥"]];
        const days = rangeDays(groupSettings.startDate, calcFourWeekEnd(groupSettings.startDate));
        
        for(const d of days) {
            const sh = shiftForWeekday(d.getDay());
            if(!sh) continue;
            const key = fmtDateKey(d);
            rows.push([fmtDM(d), hebDaysLong[d.getDay()], sh.label, pack.assign[key] || ""]);
        }
        
        const csvContent = "\uFEFF" + rows.map(e => e.join(",")).join("\n");
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `schedule_${currentGroup}.csv`;
        link.click();
    });

    // --- IDENTITY & AUTH ---
    function showIdentityModal() {
        // Populate select based on hardcoded DB
        const sorted = [...USERS_DB].sort((a,b) => a.group.localeCompare(b.group));
        identitySelect.innerHTML = `<option value="">×‘×—×¨ ××©×ª××©...</option>` + 
            sorted.map(u => `<option value="${u.id}">${u.name} (${u.group})</option>`).join("");
            
        identityBackdrop.style.display = "flex";
    }

    identityStartBtn.addEventListener("click", async () => {
        const uid = identitySelect.value;
        if(!uid) return;
        
        const user = USERS_DB.find(u => u.id === uid);
        if(user) {
            localStorage.setItem("scheduler_uid", uid);
            await loginUser(user);
            identityBackdrop.style.display = "none";
        }
    });

    async function loginUser(user) {
        currentUser = user;
        activePersonName = user.name;
        whoamiEl.textContent = `${user.name} (${user.group})`;
        
        // Auto-switch group if different
        if(user.group !== currentGroup) {
            switchGroup(user.group);
        } else {
            // Reload to check admin perms
            checkAdminAccess();
            renderConstraintsPanel(); // Update "Me" chip
        }

        if(!auth.currentUser) {
            await signInAnonymously(auth);
        }
    }

    whoamiEl.addEventListener("click", () => {
        if(confirm("×œ×”×ª× ×ª×§ ×•×œ×”×—×œ×™×£ ××©×ª××©?")) {
            localStorage.removeItem("scheduler_uid");
            location.reload();
        }
    });

    // --- ADMIN PANEL ---
    adminBtn.addEventListener("click", () => {
        document.getElementById("adminGroupName").textContent = currentGroup;
        if(groupSettings.startDate) dateInput.value = fmtDateKey(groupSettings.startDate);
        if(groupSettings.lockedUntil) lockInput.value = fmtDateKey(groupSettings.lockedUntil);
        adminBackdrop.style.display = "flex";
    });
    
    adminCancelBtn.addEventListener("click", () => adminBackdrop.style.display = "none");
    
    adminSaveBtn.addEventListener("click", async () => {
        const newStart = dateInput.value;
        const newLock = lockInput.value;
        
        if(!newStart) { toast("×—×•×‘×” ×œ×‘×—×•×¨ ×ª××¨×™×š ×”×ª×—×œ×”", "warn"); return; }
        
        await setDoc(doc(db, "groups", currentGroup), {
            startDate: newStart,
            lockedUntil: newLock || ""
        }, { merge: true });
        
        toast("×”×’×“×¨×•×ª × ×©××¨×•", "ok");
        adminBackdrop.style.display = "none";
        // Reload will happen via snapshot listener
    });

    adminResetBtn.addEventListener("click", async () => {
        if(confirm(`×¤×¢×•×œ×” ×–×• ×ª××—×§ ××ª ×›×œ ×”××™×œ×•×¦×™× ×©×œ ${currentGroup} ×œ×—×•×“×© ×”× ×•×›×—×™. ×‘×˜×•×—?`)) {
             const start = groupSettings.startDate;
             const monthKey = monthKeyFrom(start);
             const q = query(collection(db, "groups", currentGroup, "constraints", monthKey, "days"));
             const snap = await getDocs(q);
             
             const batch = writeBatch(db);
             snap.forEach(d => batch.delete(d.ref));
             await batch.commit();
             
             toast("×”×˜×‘×œ×” ××•×¤×¡×”", "ok");
             adminBackdrop.style.display = "none";
        }
    });


    // --- BOOTSTRAP ---
    (async function init() {
        renderTabs();
        
        // Check local storage for identity
        const savedUid = localStorage.getItem("scheduler_uid");
        if(savedUid) {
            const u = USERS_DB.find(x => x.id === savedUid);
            if(u) {
                await loginUser(u);
            } else {
                showIdentityModal();
            }
        } else {
            showIdentityModal();
        }
        
        // Initial load (if not logged in, load default group anonymously)
        if(!currentUser) {
            await signInAnonymously(auth);
            switchGroup(GROUPS[0]);
        }
    })();

  </script>
</body>
</html>
