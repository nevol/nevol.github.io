<!DOCTYPE html>
<html lang="he" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>×œ×•×— ×©×™×‘×•×¦×™× ×œ×¡×“× ×”</title>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9aa6b2;
      --border:#273244; --accent:#38bdf8; --accent2:#22d3ee;
      --chip-bg:#0b1222; --pill-bg:#122; --btn-ink:#06121c;
      --ok-bg:#032015; --ok-br:#0c3; --ok-ink:#b7f7cf;
      --warn-bg:#231e07; --warn-br:#54450a; --warn-ink:#fde68a;
      --bad-bg:#2b0a0a; --bad-br:#521; --bad-ink:#fecaca;
      --fri-bg:#0a1d2b; --fri-br:#224055; --fri-pill:#0e2a3f;
      --badge-bg:transparent;
      --title-g1: var(--accent); --title-g2: var(--accent2);
      --toast-bg: rgba(15,23,42,.9); --toast-br:#2b3a55; --toast-ink:#e5e7eb;
      --tabs-bg: rgba(6, 12, 21, .75);
    }
    html[data-theme="light"]{
      --bg:#f6f8fb; --card:#ffffff; --ink:#0b1222; --muted:#5b6472;
      --border:#dce3ea; --accent:#0ea5e9; --accent2:#06b6d4;
      --chip-bg:#f4f7fb; --pill-bg:#f6fafc; --btn-ink:#001018;
      --ok-bg:#e8f8ed; --ok-br:#16a34a; --ok-ink:#065f2a;
      --warn-bg:#fff6db; --warn-br:#eab308; --warn-ink:#6b4f00;
      --bad-bg:#ffe7e7; --bad-br:#ef4444; --bad-ink:#7f1d1d;
      --fri-bg:#ecf6ff; --fri-br:#cfe9ff; --fri-pill:#f5faff;
      --badge-bg:#eef3f8;
      --title-g1:#0ea5e9; --title-g2:#06b6d4;
      --toast-bg:#ffffff; --toast-br:#dce3ea; --toast-ink:#0b1222;
      --tabs-bg:#ffffff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; overflow-x:hidden;
      font-family:"Assistant",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif;
      background:
        radial-gradient(1200px 800px at 80% -10%, #0b1222 0%, var(--bg) 40%),
        linear-gradient(180deg, #0b1222 0%, var(--bg) 100%);
      color:var(--ink); font-size:16px;
      padding-bottom:52px;
    }
    html[data-theme="light"] body{
      background:
        radial-gradient(1200px 800px at 80% -10%, #ffffff 0%, var(--bg) 40%),
        linear-gradient(180deg, #ffffff 0%, var(--bg) 100%);
    }

    .app{max-width:1600px;margin:0 auto;padding:16px}
    header.header{display:flex;justify-content:space-between;align-items:flex-start;gap:16px;flex-wrap:wrap}
    .title{margin:0;font-weight:800;letter-spacing:.2px;font-size:clamp(22px,2.8vw,34px);
      background:linear-gradient(90deg,var(--title-g1),var(--title-g2));
      -webkit-background-clip:text;background-clip:text;color:transparent}
    .sub{color:var(--muted);font-size:14px;margin-top:6px;margin-bottom:16px;display:block}
    .header-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap;max-width:100%}
    .badge{border:1px solid var(--border);border-radius:999px;padding:6px 12px;font-size:13px;color:var(--muted);background:var(--badge-bg)}
    .id-badge{border:1px solid var(--border);padding:6px 12px;border-radius:999px;font-size:13px;white-space:nowrap}

    .two{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,2fr);grid-template-areas:"constraints schedule";gap:18px;align-items:start;}
    .constraints{grid-area:constraints}
    .schedule-panel{grid-area:schedule}
    @media (max-width: 1100px){
      .two{grid-template-columns:1fr;grid-template-areas:"schedule" "constraints";}
      .constraints{position:static}
      .constraints .bd{max-height:none;overflow:visible}
    }
    body.view-only .two{grid-template-columns:1fr;grid-template-areas:"schedule"}

    .panel{background:linear-gradient(180deg,var(--card),color-mix(in oklab,var(--card) 80%,var(--bg)));border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08);overflow:hidden}
    html[data-theme="dark"] .panel{box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .hd{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
    .panel .bd{padding:16px}
    .panel h3{margin:0;font-size:20px}

    button{cursor:pointer;border:none;border-radius:12px;padding:10px 14px;font-weight:700;color:var(--btn-ink);background:linear-gradient(90deg,var(--accent),var(--accent2))}
    button.ghost{background:transparent;color:var(--ink);border:1px solid var(--border)}
    button.secondary{background:var(--chip-bg);color:var(--ink);border:1px solid var(--border);height:48px}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .vsep{width:1px;height:34px;background:var(--border);border-radius:1px;margin-inline:8px}

    .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:48px;height:48px;border-radius:12px;background:var(--chip-bg);border:1px solid var(--border);color:var(--ink)}
    .icon-btn svg{width:26px;height:26px}

    .legend{display:flex;align-items:center;gap:10px;color:var(--muted);font-size:13px}
    .dot{display:inline-block;width:14px;height:14px;border-radius:4px;border:1px solid var(--border)}
    .dot-0{background:var(--chip-bg)}
    .dot-1{background:#231e07;border-color:#54450a}
    .dot-2{background:#2b0a0a;border-color:#512}

    .people{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .chip{background:var(--chip-bg);color:var(--ink);border:1px solid var(--border);border-radius:999px;padding:8px 12px;white-space:nowrap}
    .chip.active{outline:2px solid var(--accent)}

    .days{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .day{background:var(--chip-bg);border:1px dashed var(--border);border-radius:12px;padding:10px;text-align:center;cursor:pointer;min-height:64px;display:flex;flex-direction:column;gap:6px;justify-content:center}
    .day .d1{font-size:15px;}
    .day .d2{font-size:12px;color:var(--muted)}
    .day.shabbat{opacity:.35;cursor:not-allowed}
    .day.fri.state-0{background:var(--fri-bg);border-color:var(--fri-br)}
    .day.state-1{background:#231e07;border:1px solid #54450a}
    .day.state-2{background:#2b0a0a;border:1px solid #521}

    .schedule{display:grid;grid-template-columns:minmax(90px,9ch) repeat(6,minmax(0,1fr));gap:10px;align-items:stretch}
    @media (max-width:1500px){.schedule{grid-template-columns:minmax(90px,9ch) repeat(3,minmax(0,1fr))}}
    @media (max-width:700px){.schedule{grid-template-columns:1fr}.schedule .col-hd{display:none}}
    .col-hd{font-size:13px;color:var(--muted);text-align:center;white-space:nowrap}

    .slot{background:var(--chip-bg);border:1px solid var(--border);border-radius:12px;min-height:88px;padding:10px;display:flex;flex-direction:column;gap:8px;min-width:0}
    .slot.fri{background:var(--fri-bg);border-color:var(--fri-br)}
    .slot .datebox{border:1px solid var(--border);border-radius:10px;padding:8px 10px;background:color-mix(in oklab,var(--chip-bg) 90%, transparent)}
    .slot .datebox .d-top{font-size:16px;font-weight:700}
    .slot .datebox .d-time{font-size:12px;color:var(--muted);margin-top:2px}
    .pill{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:var(--pill-bg);white-space:nowrap}
    .pill.ok{background:var(--ok-bg);border-color:var(--ok-br);color:var(--ok-ink)}
    .pill.bad{background:var(--bad-bg);border-color:var(--bad-br);color:var(--bad-ink)}
    .pill.warn{background:var(--warn-bg);border-color:var(--warn-br);color:var(--warn-ink)}

    .constraints{align-self:start; position:sticky; top:92px}
    .constraints .bd{max-height:calc(100vh - 132px); overflow:auto}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
    html[data-theme="light"] .modal-backdrop{background:rgba(0,0,0,.25)}
    .modal{width:min(560px,92vw);background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 24px 60px rgba(0,0,0,.35);padding:18px}
    .modal h2{margin:0 0 6px 0}.modal p{margin:0 0 12px 0;color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:12px}
    .select,.date{background:var(--chip-bg);color:var(--ink);border:1px solid var(--border);padding:10px 12px;border-radius:10px;min-width:auto;font-weight:600}
    .checkbox{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;cursor:pointer;background:var(--chip-bg);border:1px solid var(--border);border-radius:10px}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    .admin-bar{position:fixed;left:12px;top:12px;z-index:10000;display:flex;gap:8px;flex-wrap:wrap}

    .toast-wrap{position:fixed;left:50%;transform:translateX(-50%);bottom:68px;z-index:10050;display:flex;flex-direction:column;gap:8px;pointer-events:none}
    .toast{pointer-events:auto;min-width:260px;max-width:min(92vw,520px);border-radius:14px;border:1px solid var(--toast-br);background:var(--toast-bg);color:var(--ink);padding:12px 14px;box-shadow:0 18px 40px rgba(0,0,0,.35);display:flex;align-items:flex-start;gap:10px}

    .tabs-bar{
      position:fixed;bottom:0;left:0;right:0;
      background:var(--tabs-bg);backdrop-filter:blur(10px);
      border-top:1px solid rgba(255,255,255,.05);
      display:flex;gap:6px;align-items:center;
      padding:6px 12px;overflow-x:auto;z-index:9000;
    }
    .tab-btn{
      background:transparent;border:1px solid transparent;
      color:var(--ink);border-radius:10px;
      padding:6px 12px;font-size:14px;white-space:nowrap;
      display:flex;align-items:center;gap:6px;
      cursor:pointer;
    }
    .tab-btn.active{
      background:rgba(34,211,238,.12);
      border-color:rgba(34,211,238,.35);
    }
    .tab-lock{font-size:11px;opacity:.6}

    body.view-only .constraints,
    body.view-only #switchUserBtn,
    body.view-only #whoami{display:none!important}
  </style>
</head>
<body>
  <!-- admin floating -->
  <div class="admin-bar">
    <button id="adminBtn" class="icon-btn" title="××¦×‘ × ×™×”×•×œ">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"/>
        <path d="M19.4 15a1.8 1.8 0 0 0 .36 1.98l.05.05a2 2 0 1 1-2.83 2.83l-.05-.05A1.8 1.8 0 0 0 15 19.4a1.8 1.8 0 0 0-1 .2 1.8 1.8 0 0 0-.9 1.57V21a2 2 0 1 1-4 0v-.03A1.8 1.8 0 0 0 8.2 19.4 1.8 1.8 0 0 0 7 19.4a1.8 1.8 0 0 0-1.98.36l-.05.05a2 2 0 1 1-2.83-2.83l.05-.05A1.8 1.8 0 0 0 4.6 15a1.8 1.8 0 0 0-.2-1 1.8 1.8 0 0 0-1.57-.9H2a2 2 0 1 1 0-4h.03A1.8 1.8 0 0 0 4.6 8.2a1.8 1.8 0 0 0 .2-1A1.8 1.8 0 0 0 4.44 5.2l-.05-.05A2 2 0 1 1 7.22 2.3l.05.05A1.8 1.8 0 0 0 9 4.6c.31.05.66.05 1 0A1.8 1.8 0 0 0 10.9 3V3a2 2 0 1 1 4 0v.03a1.8 1.8 0 0 0 .9 1.57c.34.17.69.24 1 .2a1.8 1.8 0 0 0 1.98-.36l.05-.05a2 2 0 1 1 2.83 2.83l-.05.05A1.8 1.8 0 0 0 19.4 9c.05.34 0 .69-.2 1 .17.34.24.69.2 1 .05.31.05.66 0 1Z"/>
      </svg>
    </button>
  </div>

  <div class="app">
    <header class="header">
      <div>
        <h1 id="pageTitle" class="title">×œ×•×— ×©×™×‘×•×¦×™×</h1>
        <span id="pageSub" class="sub">××³â€“×”×³ 16:00â€“22:00 Â· ×•×³ 08:00â€“14:00 Â· ×©×‘×ª â€“ ××™×Ÿ ××©××¨×ª</span>
      </div>
      <div class="header-actions">
        <span id="whoami" class="id-badge">×œ× ××—×•×‘×¨</span>
        <button id="switchUserBtn" class="secondary">×”×—×œ×£ ××©×ª××©</button>
        <button id="themeBtn" class="icon-btn" title="××¦×‘ ×‘×”×™×¨/×›×”×”">
          <svg id="themeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"></svg>
        </button>
      </div>
    </header>

    <main class="two">
      <!-- schedule -->
      <section class="panel schedule-panel">
        <div class="hd" style="display:flex;align-items:center">
          <h3 style="margin-inline-end:12px">×œ×•×— ×©×™×‘×•×¦×™×</h3>
          <span id="dateRangeBadge" class="badge" style="margin-inline-end:auto"></span>
          <button id="computeBtn" class="ghost">×—×©×‘ ×©×™×‘×•×¥</button>
          <button id="exportBtn" class="ghost">×™×¦×•× CSV</button>
          <button id="shareBtn" class="ghost">×©×™×ª×•×£</button>
          <span class="vsep" aria-hidden="true"></span>
          <button id="addCalendarBtn" class="ghost" title="×”×•×¡×£ ×œ×™×•××Ÿ">
            <span style="display:inline-flex;gap:8px;align-items:center">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2"></rect>
                <path d="M16 2v4M8 2v4M3 10h18M12 14v6M9 17h6"/>
              </svg>
              ×”×•×¡×£ ×œ×™×•××Ÿ
            </span>
          </button>
        </div>
        <div class="bd">
          <div id="scheduleGrid" class="schedule"></div>
          <div id="summaryBox" style="margin-top:12px"></div>
        </div>
      </section>

      <!-- constraints -->
      <section class="panel constraints">
        <div class="hd">
          <h3>××™×œ×•×¦×™× ×œ×˜×•×•×— ×”×¤×¢×™×œ</h3>
          <div class="legend">
            <span class="dot dot-0"></span> ×–××™×Ÿ
            <span class="dot dot-1"></span> ××¢×“×™×£ ×©×œ×
            <span class="dot dot-2"></span> ×œ× ×–××™×Ÿ
          </div>
        </div>
        <div class="bd">
          <div id="peopleChips" class="people"></div>
          <div id="daysGrid" class="days"></div>
          <p class="hint">×˜×¤×™×—×” ×¢×œ ×™×•× ××—×œ×™×¤×” ××¦×‘: ×–××™×Ÿ â†’ ××¢×“×™×£ ×©×œ× â†’ ×œ× ×–××™×Ÿ â†’ ×–××™×Ÿ</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="saveBtn">×©××•×¨ ×œ×¢× ×Ÿ</button>
            <button id="resetMineBtn" class="ghost">××¤×¡ ××ª ×”××™×œ×•×¦×™× ×©×œ×™</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- tabs bottom -->
  <div id="groupTabs" class="tabs-bar"></div>

  <!-- Toasts -->
  <div id="toastWrap" class="toast-wrap" aria-live="polite"></div>

  <!-- Identity Modal -->
  <div id="identityBackdrop" class="modal-backdrop">
    <div class="modal">
      <h2>×‘×—×¨ ××©×ª××©</h2>
      <p>×‘×—×¨ ××ª ×”×©× ×©×œ×š ××”×¨×©×™××”. (××™×Ÿ ×¡×™×¡××”)</p>
      <div class="row">
        <label for="identitySelect">××©×ª××©</label>
        <select id="identitySelect" class="select"></select>
      </div>
      <p style="font-size:12px;color:var(--muted)">××™×Ÿ ××•×ª×š ×‘×¨×©×™××”? ×”×× ×”×œ ×™×›×•×œ ×œ×”×•×¡×™×£ ××•×ª×š ××¤×× ×œ ×”× ×™×”×•×œ.</p>
      <div class="actions"><button id="identityStartBtn" type="button">×”×ª×—×œ</button></div>
    </div>
  </div>

  <!-- Admin Modal -->
  <div id="adminBackdrop" class="modal-backdrop">
    <div class="modal">
      <h2>× ×™×”×•×œ</h2>
      <p>×”×’×“×¨×•×ª ×œ×—×“×¨ ×”× ×•×›×—×™ + × ×™×”×•×œ ××©×ª××©×™× (××“××™×Ÿ ×‘×œ×‘×“)</p>
      <div class="row">
        <label for="dateInput">×ª××¨×™×š ×”×ª×—×œ×” ×œ×œ×•×— ×”×–×”</label>
        <input id="dateInput" class="date" type="date" />
      </div>
      <div class="row">
        <label for="lockInput">× ×¢×™×œ×ª ×œ×•×— ×¢×“</label>
        <input id="lockInput" class="date" type="date" />
      </div>
      <div class="row">
        <label for="horizonSelect">×˜×•×•×— ×—×™×©×•×‘</label>
        <select id="horizonSelect" class="select">
          <option value="1">×©×‘×•×¢ 1 ×§×“×™××”</option>
          <option value="2">×©×‘×•×¢×™×™×</option>
          <option value="4">×—×•×“×© (4 ×©×‘×•×¢×•×ª)</option>
        </select>
      </div>
      <div class="row">
        <label class="checkbox"><input type="checkbox" id="adminEditAllChk" style="accent-color:#22d3ee"> ××¤×©×¨ ×¢×¨×™×›×” ×œ×›×œ ×”××©×ª××©×™×</label>
      </div>
      <div class="row">
        <label class="checkbox"><input type="checkbox" id="manualModeChk" style="accent-color:#22d3ee"> ××¦×‘ ×©×™× ×•×™ ×™×“× ×™</label>
        <label class="checkbox"><input type="checkbox" id="manualBypassChk" style="accent-color:#22d3ee"> ××¢×§×£ ×—×•×§×™ ××™×–×•×Ÿ</label>
      </div>
      <div id="adminUsersPanel" style="margin-top:14px;border-top:1px solid var(--border);padding-top:14px;display:none">
        <h3 style="margin:0 0 6px 0;font-size:16px">××©×ª××©×™×</h3>
        <div class="row">
          <input id="newUserName" class="select" style="min-width:140px" placeholder="×©× ×—×“×©">
          <select id="newUserGroup" class="select"></select>
          <label class="checkbox" style="padding:6px 8px"><input type="checkbox" id="newUserAdmin" style="accent-color:#22d3ee"> ××“××™×Ÿ</label>
          <button id="createUserBtn" class="ghost" type="button">×¦×•×¨ / ×¢×“×›×Ÿ</button>
        </div>
        <p id="usersList" style="font-size:13px;color:var(--muted);margin-top:10px"></p>
      </div>
      <div class="row" style="margin-top:14px">
        <button id="adminResetBtn" class="ghost" style="border-color:#f00;color:#fca5a5" type="button">××™×¤×•×¡ ×˜×‘×œ×ª ××™×œ×•×¦×™× (×œ×—×“×¨)</button>
      </div>
      <div class="actions">
        <button id="adminCancelBtn" class="ghost" type="button">×¡×’×•×¨</button>
        <button id="adminSaveBtn" type="button">×©××•×¨</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, getDocs, deleteDoc, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // ---------- CONFIG ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCQ9xt6u1mr9cHGHWVJnVXlJY5wy9noL-4",
      authDomain: "time-d77ad.firebaseapp.com",
      projectId: "time-d77ad",
      storageBucket: "time-d77ad.firebasestorage.app",
      messagingSenderId: "174419203695",
      appId: "1:174419203695:web:ab7eb33b68b4de2cab5f9a",
      measurementId: "G-DGN4GHV5JD"
    };

    // ×§×‘×•×¦×•×ª
    const GROUP_DEFS = [
      { id: "printers",   name: "×—×“×¨ ××“×¤×¡×•×ª" },
      { id: "laser",      name: "×—×“×¨ ×œ×™×™×–×¨" },
      { id: "cnc",        name: "×—×“×¨ CNC" },
      { id: "paint",      name: "×—×“×¨ ×¦×‘×¢" },
      { id: "assembly",   name: "×—×“×¨ ×”×¨×›×‘×”" },
      { id: "electronics",name: "×—×“×¨ ××œ×§×˜×¨×•× ×™×§×”" },
      { id: "general",    name: "×›×œ×œ×™ / ××—×¨" }
    ];

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const MS_DAY = 86400000;
    const hebDays=["××³","×‘×³","×’×³","×“×³","×”×³","×•×³","×©×³"];
    const hebDaysLong=["×¨××©×•×Ÿ","×©× ×™","×©×œ×™×©×™","×¨×‘×™×¢×™","×—××™×©×™","×©×™×©×™","×©×‘×ª"];

    // DOM refs
    const daysGrid = document.getElementById("daysGrid");
    const scheduleGrid = document.getElementById("scheduleGrid");
    const dateRangeBadge = document.getElementById("dateRangeBadge");
    const saveBtn = document.getElementById("saveBtn");
    const resetMineBtn = document.getElementById("resetMineBtn");
    const computeBtn = document.getElementById("computeBtn");
    const exportBtn = document.getElementById("exportBtn");
    const shareBtn = document.getElementById("shareBtn");
    const addCalendarBtn = document.getElementById("addCalendarBtn");
    const whoamiEl = document.getElementById("whoami");
    const switchUserBtn = document.getElementById("switchUserBtn");
    const themeBtn = document.getElementById("themeBtn");
    const themeIcon = document.getElementById("themeIcon");
    const identityBackdrop = document.getElementById("identityBackdrop");
    const identitySelect = document.getElementById("identitySelect");
    const adminBtn = document.getElementById("adminBtn");
    const adminBackdrop = document.getElementById("adminBackdrop");
    const dateInput = document.getElementById("dateInput");
    const lockInput = document.getElementById("lockInput");
    const horizonSelect = document.getElementById("horizonSelect");
    const adminSaveBtn = document.getElementById("adminSaveBtn");
    const adminCancelBtn = document.getElementById("adminCancelBtn");
    const adminResetBtn = document.getElementById("adminResetBtn");
    const adminEditAllChk = document.getElementById("adminEditAllChk");
    const manualModeChk = document.getElementById("manualModeChk");
    const manualBypassChk = document.getElementById("manualBypassChk");
    const adminUsersPanel = document.getElementById("adminUsersPanel");
    const newUserName = document.getElementById("newUserName");
    const newUserGroup = document.getElementById("newUserGroup");
    const newUserAdmin = document.getElementById("newUserAdmin");
    const createUserBtn = document.getElementById("createUserBtn");
    const usersList = document.getElementById("usersList");
    const peopleChips = document.getElementById("peopleChips");
    const summaryBox = document.getElementById("summaryBox");
    const toastWrap = document.getElementById("toastWrap");
    const groupTabs = document.getElementById("groupTabs");
    const pageTitle = document.getElementById("pageTitle");

    const url = new URL(location.href);
    const URL_GROUP = url.searchParams.get("group");

    // state
    let currentUser = null;
    let allUsers = [];
    let activeGroupId = URL_GROUP || GROUP_DEFS[0].id;
    let startDate = startOfDay(new Date());
    let endDate   = calcEndForHorizon(startDate, 4);
    let monthKey  = monthKeyFrom(startDate);
    let groupSettings = {}; // {groupId: {startDate, lockedUntil, horizonWeeks}}
    let state = Object.create(null);
    let adminEditAll = false;
    let manualMode   = false;
    let manualBypass = false;
    let viewOnly = false;
    let currentPack = null;
    let unsubConstraints = null;

    function overrideStorageKey(){ return `scheduler_manual_overrides_${activeGroupId}_${monthKey}`; }
    let manualOverrides = JSON.parse(localStorage.getItem(overrideStorageKey()) || "{}");

    // THEME
    const savedTheme = localStorage.getItem("scheduler_theme");
    if(savedTheme === "light" || savedTheme === "dark"){ document.documentElement.setAttribute("data-theme", savedTheme); }
    renderThemeIcon();
    themeBtn.addEventListener("click", ()=>{
      const cur = document.documentElement.getAttribute("data-theme") || "dark";
      const next = cur === "dark" ? "light" : "dark";
      document.documentElement.setAttribute("data-theme", next);
      localStorage.setItem("scheduler_theme", next);
      renderThemeIcon();
    });
    function renderThemeIcon(){
      const mode = document.documentElement.getAttribute("data-theme") || "dark";
      themeIcon.innerHTML = mode === "dark"
        ? `<path d="M12 3v2M12 19v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M3 12h2M19 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/><circle cx="12" cy="12" r="4"/>`
        : `<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>`;
    }
    function toast(msg, type="ok"){ const el=document.createElement("div"); el.className=`toast ${type}`; el.innerHTML=`<div class="icon">ğŸ””</div><div class="t-body"><div class="t-text">${msg}</div></div><div class="t-actions"><button class="btn">×¡×’×•×¨</button></div>`; toastWrap.appendChild(el); const close=()=>{el.style.opacity="0";el.style.transform="translateY(6px)";setTimeout(()=>el.remove(),250)}; el.querySelector(".btn").onclick=close; setTimeout(close,3600); }

    // date helpers
    function startOfDay(d){ const c=new Date(d); c.setHours(0,0,0,0); return c; }
    function addDays(d,n){ return new Date(startOfDay(d).getTime() + n*MS_DAY); }
    function prevSunday(d){ let x=startOfDay(d); while(x.getDay()!==0){ x=addDays(x,-1);} return x; }
    function calcEndForHorizon(d, horizonWeeks){
      const sunday = prevSunday(d);
      const days = horizonWeeks * 7 - 1; // ×œ××©×œ 1 ×©×‘×•×¢ -> 6 ×™××™×
      return addDays(sunday, days + (d.getDay()===0 ? 0 : 0));
    }
    function fmtDateKey(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0"); return `${y}-${m}-${dd}`; }
    function fmtDM(d){ const dd=String(d.getDate()).padStart(2,"0"), mm=String(d.getMonth()+1).padStart(2,"0"); return `${dd}.${mm}`; }
    function rangeDays(d0,d1){ const out=[]; let t=startOfDay(d0).getTime(), t1=startOfDay(d1).getTime(); for(;t<=t1;t+=MS_DAY) out.push(new Date(t)); return out; }
    function shiftForWeekday(jsDow){ if(jsDow>=0 && jsDow<=4) return {label:"16:00â€“22:00"}; if(jsDow===5) return {label:"08:00â€“14:00"}; return null; }
    function weekIndexFor(date){ let s = prevSunday(startDate); return Math.floor((startOfDay(date) - s) / (7*MS_DAY)); }
    function monthKeyFrom(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"); return `${y}-${m}`; }
    function renderDateBadge(){ dateRangeBadge.textContent = `${fmtDM(startDate)} â† ${fmtDM(endDate)} Â· ×˜×•×•×—`; }

    // users
    async function loadAllUsers(){
      const qs = await getDocs(collection(db, "users"));
      allUsers = qs.docs.map(d=>({ id:d.id, ...d.data() }));
      renderIdentityList();
      renderGroupTabs();
    }
    function renderIdentityList(){
      identitySelect.innerHTML = "";
      allUsers.sort((a,b)=>a.name.localeCompare(b.name,"he"));
      for(const u of allUsers){
        const opt = document.createElement("option");
        opt.value = u.id;
        opt.textContent = u.name + " â€“ " + (GROUP_DEFS.find(g=>g.id===u.groupId)?.name || u.groupId);
        identitySelect.appendChild(opt);
      }
    }
    function renderGroupTabs(){
      groupTabs.innerHTML = "";
      for(const g of GROUP_DEFS){
        const btn = document.createElement("button");
        btn.className = "tab-btn" + (g.id === activeGroupId ? " active" : "");
        const lockedText = groupSettings[g.id]?.lockedUntil ? `<span class="tab-lock">ğŸ”’ ×¢×“ ${groupSettings[g.id].lockedUntil}</span>` : "";
        btn.innerHTML = `${g.name} ${lockedText}`;
        btn.addEventListener("click", ()=>{ activeGroupId = g.id; localStorage.setItem("scheduler_last_group", activeGroupId); switchToGroup(g.id); });
        groupTabs.appendChild(btn);
      }
    }

    function currentGroupPeople(){
      return allUsers.filter(u => u.groupId === activeGroupId).map(u => u.name);
    }
    function isCurrentGroupLockedForMe(){
      const gset = groupSettings[activeGroupId];
      if(!gset?.lockedUntil) return false;
      const today = fmtDateKey(new Date());
      return today <= gset.lockedUntil && !(currentUser?.isAdmin);
    }

    // constraints
    async function loadConstraints(){
      state = Object.create(null);
      const col = collection(db, "groups", activeGroupId, "constraints", monthKey, "days");
      const snap = await getDocs(col);
      snap.forEach(docSnap=>{ state[docSnap.id] = docSnap.data(); });
    }
    async function saveConstraints(){
      if(viewOnly){ toast("×œ×•×— × ×¢×•×œ ××• ×©××™×Ÿ ×œ×š ×”×¨×©××”.", "warn"); return; }
      if(!currentUser){ toast("×œ× ××—×•×‘×¨.", "warn"); return; }
      const writes = [];
      for(const [dateKey,val] of Object.entries(state)){
        const clean = {};
        for(const p of currentGroupPeople()){ if(val[p]!==undefined) clean[p]=Number(val[p])||0; }
        writes.push(setDoc(doc(db, "groups", activeGroupId, "constraints", monthKey, "days", dateKey), clean, {merge:true}));
      }
      await Promise.all(writes);
      toast("× ×©××¨.", "ok");
    }
    async function resetMonthOnCloud(){
      toast("×××¤×¡ ××ª ×”××™×œ×•×¦×™× ×©×œ ×”×—×“×¨â€¦","warn");
      const col = collection(db, "groups", activeGroupId, "constraints", monthKey, "days");
      const snap = await getDocs(col);
      await Promise.all(snap.docs.map(ds=>deleteDoc(ds.ref)));
      state = Object.create(null);
      manualOverrides = {};
      localStorage.setItem(overrideStorageKey(), "{}");
      renderCalendar();
      const p = computeSchedule(currentGroupPeople(), manualOverrides);
      currentPack = p; renderSchedule(p); renderSummary(p);
      toast("××•×¤×¡ â€“ ××•×¤×¡× ×•.","ok");
    }

    // group settings
    async function loadGroupSettings(groupId){
      const ref = doc(db, "groups", groupId);
      const snap = await getDoc(ref);
      if(snap.exists()){
        const data = snap.data();
        groupSettings[groupId] = data;
        if(groupId === activeGroupId){
          applyStartAndHorizon(data.startDate || fmtDateKey(new Date()), data.horizonWeeks || 4);
          if(data.lockedUntil) lockInput.value = data.lockedUntil;
        }
      }else{
        const sd = fmtDateKey(new Date());
        const data = { startDate: sd, lockedUntil: "", horizonWeeks: 4 };
        await setDoc(ref, data, {merge:true});
        groupSettings[groupId] = data;
      }
    }
    async function loadAllGroupSettings(){
      for(const g of GROUP_DEFS){ await loadGroupSettings(g.id); }
      renderGroupTabs();
    }

    function applyStartAndHorizon(sd, horizonWeeks){
      try{
        const [y,m,dd] = sd.split("-").map(Number);
        startDate = startOfDay(new Date(y, m-1, dd));
      }catch(_){ startDate = startOfDay(new Date()); }
      endDate = calcEndForHorizon(startDate, horizonWeeks || 4);
      monthKey = monthKeyFrom(startDate);
      renderDateBadge();
      manualOverrides = JSON.parse(localStorage.getItem(overrideStorageKey()) || "{}");
    }

    // calendar
    function renderCalendar(){
      const people = currentGroupPeople();
      peopleChips.innerHTML = "";
      const storedPerson = localStorage.getItem("scheduler_person_"+activeGroupId) || people[0] || null;
      for(const p of people){
        const btn = document.createElement("button");
        btn.className = "chip" + (p === storedPerson ? " active" : "");
        btn.dataset.person = p;
        btn.textContent = p;
        peopleChips.appendChild(btn);
      }

      const days = rangeDays(startDate, endDate);
      const head = hebDays.map(h=>`<div class="day head" aria-hidden="true"><div class="d1"></div><div class="d2">${h}</div></div>`).join("");
      let html = head;
      for(const d of days){
        const key = fmtDateKey(d);
        const jsDow = d.getDay();
        const isShabbat = jsDow===6;
        const isFriday = jsDow===5;
        const sh = shiftForWeekday(jsDow);
        const cur = state[key] || {};
        const val = Number(cur[storedPerson] ?? 0);
        html += `
          <div class="day ${isShabbat?'shabbat':''} ${isFriday?'fri':''} state-${val}" data-key="${key}">
            <div class="d1">${hebDaysLong[jsDow]}, ${fmtDM(d)}</div>
            <div class="d2">${sh?sh.label:'â€”'}</div>
          </div>
        `;
      }
      daysGrid.innerHTML = html;

      const locked = viewOnly;
      if(!locked){
        daysGrid.querySelectorAll(".day").forEach(el=>{
          const key = el.dataset.key;
          if(!key) return;
          const jsDow = new Date(key).getDay();
          if(jsDow===6) return;
          el.addEventListener("click", ()=>{
            const ap = localStorage.getItem("scheduler_person_"+activeGroupId) || currentGroupPeople()[0];
            const cur = state[key] || {};
            const old = Number(cur[ap] ?? 0);
            const next = (old + 1) % 3;
            cur[ap] = next;
            state[key] = cur;
            el.classList.remove("state-0","state-1","state-2");
            el.classList.add(`state-${next}`);
          });
        });
      }

      peopleChips.querySelectorAll(".chip").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          peopleChips.querySelectorAll(".chip").forEach(b=>b.classList.remove("active"));
          btn.classList.add("active");
          localStorage.setItem("scheduler_person_"+activeGroupId, btn.dataset.person);
          renderCalendar();
        });
      });
    }

    // compute schedule (×›××• ×§×•×“×, ×¨×§ ×¤×•× ×§×¦×™×” ××—×ª, ×œ× ××©× ×” ×›××Ÿ ×›×“×™ ×œ× ×œ×”××¨×™×š ×™×•×ª×¨)
    function computeSchedule(PEOPLE, overrides = {}){
      const days = rangeDays(startDate, endDate);
      const assign = {};
      const totalCounts  = Object.fromEntries(PEOPLE.map(p=>[p,0]));
      const fridayCounts = Object.fromEntries(PEOPLE.map(p=>[p,0]));
      const weekCounts   = [];
      const WEEK_MIN = 2;

      const ensureWeek = (idx)=>{ if(!weekCounts[idx]) weekCounts[idx] = Object.fromEntries(PEOPLE.map(p=>[p,0])); };
      const isFridayKey = (k)=> new Date(k).getDay()===5;
      const prefVal = (dayKey, person)=> Number((state[dayKey] || {})[person] ?? 0);
      const hasOtherZero = (dayKey, exceptPerson)=>{
        const row = state[dayKey] || {};
        return PEOPLE.some(p=>p!==exceptPerson && Number(row[p] ?? 0)===0);
      };
      const canAssign = (person, dateKey)=>{
        const row = state[dateKey] || {};
        return Number(row[person] ?? 0) !== 2;
      };

      for(const d of days){
        const jsDow = d.getDay();
        const sh = shiftForWeekday(jsDow);
        if(!sh) continue;
        const key = fmtDateKey(d);
        const row = state[key] || {};
        const wIdx = weekIndexFor(d); ensureWeek(wIdx);

        if(overrides[key]){
          const forced = overrides[key];
          assign[key] = forced;
          totalCounts[forced]++; weekCounts[wIdx][forced]=(weekCounts[wIdx][forced]||0)+1;
          if(jsDow===5) fridayCounts[forced]++;
          continue;
        }

        const avail0 = PEOPLE.filter(p=>Number(row[p] ?? 0)===0);
        const prefer1 = PEOPLE.filter(p=>Number(row[p] ?? 0)===1);

        let candidates = [];
        if(avail0.length) candidates = avail0.slice();
        else if(prefer1.length) candidates = prefer1.slice();

        if(candidates.length){
          candidates.sort((a,b)=>{
            if(jsDow===5){
              if(fridayCounts[a] !== fridayCounts[b]) return fridayCounts[a] - fridayCounts[b];
            }
            if(weekCounts[wIdx][a] !== weekCounts[wIdx][b]) return weekCounts[wIdx][a] - weekCounts[wIdx][b];
            return totalCounts[a] - totalCounts[b];
          });
          const pick = candidates[0];
          assign[key] = pick;
          totalCounts[pick]++; weekCounts[wIdx][pick]=(weekCounts[wIdx][pick]||0)+1;
          if(jsDow===5) fridayCounts[pick]++;
        }else{
          assign[key] = null;
        }
      }

      // weeks map
      const allKeys = Object.keys(assign);
      const keysByWeek = {};
      for(const k of allKeys){
        const wIdx = weekIndexFor(new Date(k)); ensureWeek(wIdx);
        (keysByWeek[wIdx] ||= []).push(k);
      }

      // ensure 2 per week
      for(const wIdxStr of Object.keys(keysByWeek)){
        const wIdx = Number(wIdxStr);
        const weekKeys = keysByWeek[wIdx];
        for(const person of PEOPLE){
          while((weekCounts[wIdx][person]||0) < WEEK_MIN){
            const empty = weekKeys.find(k=>!assign[k] && canAssign(person,k) && !overrides[k]);
            if(empty){
              const pref = prefVal(empty, person);
              if(!(pref===1 && hasOtherZero(empty, person))){
                assign[empty] = person;
                weekCounts[wIdx][person]=(weekCounts[wIdx][person]||0)+1;
                totalCounts[person]++;
                if(isFridayKey(empty)) fridayCounts[person]++;
                continue;
              }
            }
            const donors = PEOPLE.filter(p=>p!==person && (weekCounts[wIdx][p]||0) > WEEK_MIN)
              .sort((a,b)=>(weekCounts[wIdx][b]||0) - (weekCounts[wIdx][a]||0));

            let moved = false;
            for(const donor of donors){
              const bucket1 = weekKeys.filter(k=>assign[k]===donor && !isFridayKey(k) && !overrides[k]);
              const bucket2 = weekKeys.filter(k=>assign[k]===donor &&  isFridayKey(k) && !overrides[k]);
              const buckets = [bucket1, bucket2];
              for(const bucket of buckets){
                const sorted = bucket.slice().sort((a,b)=>prefVal(a,person)-prefVal(b,person));
                for(const dayKey of sorted){
                  if(!canAssign(person, dayKey)) continue;
                  const pref = prefVal(dayKey, person);
                  if(pref===1 && hasOtherZero(dayKey, person)) continue;
                  assign[dayKey]=person;
                  weekCounts[wIdx][person]=(weekCounts[wIdx][person]||0)+1;
                  weekCounts[wIdx][donor]=(weekCounts[wIdx][donor]||0)-1;
                  totalCounts[person]++; totalCounts[donor]--;
                  if(isFridayKey(dayKey)){ fridayCounts[person]++; fridayCounts[donor]--; }
                  moved = true;
                  break;
                }
                if(moved) break;
              }
              if(moved) break;
            }
            if(!moved) break;
          }
        }
      }

      // balance friday
      let guard=0;
      while(guard++<60){
        let maxP=PEOPLE[0], minP=PEOPLE[0];
        for(const p of PEOPLE){
          if(fridayCounts[p] > fridayCounts[maxP]) maxP = p;
          if(fridayCounts[p] < fridayCounts[minP]) minP = p;
        }
        if(fridayCounts[maxP] - fridayCounts[minP] <= 1) break;
        const fridayKeysOfMax = allKeys.filter(k=>assign[k]===maxP && isFridayKey(k) && !overrides[k]);
        let balanced = false;
        for(const fk of fridayKeysOfMax){
          const wf = weekIndexFor(new Date(fk));
          const prefMin = prefVal(fk, minP);
          if(Number((state[fk]||{})[minP] ?? 0) === 2) continue;
          if(prefMin === 1 && hasOtherZero(fk, minP)) continue;
          if((weekCounts[wf][minP]||0) < WEEK_MIN){
            assign[fk] = minP;
            weekCounts[wf][minP]=(weekCounts[wf][minP]||0)+1;
            weekCounts[wf][maxP]=(weekCounts[wf][maxP]||0)-1;
            fridayCounts[minP]++; fridayCounts[maxP]--;
            balanced = true; break;
          }
          const minWeekdayKeys = allKeys.filter(k=>assign[k]===minP && !isFridayKey(k) && !overrides[k]);
          for(const day2 of minWeekdayKeys){
            const w2 = weekIndexFor(new Date(day2));
            if(Number((state[day2]||{})[maxP] ?? 0) === 2) continue;
            const prefMaxDay2 = prefVal(day2, maxP);
            if(prefMaxDay2 === 1 && hasOtherZero(day2, maxP)) continue;
            if((weekCounts[wf][maxP]||0)-1 < WEEK_MIN) continue;
            if((weekCounts[w2][minP]||0)-1 < WEEK_MIN) continue;
            assign[fk]=minP;
            assign[day2]=maxP;
            fridayCounts[minP]++; fridayCounts[maxP]--;
            weekCounts[wf][minP]=(weekCounts[wf][minP]||0)+1;
            weekCounts[wf][maxP]=(weekCounts[wf][maxP]||0)-1;
            weekCounts[w2][maxP]=(weekCounts[w2][maxP]||0)+1;
            weekCounts[w2][minP]=(weekCounts[w2][minP]||0)-1;
            balanced = true; break;
          }
          if(balanced) break;
        }
        if(!balanced) break;
      }

      return { assign, weekCounts, fridayCounts, totalCounts };
    }

    function recomputeStatsFromAssign(PEOPLE, assign){
      const days = rangeDays(startDate, endDate);
      const weekCounts = [];
      const fridayCounts = Object.fromEntries(PEOPLE.map(p=>[p,0]));
      for(const d of days){
        const sh = shiftForWeekday(d.getDay());
        if(!sh) continue;
        const key = fmtDateKey(d);
        const who = assign[key];
        const wIdx = weekIndexFor(d);
        if(!weekCounts[wIdx]) weekCounts[wIdx] = Object.fromEntries(PEOPLE.map(p=>[p,0]));
        if(who){
          weekCounts[wIdx][who] = (weekCounts[wIdx][who]||0)+1;
          if(d.getDay()===5) fridayCounts[who] = (fridayCounts[who]||0)+1;
        }
      }
      return { weekCounts, fridayCounts };
    }

    function renderSchedule(pack){
      currentPack = pack;
      const PEOPLE = currentGroupPeople();
      const { assign } = pack;
      let html = `
        <div></div>
        <div class="col-hd">××³</div>
        <div class="col-hd">×‘×³</div>
        <div class="col-hd">×’×³</div>
        <div class="col-hd">×“×³</div>
        <div class="col-hd">×”×³</div>
        <div class="col-hd">×•×³</div>
      `;
      let weekStart = prevSunday(startDate); let guard=0;
      while(weekStart <= endDate && guard++<80){
        const weekEnd = addDays(weekStart,6);
        const rowLabel = `${fmtDM(weekStart)} â€“ ${fmtDM(weekEnd)}`;
        html += `<div class="muted" style="display:flex;align-items:center;white-space:nowrap">${rowLabel}</div>`;
        for(let i=0;i<6;i++){
          const cur = addDays(weekStart,i);
          const key = fmtDateKey(cur);
          const inRange = cur>=startDate && cur<=endDate;
          const sh = shiftForWeekday(cur.getDay());
          const dateTitle = `${hebDaysLong[cur.getDay()]}, ${fmtDM(cur)}`;
          const timeStr = sh ? sh.label : "â€”";
          if(!inRange || !sh){
            html += `<div class="slot" style="opacity:.35"><div class="datebox"><div class="d-top">${dateTitle}</div><div class="d-time">××™×Ÿ</div></div></div>`;
          }else{
            const who = assign[key] || "";
            const row = state[key] || {};
            const absent = PEOPLE.filter(p=>Number(row[p]??0)===2);
            const prefer = PEOPLE.filter(p=>Number(row[p]??0)===1);
            const isFriday = cur.getDay()===5;
            let content;
            if(manualMode && !viewOnly){
              content = `
                <select class="assign-select" data-key="${key}" style="background:var(--chip-bg);border:1px solid var(--border);border-radius:999px;padding:4px 8px;color:var(--ink)">
                  <option value="">â€” ×œ×œ× â€”</option>
                  ${PEOPLE.map(p=>`<option value="${p}" ${p===who?'selected':''}>${p}</option>`).join("")}
                </select>
              `;
            }else{
              content = `<div class="${who ? 'pill ok':'pill bad'}">${who ? `××©×•×‘×¥: <b>${who}</b>` : 'âŒ ××™×Ÿ ××©×•×‘×¥'}</div>`;
            }
            html += `
              <div class="slot ${isFriday?'fri':''}">
                <div class="datebox">
                  <div class="d-top">${dateTitle}</div>
                  <div class="d-time">${timeStr}</div>
                </div>
                ${content}
                ${prefer.length ? `<div class="pill warn">××¢×“×™×¤×™× ×©×œ×: ${prefer.join(", ")}</div>` : ``}
                ${absent.length ? `<div class="pill bad">×œ× ×–××™× ×™×: ${absent.join(", ")}</div>` : ``}
              </div>
            `;
          }
        }
        weekStart = addDays(weekStart,7);
      }
      scheduleGrid.innerHTML = html;

      if(manualMode && !viewOnly){
        scheduleGrid.querySelectorAll(".assign-select").forEach(sel=>{
          sel.addEventListener("change", ()=>{
            const key = sel.dataset.key;
            const val = sel.value || null;
            if(manualBypass){
              if(val) manualOverrides[key] = val; else delete manualOverrides[key];
              localStorage.setItem(overrideStorageKey(), JSON.stringify(manualOverrides));
              currentPack.assign[key] = val;
              const stats = recomputeStatsFromAssign(currentGroupPeople(), currentPack.assign);
              currentPack.weekCounts = stats.weekCounts;
              currentPack.fridayCounts = stats.fridayCounts;
              renderSchedule(currentPack); renderSummary(currentPack);
            }else{
              if(val) manualOverrides[key] = val; else delete manualOverrides[key];
              localStorage.setItem(overrideStorageKey(), JSON.stringify(manualOverrides));
              const PACK = computeSchedule(currentGroupPeople(), manualOverrides);
              renderSchedule(PACK); renderSummary(PACK);
            }
          });
        });
      }
    }

    function renderSummary(pack){
      const PEOPLE = currentGroupPeople();
      const { weekCounts, fridayCounts } = pack;
      const html = `
        <div class="panel" style="margin-top:12px">
          <div class="hd"><h3 style="margin:0">×¡×™×›×•× ×©×‘×•×¢×™ + ×™××™ ×©×™×©×™</h3></div>
          <div class="bd">
            <div style="overflow:auto">
              <table style="width:100%;border-collapse:collapse;font-size:15px;min-width:0">
                <thead>
                  <tr>
                    <th style="text-align:right;border-bottom:1px solid var(--border);padding:6px 4px;white-space:nowrap">×©×‘×•×¢</th>
                    ${PEOPLE.map(p=>`<th style="text-align:center;border-bottom:1px solid var(--border);padding:6px 4px">${p}</th>`).join("")}
                  </tr>
                </thead>
                <tbody>
                  ${(weekCounts||[]).map((wc,idx)=>`
                    <tr>
                      <td style="border-bottom:1px solid var(--border);padding:6px 4px;white-space:nowrap">×©×‘×•×¢ ${idx+1}</td>
                      ${PEOPLE.map(p=>`<td style="text-align:center;border-bottom:1px solid var(--border);padding:6px 4px">${wc?.[p] ?? 0}</td>`).join("")}
                    </tr>
                  `).join("")}
                </tbody>
              </table>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
              ${PEOPLE.map(p=>`<div class="pill">${p}: ×©×™×©×™ â€“ <b>${fridayCounts?.[p] ?? 0}</b></div>`).join("")}
            </div>
          </div>
        </div>
      `;
      summaryBox.innerHTML = html;
    }

    function exportCSV(pack){
      const { assign } = pack;
      const days = rangeDays(startDate, endDate);
      const rows = [["×ª××¨×™×š","×™×•×","××©××¨×ª","××©×•×‘×¥"]];
      for(const d of days){
        const sh = shiftForWeekday(d.getDay());
        if(!sh) continue;
        const key = fmtDateKey(d);
        rows.push([fmtDM(d), hebDaysLong[d.getDay()], sh.label, assign[key]||""]);
      }
      const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\r\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `schedule_${activeGroupId}.csv`;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href),200);
      toast("CSV ×™×¨×“.","ok");
    }

    function pad(n){ return String(n).padStart(2,"0"); }
    function toICSDateUTC(d, h, m){
      const z=new Date(d); z.setUTCHours(h,m,0,0);
      return `${z.getUTCFullYear()}${pad(z.getUTCMonth()+1)}${pad(z.getUTCDate())}T${pad(z.getUTCHours())}${pad(z.getUTCMinutes())}00Z`;
    }
    function downloadICSForMe(assign){
      if(!currentUser){ toast("×‘×—×¨ ××©×ª××© ×§×•×“×.","warn"); return; }
      const myName = currentUser.name;
      const days = rangeDays(startDate, endDate);
      let ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Workshop//Schedule//HE
CALSCALE:GREGORIAN
METHOD:PUBLISH
`;
      for(const d of days){
        const sh = shiftForWeekday(d.getDay());
        if(!sh) continue;
        const key = fmtDateKey(d);
        const who = assign[key];
        if(who !== myName) continue;
        let shStart=[16,0], shEnd=[22,0];
        if(d.getDay()===5){ shStart=[8,0]; shEnd=[14,0]; }
        const uid = `${key}-${myName}-${activeGroupId}@schedule`;
        ics += `BEGIN:VEVENT
UID:${uid}
DTSTAMP:${toICSDateUTC(new Date(),0,0)}
DTSTART:${toICSDateUTC(d, shStart[0], shStart[1])}
DTEND:${toICSDateUTC(d, shEnd[0], shEnd[1])}
SUMMARY:××©××¨×ª â€“ ${myName} (${GROUP_DEFS.find(g=>g.id===activeGroupId)?.name || activeGroupId})
DESCRIPTION:××©××¨×ª ${sh.label}
LOCATION:×¡×“× ×”
END:VEVENT
`;
      }
      ics += "END:VCALENDAR";
      const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `schedule_${activeGroupId}_${myName}.ics`;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href),200);
      toast("iCal × ×•×¦×¨.","ok");
    }

    // identity
    function showIdentityModal(){ renderIdentityList(); identityBackdrop.style.display="flex"; }
    function hideIdentityModal(){ identityBackdrop.style.display="none"; }

    async function startWithUser(userId){
      const u = allUsers.find(x=>x.id===userId);
      if(!u){ toast("××©×ª××© ×œ× × ××¦×.","bad"); return; }
      currentUser = u;
      activeGroupId = u.groupId;
      localStorage.setItem("scheduler_last_group", activeGroupId);
      localStorage.setItem("scheduler_last_user", u.id);
      whoamiEl.textContent = `${u.name} (${GROUP_DEFS.find(g=>g.id===activeGroupId)?.name || activeGroupId})` + (u.isAdmin?" Â· ×× ×”×œ":"");
      if(!auth.currentUser){
        try{ await signInAnonymously(auth); }catch(e){}
      }
      await switchToGroup(activeGroupId);
      hideIdentityModal();
    }

    document.getElementById("identityStartBtn").addEventListener("click", async ()=>{
      const picked = identitySelect.value;
      if(picked) await startWithUser(picked);
    });

    // switch group
    async function switchToGroup(groupId){
      activeGroupId = groupId;
      pageTitle.textContent = `×œ×•×— ×©×™×‘×•×¦×™× â€“ ${GROUP_DEFS.find(g=>g.id===groupId)?.name || groupId}`;
      const gset = groupSettings[groupId];
      applyStartAndHorizon(gset?.startDate || fmtDateKey(new Date()), gset?.horizonWeeks || 4);
      renderGroupTabs();

      if(unsubConstraints){ unsubConstraints(); unsubConstraints=null; }
      await loadConstraints();
      unsubConstraints = onSnapshot(collection(db, "groups", groupId, "constraints", monthKey, "days"), snap=>{
        snap.docChanges().forEach(ch=>{ if(!state[ch.doc.id]) state[ch.doc.id]={}; Object.assign(state[ch.doc.id], ch.doc.data()); });
        renderCalendar(); const p=computeSchedule(currentGroupPeople(), manualOverrides); renderSchedule(p); renderSummary(p);
      });

      viewOnly = isCurrentGroupLockedForMe() || (!currentUser?.isAdmin && currentUser?.groupId !== groupId);
      document.body.classList.toggle("view-only", viewOnly);

      renderCalendar();
      const pack = computeSchedule(currentGroupPeople(), manualOverrides);
      renderSchedule(pack); renderSummary(pack);
    }

    // admin UI
    function showAdmin(){
      if(!currentUser){ toast("×”×ª×—×‘×¨ ×§×•×“×.","warn"); return; }
      const gset = groupSettings[activeGroupId] || {};
      dateInput.value = gset.startDate || fmtDateKey(new Date());
      lockInput.value = gset.lockedUntil || "";
      horizonSelect.value = String(gset.horizonWeeks || 4);
      adminEditAllChk.checked = adminEditAll;
      manualModeChk.checked = manualMode;
      manualBypassChk.checked = manualBypass;
      if(currentUser.isAdmin){
        adminUsersPanel.style.display = "block";
        newUserGroup.innerHTML = GROUP_DEFS.map(g=>`<option value="${g.id}">${g.name}</option>`).join("");
        newUserGroup.value = activeGroupId;
        const usersInGroup = allUsers.filter(u=>u.groupId===activeGroupId);
        usersList.textContent = "××©×ª××©×™× ×‘×—×“×¨: " + (usersInGroup.map(u=>u.name + (u.isAdmin?" (××“××™×Ÿ)":"")).join(", ") || "â€”");
      }else{
        adminUsersPanel.style.display = "none";
      }
      adminBackdrop.style.display = "flex";
    }
    function hideAdmin(){ adminBackdrop.style.display = "none"; }
    adminBtn.addEventListener("click", showAdmin);
    adminCancelBtn.addEventListener("click", hideAdmin);
    adminResetBtn.addEventListener("click", resetMonthOnCloud);

    createUserBtn.addEventListener("click", async ()=>{
      const name = (newUserName.value || "").trim();
      const group = newUserGroup.value;
      const isAdmin = newUserAdmin.checked;
      if(!name){ toast("×¦×¨×™×š ×©×.","warn"); return; }
      await setDoc(doc(db, "users", name), { name, groupId: group, isAdmin }, { merge:true });
      await loadAllUsers();
      toast("×”××©×ª××© × ×•×¦×¨/×¢×•×“×›×Ÿ.","ok");
      newUserName.value = "";
      const usersInGroup = allUsers.filter(u=>u.groupId===activeGroupId);
      usersList.textContent = "××©×ª××©×™× ×‘×—×“×¨: " + (usersInGroup.map(u=>u.name + (u.isAdmin?" (××“××™×Ÿ)":"")).join(", ") || "â€”");
    });

    adminSaveBtn.addEventListener("click", async ()=>{
      const newStart = dateInput.value;
      const newLock  = lockInput.value;
      const newHorizon = Number(horizonSelect.value) || 4;
      adminEditAll = !!adminEditAllChk.checked;
      manualMode   = !!manualModeChk.checked;
      manualBypass = !!manualBypassChk.checked;
      await setDoc(doc(db, "groups", activeGroupId), { startDate: newStart, lockedUntil: newLock, horizonWeeks: newHorizon }, { merge:true });
      groupSettings[activeGroupId] = { ...(groupSettings[activeGroupId]||{}), startDate:newStart, lockedUntil:newLock, horizonWeeks:newHorizon };
      applyStartAndHorizon(newStart, newHorizon);
      await loadConstraints();
      renderCalendar();
      const pack = computeSchedule(currentGroupPeople(), manualOverrides);
      renderSchedule(pack); renderSummary(pack);
      viewOnly = isCurrentGroupLockedForMe() || (!currentUser?.isAdmin && currentUser?.groupId !== activeGroupId);
      document.body.classList.toggle("view-only", viewOnly);
      hideAdmin();
      toast("× ×©××¨.","ok");
    });

    // buttons
    saveBtn.addEventListener("click", saveConstraints);
    resetMineBtn.addEventListener("click", ()=>{
      if(viewOnly){ toast("×œ×•×— × ×¢×•×œ.","warn"); return; }
      const me = localStorage.getItem("scheduler_person_"+activeGroupId) || currentGroupPeople()[0];
      for(const d of rangeDays(startDate, endDate)){
        const k = fmtDateKey(d);
        if(state[k] && state[k][me]!==undefined) state[k][me]=0;
      }
      renderCalendar(); toast("×”××™×œ×•×¦×™× ×©×œ×š ××•×¤×¡×• (×ª×©××•×¨).","ok");
    });
    computeBtn.addEventListener("click", ()=>{ const p=computeSchedule(currentGroupPeople(), manualOverrides); renderSchedule(p); renderSummary(p); toast("×©×•×‘×¥.","ok"); });
    exportBtn.addEventListener("click", ()=>{ const p=currentPack || computeSchedule(currentGroupPeople(), manualOverrides); exportCSV(p); });
    shareBtn.addEventListener("click", ()=>{ const u=new URL(location.href); u.searchParams.set("group", activeGroupId); u.searchParams.set("start", fmtDateKey(startDate)); window.open(u.toString(), "_blank"); });
    addCalendarBtn.addEventListener("click", ()=>{ const p=currentPack || computeSchedule(currentGroupPeople(), manualOverrides); downloadICSForMe(p.assign); });
    switchUserBtn.addEventListener("click", ()=>{ currentUser=null; whoamiEl.textContent="×œ× ××—×•×‘×¨"; showIdentityModal(); });

    // auth/realtime
    onAuthStateChanged(auth, async ()=>{
      await loadAllUsers();
      await loadAllGroupSettings();
      const lastUser = localStorage.getItem("scheduler_last_user");
      if(lastUser && allUsers.some(u=>u.id===lastUser)){
        await startWithUser(lastUser);
      }else{
        showIdentityModal();
      }
    });

    identitySelect.addEventListener("change", ()=>{
      const uId = identitySelect.value;
      if(uId) localStorage.setItem("scheduler_last_user", uId);
    });

    function initialDraw(){ renderDateBadge(); }
    initialDraw();
  </script>
</body>
</html>
