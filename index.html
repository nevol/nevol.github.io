<!DOCTYPE html>
<html lang="he" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>××¢×¨×›×ª ×©×™×‘×•×¦×™× - ×¡×“× ×”</title>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9aa6b2;
      --border:#273244; --accent:#38bdf8; --accent2:#22d3ee;
      --chip-bg:#0b1222; --pill-bg:#122; --btn-ink:#06121c;
      --ok-bg:#032015; --ok-br:#0c3; --ok-ink:#b7f7cf;
      --warn-bg:#231e07; --warn-br:#54450a; --warn-ink:#fde68a;
      --bad-bg:#2b0a0a; --bad-br:#521; --bad-ink:#fecaca;
      --fri-bg:#0a1d2b; --fri-br:#224055; --fri-pill:#0e2a3f;
      --badge-bg:transparent;
      --title-g1: var(--accent); --title-g2: var(--accent2);
      --toast-bg: rgba(15,23,42,.95); --toast-br:#2b3a55; --toast-ink:#e5e7eb;
      --toast-ok:#16a34a; --toast-warn:#eab308; --toast-bad:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; overflow-x:hidden;
      font-family:"Assistant",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif;
      background:
        radial-gradient(1200px 800px at 80% -10%, #0b1222 0%, var(--bg) 40%),
        linear-gradient(180deg, #0b1222 0%, var(--bg) 100%);
      color:var(--ink); font-size:16px;
    }

    .app{max-width:1600px;margin:0 auto;padding:16px}
    header.header{display:flex;justify-content:space-between;align-items:flex-start;gap:16px;flex-wrap:wrap}
    .title{margin:0;font-weight:800;letter-spacing:.2px;font-size:clamp(22px,2.8vw,34px);
      background:linear-gradient(90deg,var(--title-g1),var(--title-g2));
      -webkit-background-clip:text;background-clip:text;color:transparent}
    .sub{color:var(--muted);font-size:14px;margin-top:6px;margin-bottom:16px;display:block}
    .header-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap;max-width:100%}
    .badge{border:1px solid var(--border);border-radius:999px;padding:6px 12px;font-size:13px;color:var(--muted);background:var(--badge-bg)}
    .id-badge{border:1px solid var(--border);padding:6px 12px;border-radius:999px;font-size:13px; cursor: pointer; transition: 0.2s;}
    .id-badge:hover{background:var(--chip-bg);}

    /* Tabs */
    .group-tabs { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
    .tab-btn {
        background: var(--chip-bg); border: 1px solid var(--border); color: var(--muted);
        padding: 8px 16px; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.2s;
        font-family: inherit;
    }
    .tab-btn:hover { background: var(--border); color: var(--ink); }
    .tab-btn.active {
        background: linear-gradient(90deg,var(--accent),var(--accent2)); 
        color: var(--btn-ink); border: none;
    }

    .two{
      display:grid;
      grid-template-columns:minmax(0,1fr) minmax(0,2fr);
      grid-template-areas:"constraints schedule";
      gap:18px; align-items:start;
      margin-top: 20px;
    }
    .constraints{grid-area:constraints}
    .schedule-panel{grid-area:schedule}

    @media (max-width: 1100px){
      .two{grid-template-columns:1fr;grid-template-areas:"schedule" "constraints";}
      .constraints{position:static}
      .constraints .bd{max-height:none;overflow:visible}
    }

    .panel{background:linear-gradient(180deg,var(--card),color-mix(in oklab,var(--card) 80%,var(--bg)));
      border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08);overflow:hidden}
    .panel .hd{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px; flex-wrap:wrap;}
    .panel .bd{padding:16px}
    .panel h3{margin:0;font-size:20px}

    button{cursor:pointer;border:none;border-radius:12px;padding:10px 14px;font-weight:700;color:var(--btn-ink);background:linear-gradient(90deg,var(--accent),var(--accent2)); font-family: inherit;}
    button.ghost{background:transparent;color:var(--ink);border:1px solid var(--border)}
    button.secondary{background:var(--chip-bg);color:var(--ink);border:1px solid var(--border);height:48px}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .vsep{width:1px;height:34px;background:var(--border);border-radius:1px;margin-inline:8px}

    .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:48px;height:48px;border-radius:12px;background:var(--chip-bg);border:1px solid var(--border);color:var(--ink)}
    .icon-btn svg{width:26px;height:26px}

    .legend{display:flex;align-items:center;gap:10px;color:var(--muted);font-size:13px}
    .dot{display:inline-block;width:14px;height:14px;border-radius:4px;border:1px solid var(--border)}
    .dot-0{background:var(--chip-bg)}
    .dot-1{background:#231e07;border-color:#54450a}
    .dot-2{background:#2b0a0a;border-color:#512}

    .people{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .chip{background:var(--chip-bg);color:var(--ink);border:1px solid var(--border);border-radius:999px;padding:8px 12px; opacity: 0.5; pointer-events: none;}
    .chip.active{outline:2px solid var(--accent); opacity: 1;}

    .days{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .day{background:var(--chip-bg);border:1px dashed var(--border);border-radius:12px;padding:10px;text-align:center;cursor:pointer;min-height:64px;display:flex;flex-direction:column;gap:6px;justify-content:center}
    .day .d1{font-size:15px;}
    .day .d2{font-size:12px;color:var(--muted)}
    .day.shabbat{opacity:.35;cursor:not-allowed; border:none; background:transparent;}
    .day.fri{background:var(--fri-bg);border-color:var(--fri-br)}
    .day.state-1{background:var(--warn-bg);border:1px solid var(--warn-br)}
    .day.state-2{background:var(--bad-bg);border:1px solid var(--bad-br)}
    .hint{color:var(--muted);font-size:12px;margin-top:8px}

    .schedule{display:grid;grid-template-columns:minmax(90px,9ch) repeat(6,minmax(0,1fr));gap:10px;align-items:stretch}
    @media (max-width:1500px){.schedule{grid-template-columns:minmax(90px,9ch) repeat(3,minmax(0,1fr))}}
    @media (max-width:700px){.schedule{grid-template-columns:1fr}.schedule .col-hd{display:none}}
    .col-hd{font-size:13px;color:var(--muted);text-align:center;white-space:nowrap}

    .slot{background:var(--chip-bg);border:1px solid var(--border);border-radius:12px;min-height:88px;padding:10px;display:flex;flex-direction:column;gap:8px;min-width:0}
    .slot.fri{background:var(--fri-bg);border-color:var(--fri-br)}
    .slot .datebox{border:1px solid var(--border);border-radius:10px;padding:8px 10px;background:color-mix(in oklab,var(--chip-bg) 90%, transparent)}
    .slot .datebox .d-top{font-size:16px;font-weight:700}
    .slot .datebox .d-time{font-size:12px;color:var(--muted);margin-top:2px}
    .pill{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:var(--pill-bg);white-space:nowrap}
    .pill.ok{background:var(--ok-bg);border-color:var(--ok-br);color:var(--ok-ink)}
    .pill.bad{background:var(--bad-bg);border-color:var(--bad-br);color:var(--bad-ink)}
    .pill.warn{background:var(--warn-bg);border-color:var(--warn-br);color:var(--warn-ink)}

    .constraints{align-self:start; position:sticky; top:92px}
    .constraints .bd{max-height:calc(100vh - 132px); overflow:auto}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal{width:min(560px,92vw);background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 24px 60px rgba(0,0,0,.35);padding:18px}
    .modal h2{margin:0 0 6px 0}.modal p{margin:0 0 12px 0;color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:12px}
    .select,.date{background:var(--chip-bg);color:var(--ink);border:1px solid var(--border);padding:10px 12px;border-radius:10px;min-width:auto;font-weight:600; width:100%; font-family:inherit;}
    .checkbox{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;cursor:pointer;background:var(--chip-bg);border:1px solid var(--border);border-radius:10px; width:100%;}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    .admin-bar{position:fixed;left:12px;top:12px;z-index:10000;display:flex;gap:8px;flex-wrap:wrap}
    .toast-wrap{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;z-index:10050;display:flex;flex-direction:column;gap:8px;pointer-events:none}
    .toast{pointer-events:auto;min-width:260px;max-width:min(92vw,520px);border-radius:14px;border:1px solid var(--toast-br);background:var(--toast-bg);color:var(--toast-ink);padding:12px 14px;box-shadow:0 18px 40px rgba(0,0,0,.35);display:flex;align-items:flex-start;gap:10px}
    .hidden { display: none !important; }
    
    /* Manual Mode Select */
    .assign-select { background:var(--chip-bg); color:var(--ink); border:1px solid var(--accent); padding:4px; border-radius:8px; width:100%; font-family:inherit; }
  </style>
</head>
<body>
  <!-- admin -->
  <div class="admin-bar">
    <button id="adminBtn" class="icon-btn hidden" title="××¦×‘ × ×™×”×•×œ">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"/>
        <path d="M19.4 15a1.8 1.8 0 0 0 .36 1.98l.05.05a2 2 0 1 1-2.83 2.83l-.05-.05A1.8 1.8 0 0 0 15 19.4a1.8 1.8 0 0 0-1 .2 1.8 1.8 0 0 0-.9 1.57V21a2 2 0 1 1-4 0v-.03A1.8 1.8 0 0 0 8.2 19.4 1.8 1.8 0 0 0 7 19.4a1.8 1.8 0 0 0-1.98.36l-.05.05a2 2 0 1 1-2.83-2.83l.05-.05A1.8 1.8 0 0 0 4.6 15a1.8 1.8 0 0 0-.2-1 1.8 1.8 0 0 0-1.57-.9H2a2 2 0 1 1 0-4h.03A1.8 1.8 0 0 0 4.6 8.2a1.8 1.8 0 0 0 .2-1A1.8 1.8 0 0 0 4.44 5.2l-.05-.05A2 2 0 1 1 7.22 2.3l.05.05A1.8 1.8 0 0 0 9 4.6c.31.05.66.05 1 0A1.8 1.8 0 0 0 10.9 3V3a2 2 0 1 1 4 0v.03a1.8 1.8 0 0 0 .9 1.57c.34.17.69.24 1 .2a1.8 1.8 0 0 0 1.98-.36l.05-.05a2 2 0 1 1 2.83 2.83l-.05.05A1.8 1.8 0 0 0 19.4 9c.05.34 0 .69-.2 1 .17.34.24.69.2 1 .05.31.05.66 0 1Z"/>
      </svg>
    </button>
  </div>

  <div class="app">
    <header class="header">
      <div>
        <h1 class="title">×œ×•×— ×©×™×‘×•×¦×™× ×—×•×“×©×™ - ×¡×“× ×”</h1>
        <div class="group-tabs" id="groupTabs"></div>
      </div>
      <div class="header-actions">
        <span id="whoami" class="id-badge">×œ× ××—×•×‘×¨</span>
      </div>
    </header>

    <main class="two">
      <!-- constraints (Original Order: Left Side was Constraints in Layout, but requested "Original" which had them split. Let's stick to the Two-Column Grid) -->
      <section class="panel constraints">
        <div class="hd">
          <h3>××™×œ×•×¦×™×</h3>
          <div class="legend">
            <span class="dot dot-0"></span> ×–××™×Ÿ
            <span class="dot dot-1"></span> ××¢×“×™×£ ×©×œ×
            <span class="dot dot-2"></span> ×œ× ×–××™×Ÿ
          </div>
        </div>
        <div class="bd">
          <div id="peopleChips" class="people"></div>
          
          <div class="days" style="grid-template-columns:repeat(7,1fr); text-align:center; margin-bottom:5px; color:var(--muted); font-size:12px">
             <div>×</div><div>×‘</div><div>×’</div><div>×“</div><div>×”</div><div>×•</div><div style="color:#f87171">×©</div>
          </div>
          <div id="daysGrid" class="days"></div>
          
          <p class="hint">×˜×¤×™×—×” ×¢×œ ×™×•× ××—×œ×™×¤×” ××¦×‘. ×”× ×ª×•× ×™× × ×©××¨×™× ×‘×¢× ×Ÿ.</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="saveBtn">×©××•×¨ ×©×™× ×•×™×™×</button>
            <button id="resetMineBtn" class="ghost">××¤×¡ ×‘×—×™×¨×”</button>
          </div>
        </div>
      </section>

      <!-- schedule -->
      <section class="panel schedule-panel">
        <div class="hd" style="display:flex;align-items:center">
          <h3 style="margin-inline-end:12px">×œ×•×— ×©×™×‘×•×¦×™×</h3>
          <span id="dateRangeBadge" class="badge" style="margin-inline-end:auto"></span>
          <span id="lockedBadge" class="badge" style="color:var(--bad-ink); border-color:var(--bad-br); display:none">ğŸ”’ × ×¢×•×œ</span>

          <button id="exportBtn" class="ghost">×™×¦×•× CSV</button>
        </div>
        <div class="bd">
          <div id="scheduleGrid" class="schedule"></div>
          <div id="summaryBox" style="margin-top:12px"></div>
        </div>
      </section>
    </main>
  </div>

  <!-- Toasts -->
  <div id="toastWrap" class="toast-wrap" aria-live="polite"></div>

  <!-- Identity Modal -->
  <div id="identityBackdrop" class="modal-backdrop">
    <div class="modal">
      <h2>××™ ××ª×”?</h2>
      <p>×‘×—×¨ ×©× ××©×ª××© ×œ×¢×¨×™×›×”.</p>
      <div class="row">
        <select id="identitySelect" class="select"><option value="">×˜×•×¢×Ÿ...</option></select>
      </div>
      <div class="actions"><button id="identityStartBtn" type="button">×”×ª×—×œ</button></div>
    </div>
  </div>

  <!-- Admin Modal -->
  <div id="adminBackdrop" class="modal-backdrop">
    <div class="modal">
      <h2>×”×’×“×¨×•×ª × ×™×”×•×œ: <span id="adminGroupName"></span></h2>
      <div class="row">
        <label>×ª××¨×™×š ×”×ª×—×œ×”</label>
        <input id="dateInput" class="date" type="date" />
      </div>
      <div class="row">
        <label>××©×š ×–××Ÿ</label>
        <select id="durationSelect" class="select">
           <option value="1">×©×‘×•×¢ ××—×“</option>
           <option value="2">×©×‘×•×¢×™×™×</option>
           <option value="3">3 ×©×‘×•×¢×•×ª</option>
           <option value="4">4 ×©×‘×•×¢×•×ª</option>
        </select>
      </div>
      <div class="row">
        <label>× ×¢×•×œ ×œ×¢×¨×™×›×” ×¢×“</label>
        <input id="lockInput" class="date" type="date" />
      </div>
      
      <!-- Feature Flags -->
      <div class="row">
        <label class="checkbox">
          <input type="checkbox" id="manualModeChk">
          ××¦×‘ ×©×™× ×•×™ ×™×“× ×™ (×××¤×©×¨ ×‘×—×™×¨×” ×—×•×¤×©×™×ª ×‘×œ×•×—)
        </label>
      </div>
      <div class="row">
        <label class="checkbox">
          <input type="checkbox" id="manualBypassChk">
          ××¢×§×£ ×—×•×§×™ ××™×–×•×Ÿ (×‘×˜×œ ×—×™×©×•×‘ ×—×›× ×‘×¢×ª ×©×™× ×•×™ ×™×“× ×™)
        </label>
      </div>

      <div class="row">
        <button id="adminResetBtn" class="ghost" style="border-color:#f00;color:#fca5a5; width:100%" type="button">××™×¤×•×¡ ×˜×‘×œ×” (×œ×˜×•×•×— ×”×¤×¢×™×œ)</button>
      </div>
      <div class="actions">
        <button id="adminCancelBtn" class="ghost" type="button">×¡×’×•×¨</button>
        <button id="adminSaveBtn" type="button">×©××•×¨</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, getDocs, deleteDoc, collection, query, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyBiZIHRpbg0bq4VFZ2kDDXj6QeRJZpjOpg",
      authDomain: "sadna-timetable.firebaseapp.com",
      projectId: "sadna-timetable",
      storageBucket: "sadna-timetable.firebasestorage.app",
      messagingSenderId: "605203492621",
      appId: "1:605203492621:web:7ed83f0e5e64d67b9c8a44",
      measurementId: "G-8941L7ZZJ6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const GROUPS = ["××“×¤×¡×•×ª", "×ª×¤×™×¨×”", "××ª×›×ª", "×¢×™×‘×•×“ ×©×‘×‘×™×", "×¢×¥"];
    const USERS_DB = [
        {id:"u1", name:"× ×‘×•", group:"××“×¤×¡×•×ª", role:"admin"},
        {id:"u2", name:"× ×˜×¢", group:"××“×¤×¡×•×ª", role:"user"},
        {id:"u3", name:"×˜×œ", group:"××“×¤×¡×•×ª", role:"user"},
        {id:"u4", name:"×›×œ×™×œ", group:"×ª×¤×™×¨×”", role:"user"},
        {id:"u5", name:"×¢××™×ª", group:"×ª×¤×™×¨×”", role:"user"},
        {id:"u6", name:"×©×™×¨×”", group:"×ª×¤×™×¨×”", role:"user"},
        {id:"u7", name:"×××™", group:"××ª×›×ª", role:"user"},
        {id:"u8", name:"×œ×™×¢×“", group:"×¢×™×‘×•×“ ×©×‘×‘×™×", role:"user"},
        {id:"u9", name:"××•×¨×™", group:"×¢×¥", role:"user"}
    ];

    const MS_DAY = 86400000;
    const hebDaysLong=["×¨××©×•×Ÿ","×©× ×™","×©×œ×™×©×™","×¨×‘×™×¢×™","×—××™×©×™","×©×™×©×™","×©×‘×ª"];
    const MIN_PER_PERSON = 2;

    // --- STATE ---
    let currentGroup = GROUPS[0];
    let currentUser = null; 
    let activePersonName = null; 
    let groupMembers = []; 
    let groupSettings = { startDate: startOfDay(new Date()), lockedUntil: null, weeks: 4, manualMode: false, manualBypass: false };
    
    let state = Object.create(null); // Constraints
    let manualOverrides = {}; // Manual Assignments
    let constraintsUnsub = null;
    let overridesUnsub = null;
    let settingsUnsub = null;

    // --- UTILS ---
    function startOfDay(d){ const c=new Date(d); c.setHours(0,0,0,0); return c; }
    function addDays(d,n){ return new Date(startOfDay(d).getTime() + n*MS_DAY); }
    function prevSunday(d){ let x=startOfDay(d); while(x.getDay()!==0){ x=addDays(x,-1);} return x; }
    function fmtDateKey(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0"); return `${y}-${m}-${dd}`; }
    function fmtDM(d){ const dd=String(d.getDate()).padStart(2,"0"), mm=String(d.getMonth()+1).padStart(2,"0"); return `${dd}.${mm}`; }
    function rangeDays(d0,d1){ const out=[]; let t=startOfDay(d0).getTime(), t1=startOfDay(d1).getTime(); for(;t<=t1;t+=MS_DAY) out.push(new Date(t)); return out; }
    function shiftForWeekday(jsDow){ if(jsDow>=0 && jsDow<=4) return {label:"16:00â€“22:00"}; if(jsDow===5) return {label:"08:00â€“14:00"}; return null; }
    function weekIndexFor(date, startD){ let s = prevSunday(startD); return Math.floor((startOfDay(date) - s) / (7*MS_DAY)); }
    function monthKeyFrom(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"); return `${y}-${m}`; }

    function toast(msg, type="ok") {
      const el = document.createElement("div");
      el.className = `toast ${type}`;
      el.innerHTML = `<div class="t-text">${msg}</div>`;
      document.getElementById("toastWrap").appendChild(el);
      setTimeout(()=> { el.style.opacity="0"; setTimeout(()=>el.remove(),300); }, 3000);
    }

    // --- INIT ---
    function init() {
      const tabs = document.getElementById("groupTabs");
      tabs.innerHTML = GROUPS.map(g => `<button class="tab-btn" onclick="window.switchGroup('${g}')">${g}</button>`).join("");
      
      const savedUid = localStorage.getItem("scheduler_uid");
      if(savedUid) {
        const u = USERS_DB.find(x => x.id === savedUid);
        if(u) loginUser(u);
        else showIdentityModal();
      } else {
        showIdentityModal();
      }
      if(!auth.currentUser) signInAnonymously(auth);
    }

    window.switchGroup = (g) => {
        currentGroup = g;
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.toggle("active", b.innerText===g));
        loadGroupData();
    };

    function loginUser(u) {
        currentUser = u;
        activePersonName = u.name;
        document.getElementById("whoami").textContent = `${u.name} (${u.group})`;
        
        if(u.group !== currentGroup) switchGroup(u.group);
        else { checkAdminAccess(); loadGroupData(); }
        
        document.getElementById("whoami").onclick = () => {
            if(confirm("×œ×”×ª× ×ª×§?")) { localStorage.removeItem("scheduler_uid"); location.reload(); }
        };
        document.getElementById("identityBackdrop").style.display="none";
    }

    // --- DATA LOADING ---
    async function loadGroupData() {
        groupMembers = USERS_DB.filter(u => u.group === currentGroup).map(u => u.name);
        
        if(settingsUnsub) settingsUnsub();
        settingsUnsub = onSnapshot(doc(db, "groups", currentGroup), async (snap) => {
            if(!snap.exists()) {
                await setDoc(doc(db, "groups", currentGroup), { startDate: fmtDateKey(new Date()), weeks: 4 });
                return;
            }
            const d = snap.data();
            
            if(d.startDate) {
                const [y,m,day] = d.startDate.split('-').map(Number);
                groupSettings.startDate = startOfDay(new Date(y,m-1,day));
            } else groupSettings.startDate = startOfDay(new Date());

            if(d.lockedUntil) {
                const [y,m,day] = d.lockedUntil.split('-').map(Number);
                groupSettings.lockedUntil = startOfDay(new Date(y,m-1,day));
            } else groupSettings.lockedUntil = null;

            groupSettings.weeks = d.weeks || 4;
            groupSettings.manualMode = !!d.manualMode;
            groupSettings.manualBypass = !!d.manualBypass;

            subscribeData();
        });
    }

    function subscribeData() {
        if(constraintsUnsub) constraintsUnsub();
        if(overridesUnsub) overridesUnsub();
        
        const mKey = monthKeyFrom(groupSettings.startDate);
        
        // Constraints
        constraintsUnsub = onSnapshot(collection(db, "groups", currentGroup, "constraints", mKey, "days"), (snap) => {
            state = {};
            snap.forEach(doc => state[doc.id] = doc.data());
            renderApp();
        });

        // Overrides
        overridesUnsub = onSnapshot(collection(db, "groups", currentGroup, "overrides", mKey, "days"), (snap) => {
            manualOverrides = {};
            snap.forEach(doc => manualOverrides[doc.id] = doc.data().assigned);
            renderApp();
        });
    }

    // --- RENDERING ---
    function renderApp() {
        const start = prevSunday(groupSettings.startDate);
        const end = addDays(start, (groupSettings.weeks*7)-1);
        
        // Header Info
        document.getElementById("dateRangeBadge").textContent = `${fmtDM(start)} â€“ ${fmtDM(end)}`;
        
        const isLocked = groupSettings.lockedUntil && new Date() < groupSettings.lockedUntil;
        document.getElementById("lockedBadge").style.display = isLocked ? "inline-flex" : "none";
        document.getElementById("saveBtn").disabled = isLocked && currentUser.role !== 'admin';

        checkAdminAccess();

        // Constraints
        const chipsEl = document.getElementById("peopleChips");
        chipsEl.innerHTML = groupMembers.map(p => 
            `<div class="chip ${p === activePersonName ? 'active' : ''}">${p}</div>`
        ).join("");

        let html = "";
        let curr = new Date(start);
        while(curr <= end) {
            const k = fmtDateKey(curr);
            const day = curr.getDay();
            const val = (state[k] && activePersonName) ? (state[k][activePersonName] || 0) : 0;
            
            let cls = "day";
            if(day===6) cls += " shabbat";
            else if(day===5) cls += " fri";
            if(val>0) cls += ` state-${val}`;
            
            html += `<div class="${cls}" onclick="toggleDay('${k}', ${day})">
                <div class="d1">${curr.getDate()}</div><div class="d2">${curr.getMonth()+1}</div>
            </div>`;
            curr = addDays(curr,1);
        }
        document.getElementById("daysGrid").innerHTML = html;

        // Schedule
        const pack = computeSchedule(start, end);
        renderScheduleGrid(pack, start, end);
        renderSummary(pack);
    }

    window.toggleDay = (k, day) => {
        if(day===6) return;
        if(!activePersonName) return toast("×”×ª×—×‘×¨ ×§×•×“×","warn");
        
        const isLocked = groupSettings.lockedUntil && new Date() < groupSettings.lockedUntil;
        if(isLocked && currentUser.role!=='admin') return toast("× ×¢×•×œ","warn");
        
        if(!state[k]) state[k]={};
        state[k][activePersonName] = ((state[k][activePersonName]||0)+1)%3;
        renderApp();
    };

    // --- ALGORITHM (The "Heavy" Logic) ---
    function computeSchedule(start, end) {
        const assign = {...manualOverrides}; // Start with overrides
        
        // If Manual Bypass is ON, don't run algorithm for non-overridden days
        if(groupSettings.manualBypass) {
             const counts = {}; groupMembers.forEach(m=>counts[m]={total:0, fri:0});
             const weeks = {};
             // Only count assignments
             for(let k in assign) {
                 const who = assign[k];
                 if(who) {
                     const d = new Date(k);
                     const wIdx = weekIndexFor(d, start);
                     if(!weeks[wIdx]) weeks[wIdx]={};
                     weeks[wIdx][who] = (weeks[wIdx][who]||0)+1;
                     counts[who].total++;
                     if(d.getDay()===5) counts[who].fri++;
                 }
             }
             return {assign, counts, weeks};
        }

        // Standard Algorithm
        const days = rangeDays(start, end);
        const totalCounts = Object.fromEntries(groupMembers.map(p=>[p,0]));
        const fridayCounts = Object.fromEntries(groupMembers.map(p=>[p,0]));
        const weekCounts = {};

        // Pre-fill counts from manual overrides
        for(let k in assign) {
            const who = assign[k];
            if(groupMembers.includes(who)) {
                totalCounts[who]++;
                const d = new Date(k);
                if(d.getDay()===5) fridayCounts[who]++;
                const w = weekIndexFor(d, start);
                if(!weekCounts[w]) weekCounts[w] = Object.fromEntries(groupMembers.map(p=>[p,0]));
                weekCounts[w][who]++;
            }
        }

        // --- Phase 1: Naive Assignment ---
        for(const d of days) {
            const k = fmtDateKey(d);
            if(d.getDay()===6 || assign[k]) continue; // Skip Shabbat or Overridden

            const wIdx = weekIndexFor(d, start);
            if(!weekCounts[wIdx]) weekCounts[wIdx] = Object.fromEntries(groupMembers.map(p=>[p,0]));

            let candidates = groupMembers.filter(p => (state[k]?.[p]||0) !== 2); // Not Red
            const greens = candidates.filter(p => (state[k]?.[p]||0) === 0); // Greens
            if(greens.length) candidates = greens;

            candidates.sort((a,b) => {
                if(d.getDay()===5) return fridayCounts[a] - fridayCounts[b];
                return totalCounts[a] - totalCounts[b];
            });

            if(candidates.length) {
                const winner = candidates[0];
                assign[k] = winner;
                totalCounts[winner]++;
                weekCounts[wIdx][winner]++;
                if(d.getDay()===5) fridayCounts[winner]++;
            }
        }

        // --- Phase 2: Balancing (Min shifts per week) ---
        // Simplified Logic from original: Try to give shifts to those under minimum
        for(let w in weekCounts) {
            for(let p of groupMembers) {
                if(weekCounts[w][p] < MIN_PER_PERSON) {
                    // Find a donor in this week
                    const dayToSteal = days.find(d => {
                        const k = fmtDateKey(d);
                        if(weekIndexFor(d, start)!=w) return false;
                        if(d.getDay()===6) return false;
                        if(manualOverrides[k]) return false; // Don't steal manual
                        
                        const currentOwner = assign[k];
                        if(currentOwner && currentOwner!==p && weekCounts[w][currentOwner] > MIN_PER_PERSON) {
                            // Check if 'p' can take it
                            return (state[k]?.[p]||0) !== 2;
                        }
                        return false;
                    });

                    if(dayToSteal) {
                        const k = fmtDateKey(dayToSteal);
                        const donor = assign[k];
                        assign[k] = p;
                        
                        weekCounts[w][p]++; weekCounts[w][donor]--;
                        totalCounts[p]++; totalCounts[donor]--;
                        if(dayToSteal.getDay()===5) { fridayCounts[p]++; fridayCounts[donor]--; }
                    }
                }
            }
        }

        return { assign, counts: Object.fromEntries(groupMembers.map(p=>[p, {total:totalCounts[p], fri:fridayCounts[p]}])), weeks: weekCounts };
    }

    function renderScheduleGrid(pack, start, end) {
        const { assign } = pack;
        let html = `<div class="col-hd"></div><div class="col-hd">××³</div><div class="col-hd">×‘×³</div><div class="col-hd">×’×³</div><div class="col-hd">×“×³</div><div class="col-hd">×”×³</div><div class="col-hd">×•×³</div>`;
        
        let weekStart = new Date(start);
        while(weekStart <= end) {
            const weekEnd = addDays(weekStart, 6);
            html += `<div style="display:flex;align-items:center;white-space:nowrap;font-size:12px;color:var(--muted)">${fmtDM(weekStart)}-${fmtDM(weekEnd)}</div>`;
            
            for(let i=0; i<6; i++) {
                const cur = addDays(weekStart, i);
                const k = fmtDateKey(cur);
                const isFri = (i===5);
                const shiftTime = isFri ? "08:00-14:00" : "16:00-22:00";
                const winner = assign[k];
                
                const row = state[k] || {};
                const oranges = groupMembers.filter(m => row[m]===1);
                const reds = groupMembers.filter(m => row[m]===2);
                let pills = "";
                if(oranges.length) pills += `<div class="pill warn">××¢×“×™×£ ×©×œ×: ${oranges.join(',')}</div>`;
                if(reds.length) pills += `<div class="pill bad">×œ×: ${reds.join(',')}</div>`;

                let assignHtml = `<div class="pill ${winner?'ok':'bad'}">${winner || '×¨×™×§'}</div>`;
                
                // Manual Mode Selector
                if(groupSettings.manualMode && currentUser?.role === 'admin') {
                    assignHtml = `<select class="assign-select" onchange="window.setOverride('${k}', this.value)">
                        <option value="">--</option>
                        ${groupMembers.map(m => `<option value="${m}" ${winner===m?'selected':''}>${m}</option>`).join('')}
                    </select>`;
                }

                html += `
                    <div class="slot ${isFri?'fri':''}">
                        <div class="datebox">
                            <div class="d-top"><b>${hebDaysLong[i]}</b> ${fmtDM(cur)}</div>
                            <div class="d-time">${shiftTime}</div>
                        </div>
                        ${assignHtml}
                        ${pills}
                    </div>
                `;
            }
            weekStart = addDays(weekStart, 7);
        }
        document.getElementById("scheduleGrid").innerHTML = html;
    }

    function renderSummary(pack) {
        const { counts, weeks } = pack;
        let html = `<table style="width:100%;border-collapse:collapse;font-size:14px"><thead><tr>
           <th style="text-align:right;padding:6px;border-bottom:1px solid var(--border)">×©×‘×•×¢</th>`;
        groupMembers.forEach(p => html += `<th style="text-align:center;padding:6px;border-bottom:1px solid var(--border)">${p}</th>`);
        html += `</tr></thead><tbody>`;

        Object.keys(weeks).sort().forEach((wIdx, i) => {
             html += `<tr><td style="padding:6px;border-bottom:1px solid var(--border)">×©×‘×•×¢ ${i+1}</td>`;
             groupMembers.forEach(p => {
                 html += `<td style="text-align:center;padding:6px;border-bottom:1px solid var(--border)">${weeks[wIdx][p]||0}</td>`;
             });
             html += `</tr>`;
        });
        
        html += `<tr style="font-weight:bold;background:var(--chip-bg)"><td style="padding:6px">×¡×”×´×› / ×©×™×©×™</td>`;
        groupMembers.forEach(p => {
            html += `<td style="text-align:center;padding:6px">${counts[p].total} / <span style="color:var(--accent)">${counts[p].fri}</span></td>`;
        });
        html += `</tr></tbody></table>`;
        document.getElementById("summaryBox").innerHTML = html;
    }

    // --- MANUAL OVERRIDES ---
    window.setOverride = async (dateKey, assignedTo) => {
        const mKey = monthKeyFrom(groupSettings.startDate);
        const ref = doc(db, "groups", currentGroup, "overrides", mKey, "days", dateKey);
        if(assignedTo) {
            await setDoc(ref, { assigned: assignedTo }, {merge:true});
        } else {
            await deleteDoc(ref);
        }
    };

    // --- ACTIONS ---
    document.getElementById("saveBtn").onclick = async () => {
        if(!currentUser) return;
        const mKey = monthKeyFrom(groupSettings.startDate);
        const batch = writeBatch(db);
        let c=0;
        for(const k in state) {
            if(state[k][currentUser.name] !== undefined) {
                const ref = doc(db, "groups", currentGroup, "constraints", mKey, "days", k);
                batch.set(ref, {[currentUser.name]: state[k][currentUser.name]}, {merge:true});
                c++;
            }
        }
        if(c) { await batch.commit(); toast("× ×©××¨"); }
    };

    document.getElementById("resetMineBtn").onclick = () => {
        for(let k in state) if(state[k][currentUser.name]) delete state[k][currentUser.name];
        renderApp();
    };

    // --- IDENTITY ---
    function showIdentityModal() {
        const s = document.getElementById("identitySelect");
        s.innerHTML = `<option value="">×‘×—×¨...</option>` + 
            [...USERS_DB].sort((a,b)=>a.group.localeCompare(b.group)).map(u=>`<option value="${u.id}">${u.name} (${u.group})</option>`).join("");
        document.getElementById("identityBackdrop").style.display="flex";
    }
    
    document.getElementById("identityStartBtn").onclick = () => {
        const uid = document.getElementById("identitySelect").value;
        if(uid) {
            localStorage.setItem("scheduler_uid", uid);
            loginUser(USERS_DB.find(x=>x.id===uid));
        }
    };

    function checkAdminAccess() {
        if(currentUser && currentUser.role==='admin' && currentUser.group===currentGroup) {
            document.getElementById("adminBtn").classList.remove("hidden");
        } else {
            document.getElementById("adminBtn").classList.add("hidden");
        }
    }

    // --- ADMIN PANEL ---
    document.getElementById("adminBtn").onclick = () => {
        document.getElementById("adminGroupName").innerText = currentGroup;
        document.getElementById("dateInput").value = fmtDateKey(groupSettings.startDate);
        document.getElementById("durationSelect").value = groupSettings.weeks;
        document.getElementById("lockInput").value = groupSettings.lockedUntil ? fmtDateKey(groupSettings.lockedUntil) : "";
        document.getElementById("manualModeChk").checked = groupSettings.manualMode;
        document.getElementById("manualBypassChk").checked = groupSettings.manualBypass;
        document.getElementById("adminBackdrop").style.display="flex";
    };

    document.getElementById("adminCancelBtn").onclick = () => document.getElementById("adminBackdrop").style.display="none";

    document.getElementById("adminSaveBtn").onclick = async () => {
        const s = document.getElementById("dateInput").value;
        const w = document.getElementById("durationSelect").value;
        const l = document.getElementById("lockInput").value;
        const mm = document.getElementById("manualModeChk").checked;
        const mb = document.getElementById("manualBypassChk").checked;
        
        await setDoc(doc(db, "groups", currentGroup), {
            startDate: s, weeks: Number(w), lockedUntil: l || "", manualMode: mm, manualBypass: mb
        }, {merge:true});
        
        document.getElementById("adminBackdrop").style.display="none";
        toast("×”×’×“×¨×•×ª × ×©××¨×•");
    };

    init();
  </script>
</body>
</html>
