<!DOCTYPE html>
<html lang="he" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>×œ×•×— ×©×™×‘×•×¦×™×</title>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9aa6b2;
      --border:#273244; --accent:#38bdf8; --accent2:#22d3ee;
      --chip-bg:#0b1222; --pill-bg:#122; --btn-ink:#06121c;
      --ok-bg:#032015; --ok-br:#0c3; --ok-ink:#b7f7cf;
      --warn-bg:#231e07; --warn-br:#54450a; --warn-ink:#fde68a;
      --bad-bg:#2b0a0a; --bad-br:#521; --bad-ink:#fecaca;
      --fri-bg:#0a1d2b; --fri-br:#224055;
      --toast-bg: rgba(15,23,42,.9); --toast-br:#2b3a55; --toast-ink:#e5e7eb;
    }
    html[data-theme="light"]{
      --bg:#f6f8fb; --card:#ffffff; --ink:#0b1222; --muted:#5b6472;
      --border:#dce3ea;
      --chip-bg:#f4f7fb; --pill-bg:#f6fafc;
      --toast-bg:#ffffff; --toast-br:#dce3ea; --toast-ink:#0b1222;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:"Assistant",system-ui;}
    .app{max-width:1600px;margin:0 auto;padding:16px 16px 56px;min-height:100vh}
    header.header{display:flex;justify-content:space-between;align-items:flex-start;gap:16px;flex-wrap:wrap}
    .title{margin:0;font-size:34px;font-weight:800}
    .sub{color:var(--muted);font-size:14px;margin-top:6px;margin-bottom:16px;display:block}
    .header-actions{display:flex;gap:8px;align-items:center}
    .id-badge{border:1px solid var(--border);padding:6px 12px;border-radius:999px;font-size:13px}
    button{cursor:pointer;border:none;border-radius:12px;padding:10px 14px;font-weight:700;background:linear-gradient(90deg,var(--accent),var(--accent2));color:var(--btn-ink)}
    button.ghost{background:transparent;border:1px solid var(--border);color:var(--ink)}
    .icon-btn{width:48px;height:48px;display:inline-flex;align-items:center;justify-content:center;border-radius:14px;background:var(--chip-bg);border:1px solid var(--border)}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .panel .hd{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
    .panel .bd{padding:16px}

    .split{display:grid;grid-template-columns:minmax(0,1.6fr) minmax(0,0.7fr);gap:16px}
    @media(max-width:1000px){.split{grid-template-columns:1fr}}

    .schedule-header{display:flex;gap:8px;align-items:center}
    .badge{border:1px solid var(--border);border-radius:999px;padding:5px 10px;font-size:13px;color:var(--muted)}
    .schedule{display:grid;grid-template-columns:minmax(90px,9ch) repeat(6, minmax(0,1fr));gap:10px}
    @media(max-width:1200px){.schedule{grid-template-columns:1fr}.schedule .col-hd{display:none}}
    .col-hd{text-align:center;color:var(--muted);font-size:13px}
    .slot{background:var(--chip-bg);border:1px solid var(--border);border-radius:12px;min-height:80px;padding:8px;display:flex;flex-direction:column;gap:6px}
    .slot.fri{background:var(--fri-bg);border-color:var(--fri-br)}
    .datebox{border:1px solid var(--border);border-radius:10px;padding:6px 8px}
    .datebox .d-top{font-weight:700}
    .pill{display:inline-flex;gap:6px;align-items:center;border-radius:999px;padding:4px 8px;border:1px solid var(--border);background:var(--pill-bg);font-size:12px}
    .pill.ok{background:var(--ok-bg);border-color:var(--ok-br);color:var(--ok-ink)}
    .pill.bad{background:var(--bad-bg);border-color:var(--bad-br);color:var(--bad-ink)}
    .pill.warn{background:var(--warn-bg);border-color:var(--warn-br);color:var(--warn-ink)}

    .days{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .day{background:var(--chip-bg);border:1px dashed var(--border);border-radius:12px;padding:10px;min-height:58px;cursor:pointer;display:flex;flex-direction:column;justify-content:center;gap:4px}
    .day.state-1{background:var(--warn-bg);border-color:var(--warn-br)}
    .day.state-2{background:var(--bad-bg);border-color:var(--bad-br)}
    .day.shabbat{opacity:.35;cursor:not-allowed}
    .legend{display:flex;gap:12px;font-size:13px;color:var(--muted)}
    .legend span.dot{width:14px;height:14px;border-radius:4px;border:1px solid var(--border);display:inline-block;margin-inline-end:4px}
    .dot.bg0{background:var(--chip-bg)}
    .dot.bg1{background:#231e07}
    .dot.bg2{background:#2b0a0a}

    .toast-wrap{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);z-index:10000;display:flex;flex-direction:column;gap:8px}
    .toast{background:var(--toast-bg);border:1px solid var(--toast-br);color:var(--toast-ink);padding:10px 14px;border-radius:14px;display:flex;gap:10px;align-items:flex-start;box-shadow:0 10px 40px rgba(0,0,0,.35);min-width:260px}
    .toast .btn{background:transparent;border:1px solid var(--border);border-radius:999px;padding:4px 10px}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal{background:var(--card);border:1px solid var(--border);border-radius:16px;max-width:540px;width:90%;padding:18px}
    .modal h2{margin-top:0}

    .bottom-tabs{position:fixed;bottom:0;left:0;right:0;background:rgba(7,11,20,.85);backdrop-filter:blur(10px);border-top:1px solid rgba(255,255,255,.05);display:flex;gap:8px;padding:6px 16px;overflow-x:auto}
    .tab{padding:6px 12px;border-radius:999px;border:1px solid transparent;color:#d1d5db;white-space:nowrap;cursor:pointer}
    .tab.active{background:#1f2937;border-color:#38bdf8;color:white}

    .chip{background:var(--chip-bg);border:1px solid var(--border);border-radius:999px;padding:6px 10px;cursor:pointer}
    .chip.active{outline:2px solid var(--accent)}
    #peopleChips{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap}

    .lock-pill{font-size:12px;padding:2px 6px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.05)}
    .admin-bar{position:fixed;left:16px;top:16px;z-index:10001;display:flex;gap:8px}
  </style>
</head>
<body>
  <!-- admin button -->
  <div class="admin-bar">
    <button id="adminBtn" class="icon-btn" title="×¤×× ×œ × ×™×”×•×œ">
      âš™ï¸
    </button>
  </div>

  <div class="app">
    <header class="header">
      <div>
        <h1 class="title">×œ×•×— ×©×™×‘×•×¦×™×</h1>
        <span class="sub" id="globalShiftDesc">××³â€“×”×³ 16:00â€“22:00 Â· ×•×³ 08:00â€“14:00 Â· ×©×‘×ª â€“ ××™×Ÿ ××©××¨×ª</span>
      </div>
      <div class="header-actions">
        <span id="whoami" class="id-badge">×œ× ××—×•×‘×¨</span>
        <button id="switchUserBtn" class="ghost">×”×—×œ×£ ××©×ª××©</button>
        <button id="themeBtn" class="icon-btn" title="××¦×‘ ×‘×”×™×¨/×›×”×”">
          <svg id="themeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"></svg>
        </button>
      </div>
    </header>

    <main class="split" style="margin-top:10px">
      <!-- schedule side -->
      <section class="panel">
        <div class="hd">
          <div class="schedule-header" style="gap:10px">
            <h3 style="margin:0" id="scheduleTitle">×œ×•×— ×©×™×‘×•×¦×™×</h3>
            <span id="dateRangeBadge" class="badge"></span>
            <span id="lockBadge" class="lock-pill" style="display:none;">ğŸ”’ ×œ×•×— × ×¢×•×œ</span>
          </div>
          <div style="margin-inline-start:auto;display:flex;gap:6px">
            <button id="computeBtn" class="ghost">×—×©×‘ ×©×™×‘×•×¥</button>
            <button id="exportBtn" class="ghost">×™×¦×•× CSV</button>
            <button id="shareBtn" class="ghost">×©×™×ª×•×£</button>
            <button id="addCalendarBtn" class="ghost">×”×•×¡×£ ×œ×™×•××Ÿ</button>
          </div>
        </div>
        <div class="bd">
          <div id="scheduleGrid" class="schedule"></div>
          <div id="summaryBox" style="margin-top:12px"></div>
        </div>
      </section>

      <!-- constraints side -->
      <section class="panel">
        <div class="hd" style="justify-content:space-between">
          <div>
            <h3 style="margin:0">××™×œ×•×¦×™× ×œ×˜×•×•×— ×”×¤×¢×™×œ</h3>
            <div class="legend" style="margin-top:4px">
              <span><span class="dot bg0"></span>×–××™×Ÿ</span>
              <span><span class="dot bg1"></span>××¢×“×™×£ ×©×œ×</span>
              <span><span class="dot bg2"></span>×œ× ×–××™×Ÿ</span>
            </div>
          </div>
        </div>
        <div class="bd">
          <div id="peopleChips"></div>
          <div id="daysGrid" class="days" style="margin-bottom:10px"></div>
          <p style="color:var(--muted);font-size:12px">×˜×¤×™×—×” ×¢×œ ×™×•× ××—×œ×™×¤×” ××¦×‘: ×–××™×Ÿ â†’ ××¢×“×™×£ ×©×œ× â†’ ×œ× ×–××™×Ÿ â†’ ×–××™×Ÿ.</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="saveBtn">×©××•×¨ ×œ×¢× ×Ÿ</button>
            <button id="resetMineBtn" class="ghost">××¤×¡ ××ª ×”××™×œ×•×¦×™× ×©×œ×™</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- bottom tabs -->
  <div id="bottomTabs" class="bottom-tabs"></div>

  <!-- user modal -->
  <div id="identityBackdrop" class="modal-backdrop">
    <div class="modal">
      <h2>×‘×—×¨ ××©×ª××©</h2>
      <p>×‘×—×¨ ××ª ×”×©× ×©×œ×š ××”×¨×©×™××”. (××™×Ÿ ×¡×™×¡××”)</p>
      <div class="row">
        <label for="identitySelect">××©×ª××©</label>
        <select id="identitySelect" style="width:100%;margin-top:6px;background:var(--chip-bg);border:1px solid var(--border);border-radius:10px;padding:8px"></select>
      </div>
      <p id="identityHint" style="color:var(--muted);font-size:13px;margin-top:10px">××™×Ÿ ××•×ª×š ×‘×¨×©×™××”? ×”×× ×”×œ ×™×›×•×œ ×œ×”×•×¡×™×£ ××•×ª×š ××¤×× ×œ ×”× ×™×”×•×œ.</p>
      <div style="display:flex;justify-content:flex-end;margin-top:12px">
        <button id="identityStartBtn">×”×ª×—×œ</button>
      </div>
    </div>
  </div>

  <!-- admin modal -->
  <div id="adminBackdrop" class="modal-backdrop">
    <div class="modal">
      <h2>× ×™×”×•×œ ×—×“×¨</h2>
      <p>×¨×§ ×× ×”×œ ×™×›×•×œ ×œ×©× ×•×ª ××ª ×–×”.</p>
      <div style="margin-bottom:8px">
        <label>×ª××¨×™×š ×”×ª×—×œ×”</label>
        <input id="adminStartDate" type="date" style="width:100%;margin-top:4px;background:var(--chip-bg);border:1px solid var(--border);border-radius:10px;padding:8px">
      </div>
      <div style="margin-bottom:8px">
        <label>×˜×•×•×— ×—×™×©×•×‘ (×‘×©×‘×•×¢×•×ª)</label>
        <input id="adminHorizon" type="number" min="1" max="6" value="4" style="width:100%;margin-top:4px;background:var(--chip-bg);border:1px solid var(--border);border-radius:10px;padding:8px">
      </div>
      <div style="margin-bottom:8px">
        <label>× ×¢×•×œ ×¢×“ (×¨×™×§ = ×œ× × ×¢×•×œ)</label>
        <input id="adminLockUntil" type="date" style="width:100%;margin-top:4px;background:var(--chip-bg);border:1px solid var(--border);border-radius:10px;padding:8px">
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="adminCloseBtn" class="ghost">×¡×’×•×¨</button>
        <button id="adminSaveBtn">×©××•×¨</button>
      </div>
    </div>
  </div>

  <!-- toasts -->
  <div id="toastWrap" class="toast-wrap" aria-live="polite"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, getDocs, collection, query, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // ===== Firebase config (×—×“×©) =====
    const firebaseConfig = {
      apiKey: "AIzaSyBiZIHRpbg0bq4VFZ2kDDXj6QeRJZpjOpg",
      authDomain: "sadna-timetable.firebaseapp.com",
      projectId: "sadna-timetable",
      storageBucket: "sadna-timetable.firebasestorage.app",
      messagingSenderId: "605203492621",
      appId: "1:605203492621:web:7ed83f0e5e64d67b9c8a44",
      measurementId: "G-8941L7ZZJ6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // ===== ×”×—×“×¨×™× ×•×”×× ×©×™× ×©× ×ª×ª =====
    const DEFAULT_GROUPS = {
      "××“×¤×¡×•×ª": { name: "××“×¤×¡×•×ª", people: ["× ×‘×•","× ×˜×¢","×˜×œ"], horizonWeeks: 4 },
      "×ª×¤×™×¨×”": { name: "×ª×¤×™×¨×”", people: ["×›×œ×™×œ","×¢××™×ª","×©×™×¨×”"], horizonWeeks: 4 },
      "××ª×›×ª": { name: "××ª×›×ª", people: ["×××™"], horizonWeeks: 4 },
      "×¢×™×‘×•×“ ×©×‘×‘×™×": { name: "×¢×™×‘×•×“ ×©×‘×‘×™×", people: ["×œ×™×¢×“"], horizonWeeks: 4 },
      "×¢×¥": { name: "×¢×¥", people: ["××•×¨×™"], horizonWeeks: 4 }
    };

    // × ×¢×©×” ×’× ××©×ª××©×™× ×“×™×¤×•×œ×˜×™×™×
    const DEFAULT_USERS = [
      { id: "u-navo", name: "× ×‘×•", group: "××“×¤×¡×•×ª", role: "admin" },
      { id: "u-neta", name: "× ×˜×¢", group: "××“×¤×¡×•×ª", role: "user" },
      { id: "u-tal",  name: "×˜×œ",  group: "××“×¤×¡×•×ª", role: "user" },

      { id: "u-klil", name: "×›×œ×™×œ", group: "×ª×¤×™×¨×”", role: "user" },
      { id: "u-amit", name: "×¢××™×ª", group: "×ª×¤×™×¨×”", role: "user" },
      { id: "u-shira",name: "×©×™×¨×”", group: "×ª×¤×™×¨×”", role: "user" },

      { id: "u-mai",  name: "×××™", group: "××ª×›×ª", role: "user" },
      { id: "u-liad", name: "×œ×™×¢×“", group: "×¢×™×‘×•×“ ×©×‘×‘×™×", role: "user" },
      { id: "u-uri",  name: "××•×¨×™", group: "×¢×¥", role: "user" },
    ];

    // ===== Globals =====
    const MS_DAY = 86400000;
    const hebDaysLong=["×¨××©×•×Ÿ","×©× ×™","×©×œ×™×©×™","×¨×‘×™×¢×™","×—××™×©×™","×©×™×©×™","×©×‘×ª"];
    const MIN_PER_PERSON = 2;

    let activeUser = null;           // {id,name,group,role}
    let currentGroupId = null;       // string
    let currentGroupData = null;     // {startDate,horizonWeeks,lockedUntil,people:[]}
    let state = Object.create(null); // constraints for group+month
    let peopleInGroup = [];          // array of names defined for group
    let unsubConstraints = null;

    // ===== DOM =====
    const whoamiEl = document.getElementById("whoami");
    const switchUserBtn = document.getElementById("switchUserBtn");
    const themeBtn = document.getElementById("themeBtn");
    const themeIcon = document.getElementById("themeIcon");
    const daysGrid = document.getElementById("daysGrid");
    const scheduleGrid = document.getElementById("scheduleGrid");
    const dateRangeBadge = document.getElementById("dateRangeBadge");
    const bottomTabs = document.getElementById("bottomTabs");
    const saveBtn = document.getElementById("saveBtn");
    const resetMineBtn = document.getElementById("resetMineBtn");
    const computeBtn = document.getElementById("computeBtn");
    const exportBtn = document.getElementById("exportBtn");
    const shareBtn = document.getElementById("shareBtn");
    const addCalendarBtn = document.getElementById("addCalendarBtn");
    const summaryBox = document.getElementById("summaryBox");
    const toastWrap = document.getElementById("toastWrap");
    const peopleChips = document.getElementById("peopleChips");
    const identityBackdrop = document.getElementById("identityBackdrop");
    const identitySelect = document.getElementById("identitySelect");
    const identityStartBtn = document.getElementById("identityStartBtn");
    const scheduleTitle = document.getElementById("scheduleTitle");
    const lockBadge = document.getElementById("lockBadge");
    const adminBtn = document.getElementById("adminBtn");
    const adminBackdrop = document.getElementById("adminBackdrop");
    const adminStartDate = document.getElementById("adminStartDate");
    const adminHorizon = document.getElementById("adminHorizon");
    const adminLockUntil = document.getElementById("adminLockUntil");
    const adminSaveBtn = document.getElementById("adminSaveBtn");
    const adminCloseBtn = document.getElementById("adminCloseBtn");

    // ===== Theme init =====
    const savedTheme = localStorage.getItem("scheduler_theme");
    if(savedTheme){ document.documentElement.setAttribute("data-theme", savedTheme); }
    renderThemeIcon();
    themeBtn.addEventListener("click", ()=> {
      const cur = document.documentElement.getAttribute("data-theme") || "dark";
      const next = cur === "dark" ? "light" : "dark";
      document.documentElement.setAttribute("data-theme", next);
      localStorage.setItem("scheduler_theme", next);
      renderThemeIcon();
    });
    function renderThemeIcon(){
      const mode = document.documentElement.getAttribute("data-theme") || "dark";
      themeIcon.innerHTML = mode === "dark"
        ? `<path d="M12 3v2M12 19v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M3 12h2M19 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/><circle cx="12" cy="12" r="4"/>`
        : `<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>`;
    }

    // ===== Utils =====
    function startOfDay(d){ const c=new Date(d); c.setHours(0,0,0,0); return c; }
    function addDays(d,n){ return new Date(startOfDay(d).getTime() + n*MS_DAY); }
    function prevSunday(d){ let x=startOfDay(d); while(x.getDay()!==0){ x=addDays(x,-1);} return x; }
    function fmtDateKey(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0"); return `${y}-${m}-${dd}`; }
    function fmtDM(d){ const dd=String(d.getDate()).padStart(2,"0"), mm=String(d.getMonth()+1).padStart(2,"0"); return `${dd}.${mm}`; }
    function rangeDays(d0,d1){ const out=[]; let t=d0.getTime(), t1=d1.getTime(); for(;t<=t1;t+=MS_DAY) out.push(new Date(t)); return out; }
    function shiftForWeekday(jsDow){ if(jsDow>=0 && jsDow<=4) return {label:"16:00â€“22:00"}; if(jsDow===5) return {label:"08:00â€“14:00"}; return null; }
    function weekIndexFor(date, startDate){ let s = prevSunday(startDate); return Math.floor((startOfDay(date) - s) / (7*MS_DAY)); }

    function toast(msg,type="ok"){
      const el = document.createElement("div");
      el.className = "toast " + type;
      el.innerHTML = `<div>${msg}</div><div class="t-actions"><button class="btn">×¡×’×•×¨</button></div>`;
      toastWrap.appendChild(el);
      const close = ()=>{ el.style.opacity="0"; el.style.transform="translateY(4px)"; setTimeout(()=>el.remove(),220); };
      el.querySelector(".btn").onclick = close;
      setTimeout(close, 3500);
    }

    // ===== Firestore helpers =====
    async function bootstrapIfEmpty(){
      // users
      const userSnap = await getDocs(collection(db,"users"));
      if(userSnap.empty){
        await Promise.all(DEFAULT_USERS.map(u=> setDoc(doc(db,"users",u.id),{
          name:u.name, group:u.group, role:u.role
        }, {merge:true})));
      }
      // groups
      const groupSnap = await getDocs(collection(db,"groups"));
      if(groupSnap.empty){
        const writes = [];
        for(const [id,g] of Object.entries(DEFAULT_GROUPS)){
          writes.push(setDoc(doc(db,"groups",id),{
            name:g.name,
            people:g.people,
            startDate: new Date().toISOString().slice(0,10),
            horizonWeeks: g.horizonWeeks,
            lockedUntil: ""
          },{merge:true}));
        }
        await Promise.all(writes);
      }
    }

    async function loadAllUsers(){
      const snap = await getDocs(collection(db, "users"));
      const arr = [];
      snap.forEach(d => arr.push({ id:d.id, ...d.data() }));
      window.__ALL_USERS__ = arr;
      identitySelect.innerHTML = arr.map(u=> `<option value="${u.id}">${u.name} (${u.group})${u.role==="admin"?" Â· ×× ×”×œ":""}</option>`).join("");
      return arr;
    }

    async function ensureGroupDoc(groupId){
      const gRef = doc(db, "groups", groupId);
      const gSnap = await getDoc(gRef);
      if(!gSnap.exists()){
        const def = DEFAULT_GROUPS[groupId] || {name:groupId,people:[],horizonWeeks:4};
        await setDoc(gRef, {
          name: def.name,
          people: def.people,
          startDate: new Date().toISOString().slice(0,10),
          horizonWeeks: def.horizonWeeks,
          lockedUntil: ""
        }, { merge:true });
        return (await getDoc(gRef)).data();
      }
      return gSnap.data();
    }

    async function loadConstraintsForGroup(groupId, gData){
      const startDate = startOfDay(new Date(gData?.startDate || new Date()));
      const weeks = gData?.horizonWeeks || 4;
      const endDate = addDays(startDate, weeks*7 - 1);
      const monthKey = `${startDate.getFullYear()}-${String(startDate.getMonth()+1).padStart(2,"0")}`;
      state = Object.create(null);
      const q = collection(db, "groups", groupId, "constraints", monthKey, "days");
      const snap = await getDocs(q);
      snap.forEach(d => state[d.id] = d.data());

      if(unsubConstraints){ unsubConstraints(); unsubConstraints=null; }
      unsubConstraints = onSnapshot(q, (ss)=>{
        ss.docChanges().forEach(ch=>{
          if(!state[ch.doc.id]) state[ch.doc.id]={};
          Object.assign(state[ch.doc.id], ch.doc.data());
        });
        renderCalendar();
        const pack = computeSchedule();
        renderSchedule(pack);
        renderSummary(pack);
      });

      renderDateBadge(startDate, endDate);
    }

    async function saveConstraints(){
      if(!activeUser){ toast("×‘×—×¨ ××©×ª××© ×§×•×“×.", "warn"); return; }
      if(isBoardLockedForUser()){ toast("×”×œ×•×— × ×¢×•×œ.", "warn"); return; }
      try{
        const gData = currentGroupData;
        const startDate = startOfDay(new Date(gData?.startDate || new Date()));
        const weeks = gData?.horizonWeeks || 4;
        const endDate = addDays(startDate, weeks*7 - 1);
        const monthKey = `${startDate.getFullYear()}-${String(startDate.getMonth()+1).padStart(2,"0")}`;
        const writes = [];
        for(const [dateKey,val] of Object.entries(state)){
          const clean = {};
          for(const p of peopleInGroup){ if(val[p]!==undefined) clean[p]=Number(val[p])||0; }
          writes.push(setDoc(doc(db, "groups", currentGroupId, "constraints", monthKey, "days", dateKey), clean, {merge:true}));
        }
        await Promise.all(writes);
        toast("× ×©××¨ ×‘×”×¦×œ×—×”.","ok");
      }catch(err){ console.error(err); toast("×©××™×¨×” × ×›×©×œ×”: " + err.message, "bad"); }
    }

    async function resetConstraints(){
      if(!activeUser){ toast("×‘×—×¨ ××©×ª××© ×§×•×“×.","warn"); return; }
      const gData = currentGroupData;
      const startDate = startOfDay(new Date(gData?.startDate || new Date()));
      const monthKey = `${startDate.getFullYear()}-${String(startDate.getMonth()+1).padStart(2,"0")}`;
      const q = collection(db, "groups", currentGroupId, "constraints", monthKey, "days");
      const snap = await getDocs(q);
      await Promise.all(snap.docs.map(d => deleteDoc(d.ref)));
      state = Object.create(null);
      renderCalendar();
      const p = computeSchedule(); renderSchedule(p); renderSummary(p);
    }

    // ===== Renderers =====
    function renderDateBadge(startDate, endDate){
      dateRangeBadge.textContent = `${fmtDM(startDate)} â€“ ${fmtDM(endDate)}`;
    }

    function renderPeopleChips(){
      peopleChips.innerHTML = peopleInGroup.map(name => {
        const active = (activeUser && activeUser.name === name);
        return `<button class="chip ${active?"active":""}" data-person="${name}">${name}</button>`;
      }).join("");
      peopleChips.querySelectorAll(".chip").forEach(btn=>{
        btn.addEventListener("click", ()=> {
          if(!activeUser) return;
          // ×¨×§ ×”××©×ª××© ×¢×¦××• ××• ××“××™×Ÿ ×™×›×•×œ ×œ×‘×—×•×¨
          if(activeUser.name !== btn.dataset.person && activeUser.role !== "admin") return;
          activeUser = { ...activeUser, name: btn.dataset.person };
          whoamiEl.textContent = `××ª×”: ${activeUser.name} (${activeUser.group})${activeUser.role==="admin"?" Â· ×× ×”×œ":""}`;
          renderPeopleChips();
          renderCalendar();
        });
      });
    }

    function renderCalendar(){
      const gData = currentGroupData;
      if(!gData) return;
      const startDate = startOfDay(new Date(gData?.startDate || new Date()));
      const weeks = gData?.horizonWeeks || 4;
      const endDate = addDays(startDate, weeks*7 - 1);
      const days = rangeDays(startDate, endDate);
      let html = "";
      for(const d of days){
        const key = fmtDateKey(d);
        const jsDow = d.getDay();
        const sh = shiftForWeekday(jsDow);
        const cur = state[key] || {};
        const val = activeUser ? Number(cur[activeUser.name] ?? 0) : 0;
        html += `
          <div class="day ${jsDow===6?"shabbat":""} state-${val}" data-key="${key}">
            <div>${hebDaysLong[jsDow]}, ${fmtDM(d)}</div>
            <div style="color:var(--muted);font-size:12px">${sh?sh.label:"â€”"}</div>
          </div>
        `;
      }
      daysGrid.innerHTML = html;

      daysGrid.querySelectorAll(".day").forEach(el=>{
        const key = el.dataset.key;
        const jsDow = new Date(key).getDay();
        if(jsDow===6) return;
        el.addEventListener("click", ()=>{
          if(!activeUser){ toast("×‘×—×¨ ××©×ª××© ×§×•×“×.", "warn"); return; }
          if(isBoardLockedForUser()){ toast("×”×œ×•×— × ×¢×•×œ.", "warn"); return; }
          const row = state[key] || {};
          const old = Number(row[activeUser.name] ?? 0);
          const next = (old + 1) % 3;
          row[activeUser.name] = next;
          state[key] = row;
          el.classList.remove("state-0","state-1","state-2");
          el.classList.add("state-"+next);
        });
      });
    }

    function renderSchedule(pack){
      const gData = currentGroupData;
      if(!gData){ scheduleGrid.innerHTML=""; return; }
      const startDate = startOfDay(new Date(gData?.startDate || new Date()));
      const weeks = gData?.horizonWeeks || 4;
      const endDate = addDays(startDate, weeks*7 - 1);

      const assign = pack.assign;
      let html = `
        <div></div>
        <div class="col-hd">××³</div>
        <div class="col-hd">×‘×³</div>
        <div class="col-hd">×’×³</div>
        <div class="col-hd">×“×³</div>
        <div class="col-hd">×”×³</div>
        <div class="col-hd">×•×³</div>
      `;
      let weekStart = prevSunday(startDate);
      let guard=0;
      while(weekStart <= endDate && guard++<80){
        const weekEnd = addDays(weekStart,6);
        const rowLabel = `${fmtDM(weekStart)} â€“ ${fmtDM(weekEnd)}`;
        html += `<div style="display:flex;align-items:center">${rowLabel}</div>`;
        for(let i=0;i<6;i++){
          const cur = addDays(weekStart,i);
          const key = fmtDateKey(cur);
          const inRange = cur>=startDate && cur<=endDate;
          const sh = shiftForWeekday(cur.getDay());
          if(!inRange || !sh){
            html += `<div class="slot" style="opacity:.35"><div class="datebox"><div class="d-top">${hebDaysLong[cur.getDay()]}, ${fmtDM(cur)}</div><div class="d-time">××™×Ÿ ××©××¨×ª</div></div></div>`;
          }else{
            const who = assign[key] || null;
            const row = state[key] || {};
            const absent = peopleInGroup.filter(p => Number(row[p]??0)===2);
            const prefer = peopleInGroup.filter(p => Number(row[p]??0)===1);
            const isFriday = cur.getDay()===5;
            html += `
              <div class="slot ${isFriday?'fri':''}">
                <div class="datebox">
                  <div class="d-top">${hebDaysLong[cur.getDay()]}, ${fmtDM(cur)}</div>
                  <div class="d-time">${sh.label}</div>
                </div>
                <div class="${who ? 'pill ok':'pill bad'}">${who ? `××©×•×‘×¥: <b>${who}</b>` : 'âŒ ××™×Ÿ ××©×•×‘×¥'}</div>
                ${prefer.length ? `<div class="pill warn">××¢×“×™×¤×™× ×©×œ×: ${prefer.join(", ")}</div>` : ``}
                ${absent.length ? `<div class="pill bad">×œ× ×–××™× ×™×: ${absent.join(", ")}</div>` : ``}
              </div>
            `;
          }
        }
        weekStart = addDays(weekStart,7);
      }
      scheduleGrid.innerHTML = html;
    }

    function renderSummary(pack){
      const { weekCounts, fridayCounts } = pack;
      const html = `
        <div class="panel" style="margin-top:10px">
          <div class="hd"><h3 style="margin:0">×¡×™×›×•× ×©×‘×•×¢×™ + ×™××™ ×©×™×©×™</h3></div>
          <div class="bd">
            <table style="width:100%;border-collapse:collapse;font-size:14px">
              <thead>
                <tr>
                  <th style="text-align:right;border-bottom:1px solid var(--border);padding:4px">×©×‘×•×¢</th>
                  ${peopleInGroup.map(p=>`<th style="text-align:center;border-bottom:1px solid var(--border);padding:4px">${p}</th>`).join("")}
                </tr>
              </thead>
              <tbody>
                ${weekCounts.map((wc,idx)=> `
                  <tr>
                    <td style="padding:4px;border-bottom:1px solid var(--border)">×©×‘×•×¢ ${idx+1}</td>
                    ${peopleInGroup.map(p=> `<td style="text-align:center;padding:4px;border-bottom:1px solid var(--border)">${wc?.[p] ?? 0}</td>`).join("")}
                  </tr>
                `).join("")}
              </tbody>
            </table>
            <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:8px">
              ${peopleInGroup.map(p=> `<div class="pill">${p}: ×©×™×©×™ <b>${fridayCounts?.[p] ?? 0}</b></div>`).join("")}
            </div>
          </div>
        </div>
      `;
      summaryBox.innerHTML = html;
    }

    // ===== Logic =====
    function canAssign(person, dateKey){
      const row = state[dateKey] || {};
      return Number(row[person] ?? 0) !== 2;
    }

    function computeSchedule(){
      const gData = currentGroupData;
      if(!gData) return {assign:{},weekCounts:[],fridayCounts:{},totalCounts:{}};
      const startDate = startOfDay(new Date(gData?.startDate || new Date()));
      const weeks = gData?.horizonWeeks || 4;
      const endDate = addDays(startDate, weeks*7 - 1);
      const days = rangeDays(startDate, endDate);

      const assign = {};
      const totalCounts  = Object.fromEntries(peopleInGroup.map(p=>[p,0]));
      const fridayCounts = Object.fromEntries(peopleInGroup.map(p=>[p,0]));
      const weekCounts   = [];

      const prefVal = (dayKey, person)=> Number((state[dayKey] || {})[person] ?? 0);
      const hasOtherZero = (dayKey, exceptPerson)=>{
        const row = state[dayKey] || {};
        return peopleInGroup.some(p => p !== exceptPerson && Number(row[p] ?? 0) === 0);
      };
      const isFridayKey = (k)=> new Date(k).getDay()===5;
      const ensureWeek = (idx)=>{ if(!weekCounts[idx]) weekCounts[idx] = Object.fromEntries(peopleInGroup.map(p=>[p,0])); };

      // ×©×œ×‘ 1: ×’×¨×™×“×™
      for(const d of days){
        const jsDow = d.getDay();
        const sh = shiftForWeekday(jsDow);
        if(!sh) continue;
        const key = fmtDateKey(d);
        const row = state[key] || {};
        const available0 = peopleInGroup.filter(p => Number(row[p] ?? 0) === 0);
        const prefer1    = peopleInGroup.filter(p => Number(row[p] ?? 0) === 1);
        const wIdx = weekIndexFor(d, startDate); ensureWeek(wIdx);
        let candidates = [];
        if(available0.length) candidates = available0.slice();
        else if(prefer1.length) candidates = prefer1.slice();

        if(candidates.length){
          candidates.sort((a,b)=>{
            if(jsDow===5){
              if(fridayCounts[a] !== fridayCounts[b]) return fridayCounts[a] - fridayCounts[b];
            }
            if(weekCounts[wIdx][a] !== weekCounts[wIdx][b]) return weekCounts[wIdx][a] - weekCounts[wIdx][b];
            return totalCounts[a] - totalCounts[b];
          });
          const pick = candidates[0];
          assign[key] = pick;
          totalCounts[pick]++; weekCounts[wIdx][pick] = (weekCounts[wIdx][pick]||0)+1;
          if(jsDow===5) fridayCounts[pick]++;
        }else{
          assign[key] = null;
        }
      }

      // ×§×‘×•×¦×ª ××¤×ª ×©×‘×•×¢ -> ×™××™×
      const allKeys = Object.keys(assign);
      const keysByWeek = {};
      for(const k of allKeys){
        const wIdx = weekIndexFor(new Date(k), startDate); ensureWeek(wIdx);
        (keysByWeek[wIdx] ||= []).push(k);
      }

      // ×©×œ×‘ 2: ×œ×¤×—×•×ª 2 ×‘×©×‘×•×¢
      for(const wIdxStr of Object.keys(keysByWeek)){
        const wIdx = Number(wIdxStr);
        const weekKeys = keysByWeek[wIdx];

        for(const person of peopleInGroup){
          while((weekCounts[wIdx][person] || 0) < MIN_PER_PERSON){
            // ×§×•×“× × ×¡×” ×™×•× ×¨×™×§
            const empty = weekKeys.find(k => !assign[k] && canAssign(person,k));
            if(empty){
              const pref = prefVal(empty, person);
              if(!(pref === 1 && hasOtherZero(empty, person))){
                assign[empty] = person;
                weekCounts[wIdx][person] = (weekCounts[wIdx][person]||0)+1;
                totalCounts[person]++;
                if(isFridayKey(empty)) fridayCounts[person]++;
                continue;
              }
            }

            // ××™×Ÿ ×™×•× ×¨×™×§ â€“ ×œ×§×—×ª ××ª×•×¨×
            const donors = peopleInGroup
              .filter(p => p !== person && (weekCounts[wIdx][p]||0) > MIN_PER_PERSON)
              .sort((a,b)=> (weekCounts[wIdx][b]||0) - (weekCounts[wIdx][a]||0));
            let moved = false;
            for(const donor of donors){
              const bucket1 = weekKeys.filter(k => assign[k]===donor && !isFridayKey(k));
              const bucket2 = weekKeys.filter(k => assign[k]===donor &&  isFridayKey(k));
              const buckets = [bucket1, bucket2];
              for(const bucket of buckets){
                const sorted = bucket.slice().sort((a,b)=> prefVal(a,person) - prefVal(b,person));
                for(const dayKey of sorted){
                  if(!canAssign(person, dayKey)) continue;
                  const pref = prefVal(dayKey, person);
                  if(pref === 1 && hasOtherZero(dayKey, person)) continue;
                  assign[dayKey] = person;
                  weekCounts[wIdx][person] = (weekCounts[wIdx][person]||0)+1;
                  weekCounts[wIdx][donor]  = (weekCounts[wIdx][donor]||0)-1;
                  totalCounts[person]++; totalCounts[donor]--;
                  if(isFridayKey(dayKey)){ fridayCounts[person]++; fridayCounts[donor]--; }
                  moved = true;
                  break;
                }
                if(moved) break;
              }
              if(moved) break;
            }
            if(!moved) break;
          }
        }
      }

      // ×©×œ×‘ 3: ××™×–×•×Ÿ ×©×™×©×™
      let guard = 0;
      while(guard++ < 40){
        let maxP = peopleInGroup[0], minP = peopleInGroup[0];
        for(const p of peopleInGroup){
          if(fridayCounts[p] > fridayCounts[maxP]) maxP = p;
          if(fridayCounts[p] < fridayCounts[minP]) minP = p;
        }
        if(fridayCounts[maxP] - fridayCounts[minP] <= 1) break;

        const fridayKeysOfMax = allKeys.filter(k => assign[k]===maxP && isFridayKey(k));
        let balanced = false;

        for(const fk of fridayKeysOfMax){
          const wf = weekIndexFor(new Date(fk), startDate);
          const prefMin = prefVal(fk, minP);
          if(!canAssign(minP, fk)) continue;
          if(prefMin === 1 && hasOtherZero(fk, minP)) continue;

          if((weekCounts[wf][minP]||0) < MIN_PER_PERSON){
            assign[fk] = minP;
            weekCounts[wf][minP] = (weekCounts[wf][minP]||0)+1;
            weekCounts[wf][maxP] = (weekCounts[wf][maxP]||0)-1;
            fridayCounts[minP]++; fridayCounts[maxP]--;
            totalCounts[minP]++; totalCounts[maxP]--;
            balanced = true;
            break;
          }

          const minWeekdays = allKeys.filter(k => assign[k]===minP && !isFridayKey(k));
          for(const day2 of minWeekdays){
            const w2 = weekIndexFor(new Date(day2), startDate);
            if(!canAssign(maxP, day2)) continue;
            const prefMaxDay2 = prefVal(day2, maxP);
            if(prefMaxDay2 === 1 && hasOtherZero(day2, maxP)) continue;
            const maxWeekAfterFri = (weekCounts[wf][maxP]||0) - 1;
            const minWeekAfterDay2 = (weekCounts[w2][minP]||0) - 1;
            if(maxWeekAfterFri < MIN_PER_PERSON) continue;
            if(minWeekAfterDay2 < MIN_PER_PERSON) continue;

            assign[fk] = minP;
            assign[day2] = maxP;
            fridayCounts[minP]++; fridayCounts[maxP]--;
            weekCounts[wf][minP] = (weekCounts[wf][minP]||0)+1;
            weekCounts[wf][maxP] = (weekCounts[wf][maxP]||0)-1;
            weekCounts[w2][maxP] = (weekCounts[w2][maxP]||0)+1;
            weekCounts[w2][minP] = (weekCounts[w2][minP]||0)-1;
            totalCounts[minP]++; totalCounts[maxP]--;
            balanced = true;
            break;
          }
          if(balanced) break;
        }
        if(!balanced) break;
      }

      return { assign, weekCounts, fridayCounts, totalCounts };
    }

    // ===== ICS / CSV / Share =====
    function exportCSV(pack){
      const gData = currentGroupData;
      const startDate = startOfDay(new Date(gData?.startDate || new Date()));
      const weeks = gData?.horizonWeeks || 4;
      const endDate = addDays(startDate, weeks*7 - 1);
      const { assign } = pack;
      const days = rangeDays(startDate, endDate);
      const rows = [["×ª××¨×™×š","×™×•×","××©××¨×ª","××©×•×‘×¥"]];
      for(const d of days){
        const sh = shiftForWeekday(d.getDay());
        if(!sh) continue;
        const key = fmtDateKey(d);
        rows.push([fmtDM(d), hebDaysLong[d.getDay()], sh.label, assign[key]||""]);
      }
      const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\r\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `schedule_${currentGroupId}.csv`;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 300);
      toast("CSV ×”×•×¤×§ ×•×”×•×¨×“.","ok");
    }
    function pad(n){ return String(n).padStart(2,"0"); }
    function toICSDateUTC(d, h, m){
      const z = new Date(d); z.setUTCHours(h, m, 0, 0);
      return `${z.getUTCFullYear()}${pad(z.getUTCMonth()+1)}${pad(z.getUTCDate())}T${pad(z.getUTCHours())}${pad(z.getUTCMinutes())}00Z`;
    }
    function downloadICSForMe(assign){
      if(!activeUser){ toast("×‘×—×¨ ××©×ª××© ×§×•×“×.","warn"); return; }
      const gData = currentGroupData;
      const startDate = startOfDay(new Date(gData?.startDate || new Date()));
      const weeks = gData?.horizonWeeks || 4;
      const endDate = addDays(startDate, weeks*7 - 1);
      const days = rangeDays(startDate, endDate);
      let ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Schedule//HE
CALSCALE:GREGORIAN
METHOD:PUBLISH
`;
      for(const d of days){
        const sh = shiftForWeekday(d.getDay());
        if(!sh) continue;
        const key = fmtDateKey(d);
        if(assign[key] !== activeUser.name) continue;
        let st=[16,0], en=[22,0];
        if(d.getDay()===5){ st=[8,0]; en=[14,0]; }
        ics += `BEGIN:VEVENT
UID:${key}-${activeUser.name}@schedule
DTSTAMP:${toICSDateUTC(new Date(),0,0)}
DTSTART:${toICSDateUTC(d,st[0],st[1])}
DTEND:${toICSDateUTC(d,en[0],en[1])}
SUMMARY:××©××¨×ª â€“ ${activeUser.name}
DESCRIPTION:×—×“×¨ ${currentGroupId}
LOCATION:×¡×“× ×”
END:VEVENT
`;
      }
      ics += "END:VCALENDAR";
      const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `schedule_${currentGroupId}_${activeUser.name}.ics`;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 300);
      toast("×§×•×‘×¥ iCalendar × ×•×¦×¨.","ok");
    }

    // ===== lock helper =====
    function isBoardLockedForUser(){
      if(!currentGroupData) return false;
      if(activeUser && activeUser.role === "admin") return false;
      const lockStr = currentGroupData.lockedUntil;
      if(!lockStr) return false;
      const lockDate = new Date(lockStr+"T00:00:00");
      return new Date() < lockDate;
    }

    // ===== tabs =====
    function renderTabs(selectedId){
      bottomTabs.innerHTML = Object.keys(DEFAULT_GROUPS).map(g => {
        const active = g === selectedId;
        return `<div class="tab ${active?"active":""}" data-group="${g}">${g}</div>`;
      }).join("");
      bottomTabs.querySelectorAll(".tab").forEach(tab=>{
        tab.addEventListener("click", async ()=>{
          const g = tab.dataset.group;
          currentGroupId = g;
          await switchGroup(g);
        });
      });
    }

    async function switchGroup(groupId){
      const gData = await ensureGroupDoc(groupId);
      currentGroupData = gData;
      scheduleTitle.textContent = "×œ×•×— ×©×™×‘×•×¦×™× â€“ " + (gData.name || groupId);
      lockBadge.style.display = isBoardLockedForUser() ? "inline-flex" : "none";

      // ××™ ×”×× ×©×™× ×‘×—×“×¨
      let groupPeople = gData.people;
      if(!groupPeople || !Array.isArray(groupPeople) || !groupPeople.length){
        const all = window.__ALL_USERS__ || [];
        groupPeople = all.filter(u=>u.group===groupId).map(u=>u.name);
      }
      peopleInGroup = groupPeople || [];

      renderPeopleChips();
      await loadConstraintsForGroup(groupId, gData);
      const pack = computeSchedule();
      renderSchedule(pack);
      renderSummary(pack);
      renderTabs(groupId);

      // ×ª×¢×“×›×Ÿ ×’× ×‘××•×“×œ × ×™×”×•×œ
      adminStartDate.value = gData.startDate || new Date().toISOString().slice(0,10);
      adminHorizon.value = gData.horizonWeeks || 4;
      adminLockUntil.value = gData.lockedUntil || "";
    }

    // ===== identity modal handlers =====
    function showIdentityModal(){ identityBackdrop.style.display = "flex"; }
    function hideIdentityModal(){ identityBackdrop.style.display = "none"; }

    identityStartBtn.addEventListener("click", async ()=>{
      const pickedId = identitySelect.value;
      const usersArr = window.__ALL_USERS__ || [];
      const user = usersArr.find(u => u.id === pickedId);
      if(!user){
        toast("×œ× ××¦××ª×™ ××©×ª××© ×›×–×”.", "bad");
        return;
      }
      activeUser = user;
      currentGroupId = user.group;
      localStorage.setItem("scheduler_user_id", user.id);
      localStorage.setItem("scheduler_group_id", user.group);

      await switchGroup(user.group);
      whoamiEl.textContent = `××ª×”: ${user.name} (${user.group})${user.role==="admin"?" Â· ×× ×”×œ":""}`;
      hideIdentityModal();
      toast("××—×•×‘×¨ ×›: " + user.name, "ok");
    });

    // ===== admin modal =====
    adminBtn.addEventListener("click", ()=>{
      if(!activeUser || activeUser.role!=="admin"){
        toast("×¨×§ ×× ×”×œ ×™×›×•×œ ×œ×¤×ª×•×— ××ª ×–×”.","warn");
        return;
      }
      adminBackdrop.style.display="flex";
    });
    adminCloseBtn.addEventListener("click", ()=>{ adminBackdrop.style.display="none"; });
    adminSaveBtn.addEventListener("click", async ()=>{
      if(!activeUser || activeUser.role!=="admin"){ return; }
      const payload = {
        startDate: adminStartDate.value || new Date().toISOString().slice(0,10),
        horizonWeeks: Number(adminHorizon.value)||4,
        lockedUntil: adminLockUntil.value || ""
      };
      await setDoc(doc(db,"groups",currentGroupId), payload, {merge:true});
      currentGroupData = { ...(currentGroupData||{}), ...payload };
      adminBackdrop.style.display="none";
      await switchGroup(currentGroupId);
      toast("×”×”×’×“×¨×•×ª × ×©××¨×•.","ok");
    });

    // ===== buttons =====
    saveBtn.addEventListener("click", saveConstraints);
    resetMineBtn.addEventListener("click", resetConstraints);
    computeBtn.addEventListener("click", ()=>{ const pack = computeSchedule(); renderSchedule(pack); renderSummary(pack); toast("×©×•×‘×¥ ××—×“×©.","ok"); });
    exportBtn.addEventListener("click", ()=>{ const pack = computeSchedule(); exportCSV(pack); });
    shareBtn.addEventListener("click", ()=>{
      const u = new URL(location.href);
      u.searchParams.set("view","1");
      u.searchParams.set("group", currentGroupId);
      window.open(u.toString(), "_blank");
    });
    addCalendarBtn.addEventListener("click", ()=>{ const pack = computeSchedule(); downloadICSForMe(pack.assign); });
    switchUserBtn.addEventListener("click", async ()=>{
      await signOut(auth);
      activeUser = null;
      whoamiEl.textContent = "×œ× ××—×•×‘×¨";
      showIdentityModal();
    });

    // ===== auth init =====
    onAuthStateChanged(auth, async (user)=>{
      if(user){
        await bootstrapIfEmpty();
        await loadAllUsers();
        const savedUserId = localStorage.getItem("scheduler_user_id");
        const savedGroupId = localStorage.getItem("scheduler_group_id");
        const usersArr = window.__ALL_USERS__ || [];
        const userObj = usersArr.find(u => u.id === savedUserId);
        if(userObj){
          activeUser = userObj;
          currentGroupId = savedGroupId || userObj.group;
          whoamiEl.textContent = `××ª×”: ${activeUser.name} (${activeUser.group})${activeUser.role==="admin"?" Â· ×× ×”×œ":""}`;
          await switchGroup(currentGroupId);
        }else{
          renderTabs(Object.keys(DEFAULT_GROUPS)[0]);
          showIdentityModal();
        }
      }else{
        await signInAnonymously(auth);
      }
    });

    // ===== initial =====
    renderTabs(Object.keys(DEFAULT_GROUPS)[0]);
    // schedule placeholder
    scheduleGrid.innerHTML = `<div class="slot"><div class="datebox">×˜×•×¢×Ÿ...</div></div>`;
  </script>
</body>
</html>
