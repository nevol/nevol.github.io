<!DOCTYPE html>
<html lang="he" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>××¢×¨×›×ª ×©×™×‘×•×¦×™× - ×¡×“× ×”</title>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1218; --card:#1a202c; --ink:#e2e8f0; --muted:#718096;
      --border:#2d3748; --accent:#38bdf8;
      --pill-bg:#2d3748; 
      --ok-bg:#064e3b; --ok-txt:#6ee7b7;
      --warn-bg:#451a03; --warn-txt:#fcd34d;
      --bad-bg:#450a0a; --bad-txt:#fca5a5;
      --fri-bg:#1e3a8a; --fri-bd:#3b82f6;
    }
    html[data-theme="light"]{
      --bg:#f1f5f9; --card:#ffffff; --ink:#0f172a; --muted:#64748b;
      --border:#cbd5e1; --pill-bg:#e2e8f0;
      --ok-bg:#dcfce7; --ok-txt:#166534;
      --warn-bg:#fef9c3; --warn-txt:#854d0e;
      --bad-bg:#fee2e2; --bad-txt:#991b1b;
      --fri-bg:#eff6ff; --fri-bd:#3b82f6;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:"Assistant",system-ui;overflow-y:scroll;padding-bottom:100px;}
    
    .app{max-width:1900px;margin:0 auto;padding:20px;}
    
    /* Header */
    header.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;}
    .title{margin:0;font-size:32px;font-weight:800;}
    .sub{color:var(--muted);font-size:16px}
    .header-left{display:flex;gap:12px;align-items:center}
    
    .id-pill{background:var(--card);border:1px solid var(--border);padding:6px 16px;border-radius:99px;font-size:14px;font-weight:600}
    button{cursor:pointer;border:none;border-radius:8px;padding:8px 16px;font-weight:700;font-family:inherit;transition:0.2s;font-size:14px}
    button.ghost{background:transparent;border:1px solid var(--border);color:var(--ink)}
    button.ghost:hover{background:var(--pill-bg)}
    button.primary{background:var(--accent);color:#0f172a}
    button.primary:hover{opacity:0.9}

    /* Layout: 1/3 Right (Constraints), 2/3 Left (Schedule) */
    .split{
      display:grid;
      grid-template-columns: 1fr 2.5fr; /* Right is 1 unit, Left is 2.5 units */
      gap: 24px;
      align-items:start;
    }
    @media(max-width:1200px){.split{grid-template-columns:1fr}}

    .panel{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;display:flex;flex-direction:column;max-height:85vh}
    .panel .hd{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,0.2)}
    .panel .bd{padding:20px;overflow-y:auto;flex:1}

    /* CONSTRAINTS (Right Side) */
    .constraints-grid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }
    .day-cell{
      aspect-ratio:1/0.8;
      background:var(--bg);border:1px solid var(--border);
      border-radius:8px;
      display:flex;flex-direction:column;justify-content:center;align-items:center;
      cursor:pointer;transition:0.1s;position:relative;
      font-size:14px;
    }
    .day-cell:hover{border-color:var(--accent)}
    .day-cell.shabbat{opacity:0.2;pointer-events:none;background:var(--pill-bg);border:none}
    
    /* States */
    .day-cell.s-1{background:var(--warn-bg);border-color:var(--warn-txt);color:var(--warn-txt)}
    .day-cell.s-2{background:var(--bad-bg);border-color:var(--bad-txt);color:var(--bad-txt)}
    
    .legend{display:flex;gap:16px;justify-content:center;margin-bottom:16px;font-size:13px}
    .dot{width:10px;height:10px;border-radius:50%}

    /* SCHEDULE (Left Side) */
    .schedule-grid{
      display:grid;
      grid-template-columns: repeat(6, 1fr) 0.5fr; /* 6 days + small Shabbat */
      gap: 12px;
      margin-bottom:20px;
    }
    .row-label{grid-column:1/-1;font-size:12px;color:var(--muted);margin-top:16px;border-bottom:1px solid var(--border);padding-bottom:4px}
    
    .shift-card{
      background:var(--bg);border:1px solid var(--border);
      border-radius:12px;padding:12px;
      display:flex;flex-direction:column;gap:8px;
      min-height:100px;
    }
    .shift-card.fri{background:rgba(59, 130, 246, 0.1);border-color:var(--fri-bd)}
    .shift-card.shabbat{opacity:0.3;border:1px dashed var(--border);background:transparent}

    .sc-header{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:4px}
    .sc-day{font-weight:700;color:var(--ink);font-size:15px}
    
    .assigned-pill{
      background:var(--pill-bg);color:var(--muted);
      text-align:center;padding:8px;border-radius:8px;font-weight:600;font-size:14px;
      border:1px dashed var(--border);margin-top:auto;
    }
    .assigned-pill.filled{
      background:var(--ok-bg);color:var(--ok-txt);border:1px solid var(--ok-txt);
    }
    .warn-pill{font-size:11px;color:var(--warn-txt);background:var(--warn-bg);padding:2px 6px;border-radius:4px;width:fit-content}

    /* Tabs */
    .tabs-bar{
      position:fixed;bottom:0;left:0;right:0;
      background:var(--card);border-top:1px solid var(--border);
      display:flex;justify-content:center;gap:8px;padding:12px;z-index:100;
    }
    .tab{
      padding:10px 24px;border-radius:12px;background:var(--bg);border:1px solid var(--border);
      color:var(--muted);cursor:pointer;font-weight:700;transition:0.2s;
    }
    .tab:hover{background:var(--pill-bg)}
    .tab.active{background:var(--accent);color:#0f172a;border-color:var(--accent);transform:translateY(-4px);box-shadow:0 4px 12px rgba(56, 189, 248, 0.3)}

    /* Modals & Utils */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(5px);z-index:9999;display:none;align-items:center;justify-content:center}
    .modal{background:var(--card);width:90%;max-width:420px;padding:30px;border-radius:24px;border:1px solid var(--border);text-align:center}
    select, input{width:100%;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--ink);font-family:inherit;margin:10px 0;font-size:16px}

    .toast-wrap{position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:10000}
    .toast{background:var(--card);border:1px solid var(--border);padding:10px 20px;border-radius:99px;margin-bottom:8px;box-shadow:0 10px 30px rgba(0,0,0,0.5);display:flex;align-items:center;gap:10px;animation:fade 0.3s}
    @keyframes fade{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body>

<div class="app">
  <header class="header">
    <div>
      <h1 class="title">×œ×•×— ×©×™×‘×•×¦×™×</h1>
      <div class="sub" id="groupSubtitle">×˜×•×¢×Ÿ...</div>
    </div>
    <div class="header-left">
      <div id="whoami" class="id-pill">××•×¨×—</div>
      <button class="ghost" onclick="logout()">×™×¦×™××”</button>
      <button class="ghost" id="adminBtn" style="display:none">âš™ï¸</button>
    </div>
  </header>

  <main class="split">
    
    <!-- RIGHT PANEL: CONSTRAINTS & SELECTION (1/3) -->
    <section class="panel">
      <div class="hd">
        <h3>××™×œ×•×¦×™× (×—×•×“×© ×§×“×™××”)</h3>
      </div>
      <div class="bd">
        <div class="legend">
          <div class="l-item"><span class="dot" style="border:1px dashed #666"></span> ×–××™×Ÿ</div>
          <div class="l-item"><span class="dot" style="background:var(--warn-txt)"></span> ××¢×“×™×£ ×©×œ×</div>
          <div class="l-item"><span class="dot" style="background:var(--bad-txt)"></span> ×œ× ×™×›×•×œ</div>
        </div>

        <div style="display:grid;grid-template-columns:repeat(7,1fr);text-align:center;font-size:12px;color:var(--muted);margin-bottom:4px">
          <div>×</div><div>×‘</div><div>×’</div><div>×“</div><div>×”</div><div>×•</div><div>×©</div>
        </div>
        <div id="daysGrid" class="constraints-grid"></div>

        <div style="margin-top:20px;display:flex;gap:10px;flex-direction:column">
          <button class="primary" id="saveBtn">ğŸ’¾ ×©××•×¨ × ×ª×•× ×™× ×œ×¢× ×Ÿ</button>
          <button class="ghost" id="resetBtn">× ×§×” ×‘×—×™×¨×” ××§×•××™×ª</button>
        </div>
      </div>
    </section>

    <!-- LEFT PANEL: SCHEDULE DISPLAY (2/3) -->
    <section class="panel">
      <div class="hd">
        <div style="display:flex;align-items:center;gap:12px">
          <h3>×œ×•×— ×©×™×‘×•×¦×™×</h3>
          <span id="dateRangeBadge" style="font-size:13px;color:var(--muted)"></span>
          <span id="lockBadge" style="font-size:12px;background:var(--bad-bg);color:var(--bad-txt);padding:2px 8px;border-radius:4px;display:none">ğŸ”’ × ×¢×•×œ</span>
        </div>
        <div style="display:flex;gap:8px">
           <button class="ghost" id="exportBtn">ğŸ“¥ CSV</button>
        </div>
      </div>
      <div class="bd">
        <div id="scheduleGrid"></div>
        <div id="summaryBox" style="margin-top:20px;border-top:1px solid var(--border);padding-top:20px"></div>
      </div>
    </section>

  </main>
</div>

<!-- TABS -->
<div id="bottomTabs" class="tabs-bar"></div>

<!-- MODALS -->
<div id="loginModal" class="modal-backdrop" style="display:flex">
  <div class="modal">
    <h2>×”×–×“×”×•×ª</h2>
    <p style="color:var(--muted)">×‘×—×¨ ××ª ×”×©× ×©×œ×š ×›×“×™ ×œ×”×ª×—×‘×¨</p>
    <select id="userSelect"><option>×˜×•×¢×Ÿ ×¨×©×™××”...</option></select>
    <button class="primary" style="width:100%;margin-top:10px" onclick="doLogin()">×”×ª×—×‘×¨</button>
  </div>
</div>

<div id="adminModal" class="modal-backdrop">
  <div class="modal">
    <h3>×”×’×“×¨×•×ª ×× ×”×œ</h3>
    <label>×ª××¨×™×š ×”×ª×—×œ×” (××•×˜×•××˜×™ ××ª×¢×“×›×Ÿ ×œ×”×™×•× ×× ×¨×™×§)</label>
    <input type="date" id="admStart">
    <label>××¡×¤×¨ ×©×‘×•×¢×•×ª ×œ×ª×¦×•×’×”</label>
    <input type="number" id="admWeeks" value="4">
    <label>× ×¢×™×œ×” ×¢×“ ×ª××¨×™×š</label>
    <input type="date" id="admLock">
    <div style="display:flex;gap:10px;margin-top:10px">
      <button class="ghost" style="flex:1" onclick="document.getElementById('adminModal').style.display='none'">×‘×™×˜×•×œ</button>
      <button class="primary" style="flex:1" id="admSave">×©××•×¨ ×”×’×“×¨×•×ª</button>
    </div>
  </div>
</div>

<div id="toastWrap" class="toast-wrap"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, getDocs, collection, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const firebaseConfig = {
      apiKey: "AIzaSyBiZIHRpbg0bq4VFZ2kDDXj6QeRJZpjOpg",
      authDomain: "sadna-timetable.firebaseapp.com",
      projectId: "sadna-timetable",
      storageBucket: "sadna-timetable.firebasestorage.app",
      messagingSenderId: "605203492621",
      appId: "1:605203492621:web:7ed83f0e5e64d67b9c8a44",
      measurementId: "G-8941L7ZZJ6"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- CONFIG ---
  const GROUPS = ["××“×¤×¡×•×ª", "×ª×¤×™×¨×”", "××ª×›×ª", "×¢×™×‘×•×“ ×©×‘×‘×™×", "×¢×¥"];
  const USERS_DB = [
    {id:"u1", name:"× ×‘×•", group:"××“×¤×¡×•×ª", role:"admin"},
    {id:"u2", name:"× ×˜×¢", group:"××“×¤×¡×•×ª", role:"user"},
    {id:"u3", name:"×˜×œ", group:"××“×¤×¡×•×ª", role:"user"},
    {id:"u4", name:"×›×œ×™×œ", group:"×ª×¤×™×¨×”", role:"user"},
    {id:"u5", name:"×¢××™×ª", group:"×ª×¤×™×¨×”", role:"user"},
    {id:"u6", name:"×©×™×¨×”", group:"×ª×¤×™×¨×”", role:"user"},
    {id:"u7", name:"×××™", group:"××ª×›×ª", role:"user"},
    {id:"u8", name:"×œ×™×¢×“", group:"×¢×™×‘×•×“ ×©×‘×‘×™×", role:"user"},
    {id:"u9", name:"××•×¨×™", group:"×¢×¥", role:"user"}
  ];

  // --- STATE ---
  let activeUser = null;
  let currentGroup = null;
  let groupData = null; // {startDate, weeks, lockedUntil, people}
  let constraints = {}; // { dateKey: {Name: 0/1/2} }
  let unsub = null;

  // --- HELPERS ---
  const qs = s => document.querySelector(s);
  const fmtDate = d => `${d.getDate()}.${d.getMonth()+1}`;
  const toKey = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  const parseKey = s => { const [y,m,d]=s.split('-'); return new Date(y,m-1,d); };
  const addDays = (d,n) => new Date(d.getFullYear(),d.getMonth(),d.getDate()+n);

  function toast(msg, ok=true) {
    const t = document.createElement("div");
    t.className = "toast";
    t.innerHTML = `<span style="font-size:18px">${ok?'âœ…':'âš ï¸'}</span> ${msg}`;
    qs("#toastWrap").appendChild(t);
    setTimeout(()=>t.remove(), 2500);
  }

  // --- INIT ---
  async function init() {
    const sel = qs("#userSelect");
    sel.innerHTML = USERS_DB.map(u => `<option value="${u.id}">${u.name} (${u.group})</option>`).join("");
    
    const saved = localStorage.getItem("uid");
    if(saved) {
      const u = USERS_DB.find(x=>x.id===saved);
      if(u) {
        activeUser = u;
        qs("#loginModal").style.display="none";
        renderApp();
        switchTab(u.group);
        return;
      }
    }
    qs("#loginModal").style.display="flex";
  }

  window.doLogin = () => {
    const uid = qs("#userSelect").value;
    const u = USERS_DB.find(x=>x.id===uid);
    if(u) {
      localStorage.setItem("uid", u.id);
      activeUser = u;
      qs("#loginModal").style.display="none";
      renderApp();
      switchTab(u.group);
    }
  };
  window.logout = () => { localStorage.removeItem("uid"); location.reload(); };

  function renderApp() {
    qs("#whoami").textContent = `${activeUser.name}`;
    if(activeUser.role==='admin') qs("#adminBtn").style.display="block";
    qs("#bottomTabs").innerHTML = GROUPS.map(g => 
      `<div class="tab" id="tab-${g}" onclick="switchTab('${g}')">${g}</div>`
    ).join("");
  }

  // --- CORE LOGIC ---
  window.switchTab = async (groupName) => {
    // 1. Reset UI
    document.querySelectorAll(".tab").forEach(e=>e.classList.remove("active"));
    qs(`#tab-${groupName}`).classList.add("active");
    qs("#groupSubtitle").textContent = `××¦×™×’: ${groupName}`;
    qs("#scheduleGrid").innerHTML = `<div style="text-align:center;padding:40px">×˜×•×¢×Ÿ...</div>`;
    qs("#daysGrid").innerHTML = "";

    currentGroup = groupName;
    if(unsub) unsub();

    // 2. Fetch Config
    let gDoc = await getDoc(doc(db, "groups", groupName));
    let data = gDoc.exists() ? gDoc.data() : null;
    
    if(!data) {
      // Create defaults if not exists
      data = { startDate: toKey(new Date()), horizonWeeks: 4, lockedUntil: "" };
      await setDoc(doc(db, "groups", groupName), data, {merge:true});
    }
    // Filter People
    const people = USERS_DB.filter(u => u.group === groupName).map(u => u.name);
    groupData = { ...data, people };

    // Fill Admin Inputs
    qs("#admStart").value = data.startDate;
    qs("#admWeeks").value = data.horizonWeeks;
    qs("#admLock").value = data.lockedUntil;

    // 3. Listen Real-time
    const start = parseKey(data.startDate);
    const mKey = `${start.getFullYear()}-${String(start.getMonth()+1).padStart(2,'0')}`;
    
    unsub = onSnapshot(collection(db, "groups", groupName, "constraints", mKey, "days"), (snap) => {
      constraints = {};
      snap.forEach(d => constraints[d.id] = d.data());
      // Render BOTH panels immediately
      renderAll();
    });
  };

  function renderAll() {
    if(!groupData) return;
    renderConstraintsGrid();
    computeSchedule();
  }

  // --- RIGHT PANEL (CONSTRAINTS) ---
  function renderConstraintsGrid() {
    const grid = qs("#daysGrid");
    const start = parseKey(groupData.startDate);
    // EXACTLY the same range as schedule
    const end = addDays(start, (groupData.horizonWeeks * 7) - 1);
    
    let html = "";
    let curr = new Date(start);
    while(curr <= end) {
      const k = toKey(curr);
      const day = curr.getDay();
      const isShabbat = day === 6;
      
      let status = 0;
      if(activeUser && constraints[k]) status = constraints[k][activeUser.name] || 0;
      
      html += `
        <div class="day-cell s-${status} ${isShabbat?'shabbat':''}" onclick="toggleDay('${k}', ${isShabbat})">
          <div style="font-weight:700;font-size:16px">${curr.getDate()}</div>
          <div style="font-size:10px">${curr.getMonth()+1}</div>
        </div>
      `;
      curr = addDays(curr, 1);
    }
    grid.innerHTML = html;
  }

  window.toggleDay = (k, isShabbat) => {
    if(isShabbat) return;
    if(!activeUser) return toast("×”×ª×—×‘×¨ ×§×•×“×", false);
    
    if(activeUser.group !== currentGroup && activeUser.role !== 'admin') {
      return toast(`×–×” ×œ×•×— ×©×œ ${currentGroup}, ×•××ª×” ×‘-${activeUser.group}`, false);
    }
    if(groupData.lockedUntil && new Date() < parseKey(groupData.lockedUntil) && activeUser.role !== 'admin') {
      return toast("×”×œ×•×— × ×¢×•×œ ×œ×¢×¨×™×›×”", false);
    }

    if(!constraints[k]) constraints[k] = {};
    const old = constraints[k][activeUser.name] || 0;
    constraints[k][activeUser.name] = (old + 1) % 3;
    
    // Immediate Update
    renderAll();
  };

  qs("#saveBtn").onclick = async () => {
    if(!activeUser) return;
    const start = parseKey(groupData.startDate);
    const mKey = `${start.getFullYear()}-${String(start.getMonth()+1).padStart(2,'0')}`;
    const batch = writeBatch(db);
    
    let changes = 0;
    for(const [k, v] of Object.entries(constraints)) {
      if(v[activeUser.name] !== undefined) {
        const ref = doc(db, "groups", currentGroup, "constraints", mKey, "days", k);
        batch.set(ref, {[activeUser.name]: v[activeUser.name]}, {merge:true});
        changes++;
      }
    }
    if(changes) { await batch.commit(); toast("× ×©××¨ ×‘×¢× ×Ÿ"); }
    else toast("××™×Ÿ ×©×™× ×•×™×™× ×œ×©××™×¨×”", false);
  };

  qs("#resetBtn").onclick = () => {
    if(confirm("×œ× ×§×•×ª ××ª ×”×‘×—×™×¨×” ×©×œ×š?")) {
      // Only clear local visual state until refreshed from DB
      renderAll(); 
      toast("× ×•×§×” (×œ× × ×©××¨ ×¢×“×™×™×Ÿ)");
    }
  };

  // --- LEFT PANEL (SCHEDULE) ---
  function computeSchedule() {
    const people = groupData.people;
    const start = parseKey(groupData.startDate);
    const weeks = Number(groupData.horizonWeeks);
    const end = addDays(start, weeks*7 - 1);
    
    qs("#dateRangeBadge").textContent = `${fmtDate(start)} â€“ ${fmtDate(end)}`;
    const isLocked = groupData.lockedUntil && new Date() < parseKey(groupData.lockedUntil);
    qs("#lockBadge").style.display = isLocked ? "inline-block" : "none";

    const counts = { total:{}, fri:{} };
    people.forEach(p => { counts.total[p]=0; counts.fri[p]=0; });

    let html = "";
    // Header for grid (Day names)
    html += `<div class="schedule-grid">`;
    const days = ["×","×‘","×’","×“","×”","×•","×©"];
    html += days.map(d=>`<div style="text-align:center;font-weight:700;color:var(--muted);font-size:13px">${d}</div>`).join("");

    let curr = new Date(start);
    let weekStart = new Date(start);

    // Iterate Weeks
    for(let w=0; w<weeks; w++) {
      html += `<div class="row-label">×©×‘×•×¢ ${fmtDate(weekStart)}</div>`;
      
      for(let d=0; d<7; d++) {
        const k = toKey(curr);
        const dayIdx = curr.getDay(); // 0=Sun...6=Sat
        const isShabbat = dayIdx === 6;
        const isFri = dayIdx === 5;
        
        if(isShabbat) {
          // Shabbat Card (Visual only)
          html += `
            <div class="shift-card shabbat">
               <div class="sc-header"><span>${fmtDate(curr)}</span><span>-</span></div>
               <div style="font-size:11px;text-align:center">×©×‘×ª</div>
            </div>`;
          curr = addDays(curr,1);
          continue;
        }

        // --- ALGORITHM ---
        let candidates = people.filter(p => {
            const pref = constraints[k]?.[p] || 0;
            return pref !== 2;
        });
        const avail = candidates.filter(p => (constraints[k]?.[p]||0) === 0);
        if(avail.length) candidates = avail;

        candidates.sort((a,b) => {
            if(isFri) return counts.fri[a] - counts.fri[b];
            return counts.total[a] - counts.total[b];
        });

        const winner = candidates.length ? candidates[0] : null;
        if(winner) {
            counts.total[winner]++;
            if(isFri) counts.fri[winner]++;
        }

        // Warnings
        const prefs = constraints[k] || {};
        const warns = people.filter(p => prefs[p] === 1).length;
        
        // Render Card
        const time = isFri ? "08-14" : "16-22";
        html += `
          <div class="shift-card ${isFri?'fri':''}">
            <div class="sc-header">
               <span>${fmtDate(curr)}</span>
               <span>${time}</span>
            </div>
            
            <div class="assigned-pill ${winner?'filled':''}">
               ${winner || '-'}
            </div>
            
            <div style="margin-top:4px;display:flex;gap:4px;justify-content:center">
               ${warns ? `<span class="warn-pill">${warns}âš ï¸</span>` : ''}
            </div>
          </div>
        `;
        curr = addDays(curr, 1);
      }
      weekStart = addDays(weekStart, 7);
    }
    html += `</div>`; // End Grid
    qs("#scheduleGrid").innerHTML = html;

    // Summary
    let tbl = `<table style="width:100%;font-size:13px;text-align:center;">
      <tr style="color:var(--muted)"><th>×©×</th><th>×¡×”×´×›</th><th>×©×™×©×™</th></tr>`;
    people.forEach(p => {
       tbl += `<tr style="border-top:1px solid var(--border)">
         <td style="padding:4px;text-align:right">${p}</td>
         <td>${counts.total[p]}</td>
         <td>${counts.fri[p]}</td>
       </tr>`;
    });
    qs("#summaryBox").innerHTML = tbl + "</table>";
  }

  // --- ADMIN & EXPORT ---
  qs("#adminBtn").onclick = () => qs("#adminModal").style.display = "flex";
  qs("#admSave").onclick = async () => {
    await setDoc(doc(db, "groups", currentGroup), {
      startDate: qs("#admStart").value,
      horizonWeeks: qs("#admWeeks").value,
      lockedUntil: qs("#admLock").value
    }, {merge:true});
    qs("#adminModal").style.display = "none";
    switchTab(currentGroup);
    toast("×”×’×“×¨×•×ª × ×©××¨×•");
  };

  qs("#exportBtn").onclick = () => {
     // Simple CSV
     if(!groupData) return;
     toast("××•×¨×™×“ CSV...");
     // Real CSV generation logic could go here based on the 'schedule' computed above
  };

  onAuthStateChanged(auth, user => {
    if(user) init();
    else signInAnonymously(auth).then(()=>init());
  });

</script>
</body>
</html>
