<!DOCTYPE html>
<html lang="he" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>××¢×¨×›×ª ×©×™×‘×•×¦×™× - ×¡×“× ×”</title>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f172a;
      --glass: rgba(30, 41, 59, 0.7);
      --glass-border: rgba(255, 255, 255, 0.08);
      --primary: #38bdf8;
      --primary-glow: rgba(56, 189, 248, 0.4);
      --secondary: #818cf8;
      --text-main: #f1f5f9;
      --text-muted: #94a3b8;
      --danger: #ef4444;
      --success: #10b981;
      --warning: #f59e0b;
      
      --fri-bg: rgba(59, 130, 246, 0.15);
      --fri-border: rgba(59, 130, 246, 0.3);

      --radius: 16px;
      --anim: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Heebo', sans-serif;
      background-color: var(--bg);
      background-image: 
        radial-gradient(at 0% 0%, rgba(56, 189, 248, 0.15) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(129, 140, 248, 0.15) 0px, transparent 50%);
      color: var(--text-main);
      overflow-x: hidden;
    }

    /* Layout */
    .app { max-width: 1800px; margin: 0 auto; padding: 24px; }
    
    header {
      display: flex; justify-content: space-between; align-items: flex-start;
      margin-bottom: 32px; gap: 20px; flex-wrap: wrap;
    }

    .title-area h1 {
      font-size: clamp(24px, 4vw, 36px); font-weight: 900; margin: 0;
      background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      letter-spacing: -1px;
    }
    
    /* Tabs */
    .group-tabs {
      display: flex; gap: 10px; margin-top: 16px; background: rgba(0,0,0,0.2);
      padding: 6px; border-radius: 14px; width: fit-content;
    }
    .tab-btn {
      background: transparent; border: none; color: var(--text-muted);
      padding: 10px 20px; border-radius: 10px; font-weight: 500; cursor: pointer;
      transition: var(--anim); position: relative; overflow: hidden;
    }
    .tab-btn:hover { color: #fff; background: rgba(255,255,255,0.05); }
    .tab-btn.active {
      background: var(--primary); color: #0f172a; font-weight: 700;
      box-shadow: 0 4px 15px var(--primary-glow);
    }

    /* User Badge */
    .id-badge {
      display: flex; align-items: center; gap: 8px;
      background: var(--glass); border: 1px solid var(--glass-border);
      padding: 8px 16px; border-radius: 50px; cursor: pointer;
      transition: var(--anim);
    }
    .id-badge:hover { border-color: var(--primary); transform: translateY(-2px); }
    .avatar {
      width: 28px; height: 28px; background: var(--primary); border-radius: 50%;
      color: #000; display: flex; align-items: center; justify-content: center;
      font-weight: bold; font-size: 14px;
    }

    /* Main Grid */
    .layout-grid {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 24px;
      align-items: start;
    }
    @media (max-width: 1100px) { .layout-grid { grid-template-columns: 1fr; } }

    /* Panels */
    .panel {
      background: var(--glass);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      display: flex; flex-direction: column;
    }
    
    .panel-hd {
      padding: 20px; border-bottom: 1px solid var(--glass-border);
      display: flex; justify-content: space-between; align-items: center;
    }
    .panel-hd h3 { margin: 0; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    .panel-bd { padding: 20px; }

    /* Buttons */
    .btn {
      background: var(--primary); color: #0f172a; border: none;
      padding: 10px 20px; border-radius: 10px; font-weight: 700; cursor: pointer;
      transition: var(--anim); display: inline-flex; align-items: center; gap: 8px;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px var(--primary-glow); }
    .btn:active { transform: translateY(0); }
    .btn.ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--glass-border); }
    .btn.ghost:hover { border-color: var(--text-main); color: var(--text-main); box-shadow: none; }
    .btn.danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3); }

    /* Constraints Grid (Right Side) */
    .calendar-wrap { display: flex; flex-direction: column; gap: 12px; }
    .days-header, .days-grid {
      display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center;
    }
    .day-name { font-size: 12px; color: var(--text-muted); font-weight: 700; margin-bottom: 4px; }
    
    .day-cell {
      aspect-ratio: 1; background: rgba(255,255,255,0.03);
      border: 1px solid transparent; border-radius: 10px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      cursor: pointer; transition: var(--anim); user-select: none;
      position: relative;
    }
    .day-cell:hover { background: rgba(255,255,255,0.08); transform: scale(1.05); }
    
    .day-cell.shabbat { opacity: 0.2; pointer-events: none; background: transparent; border: 1px dashed var(--glass-border); }
    
    /* States */
    .day-cell.state-0 { border-color: rgba(255,255,255,0.1); }
    .day-cell.state-1 { background: rgba(245, 158, 11, 0.2); border-color: var(--warning); color: var(--warning); }
    .day-cell.state-2 { background: rgba(239, 68, 68, 0.2); border-color: var(--danger); color: var(--danger); }
    
    .day-num { font-size: 16px; font-weight: 700; }
    .day-month { font-size: 10px; opacity: 0.6; }

    /* Schedule Grid (Left Side) */
    .schedule-grid {
      display: grid; grid-template-columns: 60px repeat(6, 1fr); gap: 12px;
    }
    @media (max-width: 900px) { .schedule-grid { grid-template-columns: 1fr; } .col-hd { display: none; } }
    
    .col-hd { text-align: center; color: var(--text-muted); font-size: 14px; margin-bottom: 8px; }
    
    .shift-card {
      background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border);
      border-radius: 12px; padding: 12px; min-height: 100px;
      display: flex; flex-direction: column; justify-content: space-between;
      transition: var(--anim);
    }
    .shift-card.fri { background: var(--fri-bg); border-color: var(--fri-border); }
    .shift-card:hover { transform: translateY(-3px); border-color: var(--primary); }
    
    .shift-date { font-size: 14px; font-weight: 700; margin-bottom: 4px; }
    .shift-time { font-size: 11px; color: var(--text-muted); }
    
    .assignee {
      margin-top: 10px; padding: 6px 10px; border-radius: 8px;
      text-align: center; font-weight: 600; font-size: 14px;
      background: rgba(0,0,0,0.3);
    }
    .assignee.filled { background: rgba(16, 185, 129, 0.2); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.3); }
    .assignee.empty { opacity: 0.5; border: 1px dashed var(--glass-border); }
    
    .chips-wrap { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
    .person-chip {
      background: rgba(255,255,255,0.05); padding: 6px 12px; border-radius: 20px;
      font-size: 13px; color: var(--text-muted); border: 1px solid transparent;
      transition: var(--anim);
    }
    .person-chip.active { background: var(--primary); color: #0f172a; font-weight: 700; transform: scale(1.05); }

    /* Modals */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
      display: none; align-items: center; justify-content: center; z-index: 100;
      animation: fadeIn 0.3s ease;
    }
    .modal-box {
      background: #1e293b; border: 1px solid var(--glass-border);
      padding: 30px; border-radius: 20px; width: 100%; max-width: 450px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      animation: slideUp 0.3s ease;
    }
    
    input, select {
      width: 100%; background: #0f172a; border: 1px solid var(--glass-border);
      color: #fff; padding: 12px; border-radius: 10px; margin: 8px 0 20px 0;
      font-family: inherit; font-size: 16px; transition: var(--anim);
    }
    input:focus, select:focus { outline: none; border-color: var(--primary); }
    label { font-size: 13px; color: var(--text-muted); font-weight: 600; }

    /* Toast */
    .toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 200; display: flex; flex-direction: column; gap: 10px; }
    .toast {
      background: #1e293b; color: #fff; padding: 12px 20px; border-radius: 50px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
      display: flex; align-items: center; gap: 10px; animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .loading-overlay {
      position: absolute; inset: 0; background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(5px); z-index: 50;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 15px; border-radius: var(--radius);
    }
    .spinner {
      width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1);
      border-top-color: var(--primary); border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <!-- App Container -->
  <div class="app">
    
    <!-- Header -->
    <header>
      <div class="title-area">
        <h1>××¢×¨×›×ª ×©×™×‘×•×¦×™× - ×¡×“× ×”</h1>
        <div class="group-tabs" id="groupTabs">
          <!-- Dynamic Tabs -->
        </div>
      </div>
      
      <div style="display: flex; gap: 12px; align-items: center;">
        <div id="whoami" class="id-badge" title="×”×—×œ×£ ××©×ª××©">
          <div class="avatar">?</div>
          <span>××•×¨×—</span>
        </div>
        <button id="adminBtn" class="btn ghost hidden" title="×”×’×“×¨×•×ª ×× ×”×œ">âš™ï¸</button>
      </div>
    </header>

    <!-- Main Content -->
    <div class="layout-grid">
      
      <!-- Right: Constraints (Selection) -->
      <section class="panel">
        <div class="panel-hd">
          <h3>
            <span>ğŸ“</span> ××™×œ×•×¦×™×
          </h3>
          <div style="font-size:12px; display:flex; gap:10px;">
             <span style="color:var(--text-muted)">âšª ×–××™×Ÿ</span>
             <span style="color:var(--warning)">ğŸŸ  ××¢×“×™×£ ×©×œ×</span>
             <span style="color:var(--danger)">ğŸ”´ ×œ× ×™×›×•×œ</span>
          </div>
        </div>
        <div class="panel-bd" style="position:relative">
          <div class="chips-wrap" id="peopleChips"></div>
          
          <div class="calendar-wrap">
            <div class="days-header">
              <div class="day-name">××³</div><div class="day-name">×‘×³</div>
              <div class="day-name">×’×³</div><div class="day-name">×“×³</div>
              <div class="day-name">×”×³</div><div class="day-name">×•×³</div>
              <div class="day-name" style="color:#ef4444">×©×³</div>
            </div>
            <div id="daysGrid" class="days-grid"></div>
          </div>

          <div style="margin-top: 24px; display:flex; gap:10px; flex-wrap:wrap">
            <button id="saveBtn" class="btn" style="flex:1">ğŸ’¾ ×©××•×¨ × ×ª×•× ×™×</button>
            <button id="resetMineBtn" class="btn ghost">ğŸ§¹ × ×§×”</button>
          </div>
        </div>
      </section>

      <!-- Left: Schedule (Result) -->
      <section class="panel" style="position:relative; min-height: 500px;">
        <div id="loadingSchedule" class="loading-overlay hidden">
          <div class="spinner"></div>
          <span>×˜×•×¢×Ÿ ×œ×•×—...</span>
        </div>
        
        <div class="panel-hd">
          <div style="display:flex; align-items:center; gap:15px">
            <h3><span>ğŸ“…</span> ×œ×•×— ×©×™×‘×•×¦×™×</h3>
            <span id="dateRangeBadge" style="font-size:13px; background:rgba(255,255,255,0.1); padding:4px 10px; border-radius:20px;"></span>
            <span id="lockedBadge" style="display:none; font-size:12px; color:var(--danger); background:rgba(239,68,68,0.1); padding:4px 10px; border-radius:20px; border:1px solid rgba(239,68,68,0.2)">ğŸ”’ × ×¢×•×œ</span>
          </div>
          <button id="exportBtn" class="btn ghost" style="font-size:13px">ğŸ“¥ CSV</button>
        </div>

        <div class="panel-bd">
          <div id="scheduleGrid" class="schedule-grid"></div>
          <div style="margin-top: 30px; padding-top:20px; border-top:1px solid var(--glass-border)">
            <h4 style="margin:0 0 15px 0; font-size:16px">×¡×™×›×•× ××©××¨×•×ª</h4>
            <div id="summaryBox" style="overflow-x:auto"></div>
          </div>
        </div>
      </section>

    </div>
  </div>

  <!-- Modals -->
  <div class="modal-overlay" id="identityBackdrop">
    <div class="modal-box">
      <h2 style="margin-top:0">×”×™×™, ××™ ××ª/×”? ğŸ‘‹</h2>
      <p style="color:var(--text-muted); margin-bottom:20px">×‘×—×¨ ××ª ×”×©× ×©×œ×š ×›×“×™ ×œ×”×ª×—×™×œ</p>
      <select id="identitySelect"><option>×˜×•×¢×Ÿ...</option></select>
      <button id="identityStartBtn" class="btn" style="width:100%">×”×ª×—×‘×¨ ×œ××¢×¨×›×ª</button>
    </div>
  </div>

  <div class="modal-overlay" id="adminBackdrop">
    <div class="modal-box">
      <h2 style="margin-top:0">×”×’×“×¨×•×ª × ×™×”×•×œ: <span id="adminGroupName" style="color:var(--primary)"></span></h2>
      
      <label>×ª××¨×™×š ×”×ª×—×œ×” ×œ×©×™×‘×•×¥</label>
      <input type="date" id="dateInput">

      <label>××©×š ×–××Ÿ ×œ×ª×¦×•×’×”</label>
      <select id="durationSelect">
        <option value="1">×©×‘×•×¢ ××—×“</option>
        <option value="2">×©×‘×•×¢×™×™×</option>
        <option value="3">3 ×©×‘×•×¢×•×ª</option>
        <option value="4">4 ×©×‘×•×¢×•×ª</option>
      </select>

      <label>× ×¢×•×œ ×œ×¢×¨×™×›×” ×¢×“ (××•×¤×¦×™×•× ×œ×™)</label>
      <input type="date" id="lockInput">
      
      <div style="height:1px; background:var(--glass-border); margin:20px 0;"></div>
      
      <button id="adminResetBtn" class="btn danger" style="width:100%; margin-bottom:10px">âš ï¸ ××™×¤×•×¡ ×›×œ ×”××™×œ×•×¦×™× ×œ×˜×•×•×— ×–×”</button>
      
      <div style="display:flex; gap:10px; margin-top:10px">
        <button id="adminCancelBtn" class="btn ghost" style="flex:1">×‘×™×˜×•×œ</button>
        <button id="adminSaveBtn" class="btn" style="flex:1">×©××•×¨ ×”×’×“×¨×•×ª</button>
      </div>
    </div>
  </div>

  <div class="toast-container" id="toastWrap"></div>

  <!-- Firebase Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, getDocs, collection, query, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // Config
    const firebaseConfig = {
      apiKey: "AIzaSyBiZIHRpbg0bq4VFZ2kDDXj6QeRJZpjOpg",
      authDomain: "sadna-timetable.firebaseapp.com",
      projectId: "sadna-timetable",
      storageBucket: "sadna-timetable.firebasestorage.app",
      messagingSenderId: "605203492621",
      appId: "1:605203492621:web:7ed83f0e5e64d67b9c8a44",
      measurementId: "G-8941L7ZZJ6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Data Constants
    const GROUPS = ["××“×¤×¡×•×ª", "×ª×¤×™×¨×”", "××ª×›×ª", "×¢×™×‘×•×“ ×©×‘×‘×™×", "×¢×¥"];
    const USERS_DB = [
        {id:"u1", name:"× ×‘×•", group:"××“×¤×¡×•×ª", role:"admin"},
        {id:"u2", name:"× ×˜×¢", group:"××“×¤×¡×•×ª", role:"user"},
        {id:"u3", name:"×˜×œ", group:"××“×¤×¡×•×ª", role:"user"},
        {id:"u4", name:"×›×œ×™×œ", group:"×ª×¤×™×¨×”", role:"user"},
        {id:"u5", name:"×¢××™×ª", group:"×ª×¤×™×¨×”", role:"user"},
        {id:"u6", name:"×©×™×¨×”", group:"×ª×¤×™×¨×”", role:"user"},
        {id:"u7", name:"×××™", group:"××ª×›×ª", role:"user"},
        {id:"u8", name:"×œ×™×¢×“", group:"×¢×™×‘×•×“ ×©×‘×‘×™×", role:"user"},
        {id:"u9", name:"××•×¨×™", group:"×¢×¥", role:"user"}
    ];
    const MS_DAY = 86400000;
    const hebDaysLong = ["×¨××©×•×Ÿ","×©× ×™","×©×œ×™×©×™","×¨×‘×™×¢×™","×—××™×©×™","×©×™×©×™","×©×‘×ª"];

    // App State
    let currentGroup = GROUPS[0];
    let currentUser = null;
    let groupMembers = [];
    let groupSettings = { startDate: new Date(), lockedUntil: null, weeks: 4 };
    let state = {};
    let unsubConstraints = null;
    let unsubSettings = null;

    // --- UTILS ---
    const startOfDay = d => { const c=new Date(d); c.setHours(0,0,0,0); return c; };
    const addDays = (d,n) => new Date(startOfDay(d).getTime() + n*MS_DAY);
    const prevSunday = d => { let x=startOfDay(d); while(x.getDay()!==0) x=addDays(x,-1); return x; };
    const fmtKey = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const fmtShow = d => `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}`;
    const monthKeyFrom = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;

    function toast(msg, type="success") {
      const el = document.createElement("div");
      el.className = "toast";
      const icon = type==="success" ? "âœ…" : (type==="danger"?"ğŸ›‘":"âš ï¸");
      el.innerHTML = `<span>${icon}</span><span>${msg}</span>`;
      document.getElementById("toastWrap").appendChild(el);
      setTimeout(() => { el.style.opacity="0"; setTimeout(()=>el.remove(),300); }, 3000);
    }

    // --- CORE LOGIC ---
    
    // 1. Init
    function init() {
      const tabs = document.getElementById("groupTabs");
      tabs.innerHTML = GROUPS.map(g => `<button class="tab-btn" onclick="switchGroup('${g}')">${g}</button>`).join("");
      
      const savedUid = localStorage.getItem("scheduler_uid");
      if(savedUid) {
        const u = USERS_DB.find(x => x.id === savedUid);
        if(u) loginUser(u);
        else showIdentity();
      } else {
        showIdentity();
      }
      
      // Auto login anon if needed
      if(!auth.currentUser) signInAnonymously(auth);
    }

    window.switchGroup = (g) => {
      currentGroup = g;
      renderTabsState();
      loadGroup();
    };

    function renderTabsState() {
      document.querySelectorAll(".tab-btn").forEach(b => {
        b.classList.toggle("active", b.innerText === currentGroup);
      });
    }

    // 2. Load Group Data
    function loadGroup() {
      document.getElementById("loadingSchedule").classList.remove("hidden");
      groupMembers = USERS_DB.filter(u => u.group === currentGroup).map(u => u.name);

      if(unsubSettings) unsubSettings();
      
      // Listen to Settings
      unsubSettings = onSnapshot(doc(db, "groups", currentGroup), async (snap) => {
        if(!snap.exists()) {
          // Auto-create
          await setDoc(doc(db, "groups", currentGroup), { startDate: fmtKey(new Date()), weeks: 4 });
          return;
        }
        
        const d = snap.data();
        // Parse settings
        if(d.startDate) {
          const parts = d.startDate.split('-').map(Number);
          groupSettings.startDate = startOfDay(new Date(parts[0], parts[1]-1, parts[2]));
        } else {
          groupSettings.startDate = startOfDay(new Date());
        }
        
        groupSettings.weeks = d.weeks ? Number(d.weeks) : 4;
        
        if(d.lockedUntil) {
           const parts = d.lockedUntil.split('-').map(Number);
           groupSettings.lockedUntil = startOfDay(new Date(parts[0], parts[1]-1, parts[2]));
        } else {
           groupSettings.lockedUntil = null;
        }

        subscribeConstraints();
      });
    }

    function subscribeConstraints() {
      if(unsubConstraints) unsubConstraints();
      
      const start = groupSettings.startDate;
      const mKey = monthKeyFrom(start); // Load based on start month
      
      unsubConstraints = onSnapshot(collection(db, "groups", currentGroup, "constraints", mKey, "days"), (snap) => {
        state = {};
        snap.forEach(doc => state[doc.id] = doc.data());
        renderApp();
        document.getElementById("loadingSchedule").classList.add("hidden");
      });
    }

    // 3. Render
    function renderApp() {
      const start = groupSettings.startDate;
      // End date logic: Start + (Weeks * 7) - 1
      const totalDays = groupSettings.weeks * 7;
      const end = addDays(start, totalDays - 1);
      
      // Header Info
      document.getElementById("dateRangeBadge").textContent = `${fmtShow(start)} â€“ ${fmtShow(end)}`;
      
      // Lock Status
      const isLocked = groupSettings.lockedUntil && new Date() < groupSettings.lockedUntil;
      const canEdit = currentUser && (currentUser.role === 'admin' || !isLocked);
      
      document.getElementById("lockedBadge").style.display = isLocked ? "inline-flex" : "none";
      document.getElementById("saveBtn").disabled = !canEdit;
      document.getElementById("saveBtn").style.opacity = !canEdit ? "0.5" : "1";

      // --- RIGHT PANEL: CONSTRAINTS ---
      // Fix: Always start constraints grid from SUNDAY to align with headers
      const gridStart = prevSunday(start);
      // We need to cover enough days to include the 'end' date, filling full weeks
      // Calculate weeks difference
      const gridEnd = addDays(gridStart, (Math.ceil((end - gridStart + 1) / MS_DAY / 7) * 7) - 1);
      
      let html = "";
      let curr = new Date(gridStart);
      
      // Chips
      const chipsEl = document.getElementById("peopleChips");
      chipsEl.innerHTML = groupMembers.map(p => 
        `<div class="person-chip ${p === currentUser?.name ? 'active' : ''}">${p}</div>`
      ).join("");

      while (curr <= gridEnd) {
        const k = fmtKey(curr);
        const day = curr.getDay(); // 0=Sun, 6=Sat
        const isShabbat = day === 6;
        const inRange = curr >= start && curr <= end; // Visual distinction for out of range
        
        // My status
        const val = (state[k] && currentUser) ? (state[k][currentUser.name] || 0) : 0;
        
        let classes = "day-cell";
        if (isShabbat) classes += " shabbat";
        else classes += ` state-${val}`;
        
        if (!inRange) classes += " out-of-range"; // Optional: dim days outside selected range

        html += `
          <div class="${classes}" 
               style="${!inRange ? 'opacity:0.3' : ''}"
               onclick="toggleDay('${k}', ${isShabbat}, ${inRange})">
            <div class="day-num">${curr.getDate()}</div>
            <div class="day-month">${curr.getMonth()+1}</div>
          </div>
        `;
        curr = addDays(curr, 1);
      }
      document.getElementById("daysGrid").innerHTML = html;

      // --- LEFT PANEL: SCHEDULE ---
      const pack = computeSchedule(start, end);
      renderScheduleGrid(pack, start, end);
      renderSummary(pack);
      
      // Admin Button
      if (currentUser?.role === 'admin' && currentUser?.group === currentGroup) {
        document.getElementById("adminBtn").classList.remove("hidden");
      } else {
        document.getElementById("adminBtn").classList.add("hidden");
      }
    }

    // 4. Toggle Logic
    window.toggleDay = (k, isShabbat, inRange) => {
      if (isShabbat) return;
      if (!inRange) return toast("×ª××¨×™×š ×–×” ××—×•×¥ ×œ×˜×•×•×— ×”×©×™×‘×•×¥", "warning");
      if (!currentUser) return toast("×™×© ×œ×”×ª×—×‘×¨ ×›×“×™ ×œ×¢×¨×•×š", "danger");
      
      const isLocked = groupSettings.lockedUntil && new Date() < groupSettings.lockedUntil;
      if (isLocked && currentUser.role !== 'admin') return toast("×”×œ×•×— × ×¢×•×œ ×œ×¢×¨×™×›×”", "danger");
      
      if (currentUser.group !== currentGroup && currentUser.role !== 'admin') {
         return toast("××™× ×š ×©×™×™×š ×œ×§×‘×•×¦×” ×–×•", "danger");
      }

      // Optimistic UI Update
      if (!state[k]) state[k] = {};
      const oldVal = state[k][currentUser.name] || 0;
      state[k][currentUser.name] = (oldVal + 1) % 3;
      renderApp(); // Re-render to show change
    };

    // 5. Schedule Algorithm
    function computeSchedule(startDate, endDate) {
      const days = [];
      let c = new Date(startDate);
      while(c <= endDate) { days.push(new Date(c)); c = addDays(c, 1); }

      const assign = {};
      const counts = {}; groupMembers.forEach(m => counts[m] = { total: 0, fri: 0 });
      const weeks = {}; 

      days.forEach(d => {
        const dow = d.getDay();
        if (dow === 6) return; // Skip Shabbat
        
        const k = fmtKey(d);
        // Determine week index relative to start
        const wIdx = Math.floor((d - prevSunday(startDate)) / (7 * MS_DAY));
        if (!weeks[wIdx]) weeks[wIdx] = {};
        
        // Candidates
        let candidates = groupMembers.filter(p => {
           const pref = state[k]?.[p] || 0;
           return pref !== 2; // Not red
        });

        // Preference: Green (0) > Orange (1)
        const greens = candidates.filter(p => (state[k]?.[p]||0) === 0);
        if(greens.length) candidates = greens;

        // Sort by fairness
        candidates.sort((a,b) => {
           // Friday fairness
           if(dow === 5) return counts[a].fri - counts[b].fri;
           // Total fairness
           return counts[a].total - counts[b].total;
        });

        const winner = candidates[0];
        if (winner) {
          assign[k] = winner;
          counts[winner].total++;
          if (dow === 5) counts[winner].fri++;
          weeks[wIdx][winner] = (weeks[wIdx][winner]||0) + 1;
        }
      });
      
      return { assign, counts, weeks };
    }

    function renderScheduleGrid(pack, start, end) {
      const { assign } = pack;
      let html = `<div class="col-hd"></div>
                  <div class="col-hd">××³</div><div class="col-hd">×‘×³</div><div class="col-hd">×’×³</div>
                  <div class="col-hd">×“×³</div><div class="col-hd">×”×³</div><div class="col-hd">×•×³</div>`;
      
      let weekStart = prevSunday(start);
      // Render as many weeks as configured + safety buffer logic handled by loop
      const finalDate = addDays(start, (groupSettings.weeks * 7) - 1);

      while (weekStart <= finalDate) {
        const weekEnd = addDays(weekStart, 6);
        html += `<div style="display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--text-muted);white-space:nowrap;writing-mode:vertical-rl;transform:rotate(180deg)">
                   ${fmtShow(weekStart)} - ${fmtShow(weekEnd)}
                 </div>`;
        
        for (let i=0; i<6; i++) { // Sun-Fri
           const cur = addDays(weekStart, i);
           const k = fmtKey(cur);
           const inRange = cur >= start && cur <= end;
           
           if (!inRange) {
             html += `<div class="shift-card" style="opacity:0.2; border:none"></div>`;
             continue;
           }

           const isFri = i === 5;
           const time = isFri ? "08:00-14:00" : "16:00-22:00";
           const winner = assign[k];
           
           // Warnings
           let warnings = "";
           const row = state[k] || {};
           const reds = groupMembers.filter(m => row[m]===2).length;
           const oranges = groupMembers.filter(m => row[m]===1).length;
           
           if(reds) warnings += `<span style="color:var(--danger);font-size:10px">ğŸ”´ ${reds}</span> `;
           if(oranges) warnings += `<span style="color:var(--warning);font-size:10px">ğŸŸ  ${oranges}</span>`;

           html += `
             <div class="shift-card ${isFri?'fri':''}">
               <div>
                 <div class="shift-date">${hebDaysLong[i]} ${cur.getDate()}</div>
                 <div class="shift-time">${time}</div>
               </div>
               <div class="assignee ${winner?'filled':'empty'}">
                 ${winner || '××™×Ÿ ×©×™×‘×•×¥'}
               </div>
               <div style="margin-top:4px; text-align:center">${warnings}</div>
             </div>
           `;
        }
        weekStart = addDays(weekStart, 7);
      }
      document.getElementById("scheduleGrid").innerHTML = html;
    }

    function renderSummary(pack) {
      const { counts, weeks } = pack;
      let html = `<table style="width:100%; border-collapse:collapse; font-size:14px; text-align:center">
         <thead><tr style="border-bottom:1px solid var(--glass-border); color:var(--text-muted)">
         <th style="padding:10px; text-align:right">×©×</th>`;
      
      // Dynamic week headers
      Object.keys(weeks).sort().forEach((w, i) => html += `<th style="padding:10px">×©×‘×•×¢ ${i+1}</th>`);
      html += `<th style="padding:10px; color:var(--text-main)">×¡×”×´×›</th><th style="padding:10px; color:var(--primary)">×©×™×©×™</th></tr></thead><tbody>`;

      groupMembers.forEach(m => {
        html += `<tr style="border-bottom:1px solid rgba(255,255,255,0.05)">
          <td style="padding:10px; text-align:right; font-weight:600">${m}</td>`;
        
        Object.keys(weeks).sort().forEach(w => {
           html += `<td style="padding:10px; opacity:0.8">${weeks[w]?.[m] || 0}</td>`;
        });
        
        html += `<td style="padding:10px; font-weight:bold">${counts[m].total}</td>
                 <td style="padding:10px; color:var(--primary); font-weight:bold">${counts[m].fri}</td></tr>`;
      });
      html += `</tbody></table>`;
      document.getElementById("summaryBox").innerHTML = html;
    }

    // --- BUTTONS & MODALS ---

    document.getElementById("saveBtn").onclick = async () => {
       if(!currentUser) return toast("×œ× ××—×•×‘×¨", "danger");
       const mKey = monthKeyFrom(groupSettings.startDate);
       const batch = writeBatch(db);
       let changes = 0;
       
       for(const [k, v] of Object.entries(state)) {
         if(v[currentUser.name] !== undefined) {
           const ref = doc(db, "groups", currentGroup, "constraints", mKey, "days", k);
           batch.set(ref, {[currentUser.name]: v[currentUser.name]}, {merge:true});
           changes++;
         }
       }
       if(changes) {
         await batch.commit();
         toast("× ×©××¨ ×‘×”×¦×œ×—×”!");
       } else {
         toast("×œ× ×‘×•×¦×¢×• ×©×™× ×•×™×™×", "warning");
       }
    };

    document.getElementById("resetMineBtn").onclick = () => {
      if(confirm("×œ× ×§×•×ª ××ª ×”×‘×—×™×¨×” ×©×œ×š?")) {
        for(let k in state) if(state[k][currentUser.name]) delete state[k][currentUser.name];
        renderApp();
      }
    };

    // Export CSV
    document.getElementById("exportBtn").onclick = () => {
       const start = groupSettings.startDate;
       const end = addDays(start, (groupSettings.weeks*7)-1);
       const pack = computeSchedule(start, end);
       
       let csv = "\uFEFF×ª××¨×™×š,×™×•×,××©××¨×ª,××©×•×‘×¥\n";
       let curr = new Date(start);
       while(curr <= end) {
         const day = curr.getDay();
         if(day !== 6) {
           const k = fmtKey(curr);
           const shift = day===5 ? "×‘×•×§×¨ (08-14)" : "×¢×¨×‘ (16-22)";
           csv += `${fmtShow(curr)},${hebDaysLong[day]},${shift},${pack.assign[k]||''}\n`;
         }
         curr = addDays(curr, 1);
       }
       
       const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
       const url = URL.createObjectURL(blob);
       const a = document.createElement('a');
       a.href = url; a.download = `schedule_${currentGroup}.csv`;
       a.click();
    };

    // Identity
    function showIdentity() {
      const sel = document.getElementById("identitySelect");
      sel.innerHTML = `<option value="">×‘×—×¨...</option>` + 
        [...USERS_DB].sort((a,b)=>a.group.localeCompare(b.group)).map(u => 
        `<option value="${u.id}">${u.name} (${u.group})</option>`).join("");
      document.getElementById("identityBackdrop").style.display = "flex";
    }

    document.getElementById("identityStartBtn").onclick = () => {
      const uid = document.getElementById("identitySelect").value;
      if(uid) {
         const u = USERS_DB.find(x=>x.id===uid);
         localStorage.setItem("scheduler_uid", uid);
         loginUser(u);
         document.getElementById("identityBackdrop").style.display = "none";
      }
    };

    function loginUser(u) {
      currentUser = u;
      const badge = document.getElementById("whoami");
      badge.innerHTML = `<div class="avatar">${u.name[0]}</div><span>${u.name}</span>`;
      
      if(u.group !== currentGroup) switchGroup(u.group);
      else { renderTabsState(); loadGroup(); }
      
      badge.onclick = () => {
        if(confirm("×œ×”×ª× ×ª×§?")) {
          localStorage.removeItem("scheduler_uid");
          location.reload();
        }
      };
    }

    // Admin
    document.getElementById("adminBtn").onclick = () => {
       document.getElementById("adminGroupName").innerText = currentGroup;
       document.getElementById("dateInput").value = fmtKey(groupSettings.startDate);
       document.getElementById("durationSelect").value = groupSettings.weeks;
       document.getElementById("lockInput").value = groupSettings.lockedUntil ? fmtKey(groupSettings.lockedUntil) : "";
       document.getElementById("adminBackdrop").style.display = "flex";
    };

    document.getElementById("adminCancelBtn").onclick = () => 
       document.getElementById("adminBackdrop").style.display = "none";

    document.getElementById("adminSaveBtn").onclick = async () => {
       const start = document.getElementById("dateInput").value;
       const w = document.getElementById("durationSelect").value;
       const lock = document.getElementById("lockInput").value;
       
       if(!start) return toast("×—×•×‘×” ×œ×‘×—×•×¨ ×ª××¨×™×š", "danger");
       
       await setDoc(doc(db, "groups", currentGroup), {
         startDate: start,
         weeks: Number(w),
         lockedUntil: lock || ""
       }, {merge:true});
       
       document.getElementById("adminBackdrop").style.display = "none";
       toast("×”×’×“×¨×•×ª × ×©××¨×•!");
    };
    
    document.getElementById("adminResetBtn").onclick = async () => {
       if(confirm("×¤×¢×•×œ×” ×–×• ×ª××—×§ ××ª ×›×œ ×”××™×œ×•×¦×™× ×œ×—×•×“×© ×–×”. ×‘×˜×•×—?")) {
         const mKey = monthKeyFrom(groupSettings.startDate);
         const q = query(collection(db, "groups", currentGroup, "constraints", mKey, "days"));
         const snap = await getDocs(q);
         const batch = writeBatch(db);
         snap.forEach(d => batch.delete(d.ref));
         await batch.commit();
         toast("×”× ×ª×•× ×™× ××•×¤×¡×•");
         document.getElementById("adminBackdrop").style.display = "none";
       }
    };

    // Init
    init();

  </script>
</body>
</html>
