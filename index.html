<!DOCTYPE html>
<html lang="he" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>××¢×¨×›×ª ×©×™×‘×•×¦×™× - ×¡×“× ×”</title>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* --- ×¢×™×¦×•×‘ ××§×•×¨×™ --- */
    :root{
      --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9aa6b2;
      --border:#273244; --accent:#38bdf8; --accent2:#22d3ee;
      --chip-bg:#0b1222; --pill-bg:#122; --btn-ink:#06121c;
      --ok-bg:#032015; --ok-br:#0c3; --ok-ink:#b7f7cf;
      --warn-bg:#231e07; --warn-br:#54450a; --warn-ink:#fde68a;
      --bad-bg:#2b0a0a; --bad-br:#521; --bad-ink:#fecaca;
      --fri-bg:#0a1d2b; --fri-br:#224055; --fri-pill:#0e2a3f;
      --badge-bg:transparent;
      --title-g1: var(--accent); --title-g2: var(--accent2);
      --toast-bg: rgba(15,23,42,.9); --toast-br:#2b3a55; --toast-ink:#e5e7eb;
      --toast-ok:#16a34a; --toast-warn:#eab308; --toast-bad:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; overflow-x:hidden;
      font-family:"Assistant",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif;
      background:
        radial-gradient(1200px 800px at 80% -10%, #0b1222 0%, var(--bg) 40%),
        linear-gradient(180deg, #0b1222 0%, var(--bg) 100%);
      color:var(--ink); font-size:16px;
    }
    
    .app{max-width:1600px;margin:0 auto;padding:16px}
    header.header{display:flex;justify-content:space-between;align-items:flex-start;gap:16px;flex-wrap:wrap; margin-bottom: 20px;}
    .title{margin:0;font-weight:800;letter-spacing:.2px;font-size:clamp(22px,2.8vw,34px);
      background:linear-gradient(90deg,var(--title-g1),var(--title-g2));
      -webkit-background-clip:text;background-clip:text;color:transparent}
    
    /* Tabs Design */
    .group-tabs { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
    .tab-btn {
        background: var(--chip-bg); border: 1px solid var(--border); color: var(--muted);
        padding: 6px 14px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s;
        font-family: inherit;
    }
    .tab-btn:hover { background: var(--border); color: var(--ink); }
    .tab-btn.active {
        background: var(--accent); color: var(--btn-ink); border-color: var(--accent);
        box-shadow: 0 4px 12px rgba(56, 189, 248, 0.25);
    }

    .header-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap;max-width:100%}
    .badge{border:1px solid var(--border);border-radius:999px;padding:6px 12px;font-size:13px;color:var(--muted);background:var(--badge-bg)}
    .id-badge{border:1px solid var(--border);padding:6px 12px;border-radius:999px;font-size:13px; cursor: pointer; transition: 0.2s; display:flex; align-items:center; gap:6px}
    .id-badge:hover{background: var(--chip-bg);}

    .two{
      display:grid;
      grid-template-columns:minmax(0,1fr) minmax(0,2.2fr); /* ×©×™× ×™×ª×™ ×™×—×¡ ×œ×˜×•×‘×ª ×”×œ×•×— */
      grid-template-areas:"constraints schedule";
      gap:24px; align-items:start;
    }
    .constraints{grid-area:constraints}
    .schedule-panel{grid-area:schedule}

    @media (max-width: 1100px){
      .two{grid-template-columns:1fr;grid-template-areas:"schedule" "constraints";}
      .constraints{position:static}
      .constraints .bd{max-height:none;overflow:visible}
    }

    .panel{background:linear-gradient(180deg,var(--card),color-mix(in oklab,var(--card) 80%,var(--bg)));
      border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08);overflow:hidden}
    .panel .hd{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px; flex-wrap:wrap;}
    .panel .bd{padding:16px}
    .panel h3{margin:0;font-size:20px}

    button{cursor:pointer;border:none;border-radius:12px;padding:10px 14px;font-weight:700;color:var(--btn-ink);background:linear-gradient(90deg,var(--accent),var(--accent2)); font-family:inherit;}
    button.ghost{background:transparent;color:var(--ink);border:1px solid var(--border)}
    button[disabled]{opacity:.5;cursor:not-allowed}
    
    .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:10px;background:var(--chip-bg);border:1px solid var(--border);color:var(--ink)}
    
    .legend{display:flex;align-items:center;gap:10px;color:var(--muted);font-size:13px; margin-inline-start: auto;}
    .dot{display:inline-block;width:12px;height:12px;border-radius:4px;border:1px solid var(--border)}
    .dot-0{background:var(--chip-bg)}
    .dot-1{background:#231e07;border-color:#54450a}
    .dot-2{background:#2b0a0a;border-color:#512}

    .people{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px; justify-content:center;}
    .chip{background:var(--chip-bg);color:var(--ink);border:1px solid var(--border);border-radius:999px;padding:6px 12px; opacity: 0.6; pointer-events: none; transition:0.2s; font-size:14px;}
    .chip.active{outline:2px solid var(--accent); opacity: 1; font-weight:700;}

    /* Days Grid for Constraints */
    .days{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .day-col-header{text-align:center; font-size:14px; color:var(--muted); padding-bottom:4px;}
    
    .day{
        background:var(--chip-bg);border:1px solid var(--border);
        border-radius:10px; padding:6px; text-align:center; cursor:pointer; 
        min-height:60px; display:flex; flex-direction:column; gap:4px; justify-content:center;
        transition:0.1s;
    }
    .day:hover{border-color:var(--accent);}
    .day .d1{font-size:16px; font-weight:700;}
    .day .d2{font-size:11px;color:var(--muted)}
    
    /* Logic Styles */
    .day.shabbat{opacity:.2; cursor:not-allowed; border:1px dashed var(--border); background:transparent;}
    .day.fri{background:var(--fri-bg); border-color:var(--fri-br);}
    
    .day.state-1{background:var(--warn-bg); border-color:var(--warn-br); color:var(--warn-ink);}
    .day.state-2{background:var(--bad-bg); border-color:var(--bad-br); color:var(--bad-ink);}

    .hint{color:var(--muted);font-size:12px;margin-top:12px; text-align:center;}

    /* Schedule Grid */
    .schedule{display:grid;grid-template-columns:minmax(80px,8ch) repeat(6,minmax(0,1fr));gap:10px;align-items:stretch}
    @media (max-width:700px){.schedule{grid-template-columns:1fr}.schedule .col-hd{display:none}}
    .col-hd{font-size:13px;color:var(--muted);text-align:center;white-space:nowrap; margin-bottom:8px;}

    .slot{background:var(--chip-bg);border:1px solid var(--border);border-radius:12px;min-height:88px;padding:10px;display:flex;flex-direction:column;gap:8px;min-width:0; position:relative;}
    .slot.fri{background:var(--fri-bg);border-color:var(--fri-br)}
    .slot .datebox{display:flex; justify-content:space-between; align-items:baseline;}
    .slot .datebox .d-top{font-size:15px;font-weight:700}
    .slot .datebox .d-time{font-size:11px;color:var(--muted)}
    
    .pill{display:inline-flex;align-items:center;justify-content:center; gap:6px;font-size:13px;padding:6px 8px;border-radius:8px;border:1px solid var(--border);background:var(--pill-bg);white-space:nowrap; font-weight:600;}
    .pill.ok{background:var(--ok-bg);border-color:var(--ok-br);color:var(--ok-ink)}
    .pill.bad{background:var(--bad-bg);border-color:var(--bad-br);color:var(--bad-ink)}
    
    .warn-badge { position:absolute; bottom:6px; left:6px; font-size:10px; color:var(--warn-ink); background:var(--warn-bg); padding:2px 6px; border-radius:4px; }

    .constraints{align-self:start; position:sticky; top:20px}

    /* Modals */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal{width:min(500px,92vw);background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 24px 60px rgba(0,0,0,.5);padding:24px}
    .modal h2{margin:0 0 12px 0; color:var(--accent)}
    .row{margin-top:16px}
    .row label{display:block; font-size:14px; color:var(--muted); margin-bottom:6px;}
    .select,.date{background:var(--bg);color:var(--ink);border:1px solid var(--border);padding:12px;border-radius:10px;width:100%;font-size:16px; font-family:inherit;}
    .modal .actions{display:flex;gap:12px;justify-content:flex-end;margin-top:24px}

    .admin-bar{position:fixed;left:12px;top:12px;z-index:10000;}
    
    .loading-overlay {
        position: absolute; inset: 0; background: var(--bg); opacity: 0.9; 
        display: flex; align-items: center; justify-content: center; z-index: 50; flex-direction: column; gap: 10px;
    }
    .hidden { display: none !important; }
    
    .toast-wrap{position:fixed;left:50%;transform:translateX(-50%);bottom:30px;z-index:10050;display:flex;flex-direction:column;gap:8px;pointer-events:none}
    .toast{pointer-events:auto;background:var(--card);border:1px solid var(--accent);color:var(--ink);padding:12px 20px;border-radius:99px;box-shadow:0 10px 40px rgba(0,0,0,.5); display:flex;align-items:center;gap:10px}
  </style>
</head>
<body>

  <!-- Admin Trigger -->
  <div class="admin-bar">
    <button id="adminBtn" class="icon-btn hidden" title="× ×™×”×•×œ">âš™ï¸</button>
  </div>

  <div class="app">
    <header class="header">
      <div>
        <h1 class="title">××¢×¨×›×ª ×©×™×‘×•×¦×™× - ×¡×“× ×”</h1>
        <div class="group-tabs" id="groupTabs">
           <!-- Tabs Injected Here -->
        </div>
      </div>
      <div class="header-actions">
        <div id="whoami" class="id-badge">
          <span>ğŸ‘‹</span>
          <span id="whoamiName">×œ× ××—×•×‘×¨</span>
        </div>
      </div>
    </header>

    <main class="two">
      
      <!-- SCHEDULE (Left) -->
      <section class="panel schedule-panel" style="position:relative; min-height:400px">
        <div id="loadingSchedule" class="loading-overlay hidden">
            <span>×˜×•×¢×Ÿ × ×ª×•× ×™×...</span>
        </div>
        
        <div class="hd">
          <h3 style="flex:1">×œ×•×— ×©×™×‘×•×¦×™×</h3>
          <span id="dateRangeBadge" class="badge"></span>
          <span id="lockedBadge" class="badge" style="color:var(--bad-ink); border-color:var(--bad-br); display:none">ğŸ”’ × ×¢×•×œ</span>
          <button id="exportBtn" class="ghost" style="font-size:13px">ğŸ“¥ CSV</button>
        </div>
        
        <div class="bd">
          <div id="scheduleGrid" class="schedule"></div>
          
          <div style="margin-top:20px; padding-top:20px; border-top:1px solid var(--border)">
             <h4 style="margin:0 0 10px 0; color:var(--muted)">×¡×™×›×•× ××©××¨×•×ª</h4>
             <div id="summaryBox" style="overflow-x:auto"></div>
          </div>
        </div>
      </section>

      <!-- CONSTRAINTS (Right) -->
      <section class="panel constraints">
        <div class="hd">
          <h3>××™×œ×•×¦×™×</h3>
          <div class="legend">
            <span class="dot dot-0"></span> ×–××™×Ÿ
            <span class="dot dot-1"></span> ××¢×“×™×£ ×©×œ×
            <span class="dot dot-2"></span> ×œ× ×–××™×Ÿ
          </div>
        </div>
        <div class="bd">
          <div id="peopleChips" class="people"></div>
          
          <!-- Days Header -->
          <div style="display:grid; grid-template-columns:repeat(7,1fr); gap:8px; margin-bottom:6px">
             <div class="day-col-header">××³</div><div class="day-col-header">×‘×³</div>
             <div class="day-col-header">×’×³</div><div class="day-col-header">×“×³</div>
             <div class="day-col-header">×”×³</div><div class="day-col-header">×•×³</div>
             <div class="day-col-header" style="color:#f87171">×©×³</div>
          </div>
          
          <div id="daysGrid" class="days"></div>
          
          <p class="hint">×˜×¤×™×—×” ×¢×œ ×™×•× ××©× ×” ××¦×‘. ×”× ×ª×•× ×™× × ×©××¨×™× ×‘×¢× ×Ÿ.</p>
          
          <div style="display:flex;gap:10px;margin-top:20px">
            <button id="saveBtn" style="flex:1">×©××•×¨ ×©×™× ×•×™×™×</button>
            <button id="resetMineBtn" class="ghost">××¤×¡ ×‘×—×™×¨×”</button>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- Toast -->
  <div id="toastWrap" class="toast-wrap"></div>

  <!-- Login Modal -->
  <div id="identityBackdrop" class="modal-backdrop">
    <div class="modal">
      <h2>×”×™×™, ××™ ××ª/×”?</h2>
      <p>×‘×—×¨ ××ª ×”×©× ×©×œ×š ×›×“×™ ×œ×”×ª×—×‘×¨ ×œ××¢×¨×›×ª.</p>
      <div class="row">
        <select id="identitySelect" class="select"><option value="">×˜×•×¢×Ÿ ×¨×©×™××”...</option></select>
      </div>
      <div class="actions">
        <button id="identityStartBtn" style="width:100%">×”×ª×—×‘×¨</button>
      </div>
    </div>
  </div>

  <!-- Admin Modal -->
  <div id="adminBackdrop" class="modal-backdrop">
    <div class="modal">
      <h2>×”×’×“×¨×•×ª ×× ×”×œ: <span id="adminGroupName" style="color:var(--accent)"></span></h2>
      
      <div class="row">
        <label>×ª××¨×™×š ×”×ª×—×œ×” ×œ×©×™×‘×•×¥</label>
        <input id="dateInput" class="date" type="date" />
      </div>
      
      <div class="row">
        <label>××©×š ×–××Ÿ (××¡×¤×¨ ×©×‘×•×¢×•×ª)</label>
        <select id="durationSelect" class="select">
           <option value="1">×©×‘×•×¢ ××—×“</option>
           <option value="2">×©×‘×•×¢×™×™×</option>
           <option value="3">3 ×©×‘×•×¢×•×ª</option>
           <option value="4">4 ×©×‘×•×¢×•×ª</option>
        </select>
      </div>

      <div class="row">
        <label>× ×¢×•×œ ×œ×¢×¨×™×›×” ×¢×“ (×ª××¨×™×š)</label>
        <input id="lockInput" class="date" type="date" />
      </div>

      <div class="row" style="margin-top:24px; padding-top:20px; border-top:1px solid var(--border)">
        <button id="adminResetBtn" class="ghost" style="color:#fca5a5; border-color:#7f1d1d; width:100%">âš ï¸ ××™×¤×•×¡ ×›×œ ×”××™×œ×•×¦×™× ×œ×˜×•×•×— ×–×”</button>
      </div>
      
      <div class="actions">
        <button id="adminCancelBtn" class="ghost">×¡×’×•×¨</button>
        <button id="adminSaveBtn">×©××•×¨ ×”×’×“×¨×•×ª</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDocs, collection, query, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // --- CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyBiZIHRpbg0bq4VFZ2kDDXj6QeRJZpjOpg",
      authDomain: "sadna-timetable.firebaseapp.com",
      projectId: "sadna-timetable",
      storageBucket: "sadna-timetable.firebasestorage.app",
      messagingSenderId: "605203492621",
      appId: "1:605203492621:web:7ed83f0e5e64d67b9c8a44",
      measurementId: "G-8941L7ZZJ6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const GROUPS = ["××“×¤×¡×•×ª", "×ª×¤×™×¨×”", "××ª×›×ª", "×¢×™×‘×•×“ ×©×‘×‘×™×", "×¢×¥"];
    
    // ×¨×©×™××ª ××©×ª××©×™× - × ×™×ª×Ÿ ×œ×”×•×¡×™×£/×œ×©× ×•×ª ×›××Ÿ
    const USERS_DB = [
        {id:"u1", name:"× ×‘×•", group:"××“×¤×¡×•×ª", role:"admin"},
        {id:"u2", name:"× ×˜×¢", group:"××“×¤×¡×•×ª", role:"user"},
        {id:"u3", name:"×˜×œ", group:"××“×¤×¡×•×ª", role:"user"},
        {id:"u4", name:"×›×œ×™×œ", group:"×ª×¤×™×¨×”", role:"user"},
        {id:"u5", name:"×¢××™×ª", group:"×ª×¤×™×¨×”", role:"user"},
        {id:"u6", name:"×©×™×¨×”", group:"×ª×¤×™×¨×”", role:"user"},
        {id:"u7", name:"×××™", group:"××ª×›×ª", role:"user"},
        {id:"u8", name:"×œ×™×¢×“", group:"×¢×™×‘×•×“ ×©×‘×‘×™×", role:"user"},
        {id:"u9", name:"××•×¨×™", group:"×¢×¥", role:"user"}
    ];

    const MS_DAY = 86400000;
    const hebDaysLong = ["×¨××©×•×Ÿ","×©× ×™","×©×œ×™×©×™","×¨×‘×™×¢×™","×—××™×©×™","×©×™×©×™","×©×‘×ª"];

    // State
    let currentGroup = GROUPS[0];
    let currentUser = null;
    let groupMembers = [];
    let groupSettings = { startDate: new Date(), lockedUntil: null, weeks: 4 };
    let state = {};
    let unsubSettings = null;
    let unsubConstraints = null;

    // Utils
    const startOfDay = d => { const c=new Date(d); c.setHours(0,0,0,0); return c; };
    const addDays = (d,n) => new Date(startOfDay(d).getTime() + n*MS_DAY);
    const prevSunday = d => { let x=startOfDay(d); while(x.getDay()!==0) x=addDays(x,-1); return x; };
    const fmtKey = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const fmtShow = d => `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}`;
    const monthKeyFrom = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    
    function toast(msg, type="ok") {
        const el = document.createElement("div");
        el.className = "toast";
        el.innerHTML = `<span>${type==='ok'?'âœ…':'âš ï¸'}</span> ${msg}`;
        document.getElementById("toastWrap").appendChild(el);
        setTimeout(() => { el.style.opacity="0"; setTimeout(()=>el.remove(),300); }, 2500);
    }

    // --- APP LOGIC ---

    function init() {
        // Render Tabs
        document.getElementById("groupTabs").innerHTML = GROUPS.map(g => 
            `<button class="tab-btn" onclick="window.switchGroup('${g}')">${g}</button>`
        ).join("");

        // Auth Check
        const savedUid = localStorage.getItem("scheduler_uid");
        if(savedUid) {
            const u = USERS_DB.find(x => x.id === savedUid);
            if(u) loginUser(u);
            else showIdentity();
        } else {
            showIdentity();
        }
        
        if(!auth.currentUser) signInAnonymously(auth);
    }

    window.switchGroup = (g) => {
        currentGroup = g;
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.toggle("active", b.innerText===g));
        loadGroupData();
    };

    function loadGroupData() {
        document.getElementById("loadingSchedule").classList.remove("hidden");
        groupMembers = USERS_DB.filter(u => u.group === currentGroup).map(u => u.name);

        if(unsubSettings) unsubSettings();
        
        unsubSettings = onSnapshot(doc(db, "groups", currentGroup), async (snap) => {
            if(!snap.exists()) {
                await setDoc(doc(db, "groups", currentGroup), { startDate: fmtKey(new Date()), weeks: 4 });
                return;
            }
            const d = snap.data();
            
            // Start Date
            if(d.startDate) {
                const p = d.startDate.split('-').map(Number);
                groupSettings.startDate = startOfDay(new Date(p[0], p[1]-1, p[2]));
            } else groupSettings.startDate = startOfDay(new Date());

            // Lock Date
            if(d.lockedUntil) {
                const p = d.lockedUntil.split('-').map(Number);
                groupSettings.lockedUntil = startOfDay(new Date(p[0], p[1]-1, p[2]));
            } else groupSettings.lockedUntil = null;

            // Weeks
            groupSettings.weeks = d.weeks ? Number(d.weeks) : 4;

            subscribeConstraints();
        });
    }

    function subscribeConstraints() {
        if(unsubConstraints) unsubConstraints();
        
        const mKey = monthKeyFrom(groupSettings.startDate);
        unsubConstraints = onSnapshot(collection(db, "groups", currentGroup, "constraints", mKey, "days"), (snap) => {
            state = {};
            snap.forEach(doc => state[doc.id] = doc.data());
            renderApp();
            document.getElementById("loadingSchedule").classList.add("hidden");
        });
    }

    function renderApp() {
        const start = groupSettings.startDate;
        // Total range based on weeks setting
        const end = addDays(start, (groupSettings.weeks * 7) - 1);

        // Header
        document.getElementById("dateRangeBadge").textContent = `${fmtShow(start)} â€“ ${fmtShow(end)}`;
        
        const isLocked = groupSettings.lockedUntil && new Date() < groupSettings.lockedUntil;
        const isAdmin = currentUser?.role === 'admin';
        const canEdit = isAdmin || !isLocked;
        
        document.getElementById("lockedBadge").style.display = isLocked ? "inline-flex" : "none";
        document.getElementById("saveBtn").disabled = !canEdit;
        document.getElementById("adminBtn").classList.toggle("hidden", !(isAdmin && currentUser.group === currentGroup));

        // --- CONSTRAINTS PANEL ---
        const chipsEl = document.getElementById("peopleChips");
        chipsEl.innerHTML = groupMembers.map(p => 
            `<div class="chip ${p === currentUser?.name ? 'active' : ''}">${p}</div>`
        ).join("");

        const gridStart = prevSunday(start);
        // Ensure grid covers enough weeks to show the end date
        const weeksToShow = Math.ceil((end - gridStart + 1) / (7 * MS_DAY));
        const gridEnd = addDays(gridStart, (weeksToShow * 7) - 1);
        
        let html = "";
        let curr = new Date(gridStart);
        
        while(curr <= gridEnd) {
            const k = fmtKey(curr);
            const day = curr.getDay();
            const inRange = curr >= start && curr <= end;
            const val = (state[k] && currentUser) ? (state[k][currentUser.name] || 0) : 0;
            
            let classes = "day";
            if(day === 6) classes += " shabbat"; // Saturday
            else if(day === 5) classes += " fri"; // Friday
            
            if(val > 0) classes += ` state-${val}`;
            
            // Visual style for disabled/out-of-range
            const style = (!inRange) ? 'opacity:0.3; pointer-events:none' : '';

            html += `
                <div class="${classes}" style="${style}" onclick="toggleDay('${k}', ${day})">
                    <div class="d1">${curr.getDate()}</div>
                    <div class="d2">${curr.getMonth()+1}</div>
                </div>
            `;
            curr = addDays(curr, 1);
        }
        document.getElementById("daysGrid").innerHTML = html;

        // --- SCHEDULE PANEL ---
        const pack = computeSchedule(start, end);
        renderScheduleGrid(pack, start, end);
        renderSummary(pack);
    }

    window.toggleDay = (k, day) => {
        if(day === 6) return; // Block Shabbat clicks
        if(!currentUser) return toast("×œ× ××—×•×‘×¨", "warn");
        
        if(currentUser.group !== currentGroup && currentUser.role !== 'admin') {
            return toast("××™× ×š ×©×™×™×š ×œ×§×‘×•×¦×” ×–×•", "warn");
        }
        
        const isLocked = groupSettings.lockedUntil && new Date() < groupSettings.lockedUntil;
        if(isLocked && currentUser.role !== 'admin') return toast("×”×œ×•×— × ×¢×•×œ", "warn");

        if(!state[k]) state[k] = {};
        const old = state[k][currentUser.name] || 0;
        state[k][currentUser.name] = (old + 1) % 3;
        
        renderApp(); // Re-render locally
    };

    // --- ALGORITHM (Logic from Original) ---
    function computeSchedule(start, end) {
        const assign = {};
        const counts = {}; groupMembers.forEach(m => counts[m] = { total: 0, fri: 0 });
        const weeks = {};

        const days = [];
        let c = new Date(start);
        while(c <= end) { days.push(new Date(c)); c = addDays(c, 1); }

        days.forEach(d => {
            if(d.getDay() === 6) return; // Skip Shabbat

            const k = fmtKey(d);
            const wIdx = Math.floor((d - prevSunday(start)) / (7 * MS_DAY));
            if(!weeks[wIdx]) weeks[wIdx] = {};

            // 1. Filter Valid Candidates (Not Red)
            let candidates = groupMembers.filter(p => (state[k]?.[p] || 0) !== 2);
            
            // 2. Prioritize Green (0) over Yellow (1)
            const greens = candidates.filter(p => (state[k]?.[p] || 0) === 0);
            if(greens.length > 0) candidates = greens;

            // 3. Sort by Fairness (Friday Balance -> Total Balance)
            candidates.sort((a,b) => {
                if(d.getDay() === 5) return counts[a].fri - counts[b].fri;
                return counts[a].total - counts[b].total;
            });

            // 4. Assign
            const winner = candidates[0];
            if(winner) {
                assign[k] = winner;
                counts[winner].total++;
                if(d.getDay() === 5) counts[winner].fri++;
                weeks[wIdx][winner] = (weeks[wIdx][winner] || 0) + 1;
            }
        });

        return { assign, counts, weeks };
    }

    function renderScheduleGrid(pack, start, end) {
        const { assign } = pack;
        let html = `<div class="col-hd"></div>
                    <div class="col-hd">××³</div><div class="col-hd">×‘×³</div><div class="col-hd">×’×³</div>
                    <div class="col-hd">×“×³</div><div class="col-hd">×”×³</div><div class="col-hd">×•×³</div>`;
        
        let weekStart = prevSunday(start);
        const finalDate = addDays(start, (groupSettings.weeks * 7) - 1);

        while(weekStart <= finalDate) {
            const weekEnd = addDays(weekStart, 6);
            html += `<div style="display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--muted);white-space:nowrap;writing-mode:vertical-rl;transform:rotate(180deg)">
                        ${fmtShow(weekStart)} - ${fmtShow(weekEnd)}
                     </div>`;
            
            for(let i=0; i<6; i++) {
                const cur = addDays(weekStart, i);
                const k = fmtKey(cur);
                const inRange = cur >= start && cur <= end;

                if(!inRange) {
                    html += `<div class="slot" style="opacity:0.2; border:none"></div>`;
                    continue;
                }

                const isFri = (i===5);
                const shiftTime = isFri ? "08:00-14:00" : "16:00-22:00";
                const winner = assign[k];
                
                // Warnings (Yellow/Red)
                const row = state[k] || {};
                const oranges = groupMembers.filter(m => row[m]===1).length;
                const reds = groupMembers.filter(m => row[m]===2).length;
                let warnBadge = "";
                if(oranges || reds) warnBadge = `<div class="warn-badge">${oranges}ğŸŸ  ${reds}ğŸ”´</div>`;

                html += `
                    <div class="slot ${isFri?'fri':''}">
                        <div class="datebox">
                            <div class="d-top">${hebDaysLong[i]} ${cur.getDate()}</div>
                            <div class="d-time">${shiftTime}</div>
                        </div>
                        <div class="pill ${winner?'ok':'bad'}" style="margin-top:auto">
                            ${winner || '×¨×™×§'}
                        </div>
                        ${warnBadge}
                    </div>
                `;
            }
            weekStart = addDays(weekStart, 7);
        }
        document.getElementById("scheduleGrid").innerHTML = html;
    }

    function renderSummary(pack) {
        const { counts, weeks } = pack;
        let html = `<table style="width:100%; border-collapse:collapse; font-size:14px; text-align:center">
            <thead><tr style="border-bottom:1px solid var(--border); color:var(--muted)">
            <th style="padding:8px; text-align:right">×©×</th>`;
        
        Object.keys(weeks).sort().forEach((w,i) => html += `<th style="padding:8px">×©×‘×•×¢ ${i+1}</th>`);
        html += `<th style="padding:8px; color:var(--ink)">×¡×”×´×›</th><th style="padding:8px; color:var(--accent)">×©×™×©×™</th></tr></thead><tbody>`;

        groupMembers.forEach(m => {
            html += `<tr style="border-bottom:1px solid rgba(255,255,255,0.05)">
                <td style="padding:8px; text-align:right; font-weight:600">${m}</td>`;
            
            Object.keys(weeks).sort().forEach(w => {
                html += `<td style="padding:8px; opacity:0.7">${weeks[w]?.[m] || 0}</td>`;
            });

            html += `<td style="padding:8px; font-weight:bold">${counts[m].total}</td>
                     <td style="padding:8px; color:var(--accent); font-weight:bold">${counts[m].fri}</td></tr>`;
        });
        html += `</tbody></table>`;
        document.getElementById("summaryBox").innerHTML = html;
    }

    // --- BUTTONS ---
    document.getElementById("saveBtn").onclick = async () => {
        if(!currentUser) return;
        const mKey = monthKeyFrom(groupSettings.startDate);
        const batch = writeBatch(db);
        let count = 0;
        
        for(const [k, v] of Object.entries(state)) {
            if(v[currentUser.name] !== undefined) {
                const ref = doc(db, "groups", currentGroup, "constraints", mKey, "days", k);
                batch.set(ref, {[currentUser.name]: v[currentUser.name]}, {merge:true});
                count++;
            }
        }
        if(count) { await batch.commit(); toast("× ×©××¨ ×‘×”×¦×œ×—×”"); }
        else toast("××™×Ÿ ×©×™× ×•×™×™×", "warn");
    };

    document.getElementById("resetMineBtn").onclick = () => {
        if(confirm("×œ× ×§×•×ª ×‘×—×™×¨×”?")) {
            for(let k in state) if(state[k][currentUser.name]) delete state[k][currentUser.name];
            renderApp();
        }
    };

    document.getElementById("exportBtn").onclick = () => {
        const start = groupSettings.startDate;
        const end = addDays(start, (groupSettings.weeks*7)-1);
        const pack = computeSchedule(start, end);
        
        let csv = "\uFEFF×ª××¨×™×š,×™×•×,××©××¨×ª,××©×•×‘×¥\n";
        let c = new Date(start);
        while(c <= end) {
            if(c.getDay()!==6) {
                const k = fmtKey(c);
                const shift = c.getDay()===5 ? "×‘×•×§×¨" : "×¢×¨×‘";
                csv += `${fmtShow(c)},${hebDaysLong[c.getDay()]},${shift},${pack.assign[k]||''}\n`;
            }
            c = addDays(c,1);
        }
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv;charset=utf-8'}));
        a.download = `schedule_${currentGroup}.csv`;
        a.click();
    };

    // --- IDENTITY ---
    function showIdentity() {
        const s = document.getElementById("identitySelect");
        s.innerHTML = `<option value="">×‘×—×¨...</option>` + 
            [...USERS_DB].sort((a,b)=>a.group.localeCompare(b.group)).map(u=>`<option value="${u.id}">${u.name} (${u.group})</option>`).join("");
        document.getElementById("identityBackdrop").style.display="flex";
    }
    
    document.getElementById("identityStartBtn").onclick = () => {
        const uid = document.getElementById("identitySelect").value;
        if(uid) {
            localStorage.setItem("scheduler_uid", uid);
            loginUser(USERS_DB.find(x=>x.id===uid));
            document.getElementById("identityBackdrop").style.display="none";
        }
    };

    function loginUser(u) {
        currentUser = u;
        document.getElementById("whoamiName").innerText = u.name;
        if(u.group !== currentGroup) switchGroup(u.group);
        else { 
            document.querySelectorAll(".tab-btn").forEach(b => b.classList.toggle("active", b.innerText===currentGroup));
            loadGroupData();
        }
        document.getElementById("whoami").onclick = () => {
            if(confirm("×œ×”×ª× ×ª×§?")) { localStorage.removeItem("scheduler_uid"); location.reload(); }
        };
    }

    // --- ADMIN ---
    document.getElementById("adminBtn").onclick = () => {
        document.getElementById("adminGroupName").innerText = currentGroup;
        document.getElementById("dateInput").value = fmtKey(groupSettings.startDate);
        document.getElementById("durationSelect").value = groupSettings.weeks;
        document.getElementById("lockInput").value = groupSettings.lockedUntil ? fmtKey(groupSettings.lockedUntil) : "";
        document.getElementById("adminBackdrop").style.display = "flex";
    };

    document.getElementById("adminCancelBtn").onclick = () => document.getElementById("adminBackdrop").style.display="none";

    document.getElementById("adminSaveBtn").onclick = async () => {
        const s = document.getElementById("dateInput").value;
        const w = document.getElementById("durationSelect").value;
        const l = document.getElementById("lockInput").value;
        
        if(!s) return toast("×—×•×‘×” ×ª××¨×™×š", "warn");
        
        await setDoc(doc(db, "groups", currentGroup), {
            startDate: s, weeks: Number(w), lockedUntil: l || ""
        }, {merge:true});
        
        toast("×”×’×“×¨×•×ª × ×©××¨×•");
        document.getElementById("adminBackdrop").style.display="none";
    };

    document.getElementById("adminResetBtn").onclick = async () => {
        if(confirm("×œ××—×•×§ ××ª ×›×œ ×”××™×œ×•×¦×™× ×œ×˜×•×•×— ×–×”?")) {
            const mKey = monthKeyFrom(groupSettings.startDate);
            const q = query(collection(db, "groups", currentGroup, "constraints", mKey, "days"));
            const snap = await getDocs(q);
            const batch = writeBatch(db);
            snap.forEach(d => batch.delete(d.ref));
            await batch.commit();
            toast("××•×¤×¡ ×‘×”×¦×œ×—×”");
            document.getElementById("adminBackdrop").style.display="none";
        }
    };

    init();
  </script>
</body>
</html>
