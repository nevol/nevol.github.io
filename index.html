<!DOCTYPE html>
<html lang="he" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>××¢×¨×›×ª ×©×™×‘×•×¦×™× - ×¡×“× ×”</title>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* --- ×”×’×“×¨×•×ª ×¢×™×¦×•×‘ --- */
    :root{
      --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9aa6b2;
      --border:#273244; --accent:#38bdf8; --accent2:#22d3ee;
      --chip-bg:#0b1222; --pill-bg:#122; --btn-ink:#06121c;
      --ok-bg:#032015; --ok-br:#0c3; --ok-ink:#b7f7cf;
      --warn-bg:#231e07; --warn-br:#54450a; --warn-ink:#fde68a;
      --bad-bg:#2b0a0a; --bad-br:#521; --bad-ink:#fecaca;
      --fri-bg:#0a1d2b; --fri-br:#224055; --fri-pill:#0e2a3f;
      --badge-bg:transparent;
      --title-g1: var(--accent); --title-g2: var(--accent2);
      --toast-bg: rgba(15,23,42,.95); --toast-br:#2b3a55; --toast-ink:#e5e7eb;
    }
    
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; overflow-x:hidden;
      font-family:"Assistant",sans-serif;
      background: radial-gradient(1200px 800px at 80% -10%, #0b1222 0%, var(--bg) 40%), linear-gradient(180deg, #0b1222 0%, var(--bg) 100%);
      color:var(--ink); font-size:16px;
    }
    
    .app{max-width:1600px;margin:0 auto;padding:20px}
    
    /* Header & Tabs */
    header.header{display:flex;justify-content:space-between;align-items:flex-start;gap:16px;flex-wrap:wrap; margin-bottom: 24px;}
    .title{margin:0;font-weight:800;font-size:32px;
      background:linear-gradient(90deg,var(--title-g1),var(--title-g2));
      -webkit-background-clip:text;background-clip:text;color:transparent}
    
    .group-tabs { display: flex; gap: 10px; margin-top: 12px; }
    .tab-btn {
        background: var(--chip-bg); border: 1px solid var(--border); color: var(--muted);
        padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s;
        font-family: inherit;
    }
    .tab-btn:hover { background: var(--border); color: var(--ink); }
    .tab-btn.active {
        background: var(--accent); color: var(--btn-ink); border-color: var(--accent);
        box-shadow: 0 4px 12px rgba(56, 189, 248, 0.25);
    }

    .header-actions{display:flex;align-items:center;gap:10px}
    .id-badge{border:1px solid var(--border);padding:6px 14px;border-radius:99px;font-size:14px; cursor: pointer; transition: 0.2s; display:flex; align-items:center; gap:8px}
    .id-badge:hover{background: var(--chip-bg); border-color:var(--accent);}

    /* Main Grid Layout */
    .two{
      display:grid;
      grid-template-columns: 1fr 280px; /* ×¤×× ×œ ×™×× ×™ ×’×“×•×œ, ×¤×× ×œ ×©×××œ×™ (××™×œ×•×¦×™×) ×§×‘×•×¢ */
      gap:24px; align-items:start;
      grid-template-areas: "schedule constraints";
    }
    .constraints{grid-area:constraints}
    .schedule-panel{grid-area:schedule}

    @media (max-width: 1100px){
      .two{grid-template-columns:1fr; grid-template-areas:"constraints" "schedule";}
    }

    /* Panels */
    .panel{background:linear-gradient(180deg,var(--card),rgba(17, 24, 39, 0.8));
      border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.2); overflow:hidden}
    .panel .hd{padding:16px 20px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:12px; flex-wrap:wrap;}
    .panel .bd{padding:20px}
    .panel h3{margin:0;font-size:20px; font-weight:700}

    /* Buttons */
    button{cursor:pointer;border:none;border-radius:10px;padding:10px 16px;font-weight:700;color:var(--btn-ink);background:linear-gradient(90deg,var(--accent),var(--accent2)); font-family:inherit;}
    button.ghost{background:transparent;color:var(--ink);border:1px solid var(--border)}
    button[disabled]{opacity:.5;cursor:not-allowed}
    button:hover:not([disabled]){opacity:0.9}

    .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:10px;background:var(--chip-bg);border:1px solid var(--border);color:var(--ink)}

    /* Constraints Panel (Right) */
    .legend{display:flex; justify-content:center; gap:12px; color:var(--muted); font-size:12px; margin-bottom:16px;}
    .dot{display:inline-block;width:10px;height:10px;border-radius:50%; margin-inline-end:4px;}
    .dot-0{background:var(--ink); opacity:0.2}
    .dot-1{background:#fbbf24;}
    .dot-2{background:#f87171;}

    .people{display:flex; gap:6px; flex-wrap:wrap; margin-bottom:20px; justify-content:center;}
    .chip{background:var(--chip-bg);color:var(--muted);border:1px solid var(--border);border-radius:20px;padding:4px 12px; font-size:13px; transition:0.2s;}
    .chip.active{border-color:var(--accent); color:var(--accent); background:rgba(56, 189, 248, 0.1); font-weight:700;}

    /* Calendar Grid */
    .days-header{display:grid; grid-template-columns:repeat(7,1fr); text-align:center; font-size:13px; color:var(--muted); margin-bottom:6px; font-weight:700;}
    .days{display:grid; grid-template-columns:repeat(7,1fr); gap:6px;}
    
    .day{
        aspect-ratio: 1;
        background:var(--chip-bg); border:1px solid var(--border);
        border-radius:8px; text-align:center; cursor:pointer; 
        display:flex; flex-direction:column; align-items:center; justify-content:center;
        transition:0.1s; position:relative;
    }
    .day:hover{border-color:var(--accent);}
    .day .d1{font-size:15px; font-weight:700;}
    .day .d2{font-size:10px; color:var(--muted)}
    
    /* Logic Styles */
    .day.shabbat{opacity:.2; cursor:not-allowed; border:none; background:transparent;}
    .day.fri{background:var(--fri-bg); border-color:var(--fri-br);}
    
    .day.state-1{background:rgba(251, 191, 36, 0.15); border-color:rgba(251, 191, 36, 0.5); color:#fbbf24;}
    .day.state-2{background:rgba(248, 113, 113, 0.15); border-color:rgba(248, 113, 113, 0.5); color:#f87171;}

    /* Schedule Panel (Left) */
    .schedule{display:grid; grid-template-columns: 80px repeat(6, 1fr); gap:12px; margin-bottom:20px;}
    .col-hd{text-align:center; color:var(--muted); font-size:14px; margin-bottom:8px;}
    
    .row-hd{
        display:flex; align-items:center; justify-content:center;
        font-size:12px; color:var(--muted); writing-mode:vertical-rl; transform:rotate(180deg);
        letter-spacing:1px;
    }

    .slot{
        background:var(--chip-bg); border:1px solid var(--border); border-radius:12px;
        min-height:90px; padding:12px; display:flex; flex-direction:column; justify-content:space-between;
        position:relative; transition:0.2s;
    }
    .slot.fri{background:var(--fri-bg); border-color:var(--fri-br);}
    .slot:hover{transform:translateY(-2px); border-color:var(--accent);}
    
    .slot .date-info{display:flex; justify-content:space-between; align-items:center; font-size:13px; margin-bottom:6px;}
    .slot .date-info .num{font-weight:700; font-size:16px;}
    .slot .time{font-size:11px; color:var(--muted);}
    
    .assignee{
        text-align:center; padding:6px; border-radius:8px; font-size:14px; font-weight:700;
        background:var(--bg); border:1px dashed var(--border); color:var(--muted);
    }
    .assignee.filled{background:rgba(16, 185, 129, 0.15); color:#34d399; border:1px solid rgba(16, 185, 129, 0.3);}
    
    .warn-badge { position:absolute; bottom:6px; left:6px; font-size:10px; display:flex; gap:2px; }

    /* Utilities */
    .badge{border:1px solid var(--border);border-radius:20px;padding:4px 12px;font-size:12px;color:var(--muted);}
    .hidden { display: none !important; }
    .loading-overlay {
        position: absolute; inset: 0; background: var(--bg); opacity: 0.9; 
        display: flex; flex-direction:column; align-items: center; justify-content: center; z-index: 50;
    }
    
    /* Modals */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal{width:min(450px,90vw);background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 25px 50px rgba(0,0,0,.5);padding:30px}
    .modal h2{margin:0 0 16px 0; color:var(--accent)}
    .field{margin-bottom:16px;}
    .field label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px;}
    input, select{width:100%; background:var(--bg); color:white; border:1px solid var(--border); padding:10px; border-radius:8px; font-size:16px; font-family:inherit;}
    
    .toast-wrap{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);z-index:10000}
    .toast{background:#1e293b; color:#fff; padding:10px 20px; border-radius:30px; border:1px solid var(--accent); box-shadow:0 10px 30px rgba(0,0,0,0.4); display:flex; align-items:center; gap:10px;}
  </style>
</head>
<body>

  <!-- Admin Trigger -->
  <div style="position:fixed; left:20px; top:20px; z-index:100;">
    <button id="adminBtn" class="icon-btn hidden" title="× ×™×”×•×œ">âš™ï¸</button>
  </div>

  <div class="app">
    <header class="header">
      <div>
        <h1 class="title">××¢×¨×›×ª ×©×™×‘×•×¦×™× - ×¡×“× ×”</h1>
        <div class="group-tabs" id="groupTabs"></div>
      </div>
      <div class="header-actions">
        <div id="whoami" class="id-badge">
          <span>ğŸ‘‹</span>
          <span id="whoamiName">××•×¨×—</span>
        </div>
      </div>
    </header>

    <main class="two">
      
      <!-- SCHEDULE (Main Panel) -->
      <section class="panel schedule-panel" style="position:relative; min-height:500px">
        <div id="loadingSchedule" class="loading-overlay hidden">
            <span>×˜×•×¢×Ÿ ×œ×•×—...</span>
        </div>
        
        <div class="hd">
          <h3 style="flex:1">×œ×•×— ×©×™×‘×•×¦×™×</h3>
          <span id="dateRangeBadge" class="badge"></span>
          <span id="lockedBadge" class="badge" style="color:var(--bad-ink); border-color:var(--bad-br); display:none">ğŸ”’ × ×¢×•×œ</span>
          <button id="exportBtn" class="ghost" style="font-size:13px">ğŸ“¥ CSV</button>
        </div>
        
        <div class="bd">
          <div id="scheduleGrid" class="schedule"></div>
          
          <div style="margin-top:30px; padding-top:20px; border-top:1px solid var(--border)">
             <h4 style="margin:0 0 16px 0; color:var(--muted); font-size:16px">ğŸ“Š ×¡×™×›×•× ××©××¨×•×ª</h4>
             <div id="summaryBox" style="overflow-x:auto"></div>
          </div>
        </div>
      </section>

      <!-- CONSTRAINTS (Side Panel) -->
      <section class="panel constraints">
        <div class="hd">
          <h3>××™×œ×•×¦×™×</h3>
          <div class="legend">
            <div><span class="dot dot-0"></span>×–××™×Ÿ</div>
            <div><span class="dot dot-1"></span>××¢×“×™×£ ×©×œ×</div>
            <div><span class="dot dot-2"></span>×œ×</div>
          </div>
        </div>
        <div class="bd">
          <div id="peopleChips" class="people"></div>
          
          <!-- Days Header (Israeli Week) -->
          <div class="days-header">
             <div>××³</div><div>×‘×³</div><div>×’×³</div><div>×“×³</div>
             <div>×”×³</div><div>×•×³</div><div style="color:#f87171">×©×³</div>
          </div>
          
          <div id="daysGrid" class="days"></div>
          
          <p class="hint" style="margin-bottom:20px">×‘×—×¨ ××ª ×”×™××™× ×©×‘×”× ××™× ×š ×™×›×•×œ/×” ×œ×”×’×™×¢</p>
          
          <div style="display:flex;gap:10px;">
            <button id="saveBtn" style="flex:1">×©××•×¨</button>
            <button id="resetMineBtn" class="ghost">× ×§×” ×”×›×œ</button>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- Toast -->
  <div id="toastWrap" class="toast-wrap"></div>

  <!-- Login Modal -->
  <div id="identityBackdrop" class="modal-backdrop">
    <div class="modal">
      <h2>×”×™×™, ××™ ××ª/×”?</h2>
      <div class="field">
        <label>×‘×—×¨ ××©×ª××© ×œ×”×ª×—×‘×¨×•×ª</label>
        <select id="identitySelect"><option value="">×˜×•×¢×Ÿ...</option></select>
      </div>
      <button id="identityStartBtn" style="width:100%">×”×ª×—×‘×¨</button>
    </div>
  </div>

  <!-- Admin Modal -->
  <div id="adminBackdrop" class="modal-backdrop">
    <div class="modal">
      <h2>×”×’×“×¨×•×ª × ×™×”×•×œ: <span id="adminGroupName" style="color:var(--accent)"></span></h2>
      
      <div class="field">
        <label>×ª××¨×™×š ×”×ª×—×œ×” (×™×•× ×¨××©×•×Ÿ)</label>
        <input id="dateInput" type="date" />
      </div>
      
      <div class="field">
        <label>××©×š ×–××Ÿ ×”×ª×¦×•×’×”</label>
        <select id="durationSelect">
           <option value="1">×©×‘×•×¢ ××—×“</option>
           <option value="2">×©×‘×•×¢×™×™×</option>
           <option value="3">3 ×©×‘×•×¢×•×ª</option>
           <option value="4">4 ×©×‘×•×¢×•×ª</option>
        </select>
      </div>

      <div class="field">
        <label>× ×¢×•×œ ×œ×¢×¨×™×›×” ×¢×“ (××•×¤×¦×™×•× ×œ×™)</label>
        <input id="lockInput" type="date" />
      </div>

      <hr style="border:0; border-top:1px solid var(--border); margin:20px 0;">
      
      <button id="adminResetBtn" class="ghost" style="color:#fca5a5; border-color:#7f1d1d; width:100%; margin-bottom:10px">âš ï¸ ××™×¤×•×¡ ×›×œ ×”××™×œ×•×¦×™× ×œ×˜×•×•×— ×–×”</button>
      
      <div style="display:flex; gap:10px; margin-top:20px">
        <button id="adminCancelBtn" class="ghost" style="flex:1">×‘×™×˜×•×œ</button>
        <button id="adminSaveBtn" style="flex:1">×©××•×¨ ×”×’×“×¨×•×ª</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDocs, collection, query, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // --- CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyBiZIHRpbg0bq4VFZ2kDDXj6QeRJZpjOpg",
      authDomain: "sadna-timetable.firebaseapp.com",
      projectId: "sadna-timetable",
      storageBucket: "sadna-timetable.firebasestorage.app",
      messagingSenderId: "605203492621",
      appId: "1:605203492621:web:7ed83f0e5e64d67b9c8a44",
      measurementId: "G-8941L7ZZJ6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const GROUPS = ["××“×¤×¡×•×ª", "×ª×¤×™×¨×”", "××ª×›×ª", "×¢×™×‘×•×“ ×©×‘×‘×™×", "×¢×¥"];
    
    const USERS_DB = [
        {id:"u1", name:"× ×‘×•", group:"××“×¤×¡×•×ª", role:"admin"},
        {id:"u2", name:"× ×˜×¢", group:"××“×¤×¡×•×ª", role:"user"},
        {id:"u3", name:"×˜×œ", group:"××“×¤×¡×•×ª", role:"user"},
        {id:"u4", name:"×›×œ×™×œ", group:"×ª×¤×™×¨×”", role:"user"},
        {id:"u5", name:"×¢××™×ª", group:"×ª×¤×™×¨×”", role:"user"},
        {id:"u6", name:"×©×™×¨×”", group:"×ª×¤×™×¨×”", role:"user"},
        {id:"u7", name:"×××™", group:"××ª×›×ª", role:"user"},
        {id:"u8", name:"×œ×™×¢×“", group:"×¢×™×‘×•×“ ×©×‘×‘×™×", role:"user"},
        {id:"u9", name:"××•×¨×™", group:"×¢×¥", role:"user"}
    ];

    const MS_DAY = 86400000;
    const hebDaysLong = ["×¨××©×•×Ÿ","×©× ×™","×©×œ×™×©×™","×¨×‘×™×¢×™","×—××™×©×™","×©×™×©×™","×©×‘×ª"];

    // State
    let currentGroup = GROUPS[0];
    let currentUser = null;
    let groupMembers = [];
    let groupSettings = { startDate: new Date(), lockedUntil: null, weeks: 4 };
    let state = {};
    let unsubSettings = null;
    let unsubConstraints = null;

    // --- ISRAELI DATE UTILS ---
    // Ensuring everything works Sunday to Saturday, DD/MM/YYYY
    const startOfDay = d => { const c=new Date(d); c.setHours(0,0,0,0); return c; };
    const addDays = (d,n) => new Date(startOfDay(d).getTime() + n*MS_DAY);
    
    // Get the previous Sunday (or today if it is Sunday)
    const prevSunday = d => { 
        let t = new Date(d); 
        t.setDate(t.getDate() - t.getDay()); 
        return startOfDay(t);
    };
    
    // Formatting: YYYY-MM-DD for DB keys
    const fmtKey = d => {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
    };

    // Formatting: DD.MM for Display
    const fmtShow = d => {
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${day}.${m}`;
    };

    const monthKeyFrom = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    
    function toast(msg, type="ok") {
        const el = document.createElement("div");
        el.className = "toast";
        el.innerHTML = `<span>${type==='ok'?'âœ…':'âš ï¸'}</span> ${msg}`;
        document.getElementById("toastWrap").appendChild(el);
        setTimeout(() => { el.style.opacity="0"; setTimeout(()=>el.remove(),300); }, 2500);
    }

    // --- APP LOGIC ---

    function init() {
        // Render Tabs
        document.getElementById("groupTabs").innerHTML = GROUPS.map(g => 
            `<button class="tab-btn" onclick="window.switchGroup('${g}')">${g}</button>`
        ).join("");

        // Auth Check
        const savedUid = localStorage.getItem("scheduler_uid");
        if(savedUid) {
            const u = USERS_DB.find(x => x.id === savedUid);
            if(u) loginUser(u);
            else showIdentity();
        } else {
            showIdentity();
        }
        
        if(!auth.currentUser) signInAnonymously(auth);
    }

    window.switchGroup = (g) => {
        currentGroup = g;
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.toggle("active", b.innerText===g));
        loadGroupData();
    };

    function loadGroupData() {
        document.getElementById("loadingSchedule").classList.remove("hidden");
        groupMembers = USERS_DB.filter(u => u.group === currentGroup).map(u => u.name);

        if(unsubSettings) unsubSettings();
        
        unsubSettings = onSnapshot(doc(db, "groups", currentGroup), async (snap) => {
            if(!snap.exists()) {
                await setDoc(doc(db, "groups", currentGroup), { startDate: fmtKey(new Date()), weeks: 4 });
                return;
            }
            const d = snap.data();
            
            // Start Date
            if(d.startDate) {
                const p = d.startDate.split('-').map(Number);
                // JS Month is 0-indexed
                groupSettings.startDate = startOfDay(new Date(p[0], p[1]-1, p[2]));
            } else groupSettings.startDate = startOfDay(new Date());

            // Lock Date
            if(d.lockedUntil) {
                const p = d.lockedUntil.split('-').map(Number);
                groupSettings.lockedUntil = startOfDay(new Date(p[0], p[1]-1, p[2]));
            } else groupSettings.lockedUntil = null;

            // Weeks
            groupSettings.weeks = d.weeks ? Number(d.weeks) : 4;

            subscribeConstraints();
        });
    }

    function subscribeConstraints() {
        if(unsubConstraints) unsubConstraints();
        
        const mKey = monthKeyFrom(groupSettings.startDate);
        unsubConstraints = onSnapshot(collection(db, "groups", currentGroup, "constraints", mKey, "days"), (snap) => {
            state = {};
            snap.forEach(doc => state[doc.id] = doc.data());
            renderApp();
            document.getElementById("loadingSchedule").classList.add("hidden");
        });
    }

    function renderApp() {
        // Always snap start date to Sunday for display logic
        const start = prevSunday(groupSettings.startDate);
        const weeksToShow = groupSettings.weeks;
        const totalDays = weeksToShow * 7;
        const end = addDays(start, totalDays - 1);

        // Header
        document.getElementById("dateRangeBadge").textContent = `${fmtShow(start)} â€“ ${fmtShow(end)}`;
        
        const isLocked = groupSettings.lockedUntil && new Date() < groupSettings.lockedUntil;
        const isAdmin = currentUser?.role === 'admin';
        const canEdit = isAdmin || !isLocked;
        
        document.getElementById("lockedBadge").style.display = isLocked ? "inline-flex" : "none";
        document.getElementById("saveBtn").disabled = !canEdit;
        document.getElementById("adminBtn").classList.toggle("hidden", !(isAdmin && currentUser.group === currentGroup));

        // --- CONSTRAINTS PANEL ---
        const chipsEl = document.getElementById("peopleChips");
        chipsEl.innerHTML = groupMembers.map(p => 
            `<div class="chip ${p === currentUser?.name ? 'active' : ''}">${p}</div>`
        ).join("");

        // Render Constraint Days (Sunday to Saturday)
        let html = "";
        let curr = new Date(start);
        
        while(curr <= end) {
            const k = fmtKey(curr);
            const day = curr.getDay(); // 0=Sun, 6=Sat
            const val = (state[k] && currentUser) ? (state[k][currentUser.name] || 0) : 0;
            
            let classes = "day";
            if(day === 6) classes += " shabbat"; 
            else if(day === 5) classes += " fri"; 
            
            if(val > 0) classes += ` state-${val}`;
            
            html += `
                <div class="${classes}" onclick="toggleDay('${k}', ${day})">
                    <div class="d1">${curr.getDate()}</div>
                    <div class="d2">${curr.getMonth()+1}</div>
                </div>
            `;
            curr = addDays(curr, 1);
        }
        document.getElementById("daysGrid").innerHTML = html;

        // --- SCHEDULE PANEL ---
        const pack = computeSchedule(start, end);
        renderScheduleGrid(pack, start, end);
        renderSummary(pack);
    }

    window.toggleDay = (k, day) => {
        if(day === 6) return; // Block Shabbat clicks
        if(!currentUser) return toast("×œ× ××—×•×‘×¨", "warn");
        
        if(currentUser.group !== currentGroup && currentUser.role !== 'admin') {
            return toast("××™× ×š ×©×™×™×š ×œ×§×‘×•×¦×” ×–×•", "warn");
        }
        
        const isLocked = groupSettings.lockedUntil && new Date() < groupSettings.lockedUntil;
        if(isLocked && currentUser.role !== 'admin') return toast("×”×œ×•×— × ×¢×•×œ", "warn");

        if(!state[k]) state[k] = {};
        const old = state[k][currentUser.name] || 0;
        state[k][currentUser.name] = (old + 1) % 3;
        
        renderApp(); // Re-render locally
    };

    // --- ALGORITHM (Smart Assign) ---
    function computeSchedule(start, end) {
        const assign = {};
        const counts = {}; groupMembers.forEach(m => counts[m] = { total: 0, fri: 0 });
        const weeks = {};

        const days = [];
        let c = new Date(start);
        while(c <= end) { days.push(new Date(c)); c = addDays(c, 1); }

        days.forEach(d => {
            if(d.getDay() === 6) return; // Skip Shabbat

            const k = fmtKey(d);
            const wIdx = Math.floor((d - start) / (7 * MS_DAY));
            if(!weeks[wIdx]) weeks[wIdx] = {};

            // 1. Filter Valid Candidates (Not Red)
            let candidates = groupMembers.filter(p => (state[k]?.[p] || 0) !== 2);
            
            // 2. Prioritize Green (0) over Yellow (1)
            const greens = candidates.filter(p => (state[k]?.[p] || 0) === 0);
            if(greens.length > 0) candidates = greens;

            // 3. Sort by Fairness (Friday Balance -> Total Balance)
            candidates.sort((a,b) => {
                if(d.getDay() === 5) return counts[a].fri - counts[b].fri;
                return counts[a].total - counts[b].total;
            });

            // 4. Assign
            const winner = candidates[0];
            if(winner) {
                assign[k] = winner;
                counts[winner].total++;
                if(d.getDay() === 5) counts[winner].fri++;
                weeks[wIdx][winner] = (weeks[wIdx][winner] || 0) + 1;
            }
        });

        return { assign, counts, weeks };
    }

    function renderScheduleGrid(pack, start, end) {
        const { assign } = pack;
        // Israeli Headers: Sun-Fri
        let html = `<div class="col-hd"></div>
                    <div class="col-hd">××³</div><div class="col-hd">×‘×³</div><div class="col-hd">×’×³</div>
                    <div class="col-hd">×“×³</div><div class="col-hd">×”×³</div><div class="col-hd">×•×³</div>`;
        
        let weekStart = new Date(start);

        while(weekStart <= end) {
            const weekEnd = addDays(weekStart, 6);
            html += `<div class="row-hd">
                        ${fmtShow(weekStart)} - ${fmtShow(weekEnd)}
                     </div>`;
            
            // Loop 0 (Sun) to 5 (Fri) - 6 columns
            for(let i=0; i<6; i++) {
                const cur = addDays(weekStart, i);
                const k = fmtKey(cur);
                const isFri = (i===5);
                const shiftTime = isFri ? "08:00-14:00" : "16:00-22:00";
                const winner = assign[k];
                
                // Warnings (Yellow/Red)
                const row = state[k] || {};
                const oranges = groupMembers.filter(m => row[m]===1).length;
                const reds = groupMembers.filter(m => row[m]===2).length;
                let warnBadge = "";
                if(oranges || reds) warnBadge = `<div class="warn-badge">${oranges}ğŸŸ  ${reds}ğŸ”´</div>`;

                html += `
                    <div class="slot ${isFri?'fri':''}">
                        <div class="datebox">
                            <div class="d-top">${cur.getDate()}.${cur.getMonth()+1}</div>
                            <div class="d-time">${shiftTime}</div>
                        </div>
                        <div class="assignee ${winner?'filled':''}">
                            ${winner || '×¨×™×§'}
                        </div>
                        ${warnBadge}
                    </div>
                `;
            }
            weekStart = addDays(weekStart, 7);
        }
        document.getElementById("scheduleGrid").innerHTML = html;
    }

    function renderSummary(pack) {
        const { counts, weeks } = pack;
        let html = `<table style="width:100%; border-collapse:collapse; font-size:14px; text-align:center">
            <thead><tr style="border-bottom:1px solid var(--border); color:var(--muted)">
            <th style="padding:10px; text-align:right">×©×</th>`;
        
        Object.keys(weeks).sort().forEach((w,i) => html += `<th style="padding:10px">×©×‘×•×¢ ${i+1}</th>`);
        html += `<th style="padding:10px; color:var(--ink)">×¡×”×´×›</th><th style="padding:10px; color:var(--accent)">×©×™×©×™</th></tr></thead><tbody>`;

        groupMembers.forEach(m => {
            html += `<tr style="border-bottom:1px solid rgba(255,255,255,0.05)">
                <td style="padding:10px; text-align:right; font-weight:600">${m}</td>`;
            
            Object.keys(weeks).sort().forEach(w => {
                html += `<td style="padding:10px; opacity:0.7">${weeks[w]?.[m] || 0}</td>`;
            });

            html += `<td style="padding:10px; font-weight:bold">${counts[m].total}</td>
                     <td style="padding:10px; color:var(--accent); font-weight:bold">${counts[m].fri}</td></tr>`;
        });
        html += `</tbody></table>`;
        document.getElementById("summaryBox").innerHTML = html;
    }

    // --- BUTTONS ---
    document.getElementById("saveBtn").onclick = async () => {
        if(!currentUser) return;
        const mKey = monthKeyFrom(groupSettings.startDate);
        const batch = writeBatch(db);
        let count = 0;
        
        for(const [k, v] of Object.entries(state)) {
            if(v[currentUser.name] !== undefined) {
                const ref = doc(db, "groups", currentGroup, "constraints", mKey, "days", k);
                batch.set(ref, {[currentUser.name]: v[currentUser.name]}, {merge:true});
                count++;
            }
        }
        if(count) { await batch.commit(); toast("× ×©××¨ ×‘×”×¦×œ×—×”"); }
        else toast("××™×Ÿ ×©×™× ×•×™×™×", "warn");
    };

    document.getElementById("resetMineBtn").onclick = () => {
        if(confirm("×œ× ×§×•×ª ×‘×—×™×¨×”?")) {
            for(let k in state) if(state[k][currentUser.name]) delete state[k][currentUser.name];
            renderApp();
        }
    };

    document.getElementById("exportBtn").onclick = () => {
        const start = prevSunday(groupSettings.startDate);
        const end = addDays(start, (groupSettings.weeks*7)-1);
        const pack = computeSchedule(start, end);
        
        let csv = "\uFEFF×ª××¨×™×š,×™×•×,××©××¨×ª,××©×•×‘×¥\n";
        let c = new Date(start);
        while(c <= end) {
            if(c.getDay()!==6) {
                const k = fmtKey(c);
                const shift = c.getDay()===5 ? "×‘×•×§×¨" : "×¢×¨×‘";
                csv += `${fmtShow(c)},${hebDaysLong[c.getDay()]},${shift},${pack.assign[k]||''}\n`;
            }
            c = addDays(c,1);
        }
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv;charset=utf-8'}));
        a.download = `schedule_${currentGroup}.csv`;
        a.click();
    };

    // --- IDENTITY ---
    function showIdentity() {
        const s = document.getElementById("identitySelect");
        s.innerHTML = `<option value="">×‘×—×¨...</option>` + 
            [...USERS_DB].sort((a,b)=>a.group.localeCompare(b.group)).map(u=>`<option value="${u.id}">${u.name} (${u.group})</option>`).join("");
        document.getElementById("identityBackdrop").style.display="flex";
    }
    
    document.getElementById("identityStartBtn").onclick = () => {
        const uid = document.getElementById("identitySelect").value;
        if(uid) {
            localStorage.setItem("scheduler_uid", uid);
            loginUser(USERS_DB.find(x=>x.id===uid));
            document.getElementById("identityBackdrop").style.display="none";
        }
    };

    function loginUser(u) {
        currentUser = u;
        document.getElementById("whoamiName").innerText = u.name;
        if(u.group !== currentGroup) switchGroup(u.group);
        else { 
            document.querySelectorAll(".tab-btn").forEach(b => b.classList.toggle("active", b.innerText===currentGroup));
            loadGroupData();
        }
        document.getElementById("whoami").onclick = () => {
            if(confirm("×œ×”×ª× ×ª×§?")) { localStorage.removeItem("scheduler_uid"); location.reload(); }
        };
    }

    // --- ADMIN ---
    document.getElementById("adminBtn").onclick = () => {
        document.getElementById("adminGroupName").innerText = currentGroup;
        document.getElementById("dateInput").value = fmtKey(groupSettings.startDate);
        document.getElementById("durationSelect").value = groupSettings.weeks;
        document.getElementById("lockInput").value = groupSettings.lockedUntil ? fmtKey(groupSettings.lockedUntil) : "";
        document.getElementById("adminBackdrop").style.display = "flex";
    };

    document.getElementById("adminCancelBtn").onclick = () => document.getElementById("adminBackdrop").style.display="none";

    document.getElementById("adminSaveBtn").onclick = async () => {
        const s = document.getElementById("dateInput").value;
        const w = document.getElementById("durationSelect").value;
        const l = document.getElementById("lockInput").value;
        
        if(!s) return toast("×—×•×‘×” ×ª××¨×™×š", "warn");
        
        await setDoc(doc(db, "groups", currentGroup), {
            startDate: s, weeks: Number(w), lockedUntil: l || ""
        }, {merge:true});
        
        toast("×”×’×“×¨×•×ª × ×©××¨×•");
        document.getElementById("adminBackdrop").style.display="none";
    };

    document.getElementById("adminResetBtn").onclick = async () => {
        if(confirm("×œ××—×•×§ ××ª ×›×œ ×”××™×œ×•×¦×™× ×œ×˜×•×•×— ×–×”?")) {
            const mKey = monthKeyFrom(groupSettings.startDate);
            const q = query(collection(db, "groups", currentGroup, "constraints", mKey, "days"));
            const snap = await getDocs(q);
            const batch = writeBatch(db);
            snap.forEach(d => batch.delete(d.ref));
            await batch.commit();
            toast("××•×¤×¡ ×‘×”×¦×œ×—×”");
            document.getElementById("adminBackdrop").style.display="none";
        }
    };

    init();
  </script>
</body>
</html>
