<!DOCTYPE html>
<html lang="he" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>לוח שיבוצים לסדנה</title>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9aa6b2;
      --border:#273244; --accent:#38bdf8; --accent2:#22d3ee;
      --chip-bg:#0b1222; --pill-bg:#122; --btn-ink:#06121c;
      --ok-bg:#032015; --ok-br:#0c3; --ok-ink:#b7f7cf;
      --warn-bg:#231e07; --warn-br:#54450a; --warn-ink:#fde68a;
      --bad-bg:#2b0a0a; --bad-br:#521; --bad-ink:#fecaca;
      --fri-bg:#0a1d2b; --fri-br:#224055; --fri-pill:#0e2a3f;
      --badge-bg:transparent;
      --title-g1: var(--accent); --title-g2: var(--accent2);
      --toast-bg: rgba(15,23,42,.9); --toast-br:#2b3a55; --toast-ink:#e5e7eb;
      --tabs-bg: rgba(6, 12, 21, .75);
    }
    html[data-theme="light"]{
      --bg:#f6f8fb; --card:#ffffff; --ink:#0b1222; --muted:#5b6472;
      --border:#dce3ea; --accent:#0ea5e9; --accent2:#06b6d4;
      --chip-bg:#f4f7fb; --pill-bg:#f6fafc; --btn-ink:#001018;
      --ok-bg:#e8f8ed; --ok-br:#16a34a; --ok-ink:#065f2a;
      --warn-bg:#fff6db; --warn-br:#eab308; --warn-ink:#6b4f00;
      --bad-bg:#ffe7e7; --bad-br:#ef4444; --bad-ink:#7f1d1d;
      --fri-bg:#ecf6ff; --fri-br:#cfe9ff; --fri-pill:#f5faff;
      --badge-bg:#eef3f8;
      --title-g1:#0ea5e9; --title-g2:#06b6d4;
      --toast-bg:#ffffff; --toast-br:#dce3ea; --toast-ink:#0b1222;
      --tabs-bg:#ffffff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; overflow-x:hidden;
      font-family:"Assistant",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif;
      background:
        radial-gradient(1200px 800px at 80% -10%, #0b1222 0%, var(--bg) 40%),
        linear-gradient(180deg, #0b1222 0%, var(--bg) 100%);
      color:var(--ink); font-size:16px;
      padding-bottom:52px;
    }
    html[data-theme="light"] body{
      background:
        radial-gradient(1200px 800px at 80% -10%, #ffffff 0%, var(--bg) 40%),
        linear-gradient(180deg, #ffffff 0%, var(--bg) 100%);
    }

    .app{max-width:1600px;margin:0 auto;padding:16px}
    header.header{display:flex;justify-content:space-between;align-items:flex-start;gap:16px;flex-wrap:wrap}
    .title{margin:0;font-weight:800;letter-spacing:.2px;font-size:clamp(22px,2.8vw,34px);
      background:linear-gradient(90deg,var(--title-g1),var(--title-g2));
      -webkit-background-clip:text;background-clip:text;color:transparent}
    .sub{color:var(--muted);font-size:14px;margin-top:6px;margin-bottom:16px;display:block}
    .header-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap;max-width:100%}
    .badge{border:1px solid var(--border);border-radius:999px;padding:6px 12px;font-size:13px;color:var(--muted);background:var(--badge-bg)}
    .id-badge{border:1px solid var(--border);padding:6px 12px;border-radius:999px;font-size:13px;white-space:nowrap}

    .two{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,2fr);grid-template-areas:"constraints schedule";gap:18px;align-items:start;}
    .constraints{grid-area:constraints}
    .schedule-panel{grid-area:schedule}
    @media (max-width: 1100px){
      .two{grid-template-columns:1fr;grid-template-areas:"schedule" "constraints";}
      .constraints{position:static}
      .constraints .bd{max-height:none;overflow:visible}
    }
    body.view-only .two{grid-template-columns:1fr;grid-template-areas:"schedule"}

    .panel{background:linear-gradient(180deg,var(--card),color-mix(in oklab,var(--card) 80%,var(--bg)));border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08);overflow:hidden}
    html[data-theme="dark"] .panel{box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel .hd{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
    .panel .bd{padding:16px}
    .panel h3{margin:0;font-size:20px}

    button{cursor:pointer;border:none;border-radius:12px;padding:10px 14px;font-weight:700;color:var(--btn-ink);background:linear-gradient(90deg,var(--accent),var(--accent2))}
    button.ghost{background:transparent;color:var(--ink);border:1px solid var(--border)}
    button.secondary{background:var(--chip-bg);color:var(--ink);border:1px solid var(--border);height:48px}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .vsep{width:1px;height:34px;background:var(--border);border-radius:1px;margin-inline:8px}

    .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:48px;height:48px;border-radius:12px;background:var(--chip-bg);border:1px solid var(--border);color:var(--ink)}
    .icon-btn svg{width:26px;height:26px}

    .legend{display:flex;align-items:center;gap:10px;color:var(--muted);font-size:13px}
    .dot{display:inline-block;width:14px;height:14px;border-radius:4px;border:1px solid var(--border)}
    .dot-0{background:var(--chip-bg)}
    .dot-1{background:#231e07;border-color:#54450a}
    .dot-2{background:#2b0a0a;border-color:#512}

    .people{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .chip{background:var(--chip-bg);color:var(--ink);border:1px solid var(--border);border-radius:999px;padding:8px 12px;white-space:nowrap}
    .chip.active{outline:2px solid var(--accent)}

    .days{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .day{background:var(--chip-bg);border:1px dashed var(--border);border-radius:12px;padding:10px;text-align:center;cursor:pointer;min-height:64px;display:flex;flex-direction:column;gap:6px;justify-content:center}
    .day .d1{font-size:15px;}
    .day .d2{font-size:12px;color:var(--muted)}
    .day.shabbat{opacity:.35;cursor:not-allowed}
    .day.fri.state-0{background:var(--fri-bg);border-color:var(--fri-br)}
    .day.state-1{background:#231e07;border:1px solid #54450a}
    .day.state-2{background:#2b0a0a;border:1px solid #521}

    .schedule{display:grid;grid-template-columns:minmax(90px,9ch) repeat(6,minmax(0,1fr));gap:10px;align-items:stretch}
    @media (max-width:1500px){.schedule{grid-template-columns:minmax(90px,9ch) repeat(3,minmax(0,1fr))}}
    @media (max-width:700px){.schedule{grid-template-columns:1fr}.schedule .col-hd{display:none}}
    .col-hd{font-size:13px;color:var(--muted);text-align:center;white-space:nowrap}

    .slot{background:var(--chip-bg);border:1px solid var(--border);border-radius:12px;min-height:88px;padding:10px;display:flex;flex-direction:column;gap:8px;min-width:0}
    .slot.fri{background:var(--fri-bg);border-color:var(--fri-br)}
    .slot .datebox{border:1px solid var(--border);border-radius:10px;padding:8px 10px;background:color-mix(in oklab,var(--chip-bg) 90%, transparent)}
    .slot .datebox .d-top{font-size:16px;font-weight:700}
    .slot .datebox .d-time{font-size:12px;color:var(--muted);margin-top:2px}
    .pill{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:var(--pill-bg);white-space:nowrap}
    .pill.ok{background:var(--ok-bg);border-color:var(--ok-br);color:var(--ok-ink)}
    .pill.bad{background:var(--bad-bg);border-color:var(--bad-br);color:var(--bad-ink)}
    .pill.warn{background:var(--warn-bg);border-color:var(--warn-br);color:var(--warn-ink)}

    .constraints{align-self:start; position:sticky; top:92px}
    .constraints .bd{max-height:calc(100vh - 132px); overflow:auto}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
    html[data-theme="light"] .modal-backdrop{background:rgba(0,0,0,.25)}
    .modal{width:min(560px,92vw);background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 24px 60px rgba(0,0,0,.35);padding:18px}
    .modal h2{margin:0 0 6px 0}.modal p{margin:0 0 12px 0;color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:12px}
    .select,.date{background:var(--chip-bg);color:var(--ink);border:1px solid var(--border);padding:10px 12px;border-radius:10px;min-width:auto;font-weight:600}
    .checkbox{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;cursor:pointer;background:var(--chip-bg);border:1px solid var(--border);border-radius:10px}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    .admin-bar{position:fixed;left:12px;top:12px;z-index:10000;display:flex;gap:8px;flex-wrap:wrap}

    .toast-wrap{position:fixed;left:50%;transform:translateX(-50%);bottom:68px;z-index:10050;display:flex;flex-direction:column;gap:8px;pointer-events:none}
    .toast{pointer-events:auto;min-width:260px;max-width:min(92vw,520px);border-radius:14px;border:1px solid var(--toast-br);background:var(--toast-bg);color:var(--ink);padding:12px 14px;box-shadow:0 18px 40px rgba(0,0,0,.35);display:flex;align-items:flex-start;gap:10px}

    .tabs-bar{
      position:fixed;bottom:0;left:0;right:0;
      background:var(--tabs-bg);backdrop-filter:blur(10px);
      border-top:1px solid rgba(255,255,255,.05);
      display:flex;gap:6px;align-items:center;
      padding:6px 12px;overflow-x:auto;z-index:9000;
    }
    .tab-btn{
      background:transparent;border:1px solid transparent;
      color:var(--ink);border-radius:10px;
      padding:6px 12px;font-size:14px;white-space:nowrap;
      display:flex;align-items:center;gap:6px;
      cursor:pointer;
    }
    .tab-btn.active{
      background:rgba(34,211,238,.12);
      border-color:rgba(34,211,238,.35);
    }
    .tab-lock{font-size:11px;opacity:.6}

    body.view-only .constraints,
    body.view-only #switchUserBtn,
    body.view-only #whoami{display:none!important}
  </style>
</head>
<body>
  <!-- admin floating -->
  <div class="admin-bar">
    <button id="adminBtn" class="icon-btn" title="מצב ניהול">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"/>
        <path d="M19.4 15a1.8 1.8 0 0 0 .36 1.98l.05.05a2 2 0 1 1-2.83 2.83l-.05-.05A1.8 1.8 0 0 0 15 19.4a1.8 1.8 0 0 0-1 .2 1.8 1.8 0 0 0-.9 1.57V21a2 2 0 1 1-4 0v-.03A1.8 1.8 0 0 0 8.2 19.4 1.8 1.8 0 0 0 7 19.4a1.8 1.8 0 0 0-1.98.36l-.05.05a2 2 0 1 1-2.83-2.83l.05-.05A1.8 1.8 0 0 0 4.6 15a1.8 1.8 0 0 0-.2-1 1.8 1.8 0 0 0-1.57-.9H2a2 2 0 1 1 0-4h.03A1.8 1.8 0 0 0 4.6 8.2a1.8 1.8 0 0 0 .2-1A1.8 1.8 0 0 0 4.44 5.2l-.05-.05A2 2 0 1 1 7.22 2.3l.05.05A1.8 1.8 0 0 0 9 4.6c.31.05.66.05 1 0A1.8 1.8 0 0 0 10.9 3V3a2 2 0 1 1 4 0v.03a1.8 1.8 0 0 0 .9 1.57c.34.17.69.24 1 .2a1.8 1.8 0 0 0 1.98-.36l.05-.05a2 2 0 1 1 2.83 2.83l-.05.05A1.8 1.8 0 0 0 19.4 9c.05.34 0 .69-.2 1 .17.34.24.69.2 1 .05.31.05.66 0 1Z"/>
      </svg>
    </button>
  </div>

  <div class="app">
    <header class="header">
      <div>
        <h1 id="pageTitle" class="title">לוח שיבוצים</h1>
        <span id="pageSub" class="sub">א׳–ה׳ 16:00–22:00 · ו׳ 08:00–14:00 · שבת – אין משמרת</span>
      </div>
      <div class="header-actions">
        <span id="whoami" class="id-badge">לא מחובר</span>
        <button id="switchUserBtn" class="secondary">החלף משתמש</button>
        <button id="themeBtn" class="icon-btn" title="מצב בהיר/כהה">
          <svg id="themeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"></svg>
        </button>
      </div>
    </header>

    <main class="two">
      <!-- schedule -->
      <section class="panel schedule-panel">
        <div class="hd" style="display:flex;align-items:center">
          <h3 style="margin-inline-end:12px">לוח שיבוצים</h3>
          <span id="dateRangeBadge" class="badge" style="margin-inline-end:auto"></span>
          <button id="computeBtn" class="ghost">חשב שיבוץ</button>
          <button id="exportBtn" class="ghost">יצוא CSV</button>
          <button id="shareBtn" class="ghost">שיתוף</button>
          <span class="vsep" aria-hidden="true"></span>
          <button id="addCalendarBtn" class="ghost" title="הוסף ליומן">
            <span style="display:inline-flex;gap:8px;align-items:center">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2"></rect>
                <path d="M16 2v4M8 2v4M3 10h18M12 14v6M9 17h6"/>
              </svg>
              הוסף ליומן
            </span>
          </button>
        </div>
        <div class="bd">
          <div id="scheduleGrid" class="schedule"></div>
          <div id="summaryBox" style="margin-top:12px"></div>
        </div>
      </section>

      <!-- constraints -->
      <section class="panel constraints">
        <div class="hd">
          <h3>אילוצים לטווח הפעיל</h3>
          <div class="legend">
            <span class="dot dot-0"></span> זמין
            <span class="dot dot-1"></span> מעדיף שלא
            <span class="dot dot-2"></span> לא זמין
          </div>
        </div>
        <div class="bd">
          <div id="peopleChips" class="people"></div>
          <div id="daysGrid" class="days"></div>
          <p class="hint">טפיחה על יום מחליפה מצב: זמין → מעדיף שלא → לא זמין → זמין</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="saveBtn">שמור לענן</button>
            <button id="resetMineBtn" class="ghost">אפס את האילוצים שלי</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- tabs bottom -->
  <div id="groupTabs" class="tabs-bar"></div>

  <!-- Toasts -->
  <div id="toastWrap" class="toast-wrap" aria-live="polite"></div>

  <!-- Identity Modal -->
  <div id="identityBackdrop" class="modal-backdrop">
    <div class="modal">
      <h2>בחר משתמש</h2>
      <p>בחר את השם שלך מהרשימה. (אין סיסמה)</p>
      <div class="row">
        <label for="identitySelect">משתמש</label>
        <select id="identitySelect" class="select"></select>
      </div>
      <p style="font-size:12px;color:var(--muted)">אין אותך ברשימה? המנהל יכול להוסיף אותך מפאנל הניהול.</p>
      <div class="actions"><button id="identityStartBtn" type="button">התחל</button></div>
    </div>
  </div>

  <!-- Admin Modal -->
  <div id="adminBackdrop" class="modal-backdrop">
    <div class="modal">
      <h2>ניהול</h2>
      <p>הגדרות לחדר הנוכחי + ניהול משתמשים (אדמין בלבד)</p>
      <div class="row">
        <label for="dateInput">תאריך התחלה ללוח הזה</label>
        <input id="dateInput" class="date" type="date" />
      </div>
      <div class="row">
        <label for="lockInput">נעילת לוח עד</label>
        <input id="lockInput" class="date" type="date" />
      </div>
      <div class="row">
        <label for="horizonSelect">טווח חישוב</label>
        <select id="horizonSelect" class="select">
          <option value="1">שבוע 1 קדימה</option>
          <option value="2">שבועיים</option>
          <option value="4">חודש (4 שבועות)</option>
        </select>
      </div>
      <div class="row">
        <label class="checkbox"><input type="checkbox" id="adminEditAllChk" style="accent-color:#22d3ee"> אפשר עריכה לכל המשתמשים</label>
      </div>
      <div class="row">
        <label class="checkbox"><input type="checkbox" id="manualModeChk" style="accent-color:#22d3ee"> מצב שינוי ידני</label>
        <label class="checkbox"><input type="checkbox" id="manualBypassChk" style="accent-color:#22d3ee"> מעקף חוקי איזון</label>
      </div>
      <div id="adminUsersPanel" style="margin-top:14px;border-top:1px solid var(--border);padding-top:14px;display:none">
        <h3 style="margin:0 0 6px 0;font-size:16px">משתמשים</h3>
        <div class="row">
          <input id="newUserName" class="select" style="min-width:140px" placeholder="שם חדש">
          <select id="newUserGroup" class="select"></select>
          <label class="checkbox" style="padding:6px 8px"><input type="checkbox" id="newUserAdmin" style="accent-color:#22d3ee"> אדמין</label>
          <button id="createUserBtn" class="ghost" type="button">צור / עדכן</button>
        </div>
        <p id="usersList" style="font-size:13px;color:var(--muted);margin-top:10px"></p>
      </div>
      <div class="row" style="margin-top:14px">
        <button id="adminResetBtn" class="ghost" style="border-color:#f00;color:#fca5a5" type="button">איפוס טבלת אילוצים (לחדר)</button>
      </div>
      <div class="actions">
        <button id="adminCancelBtn" class="ghost" type="button">סגור</button>
        <button id="adminSaveBtn" type="button">שמור</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, getDocs, deleteDoc, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // ---------- CONFIG ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCQ9xt6u1mr9cHGHWVJnVXlJY5wy9noL-4",
      authDomain: "time-d77ad.firebaseapp.com",
      projectId: "time-d77ad",
      storageBucket: "time-d77ad.firebasestorage.app",
      messagingSenderId: "174419203695",
      appId: "1:174419203695:web:ab7eb33b68b4de2cab5f9a",
      measurementId: "G-DGN4GHV5JD"
    };

    // קבוצות
    const GROUP_DEFS = [
      { id: "printers",   name: "חדר מדפסות" },
      { id: "laser",      name: "חדר לייזר" },
      { id: "cnc",        name: "חדר CNC" },
      { id: "paint",      name: "חדר צבע" },
      { id: "assembly",   name: "חדר הרכבה" },
      { id: "electronics",name: "חדר אלקטרוניקה" },
      { id: "general",    name: "כללי / אחר" }
    ];

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const MS_DAY = 86400000;
    const hebDays=["א׳","ב׳","ג׳","ד׳","ה׳","ו׳","ש׳"];
    const hebDaysLong=["ראשון","שני","שלישי","רביעי","חמישי","שישי","שבת"];

    // DOM refs
    const daysGrid = document.getElementById("daysGrid");
    const scheduleGrid = document.getElementById("scheduleGrid");
    const dateRangeBadge = document.getElementById("dateRangeBadge");
    const saveBtn = document.getElementById("saveBtn");
    const resetMineBtn = document.getElementById("resetMineBtn");
    const computeBtn = document.getElementById("computeBtn");
    const exportBtn = document.getElementById("exportBtn");
    const shareBtn = document.getElementById("shareBtn");
    const addCalendarBtn = document.getElementById("addCalendarBtn");
    const whoamiEl = document.getElementById("whoami");
    const switchUserBtn = document.getElementById("switchUserBtn");
    const themeBtn = document.getElementById("themeBtn");
    const themeIcon = document.getElementById("themeIcon");
    const identityBackdrop = document.getElementById("identityBackdrop");
    const identitySelect = document.getElementById("identitySelect");
    const adminBtn = document.getElementById("adminBtn");
    const adminBackdrop = document.getElementById("adminBackdrop");
    const dateInput = document.getElementById("dateInput");
    const lockInput = document.getElementById("lockInput");
    const horizonSelect = document.getElementById("horizonSelect");
    const adminSaveBtn = document.getElementById("adminSaveBtn");
    const adminCancelBtn = document.getElementById("adminCancelBtn");
    const adminResetBtn = document.getElementById("adminResetBtn");
    const adminEditAllChk = document.getElementById("adminEditAllChk");
    const manualModeChk = document.getElementById("manualModeChk");
    const manualBypassChk = document.getElementById("manualBypassChk");
    const adminUsersPanel = document.getElemen
