<!DOCTYPE html>
<html lang="he" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>×œ×•×— ×©×™×‘×•×¦×™× - ××ª×•×§×Ÿ</title>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f172a; --card:#1e293b; --ink:#f1f5f9; --muted:#94a3b8;
      --border:#334155; --accent:#38bdf8; --accent2:#06b6d4;
      --chip-bg:#1e293b; --pill-bg:#334155; --btn-ink:#0f172a;
      --ok-bg:#052e16; --ok-br:#22c55e; --ok-ink:#bbf7d0;
      --warn-bg:#422006; --warn-br:#ca8a04; --warn-ink:#fde047;
      --bad-bg:#450a0a; --bad-br:#ef4444; --bad-ink:#fecaca;
      --fri-bg:#172554; --fri-br:#1e40af;
      --toast-bg:#1e293b; --toast-br:#475569; --toast-ink:#f1f5f9;
    }
    html[data-theme="light"]{
      --bg:#f1f5f9; --card:#ffffff; --ink:#0f172a; --muted:#64748b;
      --border:#e2e8f0;
      --chip-bg:#f8fafc; --pill-bg:#f1f5f9;
      --ok-bg:#dcfce7; --ok-br:#22c55e; --ok-ink:#14532d;
      --warn-bg:#fef9c3; --warn-br:#eab308; --warn-ink:#713f12;
      --bad-bg:#fee2e2; --bad-br:#ef4444; --bad-ink:#7f1d1d;
      --fri-bg:#eff6ff; --fri-br:#bfdbfe;
      --toast-bg:#ffffff; --toast-br:#cbd5e1; --toast-ink:#0f172a;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:"Assistant",system-ui;padding-bottom:80px;}
    .app{max-width:1600px;margin:0 auto;padding:16px;}
    
    /* Header */
    header.header{display:flex;justify-content:space-between;align-items:flex-start;gap:16px;flex-wrap:wrap;margin-bottom:20px;}
    .title{margin:0;font-size:28px;font-weight:800}
    .sub{color:var(--muted);font-size:14px;margin-top:4px;display:block}
    .header-actions{display:flex;gap:8px;align-items:center}
    .id-badge{border:1px solid var(--border);padding:6px 12px;border-radius:999px;font-size:13px;background:var(--card)}
    
    /* Buttons */
    button{cursor:pointer;border:none;border-radius:10px;padding:8px 14px;font-weight:700;font-family:inherit;font-size:14px;transition:0.2s;}
    button.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:var(--btn-ink)}
    button.primary:hover{opacity:0.9;transform:translateY(-1px)}
    button.ghost{background:transparent;border:1px solid var(--border);color:var(--ink)}
    button.ghost:hover{background:var(--pill-bg)}
    .icon-btn{width:40px;height:40px;display:inline-flex;align-items:center;justify-content:center;border-radius:10px;background:var(--card);border:1px solid var(--border);color:var(--ink)}
    
    /* Layout */
    .panel{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:16px;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1)}
    .panel .hd{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .panel .bd{padding:16px}
    .split{display:grid;grid-template-columns:1fr 340px;gap:16px}
    @media(max-width:1000px){.split{grid-template-columns:1fr}}

    /* Schedule Grid */
    .schedule-header{display:flex;gap:10px;align-items:center}
    .badge{border:1px solid var(--border);border-radius:6px;padding:2px 8px;font-size:12px;color:var(--muted);background:var(--bg)}
    
    /* Grid Layout: Time Label + 6 Days */
    .schedule{display:grid;grid-template-columns:90px repeat(6, 1fr);gap:8px;overflow-x:auto}
    @media(max-width:1200px){.schedule{min-width:800px}} /* Force scroll on small screens */
    
    .col-hd{text-align:center;color:var(--muted);font-size:13px;font-weight:700;padding-bottom:4px}
    .row-label{display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--muted);text-align:center;line-height:1.2}
    
    .slot{background:var(--bg);border:1px solid var(--border);border-radius:12px;min-height:90px;padding:8px;display:flex;flex-direction:column;gap:6px;position:relative}
    .slot.fri{background:var(--fri-bg);border-color:var(--fri-br)}
    .slot.empty{opacity:0.5;background:repeating-linear-gradient(45deg,transparent,transparent 10px,var(--pill-bg) 10px,var(--pill-bg) 20px)}
    
    .datebox{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:2px}
    .d-top{font-weight:700;color:var(--ink)}
    
    .pill{display:inline-flex;gap:6px;align-items:center;border-radius:6px;padding:3px 8px;border:1px solid var(--border);background:var(--pill-bg);font-size:12px;width:fit-content}
    .pill.ok{background:var(--ok-bg);border-color:var(--ok-br);color:var(--ok-ink)}
    .pill.bad{background:var(--bad-bg);border-color:var(--bad-br);color:var(--bad-ink)}
    .pill.warn{background:var(--warn-bg);border-color:var(--warn-br);color:var(--warn-ink)}
    .pill b{font-weight:700}

    /* Constraints & Chips */
    .days{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .day{background:var(--bg);border:1px dashed var(--border);border-radius:8px;padding:8px;min-height:50px;cursor:pointer;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;gap:2px;font-size:13px;transition:0.1s}
    .day:hover{border-color:var(--accent)}
    .day.state-1{background:var(--warn-bg);border-color:var(--warn-br);border-style:solid} /* Prefer not */
    .day.state-2{background:var(--bad-bg);border-color:var(--bad-br);border-style:solid} /* Cannot */
    .day.shabbat{opacity:.3;cursor:not-allowed;background:var(--pill-bg)}
    
    .legend{display:flex;gap:12px;font-size:12px;color:var(--muted);margin-bottom:8px}
    .legend span{display:flex;align-items:center;gap:4px}
    .dot{width:10px;height:10px;border-radius:50%;display:inline-block}
    .dot.bg0{background:var(--bg);border:1px dashed var(--muted)}
    .dot.bg1{background:var(--warn-br)}
    .dot.bg2{background:var(--bad-br)}

    .chip{background:var(--chip-bg);border:1px solid var(--border);border-radius:999px;padding:6px 12px;cursor:pointer;font-size:13px;transition:0.2s}
    .chip:hover{background:var(--pill-bg)}
    .chip.active{background:var(--accent);color:var(--btn-ink);border-color:var(--accent);font-weight:700}
    #peopleChips{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}

    /* Modals & Toasts */
    .toast-wrap{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);z-index:10000;display:flex;flex-direction:column;gap:8px;pointer-events:none}
    .toast{pointer-events:all;background:var(--toast-bg);border:1px solid var(--toast-br);color:var(--toast-ink);padding:10px 16px;border-radius:12px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 10px 40px rgba(0,0,0,0.3);min-width:300px;animation:slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)}
    @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
    
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal{background:var(--card);border:1px solid var(--border);border-radius:16px;max-width:500px;width:90%;padding:24px;box-shadow:0 20px 25px -5px rgba(0,0,0,0.3)}
    .modal h2{margin-top:0;font-size:22px}
    input, select{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px;color:var(--ink);font-family:inherit;outline:none}
    input:focus, select:focus{border-color:var(--accent)}

    /* Bottom Tabs */
    .bottom-tabs{position:fixed;bottom:0;left:0;right:0;background:var(--card);border-top:1px solid var(--border);display:flex;gap:8px;padding:10px 16px;overflow-x:auto;z-index:500}
    .tab{padding:6px 14px;border-radius:999px;border:1px solid transparent;color:var(--muted);white-space:nowrap;cursor:pointer;font-size:14px;transition:0.2s}
    .tab:hover{background:var(--pill-bg)}
    .tab.active{background:var(--accent);color:var(--btn-ink);font-weight:700}
    
    .admin-bar{position:fixed;left:16px;top:16px;z-index:10001;display:flex;gap:8px}
  </style>
</head>
<body>
  <!-- Admin Button -->
  <div class="admin-bar">
    <button id="adminBtn" class="icon-btn" title="×¤×× ×œ × ×™×”×•×œ" style="display:none">âš™ï¸</button>
  </div>

  <div class="app">
    <header class="header">
      <div>
        <h1 class="title">×œ×•×— ×©×™×‘×•×¦×™×</h1>
        <span class="sub" id="globalShiftDesc">××³â€“×”×³ 16:00â€“22:00 Â· ×•×³ 08:00â€“14:00</span>
      </div>
      <div class="header-actions">
        <span id="whoami" class="id-badge">×œ× ××—×•×‘×¨</span>
        <button id="switchUserBtn" class="ghost">×”×—×œ×£ ××©×ª××©</button>
        <button id="themeBtn" class="icon-btn" title="××¦×‘ ×‘×”×™×¨/×›×”×”">ğŸŒ™</button>
      </div>
    </header>

    <main class="split">
      <!-- Schedule Side -->
      <section class="panel">
        <div class="hd">
          <div class="schedule-header">
            <h3 style="margin:0" id="scheduleTitle">×œ×•×— ×©×™×‘×•×¦×™×</h3>
            <span id="dateRangeBadge" class="badge"></span>
            <span id="lockBadge" class="badge" style="background:var(--bad-bg);color:var(--bad-ink);border-color:var(--bad-br);display:none;">ğŸ”’ × ×¢×•×œ</span>
          </div>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <button id="computeBtn" class="ghost">âš¡ ×—×©×‘</button>
            <button id="exportBtn" class="ghost">ğŸ“¥ CSV</button>
            <button id="addCalendarBtn" class="ghost">ğŸ“… ×™×•××Ÿ</button>
          </div>
        </div>
        <div class="bd">
          <div id="scheduleGrid" class="schedule"></div>
          <div id="summaryBox" style="margin-top:16px"></div>
        </div>
      </section>

      <!-- Constraints Side -->
      <section class="panel">
        <div class="hd">
          <h3 style="margin:0">×”××™×œ×•×¦×™× ×©×œ×™</h3>
        </div>
        <div class="bd">
          <div id="peopleChips"></div>
          
          <div class="legend">
            <span><span class="dot bg0"></span>×–××™×Ÿ</span>
            <span><span class="dot bg1"></span>××¢×“×™×£ ×©×œ×</span>
            <span><span class="dot bg2"></span>×œ× ×™×›×•×œ</span>
          </div>

          <div id="daysGrid" class="days" style="margin-bottom:16px"></div>
          
          <p style="color:var(--muted);font-size:13px;line-height:1.4">
            ×œ×—×™×¦×” ×¢×œ ×™×•× ××©× ×” ××ª ×”××¦×‘.<br>
            ×”×©×™× ×•×™×™× × ×©××¨×™× ×›×©×ª×œ×—×¥ ×¢×œ "×©××•×¨ ×©×™× ×•×™×™×".
          </p>
          
          <div style="display:flex;gap:8px;flex-direction:column">
            <button id="saveBtn" class="primary" style="width:100%">ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×</button>
            <button id="resetMineBtn" class="ghost" style="width:100%">××¤×¡ ××ª ×”××™×œ×•×¦×™× ×©×œ×™</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Bottom Tabs -->
  <div id="bottomTabs" class="bottom-tabs"></div>

  <!-- User Modal -->
  <div id="identityBackdrop" class="modal-backdrop">
    <div class="modal">
      <h2>×”×™×™, ××™ ××ª/×”?</h2>
      <p style="color:var(--muted)">×‘×—×¨/×™ ××ª ×”×©× ×©×œ×š ××”×¨×©×™××” ×›×“×™ ×œ×”×ª×—×™×œ.</p>
      <div style="margin-bottom:16px">
        <label for="identitySelect" style="display:block;margin-bottom:6px;font-weight:600">××©×ª××©</label>
        <select id="identitySelect"></select>
      </div>
      <div style="display:flex;justify-content:flex-end">
        <button id="identityStartBtn" class="primary">×”×ª×—×œ</button>
      </div>
    </div>
  </div>

  <!-- Admin Modal -->
  <div id="adminBackdrop" class="modal-backdrop">
    <div class="modal">
      <h2>×”×’×“×¨×•×ª ×—×“×¨</h2>
      <div style="margin-bottom:12px">
        <label style="font-size:13px">×ª××¨×™×š ×”×ª×—×œ×” (×™×•× ×¨××©×•×Ÿ)</label>
        <input id="adminStartDate" type="date">
      </div>
      <div style="margin-bottom:12px">
        <label style="font-size:13px">××¡×¤×¨ ×©×‘×•×¢×•×ª ×œ×—×™×©×•×‘</label>
        <input id="adminHorizon" type="number" min="1" max="8" value="4">
      </div>
      <div style="margin-bottom:12px">
        <label style="font-size:13px">× ×¢×•×œ ×¢×“ ×ª××¨×™×š (×¨×™×§ = ×¤×ª×•×—)</label>
        <input id="adminLockUntil" type="date">
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px">
        <button id="adminCloseBtn" class="ghost">×‘×™×˜×•×œ</button>
        <button id="adminSaveBtn" class="primary">×©××•×¨ ×”×’×“×¨×•×ª</button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastWrap" class="toast-wrap" aria-live="polite"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, getDocs, collection, deleteField, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // --- Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyBiZIHRpbg0bq4VFZ2kDDXj6QeRJZpjOpg",
      authDomain: "sadna-timetable.firebaseapp.com",
      projectId: "sadna-timetable",
      storageBucket: "sadna-timetable.firebasestorage.app",
      messagingSenderId: "605203492621",
      appId: "1:605203492621:web:7ed83f0e5e64d67b9c8a44",
      measurementId: "G-8941L7ZZJ6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const DEFAULT_GROUPS = {
      "××“×¤×¡×•×ª": { name: "××“×¤×¡×•×ª", people: ["× ×‘×•","× ×˜×¢","×˜×œ"], horizonWeeks: 4 },
      "×ª×¤×™×¨×”": { name: "×ª×¤×™×¨×”", people: ["×›×œ×™×œ","×¢××™×ª","×©×™×¨×”"], horizonWeeks: 4 },
      "××ª×›×ª": { name: "××ª×›×ª", people: ["×××™"], horizonWeeks: 4 },
      "×¢×™×‘×•×“ ×©×‘×‘×™×": { name: "×¢×™×‘×•×“ ×©×‘×‘×™×", people: ["×œ×™×¢×“"], horizonWeeks: 4 },
      "×¢×¥": { name: "×¢×¥", people: ["××•×¨×™"], horizonWeeks: 4 }
    };
    
    // Fallback users if DB is empty
    const DEFAULT_USERS = [
      { id: "u-navo", name: "× ×‘×•", group: "××“×¤×¡×•×ª", role: "admin" },
      { id: "u-neta", name: "× ×˜×¢", group: "××“×¤×¡×•×ª", role: "user" },
      { id: "u-tal",  name: "×˜×œ",  group: "××“×¤×¡×•×ª", role: "user" },
      { id: "u-klil", name: "×›×œ×™×œ", group: "×ª×¤×™×¨×”", role: "user" },
      { id: "u-amit", name: "×¢××™×ª", group: "×ª×¤×™×¨×”", role: "user" },
      { id: "u-shira",name: "×©×™×¨×”", group: "×ª×¤×™×¨×”", role: "user" },
      { id: "u-mai",  name: "×××™", group: "××ª×›×ª", role: "user" },
      { id: "u-liad", name: "×œ×™×¢×“", group: "×¢×™×‘×•×“ ×©×‘×‘×™×", role: "user" },
      { id: "u-uri",  name: "××•×¨×™", group: "×¢×¥", role: "user" }
    ];

    // --- Globals ---
    const MS_DAY = 86400000;
    const hebDaysShort = ["××³","×‘×³","×’×³","×“×³","×”×³","×•×³","×©×³"];
    const MIN_PER_PERSON = 2; // Target shifts per person per week

    let activeUser = null;
    let currentGroupId = null;
    let currentGroupData = null;
    let state = {}; // { "2023-11-27": { "Nevo": 1, "Tal": 2 } }
    let peopleInGroup = [];
    let unsubConstraints = null;
    let lastComputedPack = null;

    // --- DOM Elements ---
    const els = {
      whoami: document.getElementById("whoami"),
      switchUser: document.getElementById("switchUserBtn"),
      themeBtn: document.getElementById("themeBtn"),
      daysGrid: document.getElementById("daysGrid"),
      scheduleGrid: document.getElementById("scheduleGrid"),
      dateRangeBadge: document.getElementById("dateRangeBadge"),
      lockBadge: document.getElementById("lockBadge"),
      tabs: document.getElementById("bottomTabs"),
      save: document.getElementById("saveBtn"),
      reset: document.getElementById("resetMineBtn"),
      compute: document.getElementById("computeBtn"),
      export: document.getElementById("exportBtn"),
      calendar: document.getElementById("addCalendarBtn"),
      summary: document.getElementById("summaryBox"),
      toastWrap: document.getElementById("toastWrap"),
      chips: document.getElementById("peopleChips"),
      modalId: document.getElementById("identityBackdrop"),
      selectId: document.getElementById("identitySelect"),
      startId: document.getElementById("identityStartBtn"),
      title: document.getElementById("scheduleTitle"),
      adminBtn: document.getElementById("adminBtn"),
      modalAdmin: document.getElementById("adminBackdrop"),
      adminStart: document.getElementById("adminStartDate"),
      adminHorizon: document.getElementById("adminHorizon"),
      adminLock: document.getElementById("adminLockUntil"),
      adminSave: document.getElementById("adminSaveBtn"),
      adminClose: document.getElementById("adminCloseBtn")
    };

    // --- Helpers ---
    // Parses "YYYY-MM-DD" to Local Midnight Date Object
    function parseLocalDate(str) {
      if(!str) return new Date();
      const [y,m,d] = str.split('-').map(Number);
      return new Date(y, m-1, d, 0, 0, 0, 0);
    }
    
    // Formats Date Object to "YYYY-MM-DD" (Local)
    function fmtDateKey(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    function fmtDM(d) { return `${d.getDate()}.${d.getMonth()+1}`; }
    function addDays(d, n) { return new Date(d.getFullYear(), d.getMonth(), d.getDate() + n); }
    
    // Returns Sunday of the same week
    function getSunday(d) {
      const day = d.getDay();
      return addDays(d, -day);
    }
    
    function rangeDays(start, end) {
      const arr=[];
      let c = new Date(start);
      while(c <= end) { arr.push(new Date(c)); c = addDays(c,1); }
      return arr;
    }

    function shiftInfo(d) {
      const day = d.getDay();
      if(day === 5) return { label: "08:00â€“14:00" };
      if(day === 6) return null; // Shabbat
      return { label: "16:00â€“22:00" };
    }

    function toast(msg, type="ok") {
      const t = document.createElement("div");
      t.className = `toast`;
      // Colors handled by CSS via class inheritance logic or direct style if needed, 
      // but simpler to use innerHTML for icon + text
      let icon = type==="ok"?"âœ…":type==="warn"?"âš ï¸":"âŒ";
      t.innerHTML = `<div><span style="margin-inline-end:8px">${icon}</span>${msg}</div>`;
      els.toastWrap.appendChild(t);
      setTimeout(() => { t.style.opacity="0"; setTimeout(()=>t.remove(),300); }, 3500);
    }

    // --- Firebase Logic ---

    async function bootstrap() {
      // Create defaults if missing
      try {
        const uSnap = await getDocs(collection(db, "users"));
        if(uSnap.empty) {
          const batch = writeBatch(db);
          DEFAULT_USERS.forEach(u => batch.set(doc(db,"users",u.id), u));
          await batch.commit();
        }
        
        const gSnap = await getDocs(collection(db, "groups"));
        if(gSnap.empty) {
          const batch = writeBatch(db);
          for(const [k,v] of Object.entries(DEFAULT_GROUPS)) {
            batch.set(doc(db,"groups",k), {
              name: v.name,
              people: v.people,
              startDate: fmtDateKey(new Date()), // Today
              horizonWeeks: v.horizonWeeks,
              lockedUntil: ""
            });
          }
          await batch.commit();
        }
      } catch(e) { console.error("Bootstrap error", e); }
    }

    async function loadUsers() {
      const snap = await getDocs(collection(db, "users"));
      const users = [];
      snap.forEach(d => users.push({id:d.id, ...d.data()}));
      window.__USERS__ = users;
      
      // Populate select
      els.selectId.innerHTML = users.map(u => 
        `<option value="${u.id}">${u.name} (${u.group}) ${u.role==='admin'?'[×× ×”×œ]':''}</option>`
      ).join("");
    }

    async function switchGroup(groupId) {
      // 1. Get Group Data
      const gRef = doc(db, "groups", groupId);
      let snap = await getDoc(gRef);
      
      if(!snap.exists()) {
        // Fallback if group doc missing
        currentGroupData = { ...DEFAULT_GROUPS[groupId], startDate: fmtDateKey(new Date()) };
      } else {
        currentGroupData = snap.data();
      }
      currentGroupId = groupId;
      
      // 2. Determine People
      let pList = currentGroupData.people || [];
      if(pList.length === 0 && window.__USERS__) {
        pList = window.__USERS__.filter(u => u.group === groupId).map(u => u.name);
      }
      peopleInGroup = pList;

      // 3. UI Updates
      els.title.textContent = `×œ×•×— ×©×™×‘×•×¦×™× â€“ ${currentGroupData.name || groupId}`;
      renderTabs();
      renderChips();
      
      // Check lock
      const lockedDate = currentGroupData.lockedUntil ? parseLocalDate(currentGroupData.lockedUntil) : null;
      const isLocked = lockedDate && new Date() < lockedDate;
      els.lockBadge.style.display = isLocked ? "inline-block" : "none";
      
      // Admin modal populate
      els.adminStart.value = currentGroupData.startDate || "";
      els.adminHorizon.value = currentGroupData.horizonWeeks || 4;
      els.adminLock.value = currentGroupData.lockedUntil || "";

      // 4. Load Constraints
      loadConstraints();
    }

    function loadConstraints() {
      if(unsubConstraints) unsubConstraints();
      state = {};
      
      const startDate = parseLocalDate(currentGroupData.startDate || fmtDateKey(new Date()));
      const monthKey = `${startDate.getFullYear()}-${String(startDate.getMonth()+1).padStart(2,'0')}`;
      
      const q = collection(db, "groups", currentGroupId, "constraints", monthKey, "days");
      
      unsubConstraints = onSnapshot(q, (snapshot) => {
        snapshot.docChanges().forEach(change => {
          if(change.type === "removed") {
            delete state[change.doc.id];
          } else {
            state[change.doc.id] = change.doc.data();
          }
        });
        
        renderCalendar();
        runCompute(); // Auto re-compute on update
      });
    }

    async function saveMyConstraints() {
      if(!activeUser) return toast("×™×© ×œ×”×ª×—×‘×¨ ×§×•×“×","warn");
      const lockedDate = currentGroupData.lockedUntil ? parseLocalDate(currentGroupData.lockedUntil) : null;
      if(lockedDate && new Date() < lockedDate && activeUser.role !== 'admin') return toast("×”×œ×•×— × ×¢×•×œ ×œ×¢×¨×™×›×”","warn");

      const startDate = parseLocalDate(currentGroupData.startDate);
      const monthKey = `${startDate.getFullYear()}-${String(startDate.getMonth()+1).padStart(2,'0')}`;
      
      const batch = writeBatch(db);
      let count = 0;

      // We only save days that exist in our local state to avoid overwrites
      // Ideally we would only save diffs, but for simplicity we save the current user's state for modified days
      for(const [dateKey, dayData] of Object.entries(state)) {
        if(dayData[activeUser.name] !== undefined) {
          const ref = doc(db, "groups", currentGroupId, "constraints", monthKey, "days", dateKey);
          batch.set(ref, { [activeUser.name]: dayData[activeUser.name] }, { merge: true });
          count++;
        }
      }
      
      if(count > 0) {
        await batch.commit();
        toast("×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×”");
      } else {
        toast("×œ× ×–×•×”×• ×©×™× ×•×™×™× ×œ×©××™×¨×”");
      }
    }

    async function resetMyConstraints() {
      if(!activeUser) return toast("×™×© ×œ×”×ª×—×‘×¨ ×§×•×“×","warn");
      if(!confirm("×”×× ×œ××¤×¡ ××ª ×›×œ ×”×”×’×“×¨×•×ª ×©×œ×š ×œ×œ×•×— ×–×”?")) return;

      const startDate = parseLocalDate(currentGroupData.startDate);
      const monthKey = `${startDate.getFullYear()}-${String(startDate.getMonth()+1).padStart(2,'0')}`;
      
      // Get all docs where I have constraints
      const q = collection(db, "groups", currentGroupId, "constraints", monthKey, "days");
      const snapshot = await getDocs(q);
      
      const batch = writeBatch(db);
      snapshot.forEach(d => {
        const data = d.data();
        if(data[activeUser.name] !== undefined) {
          // Delete only my field
          batch.update(d.ref, { [activeUser.name]: deleteField() });
        }
      });
      
      await batch.commit();
      // Local state will update via onSnapshot
      toast("×”××™×œ×•×¦×™× ××•×¤×¡×•");
    }

    // --- Core Logic ---

    function runCompute() {
      if(!currentGroupData) return;
      
      const startDate = parseLocalDate(currentGroupData.startDate);
      const weeks = Number(currentGroupData.horizonWeeks) || 4;
      const endDate = addDays(startDate, weeks * 7 - 1);
      const allDays = rangeDays(startDate, endDate);

      // Init counters
      const counters = { total: {}, week: [], friday: {} };
      peopleInGroup.forEach(p => {
        counters.total[p] = 0;
        counters.friday[p] = 0;
      });
      // Init week buckets
      for(let w=0; w<weeks; w++) {
        counters.week[w] = {};
        peopleInGroup.forEach(p => counters.week[w][p] = 0);
      }

      const assignment = {};

      // Helper to get preference: 0=Avail, 1=PreferNo, 2=Cannot
      const getPref = (dStr, p) => (state[dStr] && state[dStr][p] !== undefined) ? state[dStr][p] : 0;
      
      // 1. Simple Greedy pass
      allDays.forEach(d => {
        const sInfo = shiftInfo(d);
        if(!sInfo) return; // Skip Shabbat
        
        const dStr = fmtDateKey(d);
        const wIdx = Math.floor((d - startDate) / (7 * MS_DAY));
        if(wIdx >= weeks) return;

        // Candidates: Not blocked (2)
        let candidates = peopleInGroup.filter(p => getPref(dStr, p) !== 2);
        
        // Filter out "Prefer No" (1) if possible
        const avail = candidates.filter(p => getPref(dStr, p) === 0);
        if(avail.length > 0) candidates = avail;

        if(candidates.length === 0) {
          assignment[dStr] = null; // No one available
          return;
        }

        // Sort by fairness
        candidates.sort((a,b) => {
          // If Friday, prioritize those with fewer Fridays
          if(d.getDay() === 5) {
             if(counters.friday[a] !== counters.friday[b]) return counters.friday[a] - counters.friday[b];
          }
          // Prioritize fewer shifts this week
          if(counters.week[wIdx][a] !== counters.week[wIdx][b]) return counters.week[wIdx][a] - counters.week[wIdx][b];
          // Prioritize fewer total
          return counters.total[a] - counters.total[b];
        });

        const winner = candidates[0];
        assignment[dStr] = winner;
        
        // Update stats
        counters.total[winner]++;
        counters.week[wIdx][winner]++;
        if(d.getDay() === 5) counters.friday[winner]++;
      });

      lastComputedPack = { assignment, counters, startDate, endDate, weeks };
      renderSchedule();
      renderSummary();
    }

    // --- Rendering ---

    function renderTabs() {
      const keys = Object.keys(DEFAULT_GROUPS);
      els.tabs.innerHTML = keys.map(k => {
        const isActive = k === currentGroupId ? "active" : "";
        return `<div class="tab ${isActive}" data-g="${k}">${k}</div>`;
      }).join("");
      
      els.tabs.querySelectorAll(".tab").forEach(el => {
        el.onclick = () => switchGroup(el.dataset.g);
      });
    }

    function renderChips() {
      els.chips.innerHTML = peopleInGroup.map(p => {
        const isMe = activeUser && activeUser.name === p;
        const isActive = isMe; // Or if we want to view others? For now only me.
        return `<div class="chip ${isActive?'active':''}" data-p="${p}">${p}</div>`;
      }).join("");
      
      // Impersonation logic (only for clicking, visual only)
      els.chips.querySelectorAll(".chip").forEach(el => {
        el.onclick = () => {
          if(!activeUser) return;
          if(activeUser.role !== 'admin' && activeUser.name !== el.dataset.p) return;
          // As admin, allow swapping identity locally for editing
          if(activeUser.role === 'admin') {
             activeUser = { ...activeUser, name: el.dataset.p };
             renderChips();
             renderCalendar();
             toast(`×¢×•×¨×š ×›×¢×ª ××ª: ${el.dataset.p}`);
          }
        };
      });
    }

    function renderCalendar() {
      if(!currentGroupData) return;
      const startDate = parseLocalDate(currentGroupData.startDate);
      const weeks = Number(currentGroupData.horizonWeeks);
      const endDate = addDays(startDate, weeks*7 - 1);
      const daysArr = rangeDays(startDate, endDate);
      
      els.daysGrid.innerHTML = daysArr.map(d => {
        const dStr = fmtDateKey(d);
        const dayOfWeek = d.getDay();
        const isShabbat = dayOfWeek === 6;
        
        // Get status for active user
        let status = 0;
        if(activeUser && state[dStr]) {
          status = state[dStr][activeUser.name] || 0;
        }

        const label = isShabbat ? "×©×‘×ª" : (dayOfWeek === 5 ? "×‘×•×§×¨" : "×¢×¨×‘");
        
        return `
          <div class="day state-${status} ${isShabbat?'shabbat':''}" data-d="${dStr}">
            <div>${hebDaysShort[dayOfWeek]} ${fmtDM(d)}</div>
            <div style="font-size:11px;color:var(--muted)">${label}</div>
          </div>
        `;
      }).join("");
      
      els.daysGrid.querySelectorAll(".day").forEach(el => {
        if(el.classList.contains("shabbat")) return;
        el.onclick = () => {
           if(!activeUser) return toast("×‘×—×¨ ××©×ª××© ×§×•×“×","warn");
           const dStr = el.dataset.d;
           
           // Toggle locally 0 -> 1 -> 2 -> 0
           if(!state[dStr]) state[dStr] = {};
           const curr = state[dStr][activeUser.name] || 0;
           const next = (curr + 1) % 3;
           state[dStr][activeUser.name] = next;
           
           renderCalendar(); // Re-render to show color change
        };
      });
      
      els.dateRangeBadge.textContent = `${fmtDM(startDate)} â€“ ${fmtDM(endDate)}`;
    }

    function renderSchedule() {
      if(!lastComputedPack) return;
      const { assignment, startDate, weeks } = lastComputedPack;
      
      // Grid: 
      // Header row
      let html = `<div class="col-hd"></div>`;
      for(let i=0; i<6; i++) html += `<div class="col-hd">${hebDaysShort[i]}</div>`;
      
      // Rows
      for(let w=0; w<weeks; w++) {
        const sunday = addDays(startDate, w*7);
        const saturday = addDays(sunday, 6);
        html += `<div class="row-label">
                   ${fmtDM(sunday)}<br>â€“<br>${fmtDM(saturday)}
                 </div>`;
        
        for(let d=0; d<6; d++) { // Sun-Fri
          const currDate = addDays(sunday, d);
          const dStr = fmtDateKey(currDate);
          const winner = assignment[dStr];
          
          // Determine warnings
          let warnHtml = "";
          const prefs = state[dStr] || {};
          
          const prefersNo = peopleInGroup.filter(p => prefs[p] === 1);
          const cannot = peopleInGroup.filter(p => prefs[p] === 2);
          
          if(prefersNo.length) warnHtml += `<div class="pill warn" title="××¢×“×™×¤×™× ×©×œ×">${prefersNo.length} âš ï¸</div>`;
          if(cannot.length) warnHtml += `<div class="pill bad" title="×œ× ×™×›×•×œ×™×">${cannot.length} â›”</div>`;
          
          const isFri = d===5;
          const assignedHtml = winner 
            ? `<div class="pill ok"><b>${winner}</b></div>` 
            : `<div class="pill bad">×¨×™×§</div>`;

          html += `
            <div class="slot ${isFri?'fri':''}">
              <div class="datebox">
                <span class="d-top">${hebDaysShort[d]} ${fmtDM(currDate)}</span>
                <span>${isFri?'08:00':'16:00'}</span>
              </div>
              <div style="flex:1;display:flex;flex-direction:column;justify-content:center;gap:4px">
                ${assignedHtml}
                <div style="display:flex;gap:4px;flex-wrap:wrap">${warnHtml}</div>
              </div>
            </div>
          `;
        }
      }
      els.scheduleGrid.innerHTML = html;
    }

    function renderSummary() {
      if(!lastComputedPack) return;
      const { counters, weeks } = lastComputedPack;
      
      let html = `<table style="width:100%;border-collapse:collapse;font-size:13px;text-align:center">`;
      html += `<thead><tr><th style="padding:4px;text-align:right">×©×</th>`;
      for(let w=1; w<=weeks; w++) html += `<th style="padding:4px">×©×‘×³ ${w}</th>`;
      html += `<th style="padding:4px">×¡×”×´×›</th><th style="padding:4px">×©×™×©×™</th></tr></thead><tbody>`;
      
      peopleInGroup.forEach(p => {
        html += `<tr><td style="padding:6px;text-align:right;border-top:1px solid var(--border)">${p}</td>`;
        for(let w=0; w<weeks; w++) {
           html += `<td style="padding:6px;border-top:1px solid var(--border)">${counters.week[w][p]}</td>`;
        }
        html += `<td style="padding:6px;border-top:1px solid var(--border);font-weight:bold">${counters.total[p]}</td>`;
        html += `<td style="padding:6px;border-top:1px solid var(--border)">${counters.friday[p]}</td></tr>`;
      });
      html += `</tbody></table>`;
      els.summary.innerHTML = html;
    }

    // --- Actions ---
    
    // Auth & Init
    onAuthStateChanged(auth, async (user) => {
      if(user) {
        await bootstrap();
        await loadUsers();
        
        // Restore session
        const storedUid = localStorage.getItem("sched_uid");
        if(storedUid && window.__USERS__) {
          const u = window.__USERS__.find(x => x.id === storedUid);
          if(u) {
            startSession(u);
            return;
          }
        }
        
        // Open modal if no session
        els.modalId.style.display = "flex";
      } else {
        signInAnonymously(auth);
      }
    });

    function startSession(user) {
      activeUser = user;
      localStorage.setItem("sched_uid", user.id);
      els.whoami.textContent = `${user.name} (${user.role==='admin'?'×× ×”×œ':'×¢×•×‘×“'})`;
      els.adminBtn.style.display = user.role==='admin' ? 'inline-flex' : 'none';
      
      els.modalId.style.display = "none";
      switchGroup(user.group);
      toast(`×©×œ×•× ${user.name}`);
    }

    // Event Listeners
    els.startId.onclick = () => {
      const uid = els.selectId.value;
      const u = window.__USERS__.find(x => x.id === uid);
      if(u) startSession(u);
    };

    els.switchUser.onclick = () => {
      activeUser = null;
      localStorage.removeItem("sched_uid");
      location.reload();
    };

    els.save.onclick = saveMyConstraints;
    els.reset.onclick = resetMyConstraints;
    
    els.compute.onclick = () => {
      runCompute();
      toast("×”×©×™×‘×•×¥ ×—×•×©×‘ ××—×“×©");
    };

    els.export.onclick = () => {
      if(!lastComputedPack) return toast("××™×Ÿ × ×ª×•× ×™× ×œ×™×¦×•×","warn");
      const { assignment } = lastComputedPack;
      let csv = "Date,Day,Shift,Person\n";
      for(const [k,v] of Object.entries(assignment)) {
        if(!v) continue;
        const d = parseLocalDate(k);
        const dayName = hebDaysShort[d.getDay()];
        csv += `${k},${dayName},Shift,${v}\n`;
      }
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "schedule.csv";
      link.click();
    };

    els.calendar.onclick = () => {
      if(!lastComputedPack || !activeUser) return toast("××™×Ÿ × ×ª×•× ×™×","warn");
      // Generate ICS for me
      let ics = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//MySched//IL\n";
      const { assignment } = lastComputedPack;
      for(const [k,v] of Object.entries(assignment)) {
        if(v !== activeUser.name) continue;
        const d = parseLocalDate(k);
        const isFri = d.getDay()===5;
        const stH = isFri ? '08' : '16';
        const enH = isFri ? '14' : '22';
        const ds = k.replace(/-/g,''); // YYYYMMDD
        ics += `BEGIN:VEVENT\nDTSTART:${ds}T${stH}0000\nDTEND:${ds}T${enH}0000\nSUMMARY:××©××¨×ª ×¡×“× ×”\nDESCRIPTION:×—×“×¨ ${currentGroupData.name}\nEND:VEVENT\n`;
      }
      ics += "END:VCALENDAR";
      const blob = new Blob([ics], {type:"text/calendar;charset=utf-8;"});
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "myshifts.ics";
      link.click();
    };

    // Theme Toggle
    const savedTheme = localStorage.getItem("theme") || "dark";
    document.documentElement.setAttribute("data-theme", savedTheme);
    els.themeBtn.innerHTML = savedTheme==='dark' ? 'â˜€ï¸' : 'ğŸŒ™';
    
    els.themeBtn.onclick = () => {
      const curr = document.documentElement.getAttribute("data-theme");
      const next = curr === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute("data-theme", next);
      localStorage.setItem("theme", next);
      els.themeBtn.innerHTML = next==='dark' ? 'â˜€ï¸' : 'ğŸŒ™';
    };

    // Admin
    els.adminBtn.onclick = () => els.modalAdmin.style.display = "flex";
    els.adminClose.onclick = () => els.modalAdmin.style.display = "none";
    els.adminSave.onclick = async () => {
      await setDoc(doc(db, "groups", currentGroupId), {
        startDate: els.adminStart.value,
        horizonWeeks: Number(els.adminHorizon.value),
        lockedUntil: els.adminLock.value
      }, { merge: true });
      els.modalAdmin.style.display = "none";
      toast("×”×’×“×¨×•×ª × ×©××¨×•");
      switchGroup(currentGroupId); // reload
    };

  </script>
</body>
</html>
