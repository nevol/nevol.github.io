<!DOCTYPE html>
<html lang="he" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>××¢×¨×›×ª ×©×™×‘×•×¦×™× - ×¢×™×¦×•×‘ ×—×“×©</title>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1218; --card:#151a23; --ink:#e2e8f0; --muted:#94a3b8;
      --border:#2a3441; --accent:#38bdf8;
      --pill-bg:#1e293b; 
      --ok-bg:#064e3b; --ok-txt:#6ee7b7;
      --warn-bg:#451a03; --warn-txt:#fcd34d;
      --bad-bg:#450a0a; --bad-txt:#fca5a5;
    }
    html[data-theme="light"]{
      --bg:#f8fafc; --card:#ffffff; --ink:#0f172a; --muted:#64748b;
      --border:#cbd5e1; --pill-bg:#f1f5f9;
      --ok-bg:#dcfce7; --ok-txt:#166534;
      --warn-bg:#fef9c3; --warn-txt:#854d0e;
      --bad-bg:#fee2e2; --bad-txt:#991b1b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:"Assistant",system-ui;overflow-y:scroll;padding-bottom:100px;}
    
    .app{max-width:1800px;margin:0 auto;padding:20px;}
    
    /* Header */
    header.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;}
    .title{margin:0;font-size:32px;font-weight:800;letter-spacing:-0.5px}
    .sub{color:var(--muted);font-size:16px}
    .header-left{display:flex;gap:12px;align-items:center}
    
    .id-pill{background:var(--card);border:1px solid var(--border);padding:6px 16px;border-radius:99px;font-size:14px;font-weight:600}
    button{cursor:pointer;border:none;border-radius:8px;padding:8px 16px;font-weight:700;font-family:inherit;transition:0.2s;font-size:14px}
    button.ghost{background:transparent;border:1px solid var(--border);color:var(--ink)}
    button.ghost:hover{background:var(--pill-bg);border-color:var(--muted)}
    button.primary{background:var(--accent);color:#0f172a}
    button.primary:hover{opacity:0.9}

    /* Layout: 1/3 Right, 2/3 Left */
    .split{
      display:grid;
      grid-template-columns: minmax(360px, 1fr) 2.5fr; /* 1/3 Constraints, 2/3 Schedule */
      gap: 24px;
      align-items:start;
    }
    @media(max-width:1100px){.split{grid-template-columns:1fr}}

    .panel{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1)}
    .panel .hd{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .panel .bd{padding:20px}

    /* Constraints Side (Right) */
    .constraints-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:20px}
    .day-cell{
      aspect-ratio:1/1;
      background:var(--bg);border:1px solid var(--border);
      border-radius:8px;
      display:flex;flex-direction:column;justify-content:center;align-items:center;
      cursor:pointer;transition:0.1s;position:relative;
    }
    .day-cell:hover{border-color:var(--accent)}
    .day-cell.shabbat{opacity:0.3;pointer-events:none;background:var(--pill-bg)}
    .day-cell.s-0{/*Available*/}
    .day-cell.s-1{background:var(--warn-bg);border-color:var(--warn-txt);color:var(--warn-txt)}
    .day-cell.s-2{background:var(--bad-bg);border-color:var(--bad-txt);color:var(--bad-txt)}
    
    .d-num{font-size:18px;font-weight:700}
    .d-name{font-size:12px;color:var(--muted)}

    .legend{display:flex;gap:16px;justify-content:center;margin-bottom:16px;font-size:13px}
    .l-item{display:flex;align-items:center;gap:6px}
    .dot{width:10px;height:10px;border-radius:50%}

    /* Schedule Side (Left) */
    .schedule-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
    }
    .shift-card{
      background:var(--bg);border:1px solid var(--border);
      border-radius:12px;padding:12px;
      display:flex;flex-direction:column;gap:8px;
    }
    .shift-card.fri{background:rgba(56, 189, 248, 0.05);border-color:rgba(56, 189, 248, 0.2)}
    
    .sc-header{display:flex;justify-content:space-between;font-size:13px;color:var(--muted);border-bottom:1px solid var(--border);padding-bottom:6px;margin-bottom:2px}
    .sc-day{font-weight:700;color:var(--ink);font-size:15px}
    
    .assigned-pill{
      background:var(--pill-bg);color:var(--muted);
      text-align:center;padding:8px;border-radius:8px;font-weight:600;font-size:14px;
      border:1px dashed var(--border);
    }
    .assigned-pill.filled{
      background:var(--ok-bg);color:var(--ok-txt);border:1px solid var(--ok-txt);
    }
    
    .mini-status{display:flex;gap:4px;font-size:11px}
    .stat{padding:2px 6px;border-radius:4px;background:var(--pill-bg)}

    /* Bottom Tabs */
    .tabs-bar{
      position:fixed;bottom:0;left:0;right:0;
      background:var(--card);border-top:1px solid var(--border);
      display:flex;justify-content:center;gap:8px;padding:12px;z-index:100;
    }
    .tab{
      padding:10px 24px;border-radius:12px;background:var(--bg);border:1px solid var(--border);
      color:var(--muted);cursor:pointer;font-weight:700;transition:0.2s;
    }
    .tab:hover{background:var(--pill-bg)}
    .tab.active{background:var(--accent);color:#0f172a;border-color:var(--accent);transform:translateY(-2px)}

    /* Modals & Utils */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(5px);z-index:9999;display:none;align-items:center;justify-content:center}
    .modal{background:var(--card);width:90%;max-width:420px;padding:30px;border-radius:24px;border:1px solid var(--border);text-align:center}
    select, input{width:100%;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--ink);font-family:inherit;margin:10px 0;font-size:16px}

    .toast-wrap{position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:10000}
    .toast{background:var(--card);border:1px solid var(--border);padding:10px 20px;border-radius:99px;margin-bottom:8px;box-shadow:0 10px 30px rgba(0,0,0,0.5);display:flex;align-items:center;gap:10px;animation:fade 0.3s}
    @keyframes fade{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body>

<div class="app">
  <header class="header">
    <div>
      <h1 class="title">×œ×•×— ×©×™×‘×•×¦×™×</h1>
      <div class="sub" id="groupSubtitle">×˜×•×¢×Ÿ...</div>
    </div>
    <div class="header-left">
      <div id="whoami" class="id-pill">××•×¨×—</div>
      <button class="ghost" onclick="logout()">×”×—×œ×£ ××©×ª××©</button>
      <button class="ghost" id="adminBtn" style="display:none">âš™ï¸</button>
    </div>
  </header>

  <!-- Main Layout: Constraints (Right) | Schedule (Left) -->
  <main class="split">
    
    <!-- Right Panel: Constraints & Selection (1/3) -->
    <section class="panel">
      <div class="hd">
        <h3>××™×œ×•×¦×™× ×œ×—×•×“×© ×§×“×™××”</h3>
      </div>
      <div class="bd">
        <div class="legend">
          <div class="l-item"><span class="dot" style="border:1px dashed #666"></span> ×–××™×Ÿ</div>
          <div class="l-item"><span class="dot" style="background:var(--warn-txt)"></span> ××¢×“×™×£ ×©×œ×</div>
          <div class="l-item"><span class="dot" style="background:var(--bad-txt)"></span> ×œ× ×–××™×Ÿ</div>
        </div>

        <!-- Month Grid -->
        <div id="daysGrid" class="constraints-grid"></div>

        <div style="text-align:center;color:var(--muted);font-size:13px;margin-bottom:12px">
          ×œ×—×¥ ×¢×œ ×™×•× ×›×“×™ ×œ×©× ×•×ª ×¡×˜×˜×•×¡
        </div>

        <div style="display:flex;gap:10px">
          <button class="primary" id="saveBtn" style="flex:1">×©××•×¨ ××™×œ×•×¦×™×</button>
          <button class="ghost" id="resetBtn">××¤×¡</button>
        </div>
      </div>
    </section>

    <!-- Left Panel: Schedule Display (2/3) -->
    <section class="panel">
      <div class="hd">
        <div style="display:flex;align-items:center;gap:12px">
          <h3>×œ×•×— ×©×™×‘×•×¦×™×</h3>
          <span id="lockBadge" style="font-size:12px;background:var(--bad-bg);color:var(--bad-txt);padding:2px 8px;border-radius:4px;display:none">ğŸ”’ × ×¢×•×œ</span>
        </div>
        <div style="display:flex;gap:8px">
           <button class="ghost" id="computeBtn">âš¡ ×—×©×‘ ×©×™×‘×•×¥</button>
           <button class="ghost" id="exportBtn">ğŸ“¥ CSV</button>
        </div>
      </div>
      <div class="bd">
        <div id="scheduleGrid" class="schedule-grid">
          <div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--muted)">×‘×—×¨ ×§×‘×•×¦×” ×œ××˜×” ×›×“×™ ×œ×˜×¢×•×Ÿ × ×ª×•× ×™×</div>
        </div>
        <div id="summaryBox" style="margin-top:20px;border-top:1px solid var(--border);padding-top:20px"></div>
      </div>
    </section>

  </main>
</div>

<!-- Bottom Tabs -->
<div id="bottomTabs" class="tabs-bar"></div>

<!-- Login Modal -->
<div id="loginModal" class="modal-backdrop" style="display:flex">
  <div class="modal">
    <h2>×”×™×™, ××™ ××ª/×”?</h2>
    <p style="color:var(--muted)">×‘×—×¨ ××ª ×”×©× ×©×œ×š ×›×“×™ ×œ×”×ª×—×‘×¨ ×œ××¢×¨×›×ª</p>
    <select id="userSelect"><option>×˜×•×¢×Ÿ ×¨×©×™××”...</option></select>
    <button class="primary" style="width:100%;margin-top:10px" onclick="doLogin()">×”×ª×—×œ ×œ×¢×‘×•×“</button>
  </div>
</div>

<!-- Admin Modal -->
<div id="adminModal" class="modal-backdrop">
  <div class="modal">
    <h3>×”×’×“×¨×•×ª × ×™×”×•×œ</h3>
    <label>×ª××¨×™×š ×”×ª×—×œ×” (×™×•× ×')</label>
    <input type="date" id="admStart">
    <label>××¡×¤×¨ ×©×‘×•×¢×•×ª</label>
    <input type="number" id="admWeeks" value="4">
    <label>× ×¢×™×œ×” ×¢×“ ×ª××¨×™×š</label>
    <input type="date" id="admLock">
    <div style="display:flex;gap:10px;margin-top:10px">
      <button class="ghost" style="flex:1" onclick="document.getElementById('adminModal').style.display='none'">×‘×™×˜×•×œ</button>
      <button class="primary" style="flex:1" id="admSave">×©××•×¨</button>
    </div>
  </div>
</div>

<div id="toastWrap" class="toast-wrap"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, getDocs, collection, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const firebaseConfig = {
      apiKey: "AIzaSyBiZIHRpbg0bq4VFZ2kDDXj6QeRJZpjOpg",
      authDomain: "sadna-timetable.firebaseapp.com",
      projectId: "sadna-timetable",
      storageBucket: "sadna-timetable.firebasestorage.app",
      messagingSenderId: "605203492621",
      appId: "1:605203492621:web:7ed83f0e5e64d67b9c8a44",
      measurementId: "G-8941L7ZZJ6"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- CONFIG ---
  const GROUPS = ["××“×¤×¡×•×ª", "×ª×¤×™×¨×”", "××ª×›×ª", "×¢×™×‘×•×“ ×©×‘×‘×™×", "×¢×¥"];
  const USERS_DB = [
    {id:"u1", name:"× ×‘×•", group:"××“×¤×¡×•×ª", role:"admin"},
    {id:"u2", name:"× ×˜×¢", group:"××“×¤×¡×•×ª", role:"user"},
    {id:"u3", name:"×˜×œ", group:"××“×¤×¡×•×ª", role:"user"},
    {id:"u4", name:"×›×œ×™×œ", group:"×ª×¤×™×¨×”", role:"user"},
    {id:"u5", name:"×¢××™×ª", group:"×ª×¤×™×¨×”", role:"user"},
    {id:"u6", name:"×©×™×¨×”", group:"×ª×¤×™×¨×”", role:"user"},
    {id:"u7", name:"×××™", group:"××ª×›×ª", role:"user"},
    {id:"u8", name:"×œ×™×¢×“", group:"×¢×™×‘×•×“ ×©×‘×‘×™×", role:"user"},
    {id:"u9", name:"××•×¨×™", group:"×¢×¥", role:"user"}
  ];

  // --- STATE ---
  let activeUser = null;
  let currentGroup = null;
  let groupData = null; // {startDate, weeks, lockedUntil, people}
  let constraints = {}; // { date: {Name: 0/1/2} }
  let unsub = null;

  // --- HELPERS ---
  const qs = s => document.querySelector(s);
  const fmtDate = d => `${d.getDate()}.${d.getMonth()+1}`;
  const toKey = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  const parseKey = s => { const [y,m,d]=s.split('-'); return new Date(y,m-1,d); };
  const addDays = (d,n) => new Date(d.getFullYear(),d.getMonth(),d.getDate()+n);

  function toast(msg, ok=true) {
    const t = document.createElement("div");
    t.className = "toast";
    t.innerHTML = `<span style="font-size:18px">${ok?'âœ…':'âš ï¸'}</span> ${msg}`;
    qs("#toastWrap").appendChild(t);
    setTimeout(()=>t.remove(), 3000);
  }

  // --- INIT ---
  async function init() {
    // 1. Populate Login
    const sel = qs("#userSelect");
    sel.innerHTML = USERS_DB.map(u => `<option value="${u.id}">${u.name} (${u.group})</option>`).join("");
    
    // 2. Check Session
    const saved = localStorage.getItem("uid");
    if(saved) {
      const u = USERS_DB.find(x=>x.id===saved);
      if(u) {
        activeUser = u;
        qs("#loginModal").style.display="none";
        renderApp();
        switchTab(u.group);
        return;
      }
    }
    qs("#loginModal").style.display="flex";
  }

  window.doLogin = () => {
    const uid = qs("#userSelect").value;
    const u = USERS_DB.find(x=>x.id===uid);
    if(u) {
      localStorage.setItem("uid", u.id);
      activeUser = u;
      qs("#loginModal").style.display="none";
      renderApp();
      switchTab(u.group);
    }
  };
  window.logout = () => { localStorage.removeItem("uid"); location.reload(); };

  function renderApp() {
    qs("#whoami").textContent = `${activeUser.name} (${activeUser.role==='admin'?'×× ×”×œ':'×¢×•×‘×“'})`;
    if(activeUser.role==='admin') qs("#adminBtn").style.display="block";
    
    // Render Tabs
    qs("#bottomTabs").innerHTML = GROUPS.map(g => 
      `<div class="tab" id="tab-${g}" onclick="switchTab('${g}')">${g}</div>`
    ).join("");
  }

  // --- CORE LOGIC: SWITCH GROUP ---
  window.switchTab = async (groupName) => {
    // 1. UI Updates
    document.querySelectorAll(".tab").forEach(e=>e.classList.remove("active"));
    qs(`#tab-${groupName}`).classList.add("active");
    qs("#groupSubtitle").textContent = `××¦×™×’ × ×ª×•× ×™× ×¢×‘×•×¨: ${groupName}`;
    qs("#scheduleGrid").innerHTML = `<div style="text-align:center;grid-column:1/-1;padding:40px">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>`;
    qs("#daysGrid").innerHTML = ""; // Clear constraints

    currentGroup = groupName;
    if(unsub) unsub(); // Stop listening to old group

    // 2. Fetch Group Config
    let gDoc = await getDoc(doc(db, "groups", groupName));
    let data = gDoc.exists() ? gDoc.data() : null;

    // If missing, create default
    if(!data) {
      data = {
        startDate: toKey(new Date()),
        horizonWeeks: 4,
        lockedUntil: ""
      };
      await setDoc(doc(db, "groups", groupName), data, {merge:true});
    }
    
    // Determine people (filter from static DB based on group)
    const people = USERS_DB.filter(u => u.group === groupName).map(u => u.name);
    groupData = { ...data, people };

    // Admin Inputs
    qs("#admStart").value = data.startDate;
    qs("#admWeeks").value = data.horizonWeeks;
    qs("#admLock").value = data.lockedUntil;

    // 3. Listen to Constraints
    const start = parseKey(data.startDate);
    const mKey = `${start.getFullYear()}-${String(start.getMonth()+1).padStart(2,'0')}`;
    
    unsub = onSnapshot(collection(db, "groups", groupName, "constraints", mKey, "days"), (snap) => {
      constraints = {};
      snap.forEach(d => constraints[d.id] = d.data());
      renderConstraintsGrid();
      computeSchedule();
    });
  };

  // --- RENDER CONSTRAINTS (Right Side) ---
  function renderConstraintsGrid() {
    const grid = qs("#daysGrid");
    const start = parseKey(groupData.startDate);
    const end = addDays(start, (groupData.horizonWeeks * 7) - 1);
    
    let html = "";
    const days = ["×","×‘","×’","×“","×”","×•","×©"];
    html += days.map(d=>`<div style="text-align:center;font-weight:700;font-size:12px;color:var(--muted)">${d}</div>`).join("");

    let curr = new Date(start);
    while(curr <= end) {
      const k = toKey(curr);
      const day = curr.getDay();
      const isShabbat = day === 6;
      
      // My status
      let status = 0;
      if(activeUser && constraints[k]) status = constraints[k][activeUser.name] || 0;
      
      html += `
        <div class="day-cell s-${status} ${isShabbat?'shabbat':''}" onclick="toggleDay('${k}', ${isShabbat})">
          <div class="d-num">${curr.getDate()}</div>
          <div class="d-name">${curr.getMonth()+1}</div>
        </div>
      `;
      curr = addDays(curr, 1);
    }
    grid.innerHTML = html;
  }

  window.toggleDay = (k, isShabbat) => {
    if(isShabbat) return;
    if(!activeUser) return toast("×”×ª×—×‘×¨ ×§×•×“×", false);
    
    // Check if I belong to this group or am admin
    if(activeUser.group !== currentGroup && activeUser.role !== 'admin') {
      return toast(`××ª×” ×©×™×™×š ×œ×¦×•×•×ª ${activeUser.group}, ××™×Ÿ ×œ×š ×’×™×©×” ×œ×¢×¨×•×š ××ª ${currentGroup}`, false);
    }

    // Check lock
    if(groupData.lockedUntil && new Date() < parseKey(groupData.lockedUntil) && activeUser.role !== 'admin') {
      return toast("×”×œ×•×— × ×¢×•×œ ×œ×¢×¨×™×›×”", false);
    }

    if(!constraints[k]) constraints[k] = {};
    const old = constraints[k][activeUser.name] || 0;
    constraints[k][activeUser.name] = (old + 1) % 3;
    
    // Optimistic Render
    renderConstraintsGrid();
  };

  qs("#saveBtn").onclick = async () => {
    if(!activeUser) return;
    const start = parseKey(groupData.startDate);
    const mKey = `${start.getFullYear()}-${String(start.getMonth()+1).padStart(2,'0')}`;
    const batch = writeBatch(db);
    
    let changes = 0;
    for(const [k, v] of Object.entries(constraints)) {
      if(v[activeUser.name] !== undefined) {
        const ref = doc(db, "groups", currentGroup, "constraints", mKey, "days", k);
        batch.set(ref, {[activeUser.name]: v[activeUser.name]}, {merge:true});
        changes++;
      }
    }
    if(changes) { await batch.commit(); toast("× ×©××¨ ×‘×”×¦×œ×—×”!"); }
    else toast("×œ× ×–×•×”×• ×©×™× ×•×™×™×", false);
  };

  qs("#resetBtn").onclick = () => {
    if(confirm("×œ× ×§×•×ª ××ª ×”×‘×—×™×¨×•×ª ×©×œ×š ××”××¡×š?")) {
      renderConstraintsGrid(); // Just re-renders from memory/DB state (effectively clearing unsaved local)
      toast("×”××¡×š ×¨×•×¢× ×Ÿ");
    }
  };

  // --- RENDER SCHEDULE (Left Side) ---
  function computeSchedule() {
    const people = groupData.people;
    const start = parseKey(groupData.startDate);
    const weeks = Number(groupData.horizonWeeks);
    const end = addDays(start, weeks*7 - 1);
    
    // Lock badge
    const isLocked = groupData.lockedUntil && new Date() < parseKey(groupData.lockedUntil);
    qs("#lockBadge").style.display = isLocked ? "inline-block" : "none";

    // Counters
    const counts = { total:{}, fri:{} };
    people.forEach(p => { counts.total[p]=0; counts.fri[p]=0; });

    let html = "";
    let curr = new Date(start);
    
    while(curr <= end) {
      const day = curr.getDay();
      if(day === 6) { curr = addDays(curr,1); continue; } // Skip Shabbat

      const k = toKey(curr);
      const isFri = day === 5;
      
      // Algorithm Logic
      let candidates = people.filter(p => {
        const pref = constraints[k]?.[p] || 0;
        return pref !== 2; // Not blocked
      });
      
      // Prioritize Avail(0) over PreferNo(1)
      const avail = candidates.filter(p => (constraints[k]?.[p]||0) === 0);
      if(avail.length) candidates = avail;

      // Sort by Fairness
      candidates.sort((a,b) => {
        if(isFri) return counts.fri[a] - counts.fri[b];
        return counts.total[a] - counts.total[b];
      });

      const winner = candidates.length ? candidates[0] : null;
      if(winner) {
        counts.total[winner]++;
        if(isFri) counts.fri[winner]++;
      }

      // Render Card
      const dateStr = `${fmtDate(curr)}`;
      const dayName = ["×¨××©×•×Ÿ","×©× ×™","×©×œ×™×©×™","×¨×‘×™×¢×™","×—××™×©×™","×©×™×©×™","×©×‘×ª"][day];
      const time = isFri ? "08:00-14:00" : "16:00-22:00";
      
      // Warnings
      const prefs = constraints[k] || {};
      const warns = people.filter(p => prefs[p] === 1).length;
      const bads = people.filter(p => prefs[p] === 2).length;

      html += `
        <div class="shift-card ${isFri?'fri':''}">
          <div class="sc-header">
             <span>${dateStr}</span>
             <span>${time}</span>
          </div>
          <div class="sc-day">${dayName}</div>
          
          <div class="assigned-pill ${winner?'filled':''}">
            ${winner || '××™×Ÿ ××©×•×‘×¥'}
          </div>

          <div class="mini-status">
            ${warns ? `<span class="stat" style="color:var(--warn-txt)">${warns}âš ï¸</span>` : ''}
            ${bads ? `<span class="stat" style="color:var(--bad-txt)">${bads}â›”</span>` : ''}
          </div>
        </div>
      `;

      curr = addDays(curr, 1);
    }
    qs("#scheduleGrid").innerHTML = html;

    // Summary Table
    let tbl = `<table style="width:100%;font-size:14px;text-align:center;margin-top:10px">
      <tr style="color:var(--muted)"><th>×©×</th><th>×¡×”×´×›</th><th>×©×™×©×™</th></tr>`;
    people.forEach(p => {
       tbl += `<tr style="border-top:1px solid var(--border)">
         <td style="padding:6px;text-align:right">${p}</td>
         <td>${counts.total[p]}</td>
         <td>${counts.fri[p]}</td>
       </tr>`;
    });
    qs("#summaryBox").innerHTML = tbl + "</table>";
  }

  // --- EVENTS ---
  qs("#computeBtn").onclick = () => { computeSchedule(); toast("×”×©×™×‘×•×¥ ×—×•×©×‘ ××—×“×©"); };
  
  // Admin Logic
  qs("#adminBtn").onclick = () => qs("#adminModal").style.display = "flex";
  qs("#admSave").onclick = async () => {
    await setDoc(doc(db, "groups", currentGroup), {
      startDate: qs("#admStart").value,
      horizonWeeks: qs("#admWeeks").value,
      lockedUntil: qs("#admLock").value
    }, {merge:true});
    qs("#adminModal").style.display = "none";
    switchTab(currentGroup); // Reload
    toast("×”×’×“×¨×•×ª × ×©××¨×•");
  };

  // Auth Start
  onAuthStateChanged(auth, user => {
    if(user) init();
    else signInAnonymously(auth).then(()=>init());
  });

</script>
</body>
</html>
